{
  "id": "snapshot_1765633640742_d1xqywrwf",
  "approvalId": "approval_1765633640733_bh0evepla",
  "approvalTitle": "Tasks: System Initialization Refactor",
  "version": 1,
  "timestamp": "2025-12-13T13:47:20.742Z",
  "trigger": "initial",
  "status": "pending",
  "content": "# Tasks Document: System Initialization Refactor\n\n## Phase 1: Fix Type Definitions\n\n- [ ] 1. Fix frontend type definitions to match backend API response structure\n  - File: `apps/web/src/app/features/system-init/types/system-init.types.ts`\n  - Add `ApiResponse<T>` wrapper type for all API responses\n  - Fix `DashboardResponse.nextRecommended` to be `Array<{ module: string; reason: string; }>`\n  - Add `HealthStatusData` type for health endpoint response\n  - Ensure all types match backend TypeBox schemas exactly\n  - Purpose: Establish type safety between frontend and backend\n  - _Leverage: `apps/api/src/modules/admin/system-init/system-init.schemas.ts`_\n  - _Requirements: 5.1, 5.2, 5.3_\n  - _Prompt: Implement the task for spec system-init-refactor, first run spec-workflow-guide to get the workflow guide then implement the task: Role: TypeScript Developer specializing in type alignment | Task: Fix type definitions in system-init.types.ts to match backend API response structure. Add ApiResponse wrapper type, fix nextRecommended type to Array<{module: string; reason: string}>, add HealthStatusData type | Restrictions: Do not modify backend schemas, maintain backward compatibility with existing component usage, follow project type naming conventions | _Leverage: apps/api/src/modules/admin/system-init/system-init.schemas.ts for exact type definitions | _Requirements: 5.1, 5.2, 5.3 | Success: All types compile without errors, types match backend schema exactly, existing components still work after type changes | Instructions: Mark this task as in-progress in tasks.md before starting, use log-implementation tool after completion with detailed artifacts, then mark as complete_\n\n## Phase 2: Fix Service Layer\n\n- [ ] 2. Update SystemInitService to handle wrapped API responses\n  - File: `apps/web/src/app/features/system-init/services/system-init.service.ts`\n  - Add RxJS `map()` operator to extract `response.data` from all API calls\n  - Fix `getHealth()` method to call `/health-status` instead of `/health`\n  - Add proper error handling for `success: false` responses\n  - Update return types to return unwrapped data types\n  - Purpose: Correctly transform API responses for component consumption\n  - _Leverage: Existing RxJS patterns in other services_\n  - _Requirements: 1.1, 1.2, 1.3, 1.4, 1.5, 2.1, 2.2, 2.3_\n  - _Prompt: Implement the task for spec system-init-refactor, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Angular Developer with RxJS expertise | Task: Update SystemInitService to unwrap API responses using pipe(map(response => response.data)) on all methods, fix health endpoint path to /health-status, add error handling for success:false responses | Restrictions: Do not change method signatures (only return types), maintain observable patterns, do not break existing component subscriptions | _Leverage: RxJS operators map, catchError, throwError | _Requirements: 1.1-1.5, 2.1-2.3 | Success: All service methods return unwrapped data, health endpoint calls correct path, errors are properly thrown for failed responses | Instructions: Mark this task as in-progress in tasks.md before starting, use log-implementation tool after completion with detailed artifacts, then mark as complete_\n\n## Phase 3: Remove Duplicate Files\n\n- [ ] 3. Remove duplicate service and type files from features/system folder\n  - Files to DELETE:\n    - `apps/web/src/app/features/system/services/system-init.service.ts`\n    - `apps/web/src/app/features/system/services/import-progress.service.ts`\n    - `apps/web/src/app/features/system/services/index.ts`\n    - `apps/web/src/app/features/system/types/system-init.types.ts`\n    - `apps/web/src/app/features/system/types/index.ts`\n  - Update any imports that reference the old location\n  - Purpose: Single source of truth for services and types\n  - _Leverage: Global search for import paths_\n  - _Requirements: 3.1, 3.2, 3.3_\n  - _Prompt: Implement the task for spec system-init-refactor, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Developer specializing in codebase cleanup | Task: Delete duplicate service and type files from apps/web/src/app/features/system/services/ and apps/web/src/app/features/system/types/, then search entire codebase for any imports referencing the old locations and update them | Restrictions: Do not delete the canonical files in features/system-init/, verify no references remain before completing, ensure build still passes | _Leverage: grep/ripgrep for finding imports | _Requirements: 3.1, 3.2, 3.3 | Success: All duplicate files removed, no broken imports, pnpm run build passes successfully | Instructions: Mark this task as in-progress in tasks.md before starting, use log-implementation tool after completion with detailed artifacts, then mark as complete_\n\n## Phase 4: Implement Dashboard Action Handlers\n\n- [ ] 4. Implement openImportWizard method to open actual dialog\n  - File: `apps/web/src/app/features/system-init/pages/system-init-dashboard/system-init-dashboard.page.ts`\n  - Replace snackbar \"coming soon\" with actual MatDialog.open() call\n  - Pass module data to ImportWizardDialog\n  - Handle dialog afterClosed() to refresh dashboard on success\n  - Add ImportWizardDialog to component imports\n  - Purpose: Enable import functionality from dashboard\n  - _Leverage: `apps/web/src/app/features/system-init/components/import-wizard/import-wizard.dialog.ts`_\n  - _Requirements: 4.1, 4.2_\n  - _Prompt: Implement the task for spec system-init-refactor, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Angular Developer with Material Dialog expertise | Task: Replace snackbar in openImportWizard() with MatDialog.open(ImportWizardDialog, {width: '800px', maxHeight: '90vh', data: {module}, disableClose: true}), handle afterClosed() to refresh dashboard | Restrictions: Must import ImportWizardDialog properly, maintain existing dialog configuration patterns, do not change component selector | _Leverage: ImportWizardDialog component, MatDialog service | _Requirements: 4.1, 4.2 | Success: Clicking Import button opens wizard dialog, dialog receives module data, dashboard refreshes after successful import | Instructions: Mark this task as in-progress in tasks.md before starting, use log-implementation tool after completion with detailed artifacts, then mark as complete_\n\n- [ ] 5. Implement onModuleRollback method with confirmation dialog\n  - File: `apps/web/src/app/features/system-init/pages/system-init-dashboard/system-init-dashboard.page.ts`\n  - Replace \"coming soon\" with actual rollback implementation\n  - Show confirmation dialog before rollback\n  - Call SystemInitService.rollbackImport() on confirmation\n  - Show success/error snackbar and refresh dashboard\n  - Purpose: Enable rollback functionality from module cards\n  - _Leverage: SystemInitService.rollbackImport()_\n  - _Requirements: 6.2, 6.3, 6.4, 6.5_\n  - _Prompt: Implement the task for spec system-init-refactor, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Angular Developer | Task: Implement onModuleRollback() to show confirmation dialog, call systemInitService.rollbackImport(module.module, module.lastImport.jobId), handle success/error with snackbar, refresh dashboard | Restrictions: Must validate module.lastImport exists before rollback, show appropriate error if no import to rollback, use existing snackbar patterns | _Leverage: SystemInitService, MatSnackBar, window.confirm or MatDialog | _Requirements: 6.2-6.5 | Success: Rollback shows confirmation, calls API correctly, shows result message, refreshes dashboard | Instructions: Mark this task as in-progress in tasks.md before starting, use log-implementation tool after completion with detailed artifacts, then mark as complete_\n\n- [ ] 6. Implement import history action handlers\n  - File: `apps/web/src/app/features/system-init/pages/system-init-dashboard/system-init-dashboard.page.ts`\n  - Implement `onHistoryViewDetails()` - show job details dialog or navigate\n  - Implement `onHistoryRollback()` - rollback completed import with confirmation\n  - Implement `onHistoryRetry()` - open import wizard for failed module\n  - Implement `onHistoryLoadMore()` - fetch additional history items\n  - Purpose: Enable history management functionality\n  - _Leverage: SystemInitService methods_\n  - _Requirements: 7.1, 7.2, 7.3, 7.4_\n  - _Prompt: Implement the task for spec system-init-refactor, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Angular Developer | Task: Implement all history action handlers - onHistoryViewDetails() shows details, onHistoryRollback() calls rollback API with confirmation, onHistoryRetry() opens import wizard for the module, onHistoryLoadMore() fetches more items | Restrictions: Must handle edge cases (no items, API errors), maintain existing UI patterns, do not break timeline component | _Leverage: SystemInitService, ImportWizardDialog | _Requirements: 7.1-7.4 | Success: All history actions work correctly, proper error handling, UI updates after actions | Instructions: Mark this task as in-progress in tasks.md before starting, use log-implementation tool after completion with detailed artifacts, then mark as complete_\n\n## Phase 5: Complete Import Wizard Implementation\n\n- [ ] 7. Implement Import Wizard Step 1 - Template Download\n  - File: `apps/web/src/app/features/system-init/components/import-wizard/import-wizard.dialog.ts`\n  - File: `apps/web/src/app/features/system-init/components/import-wizard/import-wizard.dialog.html`\n  - Display selected module information (name, domain, dependencies)\n  - Implement downloadTemplate() to download CSV/Excel templates\n  - Create download link and trigger browser download\n  - Purpose: Allow users to download import templates\n  - _Leverage: SystemInitService.downloadTemplate()_\n  - _Requirements: 4.3, 4.4_\n  - _Prompt: Implement the task for spec system-init-refactor, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Angular Developer with file download expertise | Task: Complete Import Wizard Step 1 - display module info, implement downloadTemplate(format) to call service and trigger browser download using URL.createObjectURL and link.click() | Restrictions: Must support both CSV and Excel formats, handle download errors gracefully, show loading state during download | _Leverage: SystemInitService.downloadTemplate(), Blob handling | _Requirements: 4.3, 4.4 | Success: Template downloads work for both formats, file has correct name and extension, errors show user-friendly message | Instructions: Mark this task as in-progress in tasks.md before starting, use log-implementation tool after completion with detailed artifacts, then mark as complete_\n\n- [ ] 8. Implement Import Wizard Step 2 - File Upload\n  - File: `apps/web/src/app/features/system-init/components/import-wizard/import-wizard.dialog.ts`\n  - File: `apps/web/src/app/features/system-init/components/import-wizard/import-wizard.dialog.html`\n  - Implement drag & drop file zone\n  - Implement file input click handler\n  - Validate file type (CSV, XLSX) and size (max 10MB) client-side\n  - Display selected file info (name, size)\n  - Purpose: Allow users to upload import files\n  - _Leverage: Native File API, HTML5 drag & drop_\n  - _Requirements: 4.5_\n  - _Prompt: Implement the task for spec system-init-refactor, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Angular Developer with file upload expertise | Task: Complete Import Wizard Step 2 - implement drag & drop zone with onDragOver, onDrop handlers, file input with onFileSelected, validate file type (.csv, .xlsx) and size (<10MB), display file info | Restrictions: Must prevent default drag behavior, validate before accepting file, show clear error for invalid files | _Leverage: Native File API, DragEvent | _Requirements: 4.5 | Success: Drag & drop works, file picker works, validation rejects invalid files, file info displays correctly | Instructions: Mark this task as in-progress in tasks.md before starting, use log-implementation tool after completion with detailed artifacts, then mark as complete_\n\n- [ ] 9. Implement Import Wizard Step 3 - Validation\n  - File: `apps/web/src/app/features/system-init/components/import-wizard/import-wizard.dialog.ts`\n  - File: `apps/web/src/app/features/system-init/components/import-wizard/import-wizard.dialog.html`\n  - Call SystemInitService.validateFile() on step entry\n  - Display validation results using ValidationResultsComponent\n  - Show errors (blocking) and warnings (non-blocking) separately\n  - Store sessionId for import step\n  - Enable/disable \"Next\" based on canProceed\n  - Purpose: Validate file before import\n  - _Leverage: SystemInitService.validateFile(), ValidationResultsComponent_\n  - _Requirements: 4.6, 4.7, 4.8_\n  - _Prompt: Implement the task for spec system-init-refactor, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Angular Developer | Task: Complete Import Wizard Step 3 - call validateFile() when entering step, display results in ValidationResultsComponent, separate errors and warnings, store sessionId, control Next button based on canProceed | Restrictions: Must show loading during validation, handle validation errors gracefully, clear previous results on new validation | _Leverage: SystemInitService.validateFile(), ValidationResultsComponent | _Requirements: 4.6, 4.7, 4.8 | Success: Validation calls API, results display correctly, sessionId is stored, Next button enables only when canProceed is true | Instructions: Mark this task as in-progress in tasks.md before starting, use log-implementation tool after completion with detailed artifacts, then mark as complete_\n\n- [ ] 10. Implement Import Wizard Step 4 - Import Execution\n  - File: `apps/web/src/app/features/system-init/components/import-wizard/import-wizard.dialog.ts`\n  - File: `apps/web/src/app/features/system-init/components/import-wizard/import-wizard.dialog.html`\n  - Display import summary (module, file, record count, options)\n  - Implement import options form (skipWarnings, batchSize, onConflict)\n  - Call SystemInitService.importData() with sessionId and options\n  - Use ImportProgressService.trackProgress() to poll status\n  - Display progress using ProgressTrackerComponent\n  - Handle completion (success/failure) with appropriate UI\n  - Purpose: Execute import with progress tracking\n  - _Leverage: SystemInitService.importData(), ImportProgressService.trackProgress(), ProgressTrackerComponent_\n  - _Requirements: 4.9, 4.10, 4.11, 4.12_\n  - _Prompt: Implement the task for spec system-init-refactor, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Angular Developer with real-time polling expertise | Task: Complete Import Wizard Step 4 - show summary, implement options form, call importData() on confirm, use trackProgress() to poll status every 2 seconds, display progress in ProgressTrackerComponent, handle completion states | Restrictions: Must disable UI during import, handle polling cleanup on dialog close, show clear success/failure messages | _Leverage: SystemInitService, ImportProgressService, ProgressTrackerComponent | _Requirements: 4.9, 4.10, 4.11, 4.12 | Success: Import starts correctly, progress updates in real-time, completion shows appropriate message, dialog can be closed after completion | Instructions: Mark this task as in-progress in tasks.md before starting, use log-implementation tool after completion with detailed artifacts, then mark as complete_\n\n## Phase 6: Testing and Verification\n\n- [ ] 11. Build and verify all changes compile without errors\n  - Run `pnpm run build` to verify TypeScript compilation\n  - Fix any type errors or import issues\n  - Verify no console errors in browser\n  - Purpose: Ensure code quality and type safety\n  - _Leverage: TypeScript compiler, build scripts_\n  - _Requirements: All_\n  - _Prompt: Implement the task for spec system-init-refactor, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Build Engineer | Task: Run pnpm run build, fix any TypeScript errors, verify browser console has no errors when loading the system-init dashboard | Restrictions: Must fix all errors, not suppress them, do not change tsconfig strictness | _Leverage: pnpm run build | _Requirements: All | Success: Build passes with no errors, browser console is clean, all pages load correctly | Instructions: Mark this task as in-progress in tasks.md before starting, use log-implementation tool after completion with detailed artifacts, then mark as complete_\n\n- [ ] 12. Manual end-to-end testing of complete flow\n  - Test dashboard loads and displays modules correctly\n  - Test Import Wizard full flow (template → upload → validate → import)\n  - Test rollback functionality\n  - Test import history actions\n  - Document any remaining issues\n  - Purpose: Verify feature works end-to-end\n  - _Leverage: Running application at localhost:4249_\n  - _Requirements: All_\n  - _Prompt: Implement the task for spec system-init-refactor, first run spec-workflow-guide to get the workflow guide then implement the task: Role: QA Engineer | Task: Manually test entire system-init feature - dashboard loading, filtering, import wizard all steps, rollback, history actions. Document test results and any issues found | Restrictions: Test all user paths, verify error states, do not skip edge cases | _Leverage: Running app at localhost:4249/system/system-init | _Requirements: All | Success: All features work as expected, errors handled gracefully, user experience is smooth | Instructions: Mark this task as in-progress in tasks.md before starting, use log-implementation tool after completion with detailed artifacts including test results, then mark as complete_\n",
  "fileStats": {
    "size": 17924,
    "lines": 152,
    "lastModified": "2025-12-13T13:47:14.775Z"
  },
  "comments": []
}
