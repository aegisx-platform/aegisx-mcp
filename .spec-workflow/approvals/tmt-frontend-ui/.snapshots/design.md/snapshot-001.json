{
  "id": "snapshot_1765727350357_5q0d2a0nz",
  "approvalId": "approval_1765727350339_3uelngxix",
  "approvalTitle": "TMT Frontend UI - Design Document",
  "version": 1,
  "timestamp": "2025-12-14T15:49:10.357Z",
  "trigger": "initial",
  "status": "pending",
  "content": "# Design Document: TMT Frontend UI\n\n## Overview\n\nThe TMT Frontend UI is a modern Angular 18+ application designed to provide an intuitive interface for managing Thai Medical Terminology (TMT) integration in hospital inventory systems. This application follows established AegisX platform patterns and leverages:\n\n1. **TMT Mapping Interface** - Pharmacist-focused UI with AI-assisted drug-to-TMT mapping workflow\n2. **Compliance Dashboard** - Real-time monitoring dashboard with charts, statistics, and priority drug lists\n3. **Ministry Export Tools** - One-click report generation in multiple formats (CSV, Excel, JSON)\n4. **Real-time Updates** - WebSocket integration for instant compliance rate updates and mapping notifications\n\n**Design Philosophy:**\n\n- **Signal-First Architecture**: Angular Signals for reactive state management (no NgRx complexity)\n- **Standalone Components**: Tree-shakable, lazy-loaded feature modules\n- **AegisX UI Integration**: Consistent design system using established component library\n- **Performance-Optimized**: Virtual scrolling, pagination, debounced search, route-level code splitting\n- **Accessibility**: WCAG 2.1 Level AA compliance with ARIA labels and keyboard navigation\n\n**Technology Stack:**\n\n- **Framework**: Angular 18+ (standalone components, Signals, defer blocks)\n- **UI Components**: AegisX UI (`@aegisx/ui`) + Angular Material 18+\n- **Styling**: TailwindCSS 3.4+ utilities\n- **State Management**: Angular Signals (built-in reactive primitives)\n- **HTTP Client**: Angular HttpClient with interceptors\n- **Real-time**: Socket.io-client for WebSocket notifications\n- **Forms**: Reactive Forms with custom validators\n- **Charts**: Chart.js (via `ng2-charts`) for compliance trend visualization\n- **Export**: Custom export service (CSV/Excel/JSON generation)\n\n## Steering Document Alignment\n\n### Technical Standards (tech.md)\n\n**Following Established Frontend Patterns:**\n\n1. **Standalone Component Pattern** (from `drugs-list.component.ts`)\n   - No NgModules, all components standalone\n   - Direct imports in component metadata\n   - Lazy-loaded routes via `loadComponent()`\n   - Tree-shakable bundle with optimized imports\n\n2. **Signal-Based State Management** (from `drugs.service.ts`)\n   ```typescript\n   // State signals (private, writable)\n   private drugsListSignal = signal<Drug[]>([]);\n   private loadingSignal = signal<boolean>(false);\n   private errorSignal = signal<string | null>(null);\n\n   // Public readonly signals\n   readonly drugsList = this.drugsListSignal.asReadonly();\n   readonly loading = this.loadingSignal.asReadonly();\n\n   // Computed signals for derived state\n   readonly totalPages = computed(() =>\n     Math.ceil(this.totalSignal() / this.pageSizeSignal())\n   );\n   ```\n\n3. **Service Layer Pattern** (from `drugs.service.ts`)\n   - HttpClient for API calls (`/inventory/master-data/drugs`)\n   - Signal-based state management\n   - Error handling with specific status codes (400, 403, 404, 500)\n   - Pagination and filtering via HttpParams\n   - Export functionality with custom service\n\n4. **WebSocket Integration** (from `websocket.service.ts`)\n   - Socket.io-client for real-time updates\n   - Signal-based connection status\n   - Feature-based message routing\n   - Auto-reconnect with exponential backoff\n   - Type-safe message interfaces\n\n5. **Component Architecture** (from `drugs-list.component.ts`)\n   - OnPush change detection strategy\n   - Mat-Table for data display with sorting + pagination\n   - Selection model for bulk operations\n   - Dialog-based CRUD forms (Material Dialog)\n   - Snackbar notifications for user feedback\n   - Signals for search/filter state (separate input vs active signals)\n\n### Project Structure (structure.md)\n\n**Following Feature Module Organization:**\n\n```\napps/web/src/app/\n‚îú‚îÄ‚îÄ features/\n‚îÇ   ‚îî‚îÄ‚îÄ inventory/\n‚îÇ       ‚îî‚îÄ‚îÄ modules/\n‚îÇ           ‚îî‚îÄ‚îÄ tmt/                          # NEW: TMT Integration feature\n‚îÇ               ‚îú‚îÄ‚îÄ components/\n‚îÇ               ‚îÇ   ‚îú‚îÄ‚îÄ tmt-search/\n‚îÇ               ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ tmt-search.component.ts\n‚îÇ               ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ tmt-search.component.html\n‚îÇ               ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ tmt-search.component.scss\n‚îÇ               ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ tmt-concept-card.component.ts     # Reusable concept card\n‚îÇ               ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ tmt-hierarchy-tree.component.ts   # Hierarchy tree view\n‚îÇ               ‚îÇ   ‚îú‚îÄ‚îÄ tmt-mapping/\n‚îÇ               ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ mapping-dialog.component.ts        # Main mapping modal\n‚îÇ               ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ mapping-dialog.component.html\n‚îÇ               ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ mapping-dialog.component.scss\n‚îÇ               ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ ai-suggestions-list.component.ts   # AI suggestions panel\n‚îÇ               ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ confidence-badge.component.ts      # Confidence indicator\n‚îÇ               ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ mapping-form.component.ts          # Mapping form\n‚îÇ               ‚îÇ   ‚îú‚îÄ‚îÄ compliance/\n‚îÇ               ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ compliance-dashboard.component.ts  # Main dashboard page\n‚îÇ               ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ compliance-dashboard.component.html\n‚îÇ               ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ compliance-dashboard.component.scss\n‚îÇ               ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ compliance-stats-cards.component.ts\n‚îÇ               ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ compliance-chart.component.ts      # Trend line chart\n‚îÇ               ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ unmapped-drugs-table.component.ts  # Priority drugs table\n‚îÇ               ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ compliance-progress-bar.component.ts\n‚îÇ               ‚îÇ   ‚îî‚îÄ‚îÄ export/\n‚îÇ               ‚îÇ       ‚îú‚îÄ‚îÄ export-dialog.component.ts         # Export configuration\n‚îÇ               ‚îÇ       ‚îú‚îÄ‚îÄ export-dialog.component.html\n‚îÇ               ‚îÇ       ‚îú‚îÄ‚îÄ export-progress.component.ts       # Progress indicator\n‚îÇ               ‚îÇ       ‚îî‚îÄ‚îÄ export-history-list.component.ts   # Past exports\n‚îÇ               ‚îú‚îÄ‚îÄ services/\n‚îÇ               ‚îÇ   ‚îú‚îÄ‚îÄ tmt-api.service.ts                    # HTTP client for TMT API\n‚îÇ               ‚îÇ   ‚îú‚îÄ‚îÄ tmt-websocket.service.ts              # WebSocket for real-time\n‚îÇ               ‚îÇ   ‚îú‚îÄ‚îÄ tmt-state.service.ts                  # Signal-based state\n‚îÇ               ‚îÇ   ‚îú‚îÄ‚îÄ export.service.ts                     # File download utilities\n‚îÇ               ‚îÇ   ‚îî‚îÄ‚îÄ confidence-calculator.service.ts      # Client-side confidence calc\n‚îÇ               ‚îú‚îÄ‚îÄ models/\n‚îÇ               ‚îÇ   ‚îú‚îÄ‚îÄ tmt-concept.model.ts\n‚îÇ               ‚îÇ   ‚îú‚îÄ‚îÄ tmt-mapping.model.ts\n‚îÇ               ‚îÇ   ‚îú‚îÄ‚îÄ compliance-stats.model.ts\n‚îÇ               ‚îÇ   ‚îú‚îÄ‚îÄ ai-suggestion.model.ts\n‚îÇ               ‚îÇ   ‚îî‚îÄ‚îÄ export-request.model.ts\n‚îÇ               ‚îú‚îÄ‚îÄ validators/\n‚îÇ               ‚îÇ   ‚îî‚îÄ‚îÄ mapping.validators.ts                 # Form validators\n‚îÇ               ‚îú‚îÄ‚îÄ tmt.routes.ts                             # Lazy-loaded routes\n‚îÇ               ‚îî‚îÄ‚îÄ index.ts                                  # Public API\n‚îú‚îÄ‚îÄ shared/\n‚îÇ   ‚îî‚îÄ‚îÄ ui/\n‚îÇ       ‚îî‚îÄ‚îÄ components/\n‚îÇ           ‚îî‚îÄ‚îÄ tmt/                          # Reusable TMT components (if shared)\n‚îÇ               ‚îî‚îÄ‚îÄ tmt-concept-selector/     # Standalone TMT selector\n‚îî‚îÄ‚îÄ core/\n    ‚îî‚îÄ‚îÄ services/\n        ‚îî‚îÄ‚îÄ (existing services: auth, api-config, etc.)\n```\n\n**Routing Structure:**\n\n```typescript\n// apps/web/src/app/features/inventory/inventory.routes.ts\n{\n  path: 'tmt',\n  loadChildren: () => import('./modules/tmt/tmt.routes').then(m => m.TMT_ROUTES)\n}\n\n// apps/web/src/app/features/inventory/modules/tmt/tmt.routes.ts\nexport const TMT_ROUTES: Routes = [\n  {\n    path: '',\n    redirectTo: 'compliance',\n    pathMatch: 'full'\n  },\n  {\n    path: 'compliance',\n    loadComponent: () => import('./components/compliance/compliance-dashboard.component')\n      .then(m => m.ComplianceDashboardComponent),\n    data: { title: 'TMT Compliance Dashboard' }\n  },\n  {\n    path: 'search',\n    loadComponent: () => import('./components/tmt-search/tmt-search.component')\n      .then(m => m.TmtSearchComponent),\n    data: { title: 'Search TMT Concepts' }\n  }\n];\n```\n\n## Code Reuse Analysis\n\n### Existing Components to Leverage\n\n**From AegisX UI Library (`@aegisx/ui`):**\n\n- **AxCardComponent**: Container cards for dashboard statistics, unmapped drugs table\n  - Usage: `<ax-card title=\"Compliance Rate\" [loading]=\"loading()\">`\n\n- **AxTableComponent**: Advanced data table with sorting, pagination, selection (alternative to Mat-Table)\n  - Usage: `<ax-table [data]=\"unmappedDrugs()\" [columns]=\"columns\" [pageSize]=\"25\">`\n\n- **AxEmptyStateComponent**: Empty state when no TMT concepts found\n  - Usage: `<ax-empty-state message=\"‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• TMT\" icon=\"search_off\">`\n\n- **AxErrorStateComponent**: Error state for API failures\n  - Usage: `<ax-error-state [error]=\"error()\" (retry)=\"loadData()\">`\n\n- **AxDialogService**: Confirmation dialogs (delete mapping, export warnings)\n  - Usage: `axDialog.confirm('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö mapping?').subscribe(confirmed => ...)`\n\n- **AxBadgeComponent**: TMT level badges (VTM, GP, GPU, TP, TPU), confidence levels (HIGH, MEDIUM, LOW)\n  - Usage: `<ax-badge [color]=\"getConfidenceColor(score)\" [text]=\"level\">`\n\n- **AxChartComponent**: Compliance trend line chart\n  - Usage: `<ax-chart type=\"line\" [data]=\"complianceTrendData()\" [options]=\"chartOptions\">`\n\n- **BreadcrumbComponent**: Navigation breadcrumbs\n  - Usage: `<aegisx-breadcrumb [items]=\"breadcrumbItems\">`\n\n**From Angular Material:**\n\n- **MatDialog**: Modal dialogs for mapping form, export configuration\n  - Usage: `dialog.open(MappingDialogComponent, { width: '800px', data: { drug } })`\n\n- **MatSnackBar**: Toast notifications for success/error messages\n  - Usage: `snackBar.open('‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å mapping ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'Close', { duration: 3000 })`\n\n- **MatPaginator** + **MatSort**: Table pagination and sorting\n  - Usage: Integrated with MatTableDataSource\n\n- **MatTooltip**: Confidence score explanations, icon tooltips\n  - Usage: `<button matTooltip=\"‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ TMT concepts\">`\n\n- **MatCheckbox**: Pharmacist verification checkbox\n  - Usage: `<mat-checkbox [(ngModel)]=\"verified\">`\n\n- **MatProgressBar** / **MatProgressSpinner**: Loading indicators\n  - Usage: `<mat-progress-bar mode=\"indeterminate\" *ngIf=\"loading()\">`\n\n- **MatDatepicker**: Date range picker for export filters\n  - Usage: `<mat-date-range-input>`\n\n**From Existing Inventory Modules:**\n\n- **SharedExportComponent** (from `drugs-list.component.ts`):\n  - Reusable export dialog with format selection (CSV, Excel, JSON)\n  - Usage: `<app-shared-export [service]=\"exportServiceAdapter\" [fields]=\"availableExportFields\">`\n\n- **WebSocketService** (from `shared/business/services/websocket.service.ts`):\n  - Existing WebSocket service for real-time updates\n  - Extend for TMT-specific message handling\n\n- **Drugs CRUD Pattern**:\n  - List component with search/filter/pagination\n  - Dialog-based create/edit/view forms\n  - Bulk operations (delete, export)\n  - Signal-based state management\n\n### Integration Points\n\n**Backend API Integration (tmt-backend-api spec):**\n\nAll endpoints from `tmt-backend-api` spec will be consumed via `TmtApiService`:\n\n```typescript\n// API Endpoints to integrate\nGET    /inventory/master-data/tmt-concepts          # Search TMT concepts\nGET    /inventory/master-data/tmt-concepts/:id      # Get concept details\nGET    /inventory/operations/tmt-mappings           # List mappings\nPOST   /inventory/operations/tmt-mappings           # Create mapping\nPUT    /inventory/operations/tmt-mappings/:id       # Update mapping\nDELETE /inventory/operations/tmt-mappings/:id       # Delete mapping\nPOST   /inventory/operations/tmt-mappings/suggestions/:drugId  # AI suggestions\nGET    /inventory/operations/tmt-mappings/compliance          # Compliance stats\nPOST   /inventory/operations/tmt-mappings/ministry-export     # Generate report\n```\n\n**WebSocket Events:**\n\n```typescript\n// Real-time message structure\ninterface TMTWebSocketMessage {\n  feature: 'tmt';\n  entity: 'mapping' | 'compliance';\n  action: 'created' | 'updated' | 'deleted' | 'rate_changed';\n  data: {\n    mapping?: TMTMapping;\n    complianceRate?: number;\n    userId?: string;\n    userName?: string;\n  };\n  meta: { timestamp: string; userId: string; };\n}\n```\n\n**Authentication & Authorization:**\n\n- Use existing JWT authentication from `AuthService`\n- RBAC via route guards:\n  ```typescript\n  // tmt.routes.ts\n  {\n    path: 'compliance',\n    canActivate: [AuthGuard, RoleGuard],\n    data: {\n      roles: ['Finance Manager', 'Pharmacist', 'Department Head', 'Nurse']\n    }\n  }\n  ```\n\n## Architecture\n\n### System Architecture\n\n```mermaid\ngraph TB\n    User[üë§ User<br/>Pharmacist/Finance Manager]\n\n    subgraph \"Angular Frontend\"\n        Routes[Routes<br/>Lazy Loaded]\n        Components[Components<br/>Standalone]\n        Services[Services<br/>Signal-based State]\n        Guards[Guards<br/>Auth + RBAC]\n    end\n\n    subgraph \"Communication Layer\"\n        HTTP[HttpClient<br/>REST API]\n        WS[WebSocket<br/>Real-time Updates]\n    end\n\n    subgraph \"Backend API\"\n        TMTConcepts[TMT Concepts API<br/>Search & Browse]\n        TMTMappings[TMT Mappings API<br/>CRUD + Suggestions]\n        Compliance[Compliance API<br/>Stats + Export]\n    end\n\n    User --> Routes\n    Routes --> Guards\n    Guards --> Components\n    Components --> Services\n    Services --> HTTP\n    Services --> WS\n    HTTP --> TMTConcepts\n    HTTP --> TMTMappings\n    HTTP --> Compliance\n    WS --> TMTMappings\n    WS --> Compliance\n```\n\n### Component Hierarchy\n\n```mermaid\ngraph TD\n    App[App Component]\n\n    App --> InvShell[Inventory Shell<br/>inventory-shell.component]\n\n    InvShell --> CompDash[Compliance Dashboard<br/>compliance-dashboard.component]\n    InvShell --> TMTSearch[TMT Search<br/>tmt-search.component]\n\n    CompDash --> StatsCards[Compliance Stats Cards<br/>compliance-stats-cards.component]\n    CompDash --> Chart[Compliance Chart<br/>compliance-chart.component]\n    CompDash --> UnmappedTable[Unmapped Drugs Table<br/>unmapped-drugs-table.component]\n    CompDash --> ProgressBar[Compliance Progress Bar<br/>compliance-progress-bar.component]\n\n    UnmappedTable --> MapDialog[Mapping Dialog<br/>mapping-dialog.component]\n\n    MapDialog --> MapForm[Mapping Form<br/>mapping-form.component]\n    MapDialog --> AIList[AI Suggestions List<br/>ai-suggestions-list.component]\n    MapDialog --> TMTSearchInline[TMT Search Inline<br/>Reused from tmt-search]\n\n    AIList --> ConfBadge[Confidence Badge<br/>confidence-badge.component]\n\n    TMTSearch --> ConceptCard[TMT Concept Card<br/>tmt-concept-card.component]\n    TMTSearch --> HierarchyTree[TMT Hierarchy Tree<br/>tmt-hierarchy-tree.component]\n\n    CompDash --> ExportDialog[Export Dialog<br/>export-dialog.component]\n    ExportDialog --> ExportProgress[Export Progress<br/>export-progress.component]\n    ExportDialog --> ExportHistory[Export History List<br/>export-history-list.component]\n```\n\n### State Management Flow\n\n```mermaid\nsequenceDiagram\n    participant User\n    participant Component\n    participant StateService\n    participant ApiService\n    participant WebSocket\n    participant Backend\n\n    User->>Component: Load Compliance Dashboard\n    Component->>StateService: loadCompliance()\n    StateService->>StateService: loadingSignal.set(true)\n    StateService->>ApiService: GET /tmt-mappings/compliance\n    ApiService->>Backend: HTTP GET Request\n    Backend-->>ApiService: { compliance_rate: 96.5%, ... }\n    ApiService-->>StateService: ComplianceStats data\n    StateService->>StateService: complianceStatsSignal.set(data)\n    StateService->>StateService: loadingSignal.set(false)\n    StateService-->>Component: Signal updates (automatic)\n    Component-->>User: Display dashboard\n\n    Note over WebSocket: Real-time Update\n    Backend->>WebSocket: New mapping created\n    WebSocket->>StateService: onMessage({ action: 'created' })\n    StateService->>StateService: Update complianceRateSignal\n    StateService-->>Component: Signal updates (automatic)\n    Component-->>User: Show snackbar notification\n```\n\n## Components and Interfaces\n\n### Component 1: ComplianceDashboardComponent\n\n**Purpose:** Main dashboard page showing real-time TMT mapping compliance rate, statistics, unmapped drugs, and trend chart.\n\n**File:** `apps/web/src/app/features/inventory/modules/tmt/components/compliance/compliance-dashboard.component.ts`\n\n**Interfaces:**\n\n```typescript\n@Component({\n  selector: 'app-compliance-dashboard',\n  standalone: true,\n  imports: [\n    CommonModule,\n    MatCardModule,\n    MatButtonModule,\n    MatIconModule,\n    BreadcrumbComponent,\n    AxCardComponent,\n    AxChartComponent,\n    ComplianceStatsCardsComponent,\n    ComplianceChartComponent,\n    UnmappedDrugsTableComponent,\n    ComplianceProgressBarComponent,\n    ExportDialogComponent\n  ],\n  templateUrl: './compliance-dashboard.component.html',\n  styleUrl: './compliance-dashboard.component.scss',\n  changeDetection: ChangeDetectionStrategy.OnPush\n})\nexport class ComplianceDashboardComponent {\n  // Injected services\n  private tmtState = inject(TmtStateService);\n  private dialog = inject(MatDialog);\n  private snackBar = inject(MatSnackBar);\n  private wsService = inject(TmtWebSocketService);\n\n  // Readonly signals from state service\n  readonly complianceStats = this.tmtState.complianceStats;\n  readonly loading = this.tmtState.loading;\n  readonly error = this.tmtState.error;\n\n  // Computed signals\n  readonly isCompliant = computed(() =>\n    (this.complianceStats()?.compliance_rate ?? 0) >= 95\n  );\n\n  // Methods\n  ngOnInit() {\n    this.tmtState.loadCompliance();\n    this.wsService.subscribeToCompliance((msg) => this.handleRealtimeUpdate(msg));\n  }\n\n  openExportDialog() { /* ... */ }\n  handleRealtimeUpdate(msg: TMTWebSocketMessage) { /* ... */ }\n}\n```\n\n**Dependencies:**\n- `TmtStateService` (state management)\n- `TmtWebSocketService` (real-time updates)\n- `MatDialog` (export dialog)\n\n**Reuses:**\n- `AxCardComponent` (AegisX UI)\n- `AxChartComponent` (AegisX UI)\n- `BreadcrumbComponent` (AegisX UI)\n- `SharedExportComponent` (existing)\n\n---\n\n### Component 2: MappingDialogComponent\n\n**Purpose:** Modal dialog for creating/editing drug-to-TMT mappings with AI suggestions and manual search.\n\n**File:** `apps/web/src/app/features/inventory/modules/tmt/components/tmt-mapping/mapping-dialog.component.ts`\n\n**Interfaces:**\n\n```typescript\nexport interface MappingDialogData {\n  drug: Drug;\n  existingMapping?: TMTMapping;\n  mode: 'create' | 'edit';\n}\n\n@Component({\n  selector: 'app-mapping-dialog',\n  standalone: true,\n  imports: [\n    CommonModule,\n    ReactiveFormsModule,\n    MatDialogModule,\n    MatFormFieldModule,\n    MatInputModule,\n    MatCheckboxModule,\n    MatButtonModule,\n    MatProgressSpinnerModule,\n    MatSnackBarModule,\n    AiSuggestionsListComponent,\n    TmtSearchComponent,\n    MappingFormComponent,\n    AxBadgeComponent\n  ],\n  templateUrl: './mapping-dialog.component.html',\n  styleUrl: './mapping-dialog.component.scss',\n  changeDetection: ChangeDetectionStrategy.OnPush\n})\nexport class MappingDialogComponent {\n  private dialogRef = inject(MatDialogRef<MappingDialogComponent>);\n  private data: MappingDialogData = inject(MAT_DIALOG_DATA);\n  private tmtApi = inject(TmtApiService);\n  private fb = inject(FormBuilder);\n\n  // Signals\n  aiSuggestions = signal<AISuggestion[]>([]);\n  loadingSuggestions = signal(false);\n  selectedTMT = signal<TMTConcept | null>(null);\n\n  // Form\n  mappingForm = this.fb.group({\n    tmt_concept_id: ['', [Validators.required]],\n    verified: [false, [Validators.requiredTrue]],\n    notes: ['']\n  });\n\n  ngOnInit() {\n    this.loadAISuggestions();\n  }\n\n  async loadAISuggestions() {\n    this.loadingSuggestions.set(true);\n    const suggestions = await this.tmtApi.getMappingSuggestions(this.data.drug.id);\n    this.aiSuggestions.set(suggestions);\n    this.loadingSuggestions.set(false);\n  }\n\n  onSuggestionSelected(suggestion: AISuggestion) {\n    this.selectedTMT.set(suggestion.tmt_concept);\n    this.mappingForm.patchValue({ tmt_concept_id: suggestion.tmt_concept.id });\n  }\n\n  async saveMapping() {\n    if (this.mappingForm.invalid) return;\n\n    const mappingData = this.mappingForm.value;\n    const result = await this.tmtApi.createMapping(this.data.drug.id, mappingData);\n    this.dialogRef.close(result);\n  }\n}\n```\n\n**Dependencies:**\n- `TmtApiService` (API calls)\n- `MatDialog`, `MatDialogRef`, `MAT_DIALOG_DATA` (dialog utilities)\n- `FormBuilder`, `Validators` (reactive forms)\n\n**Reuses:**\n- `TmtSearchComponent` (inline TMT search)\n- `AiSuggestionsListComponent` (child component)\n- `AxBadgeComponent` (TMT level badges)\n\n---\n\n### Component 3: UnmappedDrugsTableComponent\n\n**Purpose:** Data table showing unmapped drugs sorted by usage count with quick mapping action buttons.\n\n**File:** `apps/web/src/app/features/inventory/modules/tmt/components/compliance/unmapped-drugs-table.component.ts`\n\n**Interfaces:**\n\n```typescript\n@Component({\n  selector: 'app-unmapped-drugs-table',\n  standalone: true,\n  imports: [\n    CommonModule,\n    MatTableModule,\n    MatSortModule,\n    MatPaginatorModule,\n    MatButtonModule,\n    MatIconModule,\n    MatTooltipModule,\n    AxBadgeComponent,\n    AxEmptyStateComponent\n  ],\n  templateUrl: './unmapped-drugs-table.component.html',\n  styleUrl: './unmapped-drugs-table.component.scss',\n  changeDetection: ChangeDetectionStrategy.OnPush\n})\nexport class UnmappedDrugsTableComponent {\n  private dialog = inject(MatDialog);\n\n  @Input() unmappedDrugs = signal<Drug[]>([]);\n  @Input() loading = signal(false);\n  @Output() mapClicked = new EventEmitter<Drug>();\n\n  displayedColumns = ['drug_code', 'trade_name', 'usage_count', 'days_unmapped', 'actions'];\n  dataSource = new MatTableDataSource<Drug>([]);\n\n  @ViewChild(MatPaginator) paginator!: MatPaginator;\n  @ViewChild(MatSort) sort!: MatSort;\n\n  ngOnInit() {\n    effect(() => {\n      this.dataSource.data = this.unmappedDrugs();\n    });\n  }\n\n  ngAfterViewInit() {\n    this.dataSource.paginator = this.paginator;\n    this.dataSource.sort = this.sort;\n  }\n\n  openMappingDialog(drug: Drug) {\n    const dialogRef = this.dialog.open(MappingDialogComponent, {\n      width: '800px',\n      data: { drug, mode: 'create' } as MappingDialogData\n    });\n\n    dialogRef.afterClosed().subscribe(result => {\n      if (result) {\n        this.mapClicked.emit(drug);\n      }\n    });\n  }\n\n  isPriorityDrug(drug: Drug): boolean {\n    const daysUnmapped = this.calculateDaysUnmapped(drug.created_at);\n    return daysUnmapped > 7 || (drug as any).usage_count > 1000;\n  }\n\n  calculateDaysUnmapped(createdAt: string): number {\n    const now = new Date();\n    const created = new Date(createdAt);\n    return Math.floor((now.getTime() - created.getTime()) / (1000 * 60 * 60 * 24));\n  }\n}\n```\n\n**Dependencies:**\n- `MatDialog` (open mapping dialog)\n- `MatTableDataSource`, `MatPaginator`, `MatSort` (table utilities)\n\n**Reuses:**\n- `MappingDialogComponent` (child dialog)\n- `AxBadgeComponent` (priority badges)\n- `AxEmptyStateComponent` (empty state)\n\n---\n\n### Component 4: AiSuggestionsListComponent\n\n**Purpose:** Display AI-suggested TMT matches with confidence scores and match breakdown.\n\n**File:** `apps/web/src/app/features/inventory/modules/tmt/components/tmt-mapping/ai-suggestions-list.component.ts`\n\n**Interfaces:**\n\n```typescript\n@Component({\n  selector: 'app-ai-suggestions-list',\n  standalone: true,\n  imports: [\n    CommonModule,\n    MatListModule,\n    MatButtonModule,\n    MatIconModule,\n    MatTooltipModule,\n    AxCardComponent,\n    AxBadgeComponent,\n    AxEmptyStateComponent,\n    ConfidenceBadgeComponent\n  ],\n  templateUrl: './ai-suggestions-list.component.html',\n  styleUrl: './ai-suggestions-list.component.scss',\n  changeDetection: ChangeDetectionStrategy.OnPush\n})\nexport class AiSuggestionsListComponent {\n  @Input() suggestions = signal<AISuggestion[]>([]);\n  @Input() loading = signal(false);\n  @Output() suggestionSelected = new EventEmitter<AISuggestion>();\n\n  selectSuggestion(suggestion: AISuggestion) {\n    this.suggestionSelected.emit(suggestion);\n  }\n\n  getConfidenceLevel(score: number): 'HIGH' | 'MEDIUM' | 'LOW' {\n    if (score >= 90) return 'HIGH';\n    if (score >= 70) return 'MEDIUM';\n    return 'LOW';\n  }\n\n  getConfidenceColor(level: string): string {\n    switch (level) {\n      case 'HIGH': return 'success';\n      case 'MEDIUM': return 'warning';\n      case 'LOW': return 'error';\n      default: return 'default';\n    }\n  }\n\n  getMatchBreakdown(suggestion: AISuggestion): string[] {\n    const breakdown: string[] = [];\n    if (suggestion.matched_fields.includes('name')) breakdown.push('‚úì Name matched');\n    if (suggestion.matched_fields.includes('strength')) breakdown.push('‚úì Strength matched');\n    if (suggestion.matched_fields.includes('form')) breakdown.push('‚úì Form matched');\n    return breakdown;\n  }\n}\n```\n\n**Dependencies:** None (pure presentation component)\n\n**Reuses:**\n- `AxCardComponent` (suggestion cards)\n- `AxBadgeComponent` (confidence level badges)\n- `ConfidenceBadgeComponent` (child component)\n\n---\n\n### Component 5: TmtSearchComponent\n\n**Purpose:** Searchable TMT concepts browser with filters, hierarchy view, and pagination.\n\n**File:** `apps/web/src/app/features/inventory/modules/tmt/components/tmt-search/tmt-search.component.ts`\n\n**Interfaces:**\n\n```typescript\n@Component({\n  selector: 'app-tmt-search',\n  standalone: true,\n  imports: [\n    CommonModule,\n    FormsModule,\n    MatInputModule,\n    MatSelectModule,\n    MatButtonModule,\n    MatIconModule,\n    MatProgressSpinnerModule,\n    CdkVirtualScrollViewport,\n    AxCardComponent,\n    AxEmptyStateComponent,\n    TmtConceptCardComponent,\n    TmtHierarchyTreeComponent\n  ],\n  templateUrl: './tmt-search.component.html',\n  styleUrl: './tmt-search.component.scss',\n  changeDetection: ChangeDetectionStrategy.OnPush\n})\nexport class TmtSearchComponent {\n  private tmtApi = inject(TmtApiService);\n\n  // Signals\n  searchTerm = signal('');\n  selectedLevels = signal<TMTLevel[]>([]);\n  searchResults = signal<TMTConcept[]>([]);\n  loading = signal(false);\n  selectedConcept = signal<TMTConcept | null>(null);\n\n  // Debounced search\n  private searchSubject = new Subject<string>();\n\n  ngOnInit() {\n    this.searchSubject.pipe(\n      debounceTime(300),\n      distinctUntilChanged()\n    ).subscribe(term => this.performSearch(term));\n  }\n\n  onSearchInput(term: string) {\n    this.searchTerm.set(term);\n    this.searchSubject.next(term);\n  }\n\n  async performSearch(term: string) {\n    if (!term.trim()) {\n      this.searchResults.set([]);\n      return;\n    }\n\n    this.loading.set(true);\n    const results = await this.tmtApi.searchConcepts({\n      search: term,\n      levels: this.selectedLevels(),\n      limit: 50\n    });\n    this.searchResults.set(results);\n    this.loading.set(false);\n  }\n\n  onConceptClicked(concept: TMTConcept) {\n    this.selectedConcept.set(concept);\n  }\n\n  onLevelFilterChanged(levels: TMTLevel[]) {\n    this.selectedLevels.set(levels);\n    this.performSearch(this.searchTerm());\n  }\n}\n```\n\n**Dependencies:**\n- `TmtApiService` (search API)\n- `Subject`, `debounceTime`, `distinctUntilChanged` (RxJS operators)\n\n**Reuses:**\n- `AxCardComponent` (search container)\n- `AxEmptyStateComponent` (no results state)\n- `TmtConceptCardComponent` (child component)\n- `TmtHierarchyTreeComponent` (child component)\n\n---\n\n### Component 6: ComplianceChartComponent\n\n**Purpose:** Line chart displaying compliance rate trend over the last 6 months.\n\n**File:** `apps/web/src/app/features/inventory/modules/tmt/components/compliance/compliance-chart.component.ts`\n\n**Interfaces:**\n\n```typescript\n@Component({\n  selector: 'app-compliance-chart',\n  standalone: true,\n  imports: [\n    CommonModule,\n    AxChartComponent,\n    AxCardComponent,\n    MatProgressSpinnerModule\n  ],\n  templateUrl: './compliance-chart.component.html',\n  styleUrl: './compliance-chart.component.scss',\n  changeDetection: ChangeDetectionStrategy.OnPush\n})\nexport class ComplianceChartComponent {\n  @Input() trendData = signal<ComplianceTrendData[]>([]);\n  @Input() loading = signal(false);\n\n  chartData = computed(() => ({\n    labels: this.trendData().map(d => d.month),\n    datasets: [\n      {\n        label: 'Compliance Rate (%)',\n        data: this.trendData().map(d => d.compliance_rate),\n        borderColor: '#4CAF50',\n        backgroundColor: 'rgba(76, 175, 80, 0.1)',\n        fill: true,\n        tension: 0.4\n      },\n      {\n        label: 'Target (95%)',\n        data: Array(this.trendData().length).fill(95),\n        borderColor: '#FF9800',\n        borderDash: [5, 5],\n        fill: false\n      }\n    ]\n  }));\n\n  chartOptions = {\n    responsive: true,\n    maintainAspectRatio: false,\n    scales: {\n      y: {\n        beginAtZero: false,\n        min: 80,\n        max: 100,\n        ticks: {\n          callback: (value: number) => `${value}%`\n        }\n      }\n    },\n    plugins: {\n      legend: {\n        display: true,\n        position: 'bottom'\n      },\n      tooltip: {\n        callbacks: {\n          label: (context: any) => `${context.dataset.label}: ${context.parsed.y}%`\n        }\n      }\n    }\n  };\n}\n```\n\n**Dependencies:** None (pure presentation component)\n\n**Reuses:**\n- `AxChartComponent` (AegisX UI chart wrapper)\n- `AxCardComponent` (chart container)\n\n---\n\n### Component 7: ExportDialogComponent\n\n**Purpose:** Modal dialog for configuring ministry report export (format, filters, preview).\n\n**File:** `apps/web/src/app/features/inventory/modules/tmt/components/export/export-dialog.component.ts`\n\n**Interfaces:**\n\n```typescript\nexport interface ExportDialogData {\n  complianceRate: number;\n}\n\n@Component({\n  selector: 'app-export-dialog',\n  standalone: true,\n  imports: [\n    CommonModule,\n    ReactiveFormsModule,\n    MatDialogModule,\n    MatFormFieldModule,\n    MatSelectModule,\n    MatDatepickerModule,\n    MatButtonModule,\n    MatProgressBarModule,\n    MatSnackBarModule,\n    ExportProgressComponent\n  ],\n  templateUrl: './export-dialog.component.html',\n  styleUrl: './export-dialog.component.scss',\n  changeDetection: ChangeDetectionStrategy.OnPush\n})\nexport class ExportDialogComponent {\n  private dialogRef = inject(MatDialogRef<ExportDialogComponent>);\n  private data: ExportDialogData = inject(MAT_DIALOG_DATA);\n  private exportService = inject(ExportService);\n  private snackBar = inject(MatSnackBar);\n\n  // Signals\n  exporting = signal(false);\n  exportProgress = signal(0);\n\n  // Form\n  exportForm = this.fb.group({\n    format: ['csv', Validators.required],\n    startDate: [null],\n    endDate: [null]\n  });\n\n  async startExport() {\n    if (this.exportForm.invalid) return;\n\n    // Warn if non-compliant\n    if (this.data.complianceRate < 95) {\n      const proceed = await this.confirmNonCompliantExport();\n      if (!proceed) return;\n    }\n\n    this.exporting.set(true);\n\n    try {\n      const options = this.exportForm.value;\n      const result = await this.exportService.exportMinistryReport(options, (progress) => {\n        this.exportProgress.set(progress);\n      });\n\n      this.snackBar.open('‚úÖ ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô TMT ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢', 'Close', { duration: 3000 });\n      this.dialogRef.close(result);\n    } catch (error) {\n      this.snackBar.open('‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô', 'Close', { duration: 5000 });\n    } finally {\n      this.exporting.set(false);\n    }\n  }\n\n  async confirmNonCompliantExport(): Promise<boolean> {\n    return new Promise((resolve) => {\n      // Show warning dialog\n      const dialogRef = this.dialog.open(ConfirmDialogComponent, {\n        data: {\n          title: '‡∏Ñ‡∏≥‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô',\n          message: '‚ö†Ô∏è ‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏Å‡∏≤‡∏£‡πÅ‡∏°‡πá‡∏û‡∏ï‡πà‡∏≥‡∏Å‡∏ß‡πà‡∏≤ 95% ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏à‡∏∞‡∏°‡∏µ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô',\n          confirmText: '‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡πà‡∏≠',\n          cancelText: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å'\n        }\n      });\n\n      dialogRef.afterClosed().subscribe(result => resolve(!!result));\n    });\n  }\n}\n```\n\n**Dependencies:**\n- `ExportService` (file generation)\n- `MatDialog` (confirmation dialogs)\n- `MatSnackBar` (notifications)\n\n**Reuses:**\n- `ExportProgressComponent` (child component)\n- `ConfirmDialogComponent` (existing shared component)\n\n## Data Models\n\n### TMTConcept Model\n\n```typescript\n// apps/web/src/app/features/inventory/modules/tmt/models/tmt-concept.model.ts\n\nexport enum TMTLevel {\n  VTM = 'VTM',   // Virtual Therapeutic Moiety\n  GP = 'GP',     // Generic Product\n  GPU = 'GPU',   // Generic Product with Unit\n  TP = 'TP',     // Trade Product\n  TPU = 'TPU'    // Trade Product with Unit\n}\n\nexport interface TMTConcept {\n  id: string;                    // UUID\n  tmt_id: string;                // TMT unique ID (e.g., \"100250001\")\n  concept_code: string;          // Concept code\n  level: TMTLevel;               // Hierarchy level\n  preferred_term: string;        // Preferred term (Thai)\n  fsn: string;                   // Fully Specified Name\n  parent_id: string | null;      // Parent concept UUID\n  is_active: boolean;\n\n  // Extended fields (from API)\n  parent?: TMTConcept;           // Parent concept (for hierarchy)\n  children?: TMTConcept[];       // Child concepts\n  children_count?: number;\n  mapping_count?: number;        // Number of drugs mapped to this concept\n\n  created_at: string;\n  updated_at: string;\n}\n```\n\n---\n\n### TMTMapping Model\n\n```typescript\n// apps/web/src/app/features/inventory/modules/tmt/models/tmt-mapping.model.ts\n\nexport interface TMTMapping {\n  id: string;                    // UUID\n  drug_id: number;               // Foreign key to drugs table\n  tmt_concept_id: string;        // Foreign key to tmt_concepts (UUID)\n  verified: boolean;\n  verified_by: string | null;    // User ID who verified\n  verified_at: string | null;\n  notes: string | null;\n  is_active: boolean;\n\n  // Extended fields (from API)\n  drug?: Drug;\n  tmt_concept?: TMTConcept;\n\n  created_at: string;\n  updated_at: string;\n  created_by: string;\n  updated_by: string | null;\n}\n\nexport interface CreateMappingRequest {\n  drug_id: number;\n  tmt_concept_id: string;\n  verified: boolean;\n  notes?: string;\n}\n\nexport interface UpdateMappingRequest {\n  tmt_concept_id?: string;\n  verified?: boolean;\n  notes?: string;\n}\n```\n\n---\n\n### ComplianceStats Model\n\n```typescript\n// apps/web/src/app/features/inventory/modules/tmt/models/compliance-stats.model.ts\n\nexport interface ComplianceStats {\n  total_drugs: number;\n  mapped_drugs: number;\n  unmapped_drugs: number;\n  compliance_rate: number;       // Percentage (0-100)\n  status: 'COMPLIANT' | 'NON_COMPLIANT';\n\n  // Breakdown by confidence level\n  high_confidence: number;\n  medium_confidence: number;\n  low_confidence: number;\n\n  // Breakdown by TMT level\n  level_breakdown: {\n    VTM: number;\n    GP: number;\n    GPU: number;\n    TP: number;\n    TPU: number;\n  };\n\n  // Priority metrics\n  overdue_mappings: number;      // Unmapped > 7 days\n  high_usage_unmapped: number;   // High usage drugs without mapping\n}\n\nexport interface ComplianceTrendData {\n  month: string;                 // e.g., \"Jul 24\"\n  compliance_rate: number;       // Percentage\n  mapped_count: number;\n  total_count: number;\n}\n```\n\n---\n\n### AISuggestion Model\n\n```typescript\n// apps/web/src/app/features/inventory/modules/tmt/models/ai-suggestion.model.ts\n\nexport interface AISuggestion {\n  tmt_concept: TMTConcept;\n  confidence_score: number;      // 0-100\n  confidence_level: 'HIGH' | 'MEDIUM' | 'LOW';\n  matched_fields: ('name' | 'strength' | 'form')[];\n  score_breakdown: {\n    name_similarity: number;     // 0-50\n    strength_match: number;      // 0-30\n    dosage_form_match: number;   // 0-20\n  };\n}\n\nexport interface MappingSuggestionsResponse {\n  drug_id: number;\n  suggestions: AISuggestion[];\n  suggested_at: string;\n}\n```\n\n---\n\n### ExportRequest Model\n\n```typescript\n// apps/web/src/app/features/inventory/modules/tmt/models/export-request.model.ts\n\nexport type ExportFormat = 'csv' | 'excel' | 'json';\n\nexport interface ExportRequest {\n  format: ExportFormat;\n  start_date?: string;           // ISO date string\n  end_date?: string;\n  include_unmapped?: boolean;    // Default: true\n}\n\nexport interface ExportResponse {\n  file_url: string;\n  filename: string;\n  format: ExportFormat;\n  total_records: number;\n  compliance_rate: number;\n  generated_at: string;\n}\n\nexport interface ExportHistory {\n  id: string;\n  format: ExportFormat;\n  compliance_rate: number;\n  total_records: number;\n  generated_by: string;\n  generated_at: string;\n  file_url: string;\n}\n```\n\n## Services\n\n### Service 1: TmtApiService\n\n**Purpose:** HTTP client for all TMT Backend API endpoints with signal-based error handling.\n\n**File:** `apps/web/src/app/features/inventory/modules/tmt/services/tmt-api.service.ts`\n\n**Key Methods:**\n\n```typescript\n@Injectable({ providedIn: 'root' })\nexport class TmtApiService {\n  private http = inject(HttpClient);\n  private baseUrl = '/inventory';\n\n  // ===== TMT CONCEPTS =====\n\n  async searchConcepts(params: SearchConceptsQuery): Promise<TMTConcept[]> {\n    const httpParams = new HttpParams()\n      .set('search', params.search || '')\n      .set('limit', params.limit?.toString() || '50');\n\n    if (params.levels?.length) {\n      params.levels.forEach(level => {\n        httpParams = httpParams.append('levels', level);\n      });\n    }\n\n    const response = await firstValueFrom(\n      this.http.get<PaginatedResponse<TMTConcept>>(\n        `${this.baseUrl}/master-data/tmt-concepts`,\n        { params: httpParams }\n      )\n    );\n\n    return response.data;\n  }\n\n  async getConceptById(id: string): Promise<TMTConcept> {\n    return firstValueFrom(\n      this.http.get<ApiResponse<TMTConcept>>(\n        `${this.baseUrl}/master-data/tmt-concepts/${id}`\n      )\n    ).then(res => res.data);\n  }\n\n  // ===== TMT MAPPINGS =====\n\n  async getMappings(params: ListMappingsQuery): Promise<PaginatedResponse<TMTMapping>> {\n    const httpParams = this.buildHttpParams(params);\n\n    return firstValueFrom(\n      this.http.get<PaginatedResponse<TMTMapping>>(\n        `${this.baseUrl}/operations/tmt-mappings`,\n        { params: httpParams }\n      )\n    );\n  }\n\n  async createMapping(drugId: number, data: CreateMappingRequest): Promise<TMTMapping> {\n    return firstValueFrom(\n      this.http.post<ApiResponse<TMTMapping>>(\n        `${this.baseUrl}/operations/tmt-mappings`,\n        { ...data, drug_id: drugId }\n      )\n    ).then(res => res.data);\n  }\n\n  async updateMapping(id: string, data: UpdateMappingRequest): Promise<TMTMapping> {\n    return firstValueFrom(\n      this.http.put<ApiResponse<TMTMapping>>(\n        `${this.baseUrl}/operations/tmt-mappings/${id}`,\n        data\n      )\n    ).then(res => res.data);\n  }\n\n  async deleteMapping(id: string): Promise<void> {\n    await firstValueFrom(\n      this.http.delete(`${this.baseUrl}/operations/tmt-mappings/${id}`)\n    );\n  }\n\n  // ===== AI SUGGESTIONS =====\n\n  async getMappingSuggestions(drugId: number): Promise<AISuggestion[]> {\n    return firstValueFrom(\n      this.http.post<ApiResponse<AISuggestion[]>>(\n        `${this.baseUrl}/operations/tmt-mappings/suggestions/${drugId}`,\n        {}\n      )\n    ).then(res => res.data);\n  }\n\n  // ===== COMPLIANCE =====\n\n  async getComplianceStats(): Promise<ComplianceStats> {\n    return firstValueFrom(\n      this.http.get<ApiResponse<ComplianceStats>>(\n        `${this.baseUrl}/operations/tmt-mappings/compliance`\n      )\n    ).then(res => res.data);\n  }\n\n  async getUnmappedDrugs(params?: ListDrugQuery): Promise<Drug[]> {\n    const httpParams = this.buildHttpParams(params || {});\n\n    return firstValueFrom(\n      this.http.get<PaginatedResponse<Drug>>(\n        `${this.baseUrl}/operations/tmt-mappings/unmapped-drugs`,\n        { params: httpParams }\n      )\n    ).then(res => res.data);\n  }\n\n  // ===== MINISTRY EXPORT =====\n\n  async exportMinistryReport(request: ExportRequest): Promise<ExportResponse> {\n    return firstValueFrom(\n      this.http.post<ApiResponse<ExportResponse>>(\n        `${this.baseUrl}/operations/tmt-mappings/ministry-export`,\n        request\n      )\n    ).then(res => res.data);\n  }\n\n  // Helper method\n  private buildHttpParams(params: Record<string, any>): HttpParams {\n    let httpParams = new HttpParams();\n    Object.keys(params).forEach(key => {\n      if (params[key] !== undefined && params[key] !== null) {\n        if (Array.isArray(params[key])) {\n          params[key].forEach((val: any) => {\n            httpParams = httpParams.append(key, val);\n          });\n        } else {\n          httpParams = httpParams.set(key, params[key]);\n        }\n      }\n    });\n    return httpParams;\n  }\n}\n```\n\n---\n\n### Service 2: TmtStateService\n\n**Purpose:** Signal-based state management for TMT module (compliance stats, mappings, concepts).\n\n**File:** `apps/web/src/app/features/inventory/modules/tmt/services/tmt-state.service.ts`\n\n**Key Methods:**\n\n```typescript\n@Injectable({ providedIn: 'root' })\nexport class TmtStateService {\n  private tmtApi = inject(TmtApiService);\n\n  // ===== PRIVATE SIGNALS (writable) =====\n\n  private complianceStatsSignal = signal<ComplianceStats | null>(null);\n  private unmappedDrugsSignal = signal<Drug[]>([]);\n  private complianceTrendSignal = signal<ComplianceTrendData[]>([]);\n  private loadingSignal = signal(false);\n  private errorSignal = signal<string | null>(null);\n\n  // ===== PUBLIC READONLY SIGNALS =====\n\n  readonly complianceStats = this.complianceStatsSignal.asReadonly();\n  readonly unmappedDrugs = this.unmappedDrugsSignal.asReadonly();\n  readonly complianceTrend = this.complianceTrendSignal.asReadonly();\n  readonly loading = this.loadingSignal.asReadonly();\n  readonly error = this.errorSignal.asReadonly();\n\n  // ===== COMPUTED SIGNALS =====\n\n  readonly isCompliant = computed(() => {\n    const stats = this.complianceStatsSignal();\n    return stats ? stats.compliance_rate >= 95 : false;\n  });\n\n  readonly complianceRate = computed(() => {\n    return this.complianceStatsSignal()?.compliance_rate ?? 0;\n  });\n\n  readonly unmappedCount = computed(() => {\n    return this.complianceStatsSignal()?.unmapped_drugs ?? 0;\n  });\n\n  // ===== ACTIONS =====\n\n  async loadCompliance(): Promise<void> {\n    this.loadingSignal.set(true);\n    this.errorSignal.set(null);\n\n    try {\n      const stats = await this.tmtApi.getComplianceStats();\n      this.complianceStatsSignal.set(stats);\n\n      // Load unmapped drugs\n      const unmapped = await this.tmtApi.getUnmappedDrugs({ limit: 100 });\n      this.unmappedDrugsSignal.set(unmapped);\n\n    } catch (error: any) {\n      this.errorSignal.set(error.message || 'Failed to load compliance data');\n    } finally {\n      this.loadingSignal.set(false);\n    }\n  }\n\n  async loadComplianceTrend(): Promise<void> {\n    try {\n      // TODO: Call backend API for trend data (last 6 months)\n      // const trend = await this.tmtApi.getComplianceTrend({ months: 6 });\n      // this.complianceTrendSignal.set(trend);\n    } catch (error) {\n      console.error('Failed to load compliance trend:', error);\n    }\n  }\n\n  updateComplianceRate(newRate: number): void {\n    const current = this.complianceStatsSignal();\n    if (current) {\n      this.complianceStatsSignal.set({\n        ...current,\n        compliance_rate: newRate,\n        status: newRate >= 95 ? 'COMPLIANT' : 'NON_COMPLIANT'\n      });\n    }\n  }\n\n  clearError(): void {\n    this.errorSignal.set(null);\n  }\n}\n```\n\n---\n\n### Service 3: TmtWebSocketService\n\n**Purpose:** WebSocket client for real-time TMT mapping updates and compliance rate changes.\n\n**File:** `apps/web/src/app/features/inventory/modules/tmt/services/tmt-websocket.service.ts`\n\n**Key Methods:**\n\n```typescript\n@Injectable({ providedIn: 'root' })\nexport class TmtWebSocketService {\n  private wsService = inject(WebSocketService);\n  private tmtState = inject(TmtStateService);\n  private snackBar = inject(MatSnackBar);\n\n  private subscriptions: any[] = [];\n\n  /**\n   * Subscribe to TMT mapping events\n   */\n  subscribeToMappings(callback: (msg: TMTWebSocketMessage) => void): void {\n    const sub = this.wsService.subscribeToFeature('tmt', 'mapping')\n      .subscribe((msg: WebSocketMessage) => {\n        const tmtMsg = msg as TMTWebSocketMessage;\n        callback(tmtMsg);\n\n        // Handle different actions\n        switch (tmtMsg.action) {\n          case 'created':\n            this.handleMappingCreated(tmtMsg);\n            break;\n          case 'updated':\n            this.handleMappingUpdated(tmtMsg);\n            break;\n          case 'deleted':\n            this.handleMappingDeleted(tmtMsg);\n            break;\n        }\n      });\n\n    this.subscriptions.push(sub);\n  }\n\n  /**\n   * Subscribe to compliance rate changes\n   */\n  subscribeToCompliance(callback: (msg: TMTWebSocketMessage) => void): void {\n    const sub = this.wsService.subscribeToFeature('tmt', 'compliance')\n      .subscribe((msg: WebSocketMessage) => {\n        const tmtMsg = msg as TMTWebSocketMessage;\n        callback(tmtMsg);\n\n        if (tmtMsg.action === 'rate_changed') {\n          this.handleComplianceRateChanged(tmtMsg);\n        }\n      });\n\n    this.subscriptions.push(sub);\n  }\n\n  private handleMappingCreated(msg: TMTWebSocketMessage): void {\n    const userName = msg.data.userName || '‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ';\n    this.snackBar.open(\n      `‚ÑπÔ∏è ‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÅ‡∏°‡πá‡∏û‡∏¢‡∏≤‡πÉ‡∏´‡∏°‡πà 1 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ (‡πÇ‡∏î‡∏¢: ${userName})`,\n      'Close',\n      { duration: 5000 }\n    );\n\n    // Reload compliance data\n    this.tmtState.loadCompliance();\n  }\n\n  private handleMappingUpdated(msg: TMTWebSocketMessage): void {\n    // Optionally reload data\n  }\n\n  private handleMappingDeleted(msg: TMTWebSocketMessage): void {\n    // Reload compliance data\n    this.tmtState.loadCompliance();\n  }\n\n  private handleComplianceRateChanged(msg: TMTWebSocketMessage): void {\n    const newRate = msg.data.complianceRate;\n\n    if (newRate >= 95) {\n      // Celebration toast\n      this.snackBar.open(\n        'üéâ ‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏î‡πâ‡∏ß‡∏¢! ‡∏ú‡πà‡∏≤‡∏ô‡πÄ‡∏Å‡∏ì‡∏ë‡πå ‡∏Å‡∏£‡∏∞‡∏ó‡∏£‡∏ß‡∏á‡πÅ‡∏•‡πâ‡∏ß (95%)',\n        'Close',\n        { duration: 10000, panelClass: ['success-snackbar'] }\n      );\n    }\n\n    // Update state\n    this.tmtState.updateComplianceRate(newRate);\n  }\n\n  /**\n   * Unsubscribe from all WebSocket events\n   */\n  disconnect(): void {\n    this.subscriptions.forEach(sub => sub.unsubscribe());\n    this.subscriptions = [];\n  }\n}\n```\n\n---\n\n### Service 4: ExportService\n\n**Purpose:** Generate and download ministry reports in multiple formats (CSV, Excel, JSON).\n\n**File:** `apps/web/src/app/features/inventory/modules/tmt/services/export.service.ts`\n\n**Key Methods:**\n\n```typescript\n@Injectable({ providedIn: 'root' })\nexport class ExportService {\n  private tmtApi = inject(TmtApiService);\n\n  async exportMinistryReport(\n    request: ExportRequest,\n    onProgress?: (progress: number) => void\n  ): Promise<ExportResponse> {\n    // Call backend export API\n    const response = await this.tmtApi.exportMinistryReport(request);\n\n    // Download file\n    await this.downloadFile(response.file_url, response.filename, onProgress);\n\n    return response;\n  }\n\n  private async downloadFile(\n    url: string,\n    filename: string,\n    onProgress?: (progress: number) => void\n  ): Promise<void> {\n    return new Promise((resolve, reject) => {\n      const xhr = new XMLHttpRequest();\n\n      xhr.open('GET', url, true);\n      xhr.responseType = 'blob';\n\n      xhr.onprogress = (event) => {\n        if (event.lengthComputable && onProgress) {\n          const progress = Math.round((event.loaded / event.total) * 100);\n          onProgress(progress);\n        }\n      };\n\n      xhr.onload = () => {\n        if (xhr.status === 200) {\n          const blob = xhr.response;\n          const link = document.createElement('a');\n          link.href = window.URL.createObjectURL(blob);\n          link.download = filename;\n          link.click();\n          window.URL.revokeObjectURL(link.href);\n          resolve();\n        } else {\n          reject(new Error(`Download failed with status ${xhr.status}`));\n        }\n      };\n\n      xhr.onerror = () => reject(new Error('Download failed'));\n      xhr.send();\n    });\n  }\n}\n```\n\n## Error Handling\n\n### Error Scenarios\n\n**1. API Call Failures**\n\n- **Scenario**: Backend API returns 500 Internal Server Error\n- **Handling**:\n  - `TmtApiService` throws error\n  - `TmtStateService` catches error and sets `errorSignal`\n  - Component displays `AxErrorStateComponent` with retry button\n- **User Impact**: Full-page error state with \"‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á\" message\n\n**2. Permission Denied (403)**\n\n- **Scenario**: User attempts to create mapping without permission\n- **Handling**:\n  - HTTP interceptor catches 403 error\n  - Service sets `permissionErrorSignal`\n  - Component shows error snackbar: \"‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏ó‡∏≥‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ\"\n- **User Impact**: Snackbar notification, no data corruption\n\n**3. Validation Errors (400)**\n\n- **Scenario**: Pharmacist forgets to check verification checkbox\n- **Handling**:\n  - Backend returns 400 with error message\n  - Component catches error and displays validation message\n  - Form shows specific field error\n- **User Impact**: Red error text below form field\n\n**4. WebSocket Connection Lost**\n\n- **Scenario**: Network interruption disconnects WebSocket\n- **Handling**:\n  - `WebSocketService` detects disconnection\n  - Auto-retry connection every 5 seconds (max 10 attempts)\n  - Show warning banner: \"‚ö†Ô∏è ‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Ç‡∏≤‡∏î‡∏´‡∏≤‡∏¢ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÉ‡∏´‡∏°‡πà...\"\n- **User Impact**: Banner at top of page, fallback to polling for updates\n\n**5. Search Returns No Results**\n\n- **Scenario**: User searches for non-existent TMT concept\n- **Handling**:\n  - API returns empty array\n  - Component displays `AxEmptyStateComponent`\n- **User Impact**: Friendly empty state: \"‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• TMT ‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡∏Ñ‡∏≥‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤\"\n\n**6. Export Failure**\n\n- **Scenario**: Export file generation times out\n- **Handling**:\n  - Backend returns 504 Gateway Timeout\n  - Component catches error in export dialog\n  - Show error snackbar with specific message\n- **User Impact**: Error snackbar, dialog stays open for retry\n\n## Testing Strategy\n\n### Unit Testing\n\n**Tools:** Jest (for services), Jasmine (for components)\n\n**Coverage Target:** ‚â• 70%\n\n**Key Test Cases:**\n\n1. **TmtStateService**\n   - Test signal updates when `loadCompliance()` is called\n   - Test computed signals (`isCompliant`, `complianceRate`)\n   - Test error handling when API fails\n\n2. **TmtApiService**\n   - Mock HttpClient responses\n   - Test correct URL construction with query params\n   - Test error propagation\n\n3. **ComplianceDashboardComponent**\n   - Test initial data loading\n   - Test WebSocket message handling\n   - Test navigation to mapping dialog\n\n4. **AiSuggestionsListComponent**\n   - Test confidence level calculation (HIGH/MEDIUM/LOW)\n   - Test suggestion selection event emission\n   - Test match breakdown rendering\n\n**Example Unit Test:**\n\n```typescript\n// tmt-state.service.spec.ts\ndescribe('TmtStateService', () => {\n  let service: TmtStateService;\n  let tmtApi: jasmine.SpyObj<TmtApiService>;\n\n  beforeEach(() => {\n    const apiSpy = jasmine.createSpyObj('TmtApiService', ['getComplianceStats', 'getUnmappedDrugs']);\n\n    TestBed.configureTestingModule({\n      providers: [\n        TmtStateService,\n        { provide: TmtApiService, useValue: apiSpy }\n      ]\n    });\n\n    service = TestBed.inject(TmtStateService);\n    tmtApi = TestBed.inject(TmtApiService) as jasmine.SpyObj<TmtApiService>;\n  });\n\n  it('should update compliance stats signal on successful load', async () => {\n    const mockStats: ComplianceStats = {\n      total_drugs: 1000,\n      mapped_drugs: 960,\n      unmapped_drugs: 40,\n      compliance_rate: 96.0,\n      status: 'COMPLIANT',\n      // ...\n    };\n\n    tmtApi.getComplianceStats.and.returnValue(Promise.resolve(mockStats));\n    tmtApi.getUnmappedDrugs.and.returnValue(Promise.resolve([]));\n\n    await service.loadCompliance();\n\n    expect(service.complianceStats()).toEqual(mockStats);\n    expect(service.isCompliant()).toBe(true);\n  });\n\n  it('should set error signal on API failure', async () => {\n    tmtApi.getComplianceStats.and.returnValue(Promise.reject(new Error('Network error')));\n\n    await service.loadCompliance();\n\n    expect(service.error()).toContain('Network error');\n    expect(service.complianceStats()).toBeNull();\n  });\n});\n```\n\n### Integration Testing\n\n**Tools:** Angular TestBed, HttpClientTestingModule\n\n**Key Flows:**\n\n1. **Mapping Workflow**\n   - User opens unmapped drugs table\n   - Clicks [Map] button\n   - Mapping dialog opens with AI suggestions\n   - User selects suggestion\n   - Form is pre-filled\n   - User checks verification checkbox\n   - Saves mapping\n   - Dialog closes, table refreshes\n\n2. **Export Workflow**\n   - User clicks \"Generate Ministry Report\"\n   - Export dialog opens\n   - User selects CSV format\n   - Clicks \"Export\"\n   - Progress bar shows 0-100%\n   - File downloads automatically\n   - Success snackbar appears\n\n**Example Integration Test:**\n\n```typescript\n// compliance-dashboard.component.spec.ts (integration)\ndescribe('ComplianceDashboardComponent Integration', () => {\n  let component: ComplianceDashboardComponent;\n  let fixture: ComponentFixture<ComplianceDashboardComponent>;\n  let httpMock: HttpTestingController;\n\n  beforeEach(async () => {\n    await TestBed.configureTestingModule({\n      imports: [\n        ComplianceDashboardComponent,\n        HttpClientTestingModule,\n        NoopAnimationsModule\n      ],\n      providers: [\n        TmtStateService,\n        TmtApiService\n      ]\n    }).compileComponents();\n\n    fixture = TestBed.createComponent(ComplianceDashboardComponent);\n    component = fixture.componentInstance;\n    httpMock = TestBed.inject(HttpTestingController);\n  });\n\n  it('should load compliance data on init', () => {\n    fixture.detectChanges(); // ngOnInit\n\n    const req = httpMock.expectOne('/inventory/operations/tmt-mappings/compliance');\n    expect(req.request.method).toBe('GET');\n\n    req.flush({\n      data: {\n        total_drugs: 1000,\n        mapped_drugs: 960,\n        compliance_rate: 96.0,\n        status: 'COMPLIANT'\n      }\n    });\n\n    fixture.detectChanges();\n\n    expect(component.complianceStats()?.compliance_rate).toBe(96.0);\n  });\n});\n```\n\n### End-to-End Testing\n\n**Tools:** Playwright\n\n**User Scenarios:**\n\n1. **Pharmacist Maps Drug to TMT**\n   ```typescript\n   test('pharmacist can map drug to TMT concept', async ({ page }) => {\n     await page.goto('/inventory/tmt/compliance');\n\n     // Wait for unmapped drugs table to load\n     await page.waitForSelector('table');\n\n     // Click [Map] button on first drug\n     await page.click('button:has-text(\"Map\")');\n\n     // Mapping dialog should open\n     await expect(page.locator('mat-dialog-container')).toBeVisible();\n\n     // AI suggestions should load\n     await expect(page.locator('.ai-suggestion')).toBeVisible();\n\n     // Click \"Use This Suggestion\" on first suggestion\n     await page.click('.ai-suggestion:first-child button:has-text(\"Use\")');\n\n     // Check verification checkbox\n     await page.check('[formControlName=\"verified\"]');\n\n     // Click Save\n     await page.click('button:has-text(\"Save Mapping\")');\n\n     // Dialog should close\n     await expect(page.locator('mat-dialog-container')).not.toBeVisible();\n\n     // Success snackbar should appear\n     await expect(page.locator('.mat-snack-bar-container')).toContainText('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å mapping ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');\n   });\n   ```\n\n2. **Finance Manager Exports Ministry Report**\n   ```typescript\n   test('finance manager can export ministry report', async ({ page }) => {\n     await page.goto('/inventory/tmt/compliance');\n\n     // Click \"Generate Ministry Report\" button\n     await page.click('button:has-text(\"Generate Ministry Report\")');\n\n     // Export dialog should open\n     await expect(page.locator('mat-dialog-container')).toBeVisible();\n\n     // Select Excel format\n     await page.selectOption('[formControlName=\"format\"]', 'excel');\n\n     // Click \"Export\" button\n     const downloadPromise = page.waitForEvent('download');\n     await page.click('button:has-text(\"Export\")');\n\n     // Wait for download to start\n     const download = await downloadPromise;\n\n     // Verify filename pattern\n     expect(download.suggestedFilename()).toMatch(/DRUGLIST_TMT_\\d{8}_\\d{6}\\.xlsx/);\n\n     // Success snackbar should appear\n     await expect(page.locator('.mat-snack-bar-container')).toContainText('‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô');\n   });\n   ```\n\n3. **Real-time Compliance Update**\n   ```typescript\n   test('compliance rate updates in real-time when new mapping created', async ({ page }) => {\n     await page.goto('/inventory/tmt/compliance');\n\n     // Initial compliance rate\n     const initialRate = await page.locator('[data-testid=\"compliance-rate\"]').textContent();\n\n     // Simulate WebSocket message (via backend action or mock)\n     // In real E2E, another user creates a mapping via API\n\n     // Wait for compliance rate to update\n     await page.waitForFunction((initial) => {\n       const current = document.querySelector('[data-testid=\"compliance-rate\"]')?.textContent;\n       return current !== initial;\n     }, initialRate);\n\n     // Notification snackbar should appear\n     await expect(page.locator('.mat-snack-bar-container')).toContainText('‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÅ‡∏°‡πá‡∏û‡∏¢‡∏≤‡πÉ‡∏´‡∏°‡πà');\n   });\n   ```\n\n## Performance Optimizations\n\n**1. Lazy Loading**\n- TMT feature module loaded only when user navigates to `/inventory/tmt`\n- Reduces initial bundle size by ~150KB\n\n**2. Virtual Scrolling**\n- Use `cdk-virtual-scroll-viewport` for TMT search results (>100 concepts)\n- Render only visible items in viewport\n\n**3. Debounced Search**\n- 300ms debounce on search input to reduce API calls\n- Cancel pending requests on new input\n\n**4. OnPush Change Detection**\n- All components use `ChangeDetectionStrategy.OnPush`\n- Change detection triggered only when signals update\n\n**5. Computed Signals**\n- Derived state (e.g., `isCompliant`) calculated via computed signals\n- Automatic memoization, no manual caching needed\n\n**6. HTTP Caching**\n- Cache TMT concepts in service (1-hour TTL)\n- Invalidate cache on new mapping creation\n\n**7. Bundle Splitting**\n- Separate chunks for Chart.js (only load on dashboard)\n- Tree-shake unused Angular Material components\n\n**8. Image Optimization**\n- Use WebP format for icons/logos\n- Lazy load images below the fold\n\n---\n\n## Accessibility (WCAG 2.1 Level AA)\n\n**1. ARIA Labels**\n- All buttons: `aria-label=\"‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ TMT concepts\"`\n- All form fields: `aria-labelledby=\"field-label-id\"`\n- Live regions for real-time updates: `<div role=\"status\" aria-live=\"polite\">`\n\n**2. Keyboard Navigation**\n- Tab order follows visual flow\n- Escape key closes dialogs\n- Enter key submits forms\n- Arrow keys navigate tables\n\n**3. Color Contrast**\n- Text: ‚â• 4.5:1 contrast ratio\n- Icons: ‚â• 3:1 contrast ratio\n- Confidence badges: Color + text label (not color-only)\n\n**4. Screen Reader Support**\n- Chart data available as table (hidden visually)\n- Loading spinners: `<mat-spinner aria-label=\"‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•\">`\n- Empty states: Descriptive text read by screen readers\n\n**5. Focus Indicators**\n- Visible focus outline on all interactive elements\n- Custom focus styles for AegisX UI components\n\n---\n\nThis design document provides a comprehensive blueprint for implementing the TMT Frontend UI with Angular 18+, following established AegisX platform patterns and ensuring performance, accessibility, and maintainability.\n",
  "fileStats": {
    "size": 59856,
    "lines": 1969,
    "lastModified": "2025-12-14T15:48:58.229Z"
  },
  "comments": []
}