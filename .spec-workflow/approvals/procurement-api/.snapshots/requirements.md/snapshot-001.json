{
  "id": "snapshot_1765717554573_eer1exqsb",
  "approvalId": "approval_1765717554545_bcr9nki31",
  "approvalTitle": "Procurement API - Requirements Document",
  "version": 1,
  "timestamp": "2025-12-14T13:05:54.573Z",
  "trigger": "initial",
  "status": "pending",
  "content": "# Requirements Document - Procurement API\n\n## Introduction\n\nThe **Procurement API** completes the backend implementation of the hospital drug procurement workflow system. While the foundational CRUD operations for 8 procurement modules (Purchase Requests, Purchase Orders, Receipts, Contracts, etc.) are already implemented (~80% complete), this specification focuses on implementing the critical **workflow endpoints** and **business logic** that enable the complete procurement cycle:\n\n**Purchase Request (PR) → Approval → Purchase Order (PO) → Vendor Delivery → Goods Receipt (GR) → Inventory Update → Payment**\n\nThis API provides the backend services for:\n- Multi-stage approval workflows for purchase requests\n- Budget integration (reserve, commit, release)\n- Purchase order lifecycle management\n- Goods receipt verification and posting to inventory\n- Inspector committee management\n- Payment document tracking\n- Contract-based pricing application\n\n**Value to Users:**\n- Pharmacists can submit purchase requests with automatic budget validation\n- Department heads can approve/reject requests with full visibility\n- Procurement officers can manage orders and vendor communications\n- Warehouse staff can record receipts and update inventory seamlessly\n- Finance officers can track payments with complete audit trails\n- Management can monitor spending against budgets in real-time\n\n## Alignment with Product Vision\n\nThis feature supports the **INVS Modern** vision of a comprehensive hospital drug inventory management system by:\n\n1. **Automated Workflow Management**: Eliminates manual paper-based procurement processes, reducing approval time from days to hours\n2. **Budget Control Integration**: Real-time budget checking prevents overspending and ensures fiscal responsibility\n3. **Inventory Accuracy**: Automatic lot tracking and FIFO/FEFO integration ensures accurate stock levels and expiry management\n4. **Audit Trail**: Complete transaction history for regulatory compliance and internal audits\n5. **Cross-System Integration**: Seamless data flow between Budget, Procurement, and Inventory systems\n6. **Ministry Compliance**: Supports DMSIC 2568 reporting requirements for RECEIPT and PURCHASEPLAN exports\n\n**Technical Alignment:**\n- Follows AegisX platform standards (TypeBox schemas, Fastify routes, service layer pattern)\n- Reuses existing 8 CRUD modules as foundation\n- Integrates with Budget Management API for financial controls\n- Integrates with Inventory API for stock updates\n- Uses PostgreSQL functions for complex business logic\n\n## Requirements\n\n### REQ-1: Purchase Request Submission Workflow\n\n**User Story:** As a department staff member, I want to submit purchase requests for approval with automatic budget validation, so that I can get necessary drugs approved efficiently without budget violations.\n\n#### Acceptance Criteria\n\n1. **WHEN** user calls `POST /api/inventory/procurement/purchase-requests/:id/submit` **THEN** system **SHALL** validate that PR status is DRAFT\n2. **WHEN** PR is submitted **THEN** system **SHALL** call Budget API to check availability using `check_budget_availability(fiscal_year, budget_type_id, dept_id, amount, quarter)`\n3. **IF** budget is insufficient **THEN** system **SHALL** return 400 error with shortage details and prevent submission\n4. **WHEN** budget is available **THEN** system **SHALL** call Budget API to reserve budget with 30-day expiration\n5. **WHEN** budget reservation succeeds **THEN** system **SHALL** update PR status to SUBMITTED and record submission timestamp\n6. **WHEN** PR is submitted **THEN** system **SHALL** send notification to department manager for approval\n7. **IF** any step fails **THEN** system **SHALL** rollback all changes and return appropriate error\n\n### REQ-2: Purchase Request Approval/Rejection Workflow\n\n**User Story:** As a department head, I want to approve or reject purchase requests with clear reasoning, so that I can maintain budget control and ensure only necessary purchases proceed.\n\n#### Acceptance Criteria\n\n1. **WHEN** manager calls `POST /api/inventory/procurement/purchase-requests/:id/approve` **THEN** system **SHALL** validate that PR status is SUBMITTED\n2. **WHEN** PR is approved **THEN** system **SHALL** update status to APPROVED, record approver ID and timestamp\n3. **WHEN** PR is approved **THEN** system **SHALL** keep budget reservation active (do not release)\n4. **WHEN** PR is approved **THEN** system **SHALL** send notification to requester with approval confirmation\n5. **WHEN** manager calls `POST /api/inventory/procurement/purchase-requests/:id/reject` **THEN** system **SHALL** validate that PR status is SUBMITTED\n6. **WHEN** PR is rejected **THEN** system **SHALL** update status to REJECTED, record rejector ID, timestamp, and rejection reason\n7. **WHEN** PR is rejected **THEN** system **SHALL** call Budget API to release budget reservation immediately\n8. **WHEN** PR is rejected **THEN** system **SHALL** send notification to requester with rejection reason\n9. **IF** user is not authorized to approve/reject **THEN** system **SHALL** return 403 Forbidden error\n\n### REQ-3: Purchase Order Creation from Approved PR\n\n**User Story:** As a procurement officer, I want to create purchase orders from approved PRs with contract-based pricing, so that I can send orders to vendors quickly and accurately.\n\n#### Acceptance Criteria\n\n1. **WHEN** user calls `POST /api/inventory/procurement/purchase-orders` with pr_id **THEN** system **SHALL** validate that PR status is APPROVED\n2. **IF** PR is not APPROVED **THEN** system **SHALL** return 400 error \"Cannot create PO from non-approved PR\"\n3. **WHEN** creating PO **AND** vendor has active contract **THEN** system **SHALL** apply contract prices from `contract_items` table\n4. **WHEN** creating PO **AND** no contract exists **THEN** system **SHALL** use estimated prices from PR items\n5. **WHEN** PO is created **THEN** system **SHALL** calculate VAT (7%) and grand total automatically\n6. **WHEN** PO is created **THEN** system **SHALL** set initial status to DRAFT\n7. **WHEN** PO is created **THEN** system **SHALL** create PO items linked to PR items via `pr_item_id`\n8. **WHEN** PO is saved **THEN** system **SHALL** return PO details with items, vendor info, and totals\n\n### REQ-4: Purchase Order Approval and Sending Workflow\n\n**User Story:** As a procurement officer, I want to send approved purchase orders to vendors with budget commitment, so that orders are officially recorded and budgets are properly allocated.\n\n#### Acceptance Criteria\n\n1. **WHEN** user calls `POST /api/inventory/procurement/purchase-orders/:id/approve` **THEN** system **SHALL** validate that PO status is PENDING or DRAFT\n2. **WHEN** PO grand_total > 100,000 **THEN** system **SHALL** require approval document in `approval_documents` table\n3. **IF** approval document missing for high-value PO **THEN** system **SHALL** return 400 error \"Approval document required\"\n4. **WHEN** PO is approved **THEN** system **SHALL** update status to APPROVED, record approver and timestamp\n5. **WHEN** user calls `POST /api/inventory/procurement/purchase-orders/:id/send` **THEN** system **SHALL** validate status is APPROVED\n6. **WHEN** PO is sent **THEN** system **SHALL** call Budget API to commit budget (convert reservation to commitment)\n7. **WHEN** budget is committed **THEN** system **SHALL** release budget reservation\n8. **WHEN** PO is sent **THEN** system **SHALL** update linked PR status to CONVERTED\n9. **WHEN** PO is sent **THEN** system **SHALL** update PO status to SENT and record sent timestamp\n10. **IF** budget commit fails **THEN** system **SHALL** rollback PO status and return error\n\n### REQ-5: Purchase Order Cancellation Workflow\n\n**User Story:** As a finance manager, I want to cancel purchase orders when necessary, so that I can handle vendor issues or budget changes while releasing committed funds.\n\n#### Acceptance Criteria\n\n1. **WHEN** user calls `POST /api/inventory/procurement/purchase-orders/:id/cancel` **THEN** system **SHALL** validate that PO status is not COMPLETED or CANCELLED\n2. **WHEN** PO is cancelled **THEN** system **SHALL** update status to CANCELLED and record cancellation timestamp and reason\n3. **WHEN** PO with committed budget is cancelled **THEN** system **SHALL** call Budget API to release budget commitment\n4. **WHEN** PO is cancelled **AND** PR exists **THEN** system **SHALL** update PR status back to APPROVED (allow new PO creation)\n5. **WHEN** PO is cancelled **THEN** system **SHALL** send notification to vendor (if status was SENT)\n6. **IF** PO has associated receipts **THEN** system **SHALL** return 400 error \"Cannot cancel PO with receipts\"\n\n### REQ-6: Goods Receipt Recording\n\n**User Story:** As a warehouse staff member, I want to record goods received from vendors with lot tracking, so that I can verify quantities and qualities before accepting delivery.\n\n#### Acceptance Criteria\n\n1. **WHEN** user calls `POST /api/inventory/procurement/receipts` **THEN** system **SHALL** validate that PO exists and status is SENT or PARTIAL\n2. **WHEN** recording receipt items **THEN** system **SHALL** require lot_number, manufacture_date, and expiry_date for each item\n3. **WHEN** received quantity > ordered quantity **THEN** system **SHALL** return 400 error \"Cannot receive more than ordered\"\n4. **WHEN** expiry_date < 6 months from now **THEN** system **SHALL** return warning but allow acceptance\n5. **WHEN** items have quantity_rejected > 0 **THEN** system **SHALL** require rejection_reason\n6. **WHEN** receipt is created **THEN** system **SHALL** set status to DRAFT\n7. **WHEN** receipt is created **THEN** system **SHALL** calculate total_amount based on accepted quantities\n\n### REQ-7: Receipt Inspector Committee Management\n\n**User Story:** As a warehouse manager, I want to assign inspector committee members to receipts, so that goods are verified by proper authorities as per hospital policy.\n\n#### Acceptance Criteria\n\n1. **WHEN** adding inspectors via `POST /api/inventory/procurement/receipts/:id/inspectors` **THEN** system **SHALL** create records in `receipt_inspectors` table\n2. **WHEN** adding inspectors **THEN** system **SHALL** require minimum 3 inspectors (chairman, member, secretary)\n3. **WHEN** all inspectors sign **THEN** system **SHALL** update receipt inspected_by and inspected_at\n4. **IF** fewer than 3 inspectors **THEN** system **SHALL** prevent receipt posting with error \"Minimum 3 inspectors required\"\n5. **WHEN** inspector signs **THEN** system **SHALL** record user_id, role, and signed timestamp\n\n### REQ-8: Receipt Posting to Inventory\n\n**User Story:** As a warehouse staff member, I want to post verified receipts to inventory, so that stock levels are updated automatically with proper lot tracking.\n\n#### Acceptance Criteria\n\n1. **WHEN** user calls `POST /api/inventory/procurement/receipts/:id/post` **THEN** system **SHALL** validate receipt status is DRAFT or INSPECTING\n2. **WHEN** posting receipt **THEN** system **SHALL** validate minimum 3 inspectors signed\n3. **WHEN** receipt is posted **THEN** system **SHALL** create drug_lots records for each accepted item with lot details\n4. **WHEN** receipt is posted **THEN** system **SHALL** update or create inventory records for each drug/location combination\n5. **WHEN** receipt is posted **THEN** system **SHALL** increment inventory quantity_on_hand by accepted quantity\n6. **WHEN** receipt is posted **THEN** system **SHALL** create inventory_transactions with type='RECEIVE' and reference to receipt\n7. **WHEN** all PO items fully received **THEN** system **SHALL** update PO status to COMPLETED\n8. **WHEN** PO partially received **THEN** system **SHALL** update PO status to PARTIAL\n9. **WHEN** receipt is posted **THEN** system **SHALL** update receipt status to POSTED\n10. **IF** inventory update fails **THEN** system **SHALL** rollback entire transaction including lot creation\n\n### REQ-9: Payment Document Management\n\n**User Story:** As a finance officer, I want to record payment documents with evidence attachments, so that I can track vendor payments and maintain audit trails.\n\n#### Acceptance Criteria\n\n1. **WHEN** user calls `POST /api/inventory/procurement/payments` **THEN** system **SHALL** validate that receipt status is POSTED\n2. **IF** receipt not posted **THEN** system **SHALL** return 400 error \"Cannot pay for unposted receipt\"\n3. **WHEN** creating payment **THEN** system **SHALL** validate payment_amount matches receipt total_amount\n4. **WHEN** payment method is CHEQUE or TRANSFER **THEN** system **SHALL** require reference_number\n5. **WHEN** payment is created **THEN** system **SHALL** allow attachment uploads via `POST /api/inventory/procurement/payments/:id/attachments`\n6. **WHEN** payment is created **THEN** system **SHALL** record paid_by user and paid_at timestamp\n7. **WHEN** payment is completed **THEN** system **SHALL** send notification to accounting department\n\n### REQ-10: Contract-Based Pricing Integration\n\n**User Story:** As a procurement officer, I want the system to automatically apply contract prices when creating POs, so that I can ensure agreed pricing is used and reduce manual errors.\n\n#### Acceptance Criteria\n\n1. **WHEN** creating PO from PR **AND** vendor has active contract **THEN** system **SHALL** query `contracts` table for active contract\n2. **WHEN** active contract found **THEN** system **SHALL** join with `contract_items` to find agreed prices for requested drugs\n3. **WHEN** contract item exists **THEN** system **SHALL** apply contract agreed_unit_price to PO item\n4. **WHEN** contract item not found **THEN** system **SHALL** use PR estimated_unit_price\n5. **WHEN** contract is expired **THEN** system **SHALL** return warning \"Contract expired - using estimated prices\"\n6. **WHEN** using contract prices **THEN** system **SHALL** record contract_id in PO for audit trail\n\n### REQ-11: Budget Integration Service\n\n**User Story:** As a system administrator, I want the procurement API to properly integrate with Budget Management API, so that budget controls are enforced throughout the procurement workflow.\n\n#### Acceptance Criteria\n\n1. **WHEN** PR is submitted **THEN** system **SHALL** call `POST /api/budget/check-availability` with fiscal_year, budget_type, department, amount, quarter\n2. **WHEN** budget available **THEN** system **SHALL** call `POST /api/budget/reserve` with allocation_id, pr_id, amount, quarter, expires_date (30 days)\n3. **WHEN** PO is sent **THEN** system **SHALL** call `POST /api/budget/commit` with allocation_id, po_id, amount, quarter\n4. **WHEN** PO is cancelled **THEN** system **SHALL** call `POST /api/budget/release-commitment` with commitment_id\n5. **WHEN** PR is rejected **THEN** system **SHALL** call `POST /api/budget/release-reservation` with reservation_id\n6. **IF** any budget API call fails **THEN** system **SHALL** return meaningful error to user and prevent workflow progression\n7. **WHEN** budget API unavailable **THEN** system **SHALL** return 503 Service Unavailable with retry guidance\n\n### REQ-12: Multi-Level Approval Workflow\n\n**User Story:** As a hospital administrator, I want purchase requests to go through proper approval levels based on amount thresholds, so that high-value purchases receive appropriate oversight.\n\n#### Acceptance Criteria\n\n1. **WHEN** PR amount < 50,000 **THEN** system **SHALL** require only department head approval (1 level)\n2. **WHEN** PR amount >= 50,000 AND < 200,000 **THEN** system **SHALL** require department head + finance manager approval (2 levels)\n3. **WHEN** PR amount >= 200,000 **THEN** system **SHALL** require department head + finance manager + director approval (3 levels)\n4. **WHEN** first level approves **THEN** system **SHALL** update status to PENDING_LEVEL_2 and notify next approver\n5. **WHEN** all required levels approve **THEN** system **SHALL** update status to APPROVED\n6. **IF** any level rejects **THEN** system **SHALL** update status to REJECTED and release budget immediately\n7. **WHEN** approval level changes **THEN** system **SHALL** record each approver with timestamp in separate approval_history table (to be created)\n\n## Non-Functional Requirements\n\n### Code Architecture and Modularity\n\n- **Single Responsibility Principle**: Each workflow endpoint (submit, approve, send, post) should be a separate controller method with focused business logic\n- **Service Layer Pattern**: Complex business logic must be implemented in service classes, not controllers\n  - `PurchaseRequestWorkflowService` - handles PR submission, approval, rejection\n  - `PurchaseOrderWorkflowService` - handles PO approval, sending, cancellation\n  - `ReceiptWorkflowService` - handles receipt posting, lot creation, inventory updates\n  - `BudgetIntegrationService` - handles all Budget API calls\n  - `ContractPricingService` - handles contract price lookups\n- **Modular Design**: Each service should be isolated and testable independently\n- **Dependency Injection**: Services should be injected via Fastify decorators, not instantiated directly\n- **Clear Interfaces**: Define TypeScript interfaces for all service method signatures\n- **Transaction Management**: All multi-step operations must use Prisma transactions to ensure atomicity\n- **Error Handling**: Use custom error classes (BudgetError, WorkflowError, ValidationError) with proper HTTP status codes\n\n### Performance\n\n- **Response Time**: All workflow endpoints must respond within 3 seconds under normal load\n- **Budget API Calls**: Implement 5-second timeout for Budget API calls with retry logic (3 retries with exponential backoff)\n- **Database Queries**: All queries must use proper indexes (verified with EXPLAIN ANALYZE)\n- **Batch Operations**: Receipt posting with 100+ items must complete within 10 seconds\n- **Concurrent Requests**: System must handle 50 concurrent PR submissions without performance degradation\n- **Query Optimization**: Use Prisma `include` carefully to avoid N+1 queries; prefer `select` for large datasets\n\n### Security\n\n- **Authentication**: All endpoints must require JWT authentication via `fastify.authenticate` hook\n- **Authorization**: Implement role-based permissions:\n  - `procurement:pr:submit` - can submit PRs\n  - `procurement:pr:approve` - can approve PRs\n  - `procurement:po:create` - can create POs\n  - `procurement:po:send` - can send POs\n  - `procurement:receipt:post` - can post receipts\n  - `procurement:payment:create` - can create payments\n- **Input Validation**: All request bodies must be validated using TypeBox schemas before processing\n- **SQL Injection Prevention**: Use Prisma parameterized queries exclusively; never construct raw SQL strings\n- **Budget Validation**: Never trust client-submitted budget availability; always verify via Budget API\n- **Audit Logging**: Log all approval/rejection actions with user_id, timestamp, IP address\n- **Sensitive Data**: Mask payment reference numbers in logs\n\n### Reliability\n\n- **Transaction Atomicity**: All multi-step workflows must complete fully or rollback entirely (no partial states)\n- **Budget Reservation Expiry**: Implement background job to auto-release expired reservations (>30 days)\n- **Error Recovery**: Failed Budget API calls must not leave PR in inconsistent state\n- **Data Integrity**: Enforce foreign key constraints at database level\n- **Idempotency**: POST endpoints should use idempotency keys to prevent duplicate submissions\n- **Retry Logic**: Implement exponential backoff for transient Budget API failures\n- **Health Checks**: Expose `/api/inventory/procurement/health` endpoint checking database and Budget API connectivity\n\n### Usability\n\n- **Error Messages**: Return clear, actionable error messages in Thai and English\n  - Example: `{\"code\": \"INSUFFICIENT_BUDGET\", \"message\": \"งบประมาณไม่เพียงพอ\", \"message_en\": \"Insufficient budget\", \"details\": {\"available\": 10000, \"requested\": 15000, \"shortage\": 5000}}`\n- **Validation Feedback**: Return specific field errors for invalid inputs\n- **Progress Indicators**: Provide status field in responses indicating workflow stage\n- **Timestamp Formatting**: Return all timestamps in ISO 8601 format with timezone\n- **Pagination**: List endpoints must support pagination with default page_size=50, max=500\n- **Filtering**: Support filtering by status, date_range, department_id, fiscal_year\n- **Sorting**: Support sorting by request_date, total_amount, status\n- **Response Consistency**: All endpoints must follow AegisX standard response format:\n  ```typescript\n  {\n    success: boolean,\n    data: T | T[],\n    message?: string,\n    pagination?: { page, pageSize, total, totalPages }\n  }\n  ```\n\n### Testability\n\n- **Unit Tests**: Each service method must have unit tests with mocked dependencies (target: 80% coverage)\n- **Integration Tests**: Each workflow endpoint must have integration tests hitting real database (test DB)\n- **Budget API Mocking**: Provide mock Budget API responses for testing without external dependency\n- **Test Data Factories**: Use factory pattern for creating test PRs, POs, Receipts\n- **Transaction Rollback**: Tests must rollback transactions to keep test DB clean\n- **Test Isolation**: Each test must be independent and not rely on other test execution order\n\n### Scalability\n\n- **Connection Pooling**: Configure Prisma connection pool (min: 5, max: 20 connections)\n- **Caching**: Cache contract prices in Redis with 1-hour TTL\n- **Background Jobs**: Heavy operations (receipt posting with 500+ items) should queue for background processing\n- **Database Indexing**: Create indexes on frequently queried fields:\n  - `purchase_requests(status, department_id, fiscal_year)`\n  - `purchase_orders(status, po_date)`\n  - `receipts(status, receipt_date)`\n  - `contract_items(contract_id, generic_id)`\n- **Rate Limiting**: Implement per-user rate limits (100 requests/minute for workflow endpoints)\n\n### Maintainability\n\n- **Code Documentation**: All service methods must have JSDoc comments explaining parameters, returns, and side effects\n- **Type Safety**: Use TypeScript strict mode; no `any` types allowed\n- **Schema Validation**: Maintain TypeBox schemas alongside route definitions\n- **Error Codes**: Document all error codes in `docs/api/error-codes.md`\n- **Changelog**: Maintain CHANGELOG.md for all workflow endpoint changes\n- **Versioning**: Use API versioning if breaking changes needed (prefer backward compatible changes)\n- **Logging**: Use structured logging with context (user_id, pr_id, correlation_id)\n  ```typescript\n  logger.info({ userId, prId, action: 'submit_pr', amount: 15000 }, 'PR submitted for approval')\n  ```\n",
  "fileStats": {
    "size": 22648,
    "lines": 324,
    "lastModified": "2025-12-14T13:05:43.361Z"
  },
  "comments": []
}