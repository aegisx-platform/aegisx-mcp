{
  "id": "snapshot_1765698783831_v42r7o1p5",
  "approvalId": "approval_1765698759794_h0dxwuqis",
  "approvalTitle": "Design: System Init Core Discovery",
  "version": 2,
  "timestamp": "2025-12-14T07:53:03.831Z",
  "trigger": "approved",
  "status": "pending",
  "content": "# Design Document: System Init Core Discovery\n\n## Overview\n\nปรับปรุง `ImportDiscoveryService` ให้สามารถ scan หา import services จากหลาย directories โดยเพิ่ม `apps/api/src/core` เป็น scan path เพิ่มเติมจาก `apps/api/src/modules` ที่มีอยู่เดิม\n\n**การเปลี่ยนแปลงนี้:**\n- เป็น minimal change (~10 lines)\n- ไม่กระทบ existing functionality\n- ไม่เปลี่ยน public API\n\n## Code Reuse Analysis\n\n### Existing Components to Leverage\n\n- **ImportDiscoveryService**: ใช้ `scanDirectory()` method ที่มีอยู่แล้ว - ไม่ต้องแก้ไข\n- **DepartmentsImportService**: มี implementation พร้อมใช้งานอยู่แล้วใน `apps/api/src/core/departments/`\n- **@ImportService decorator**: ใช้งานได้ทันที - ไม่ต้องแก้ไข\n\n### Integration Points\n\n- **File System Scanning**: ใช้ existing `scanDirectory()` recursive method\n- **Import Registry**: ใช้ existing registration flow ผ่าน decorator\n- **Database Persistence**: ใช้ existing `persistRegistry()` method\n\n## Architecture\n\nการเปลี่ยนแปลงอยู่ใน method เดียว: `scanForImportServices()`\n\n```mermaid\ngraph TD\n    A[discoverServices] --> B[scanForImportServices]\n    B --> C{For each basePath}\n    C --> D[modules directory]\n    C --> E[core directory]\n    D --> F[scanDirectory recursive]\n    E --> F\n    F --> G[Filter *-import.service.ts]\n    G --> H[dynamicImportServices]\n    H --> I[buildRegistry]\n```\n\n### Current Implementation (Before)\n\n```typescript\nprivate scanForImportServices(): string[] {\n  const files: string[] = [];\n  const basePath = path.join(process.cwd(), 'apps/api/src/modules');\n  // Single path only\n  this.scanDirectory(basePath, files);\n  // ...\n}\n```\n\n### New Implementation (After)\n\n```typescript\nprivate scanForImportServices(): string[] {\n  const files: string[] = [];\n  const basePaths = [\n    path.join(process.cwd(), 'apps/api/src/modules'),\n    path.join(process.cwd(), 'apps/api/src/core'),\n  ];\n\n  for (const basePath of basePaths) {\n    if (fs.existsSync(basePath)) {\n      this.scanDirectory(basePath, files);\n    }\n  }\n  // ... rest unchanged\n}\n```\n\n## Components and Interfaces\n\n### ImportDiscoveryService (Modified)\n\n- **Purpose:** Auto-discover import services from filesystem\n- **Change:** `scanForImportServices()` method to support multiple base paths\n- **Dependencies:** fs, path (existing)\n- **Reuses:** Existing `scanDirectory()` method unchanged\n\n### DepartmentsImportService (No Change)\n\n- **Purpose:** Handle bulk import of departments\n- **Location:** `apps/api/src/core/departments/departments-import.service.ts`\n- **Status:** Already implements all required interfaces\n- **Metadata:** domain=\"core\", priority=1, supportsRollback=true\n\n## Data Models\n\nไม่มีการเปลี่ยนแปลง data models - ใช้ existing types ทั้งหมด:\n\n- `ImportServiceMetadata` - unchanged\n- `RegisteredImportService` - unchanged\n- `IImportService` - unchanged\n\n## Error Handling\n\n### Error Scenarios\n\n1. **Core directory doesn't exist**\n   - **Handling:** `fs.existsSync()` check ก่อน scan\n   - **User Impact:** ไม่มี - system ทำงานต่อได้ปกติ\n\n2. **Permission denied on directory**\n   - **Handling:** Existing try-catch ใน `scanDirectory()`\n   - **User Impact:** Warning log แต่ไม่ fail\n\n3. **No import services in core**\n   - **Handling:** Empty array merged กับ modules results\n   - **User Impact:** ไม่มี - system ทำงานปกติ\n\n## Testing Strategy\n\n### Manual Verification\n\n1. Start API server\n2. Check logs for `[ImportDiscovery] Registered: departments`\n3. Call `GET /api/system-init/modules` - verify departments appears\n4. Download template: `GET /api/system-init/templates/departments`\n5. Test import with sample CSV\n\n### Expected Results\n\n```json\n{\n  \"modules\": [\n    {\n      \"module\": \"departments\",\n      \"domain\": \"core\",\n      \"displayName\": \"Departments (แผนก)\",\n      \"priority\": 1\n    }\n    // ... other modules\n  ]\n}\n```\n\n## File Changes Summary\n\n| File | Lines Changed | Type |\n|------|---------------|------|\n| `apps/api/src/core/import/discovery/import-discovery.service.ts` | ~10 | Modify |\n\n## Risk Assessment\n\n- **Risk Level:** Low\n- **Backward Compatibility:** 100% - modules directory scanned first\n- **Breaking Changes:** None\n- **Rollback:** Simple revert of ~10 lines\n",
  "fileStats": {
    "size": 4711,
    "lines": 152,
    "lastModified": "2025-12-14T07:51:55.149Z"
  },
  "comments": []
}
