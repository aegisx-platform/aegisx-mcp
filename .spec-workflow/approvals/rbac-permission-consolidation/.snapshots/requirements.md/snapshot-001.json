{
  "id": "snapshot_1765959134580_8o5z6keyk",
  "approvalId": "approval_1765959134541_8088kpvpu",
  "approvalTitle": "Requirements: RBAC Permission Consolidation",
  "version": 1,
  "timestamp": "2025-12-17T08:12:14.580Z",
  "trigger": "initial",
  "status": "pending",
  "content": "# Requirements Document - RBAC Permission Consolidation\n\n## Introduction\n\nThis specification addresses the architectural redundancy in the permission system where permissions are managed in two separate locations: the RBAC (Role-Based Access Control) system and department-level permission flags. Currently, the system has:\n\n1. **RBAC System**: Centralized permission management through `roles` → `role_permissions` → `permissions`\n2. **Department Permission Flags**: Direct permission flags in `user_departments` table (`can_create_requests`, `can_edit_requests`, etc.)\n\nThis duplication creates maintenance overhead, potential inconsistencies, and architectural confusion. The purpose of this refactoring is to **consolidate all permission logic into the RBAC system** and simplify the `user_departments` table to serve purely as an organizational structure (department membership) without permission management.\n\n**Value to Users:**\n- Consistent permission behavior across the entire application\n- Simplified permission management through a single system\n- Reduced risk of permission conflicts or inconsistencies\n- Easier permission auditing and compliance reporting\n\n## Alignment with Product Vision\n\nThis refactoring aligns with the enterprise-grade system architecture goals by:\n- Establishing RBAC as the single source of truth for all permissions\n- Simplifying the data model to reduce complexity\n- Improving maintainability and scalability of the permission system\n- Following industry best practices for permission management in enterprise applications\n\n## Requirements\n\n### Requirement 1: Remove Department-Level Permission Flags\n\n**User Story:** As a system architect, I want to remove all permission flags from the `user_departments` table, so that permissions are managed solely through RBAC and the data model is simplified.\n\n#### Acceptance Criteria\n\n1. WHEN reviewing the `user_departments` table schema THEN the system SHALL NOT contain any of the following columns:\n   - `can_create_requests`\n   - `can_edit_requests`\n   - `can_submit_requests`\n   - `can_approve_requests`\n   - `can_view_reports`\n\n2. WHEN a migration is created to remove these columns THEN the system SHALL:\n   - Create a reversible migration (with up and down methods)\n   - Include a data preservation strategy if needed\n   - Document the changes in migration comments\n\n3. WHEN the migration is applied THEN the system SHALL:\n   - Successfully remove all permission flag columns\n   - Preserve all other user-department relationship data\n   - Maintain data integrity for existing relationships\n\n### Requirement 2: Preserve Department Organizational Structure\n\n**User Story:** As a system administrator, I want departments to continue representing organizational structure and membership, so that users can still be assigned to departments without mixing permission logic.\n\n#### Acceptance Criteria\n\n1. WHEN the refactoring is complete THEN the `user_departments` table SHALL contain only:\n   - `id` (UUID) - Primary key\n   - `user_id` (UUID) - Foreign key to users\n   - `department_id` (INTEGER) - Foreign key to departments\n   - `hospital_id` (UUID) - Hospital context\n   - `is_primary` (BOOLEAN) - Primary department flag\n   - `assigned_role` (VARCHAR) - Optional role within department (e.g., \"Head\", \"Deputy\")\n   - `valid_from` (TIMESTAMP) - Assignment start date\n   - `valid_until` (TIMESTAMP) - Assignment end date (nullable)\n   - `assigned_by` (UUID) - Who made the assignment\n   - `assigned_at` (TIMESTAMP) - When assignment was made\n   - `notes` (TEXT) - Optional assignment notes\n   - Standard audit fields (created_at, updated_at, created_by, updated_by)\n\n2. WHEN querying user departments THEN the system SHALL return organizational membership without permission data\n\n3. WHEN displaying user department information THEN the system SHALL show:\n   - Department name and code\n   - Assignment dates (valid_from, valid_until)\n   - Primary department indicator\n   - Assigned role (if any)\n\n### Requirement 3: Update Backend Services to Use RBAC\n\n**User Story:** As a backend developer, I want all services to check permissions through RBAC decorators and middleware, so that permission logic is centralized and consistent.\n\n#### Acceptance Criteria\n\n1. WHEN implementing permission checks THEN the system SHALL use RBAC decorators:\n   - `@RequirePermissions(['resource:action'])`\n   - `@RequireRole(['role-name'])`\n\n2. WHEN a service needs to verify permissions THEN the system SHALL:\n   - Call RBAC permission checker methods\n   - NOT read permission flags from user_departments\n   - Use the existing permission cache for performance\n\n3. IF code exists that checks department permission flags THEN the system SHALL:\n   - Identify all such code locations through grep/search\n   - Replace with RBAC permission checks\n   - Document the mapping of old flags to RBAC permissions\n\n### Requirement 4: Map Department Permission Flags to RBAC Permissions\n\n**User Story:** As a system designer, I want a clear mapping from old department flags to RBAC permissions, so that existing functionality is preserved after refactoring.\n\n#### Acceptance Criteria\n\n1. WHEN defining the permission mapping THEN the system SHALL document:\n   ```\n   Department Flag          → RBAC Permission\n   can_create_requests     → budget-requests:create\n   can_edit_requests       → budget-requests:update\n   can_submit_requests     → budget-requests:submit\n   can_approve_requests    → budget-requests:approve\n   can_view_reports        → reports:read\n   ```\n\n2. WHEN users had department flags enabled THEN the system SHALL ensure:\n   - Equivalent RBAC permissions are assigned to appropriate roles\n   - No loss of access for existing users\n   - Clear audit trail of permission changes\n\n3. IF a department flag had no direct RBAC equivalent THEN the system SHALL:\n   - Create the appropriate RBAC permission\n   - Assign it to relevant roles\n   - Document the new permission in the permissions table\n\n### Requirement 5: Update UserDepartmentsService\n\n**User Story:** As a backend developer, I want the UserDepartmentsService to focus only on department membership management, so that it follows the single responsibility principle.\n\n#### Acceptance Criteria\n\n1. WHEN the UserDepartmentsService is refactored THEN it SHALL:\n   - Remove all methods that assign or check permission flags\n   - Keep methods for department assignment/removal\n   - Keep methods for querying user's departments\n   - NOT perform any permission validation\n\n2. WHEN assigning a user to a department THEN the service SHALL:\n   - Validate user and department exist\n   - Create the user_departments record with organizational data only\n   - NOT set any permission flags (removed)\n\n3. WHEN removing a user from a department THEN the service SHALL:\n   - Update the valid_until date or delete the record\n   - NOT affect user's RBAC permissions\n\n### Requirement 6: Update TypeBox Schemas\n\n**User Story:** As a frontend developer, I want TypeBox schemas to reflect the new structure, so that API contracts are accurate and type-safe.\n\n#### Acceptance Criteria\n\n1. WHEN updating schemas THEN the system SHALL remove:\n   - Permission flag fields from request/response schemas\n   - Validation rules for permission flags\n\n2. WHEN defining user-department schemas THEN they SHALL include only:\n   - Organizational relationship fields\n   - Assignment metadata (dates, assigned_by, notes)\n   - NOT include any permission fields\n\n3. WHEN API responses return department data THEN they SHALL:\n   - Exclude all permission flags\n   - Include only organizational information\n\n### Requirement 7: Update Frontend Components\n\n**User Story:** As a frontend developer, I want to remove all code that reads or displays department permission flags, so that the UI reflects the new RBAC-only architecture.\n\n#### Acceptance Criteria\n\n1. WHEN reviewing frontend code THEN the system SHALL identify:\n   - All components that display department permission flags\n   - All forms that edit department permission flags\n   - All services that send permission flag data\n\n2. WHEN updating frontend components THEN the system SHALL:\n   - Remove UI elements for department permission flags\n   - Use RBAC permission checks instead (via auth service)\n   - Update component logic to work without flag data\n\n3. IF a component needs to check permissions THEN it SHALL:\n   - Use the existing RBAC permission guard/directive\n   - NOT check department-related permission properties\n\n### Requirement 8: Database Migration Strategy\n\n**User Story:** As a database administrator, I want a safe migration strategy, so that the database changes can be applied without data loss or downtime.\n\n#### Acceptance Criteria\n\n1. WHEN creating the migration THEN the system SHALL:\n   - Generate a timestamped migration file\n   - Include both up (drop columns) and down (restore columns) methods\n   - Add safety checks to prevent data loss\n\n2. WHEN the migration runs in production THEN the system SHALL:\n   - Log all actions clearly\n   - Complete within acceptable timeframe (<5 seconds for typical data volumes)\n   - Support rollback if issues occur\n\n3. IF users currently have department permission flags set THEN the migration SHALL:\n   - Optionally export existing flag data to a backup table\n   - Provide a script to verify RBAC permissions are correctly assigned\n   - Document how to restore permissions if needed\n\n### Requirement 9: Update API Documentation\n\n**User Story:** As an API consumer, I want updated API documentation, so that I understand the new department and permission endpoints.\n\n#### Acceptance Criteria\n\n1. WHEN generating Swagger/OpenAPI docs THEN the system SHALL:\n   - Show updated schemas without permission flags\n   - Mark old permission-related endpoints as deprecated (if any exist)\n   - Document the proper way to check permissions (via RBAC)\n\n2. WHEN documenting department endpoints THEN the system SHALL explain:\n   - Departments are organizational units only\n   - Permissions are managed through RBAC\n   - How to assign roles to users for permission management\n\n### Requirement 10: Backward Compatibility and Migration Path\n\n**User Story:** As a system administrator, I want a clear migration path for existing deployments, so that the system can be upgraded without disruption.\n\n#### Acceptance Criteria\n\n1. WHEN planning the migration THEN the system SHALL provide:\n   - Step-by-step upgrade instructions\n   - Script to verify current permission assignments\n   - Script to assign equivalent RBAC permissions based on old flags\n\n2. WHEN upgrading a production system THEN the administrator SHALL be able to:\n   - Run a pre-migration check to identify affected users\n   - Apply the migration with confidence\n   - Verify that all users retain their access levels\n\n3. IF issues are discovered after migration THEN the system SHALL:\n   - Support rollback to previous state\n   - Provide detailed logs for troubleshooting\n   - Document how to manually fix permission assignments\n\n## Non-Functional Requirements\n\n### Code Architecture and Modularity\n\n- **Single Responsibility Principle**: UserDepartmentsService handles only department membership; RBAC services handle only permissions\n- **Separation of Concerns**: Department structure is completely independent from permission logic\n- **Clear Interfaces**: Department APIs return organizational data; permission checks use RBAC APIs\n- **Dependency Management**: Department code does not depend on permission flag logic\n\n### Performance\n\n- **Permission Checks**: Must use existing RBAC permission cache (no performance regression)\n- **Database Queries**: Removing unused columns may slightly improve query performance\n- **Migration Execution**: Must complete in under 5 seconds for databases with up to 100,000 user-department records\n\n### Security\n\n- **No Permission Bypass**: Ensure no code paths check removed permission flags (would fail open)\n- **Audit Trail**: Maintain audit logs of all permission changes during migration\n- **Access Control**: Verify that all existing access controls continue to work after refactoring\n\n### Reliability\n\n- **Zero Downtime**: Migration should support online execution if possible\n- **Rollback Support**: All changes must be reversible\n- **Data Integrity**: Foreign key constraints and relationships must remain intact\n\n### Maintainability\n\n- **Code Clarity**: Remove all references to department permission flags\n- **Documentation**: Update all relevant documentation to reflect RBAC-only approach\n- **Testing**: Update all tests to use RBAC permission checks instead of flag checks\n\n### Testability\n\n- **Unit Tests**: Update service tests to remove permission flag scenarios\n- **Integration Tests**: Verify department operations work without permission data\n- **E2E Tests**: Ensure UI flows work with RBAC-based permissions only\n",
  "fileStats": {
    "size": 12843,
    "lines": 281,
    "lastModified": "2025-12-17T08:12:06.524Z"
  },
  "comments": []
}
