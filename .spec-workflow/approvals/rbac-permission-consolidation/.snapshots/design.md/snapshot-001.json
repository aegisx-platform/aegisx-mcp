{
  "id": "snapshot_1765959383517_7hhlcc5ur",
  "approvalId": "approval_1765959383470_369bfiec1",
  "approvalTitle": "Design: RBAC Permission Consolidation",
  "version": 1,
  "timestamp": "2025-12-17T08:16:23.517Z",
  "trigger": "initial",
  "status": "pending",
  "content": "# Design Document - RBAC Permission Consolidation\n\n## Overview\n\nThis design consolidates all permission management into the existing RBAC (Role-Based Access Control) system by removing redundant permission flags from the `user_departments` table. The refactoring establishes RBAC as the single source of truth for permissions while preserving departments as organizational units for membership and structure.\n\n**Key Changes:**\n- Remove 5 permission boolean columns from `user_departments` table\n- Update `UserDepartmentsService` to focus solely on organizational membership\n- Map existing department permission flags to equivalent RBAC permissions\n- Update all code that checks department flags to use RBAC instead\n- Provide safe migration path with rollback capability\n\n## Steering Document Alignment\n\n### Technical Standards (tech.md)\n\nNot applicable - no steering documents currently exist. This design follows existing project patterns:\n- Uses Knex.js migrations for database changes (reversible up/down)\n- Follows TypeBox schema patterns for API contracts\n- Leverages existing RBAC infrastructure (RbacService, PermissionCacheInvalidationService)\n- Maintains separation of concerns (services, repositories, controllers)\n\n### Project Structure (structure.md)\n\nNot applicable - no steering documents. Design follows existing structure:\n- Backend: `apps/api/src/database/migrations/` for schema changes\n- Services: `apps/api/src/layers/platform/users/` for UserDepartmentsService updates\n- Schemas: TypeBox definitions in `*.schemas.ts` files\n- Frontend: Components in `apps/web/src/app/` hierarchy\n\n## Code Reuse Analysis\n\n### Existing Components to Leverage\n\n- **RbacService** (`apps/api/src/layers/platform/rbac/rbac.service.ts`): Use for permission checking logic\n- **PermissionCacheInvalidationService** (`apps/api/src/layers/core/auth/services/permission-cache-invalidation.service.ts`): Use for cache management during migration\n- **UserDepartmentsRepository** (`apps/api/src/layers/platform/users/user-departments.repository.ts`): Update to remove permission-related queries\n- **Knex Migration Pattern**: Follow existing migration structure from `20251213074350_create_user_departments.ts`\n\n### Integration Points\n\n- **RBAC System**: All permission checks will route through existing RBAC infrastructure\n- **Permission Cache**: Leverage existing Redis-based permission cache (no changes needed)\n- **Auth Middleware**: Existing JWT authentication continues to work (no changes)\n- **Database**: Migration will modify `user_departments` table structure\n\n## Architecture\n\nThis refactoring implements a **separation of concerns** architectural pattern:\n\n**Before (Redundant):**\n```\nuser_departments table\n├── Organizational data (user_id, department_id, is_primary)\n├── Permission flags (can_create_requests, can_edit_requests, ...)  ← REMOVE\n└── Assignment metadata (valid_from, valid_until, assigned_by)\n\nRBAC System (parallel)\n└── roles → role_permissions → permissions\n```\n\n**After (Consolidated):**\n```\nuser_departments table\n├── Organizational data (user_id, department_id, is_primary)\n└── Assignment metadata (valid_from, valid_until, assigned_by)\n\nRBAC System (single source of truth)\n└── roles → role_permissions → permissions\n    └── All permission logic flows through here\n```\n\n### Modular Design Principles\n\n- **Single Responsibility**: UserDepartmentsService manages only organizational membership\n- **Separation of Concerns**: Permissions handled by RBAC, departments handled by UserDepartmentsService\n- **Existing Infrastructure**: Reuse RbacService for all permission operations\n- **Cache Strategy**: Leverage existing PermissionCacheInvalidationService\n\n```mermaid\ngraph TD\n    A[User Request] --> B{Needs Permission Check?}\n    B -->|Yes| C[RBAC Middleware]\n    B -->|No| D[Controller]\n    C --> E[RbacService.checkPermission]\n    E --> F[Permission Cache]\n    F -->|Cache Hit| G[Allow/Deny]\n    F -->|Cache Miss| H[Database Query]\n    H --> I[roles → role_permissions → permissions]\n    I --> G\n    G --> D\n    D --> J[UserDepartmentsService]\n    J --> K[Query user_departments]\n    K --> L[Return Organizational Data Only]\n\n    style C fill:#e3f2fd\n    style E fill:#e3f2fd\n    style J fill:#f3e5f5\n    style K fill:#f3e5f5\n```\n\n## Components and Interfaces\n\n### Component 1: Database Migration\n\n**File**: `apps/api/src/database/migrations/[timestamp]_remove_user_departments_permissions.ts`\n\n**Purpose**: Remove permission flag columns from `user_departments` table\n\n**Interface**:\n```typescript\nexport async function up(knex: Knex): Promise<void> {\n  // Drop permission columns\n  await knex.schema.alterTable('user_departments', (table) => {\n    table.dropColumn('can_create_requests');\n    table.dropColumn('can_edit_requests');\n    table.dropColumn('can_submit_requests');\n    table.dropColumn('can_approve_requests');\n    table.dropColumn('can_view_reports');\n  });\n}\n\nexport async function down(knex: Knex): Promise<void> {\n  // Restore columns for rollback\n  await knex.schema.alterTable('user_departments', (table) => {\n    table.boolean('can_create_requests').notNullable().defaultTo(true);\n    table.boolean('can_edit_requests').notNullable().defaultTo(true);\n    table.boolean('can_submit_requests').notNullable().defaultTo(true);\n    table.boolean('can_approve_requests').notNullable().defaultTo(false);\n    table.boolean('can_view_reports').notNullable().defaultTo(true);\n  });\n}\n```\n\n**Dependencies**: Knex.js migration runner\n\n**Reuses**: Existing migration infrastructure\n\n---\n\n### Component 2: UserDepartmentsRepository\n\n**File**: `apps/api/src/layers/platform/users/user-departments.repository.ts`\n\n**Purpose**: Remove permission-related queries and return only organizational data\n\n**Changes**:\n```typescript\n// REMOVE these methods:\n- setDepartmentPermissions()\n- getDepartmentPermissions()\n- hasPermissionInDepartment()\n\n// UPDATE these methods to remove permission fields:\n- getActiveDepartments() → Remove permission fields from SELECT\n- getUserDepartments() → Remove permission fields from SELECT\n- assignUserToDepartment() → Remove permission parameters\n```\n\n**Example Updated Method**:\n```typescript\nasync getActiveDepartments(userId: string): Promise<UserDepartment[]> {\n  return this.db('user_departments as ud')\n    .select(\n      'ud.id',\n      'ud.user_id',\n      'ud.department_id',\n      'ud.is_primary',\n      'ud.assigned_role',\n      'ud.valid_from',\n      'ud.valid_until',\n      'ud.assigned_at',\n      'd.dept_code',\n      'd.dept_name'\n      // ❌ REMOVED: permission flag fields\n    )\n    .join('inventory.departments as d', 'ud.department_id', 'd.id')\n    .where('ud.user_id', userId)\n    .where(function() {\n      this.whereNull('ud.valid_until')\n        .orWhere('ud.valid_until', '>', this.db.fn.now());\n    });\n}\n```\n\n**Dependencies**: Knex.js\n\n**Reuses**: Existing repository pattern\n\n---\n\n### Component 3: UserDepartmentsService\n\n**File**: `apps/api/src/layers/platform/users/user-departments.service.ts`\n\n**Purpose**: Simplify to handle only organizational membership (no permission logic)\n\n**Changes**:\n```typescript\n// REMOVE these methods:\n- updateDepartmentPermissions()\n- checkDepartmentPermission()\n- getAllPermissionsForDepartment()\n\n// UPDATE these methods:\n- assignUserToDepartment() → Remove permission parameters\n- getUserDepartments() → Return data without permissions\n- getUserPrimaryDepartment() → Return data without permissions\n\n// SIMPLIFY validation:\n- Remove findById() calls that fetch roles (causing current error)\n- Use simple existence checks instead\n```\n\n**Example Updated Method**:\n```typescript\nasync assignUserToDepartment(\n  userId: string,\n  departmentId: number,\n  options: {\n    isPrimary?: boolean;\n    assignedRole?: string;\n    validFrom?: Date;\n    validUntil?: Date;\n    // ❌ REMOVED: permission flags\n  }\n): Promise<UserDepartment> {\n  // Simple validation without role fetching\n  const userExists = await this.db('users')\n    .where('id', userId)\n    .whereNull('deleted_at')\n    .first();\n\n  if (!userExists) {\n    throw new AppError('User not found', 404);\n  }\n\n  return this.userDepartmentsRepository.assignUserToDepartment(\n    userId,\n    departmentId,\n    options\n  );\n}\n```\n\n**Dependencies**: UserDepartmentsRepository, Knex\n\n**Reuses**: Existing service pattern, simplified validation\n\n---\n\n### Component 4: TypeBox Schemas\n\n**File**: `apps/api/src/layers/platform/users/user-departments.schemas.ts`\n\n**Purpose**: Update API contracts to remove permission fields\n\n**Changes**:\n```typescript\n// DepartmentDetailSchema - REMOVE permission fields:\nexport const DepartmentDetailSchema = Type.Object({\n  id: Type.String({ format: 'uuid' }),\n  userId: Type.String({ format: 'uuid' }),\n  departmentId: Type.Number(),\n  departmentCode: Type.String(),\n  departmentName: Type.String(),\n  isPrimary: Type.Boolean(),\n  assignedRole: Type.Union([Type.String(), Type.Null()]),\n  // ❌ REMOVED: can_create_requests\n  // ❌ REMOVED: can_edit_requests\n  // ❌ REMOVED: can_submit_requests\n  // ❌ REMOVED: can_approve_requests\n  // ❌ REMOVED: can_view_reports\n  validFrom: Type.Union([Type.String({ format: 'date-time' }), Type.Null()]),\n  validUntil: Type.Union([Type.String({ format: 'date-time' }), Type.Null()]),\n  assignedAt: Type.String({ format: 'date-time' }),\n});\n\n// AssignDepartmentRequest - REMOVE permission parameters:\nexport const AssignDepartmentRequestSchema = Type.Object({\n  departmentId: Type.Number(),\n  isPrimary: Type.Optional(Type.Boolean()),\n  assignedRole: Type.Optional(Type.String()),\n  validFrom: Type.Optional(Type.String({ format: 'date-time' })),\n  validUntil: Type.Optional(Type.String({ format: 'date-time' })),\n  // ❌ REMOVED: permission fields\n});\n```\n\n**Dependencies**: @sinclair/typebox\n\n**Reuses**: Existing schema patterns\n\n---\n\n### Component 5: Permission Mapping Script\n\n**File**: `apps/api/src/database/scripts/map-department-permissions-to-rbac.ts`\n\n**Purpose**: One-time script to assign RBAC permissions based on old department flags\n\n**Interface**:\n```typescript\n/**\n * Maps old department permission flags to RBAC permissions\n * Run BEFORE applying the migration\n */\nexport async function mapDepartmentPermissionsToRBAC(knex: Knex): Promise<void> {\n  const permissionMap = {\n    can_create_requests: 'budget-requests:create',\n    can_edit_requests: 'budget-requests:update',\n    can_submit_requests: 'budget-requests:submit',\n    can_approve_requests: 'budget-requests:approve',\n    can_view_reports: 'reports:read',\n  };\n\n  // 1. Get all users with department assignments\n  const userDepartments = await knex('user_departments')\n    .select('user_id', ...Object.keys(permissionMap));\n\n  // 2. For each user, determine which permissions they need\n  for (const record of userDepartments) {\n    const permissionsNeeded = [];\n\n    for (const [flagName, permission] of Object.entries(permissionMap)) {\n      if (record[flagName]) {\n        permissionsNeeded.push(permission);\n      }\n    }\n\n    // 3. Assign appropriate role(s) or permissions to user\n    // Logic: If user has all permissions → assign \"admin\" role\n    //        If user has approval permission → assign \"supervisor\" role\n    //        Otherwise → assign \"staff\" role\n  }\n\n  console.log(`Mapped permissions for ${userDepartments.length} user-department records`);\n}\n```\n\n**Usage**: Run before migration: `npx knex seed:run --specific=map-department-permissions-to-rbac.ts`\n\n**Dependencies**: Knex, RbacService\n\n**Reuses**: Existing RBAC infrastructure\n\n---\n\n### Component 6: Frontend Updates\n\n**Files**:\n- `apps/web/src/app/core/users/services/user-departments.service.ts`\n- Any components that display/edit department permissions\n\n**Purpose**: Remove UI elements and code that read/write permission flags\n\n**Changes**:\n```typescript\n// UserDepartmentsService - UPDATE interface:\ninterface DepartmentDetail {\n  id: string;\n  userId: string;\n  departmentId: number;\n  departmentCode: string;\n  departmentName: string;\n  isPrimary: boolean;\n  assignedRole: string | null;\n  // ❌ REMOVED: permission fields\n  validFrom: string | null;\n  validUntil: string | null;\n  assignedAt: string;\n}\n\n// Components - REPLACE permission checks:\n// Old code:\nif (department.can_approve_requests) {\n  // Show approve button\n}\n\n// New code:\nif (this.authService.hasPermission('budget-requests:approve')) {\n  // Show approve button\n}\n```\n\n**Dependencies**: Angular HttpClient, AuthService (for RBAC checks)\n\n**Reuses**: Existing RBAC permission guards/directives\n\n## Data Models\n\n### Updated user_departments Table Schema\n\n```sql\nCREATE TABLE user_departments (\n  -- Primary Key\n  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),\n\n  -- Foreign Keys\n  user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,\n  department_id INTEGER NOT NULL REFERENCES inventory.departments(id) ON DELETE CASCADE,\n  hospital_id INTEGER NULL REFERENCES inventory.hospitals(id) ON DELETE CASCADE,\n\n  -- Assignment Metadata\n  is_primary BOOLEAN NOT NULL DEFAULT false,\n  assigned_role VARCHAR(50) NULL,\n\n  -- ❌ REMOVED: Permission flags\n  -- can_create_requests BOOLEAN\n  -- can_edit_requests BOOLEAN\n  -- can_submit_requests BOOLEAN\n  -- can_approve_requests BOOLEAN\n  -- can_view_reports BOOLEAN\n\n  -- Temporal Validity\n  valid_from DATE NULL,\n  valid_until DATE NULL,\n\n  -- Audit Trail\n  assigned_by UUID NULL REFERENCES users(id) ON DELETE SET NULL,\n  assigned_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT NOW(),\n  notes TEXT NULL,\n\n  -- Standard Audit\n  created_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT NOW(),\n  updated_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT NOW(),\n  created_by UUID NULL REFERENCES users(id) ON DELETE SET NULL,\n  updated_by UUID NULL REFERENCES users(id) ON DELETE SET NULL,\n\n  -- Constraints\n  CONSTRAINT unique_user_department_hospital UNIQUE (user_id, department_id, hospital_id)\n);\n```\n\n### Permission Mapping Table\n\nThis is a **reference mapping** (not a database table), documenting how old flags map to RBAC permissions:\n\n| Old Department Flag      | RBAC Permission Resource:Action | Default Role Assignment |\n|--------------------------|----------------------------------|-------------------------|\n| can_create_requests      | budget-requests:create           | staff, supervisor, admin |\n| can_edit_requests        | budget-requests:update           | staff, supervisor, admin |\n| can_submit_requests      | budget-requests:submit           | staff, supervisor, admin |\n| can_approve_requests     | budget-requests:approve          | supervisor, admin        |\n| can_view_reports         | reports:read                     | staff, supervisor, admin |\n\n**Role Assignment Strategy**:\n- **admin role**: All permissions\n- **supervisor role**: All permissions including approve\n- **staff role**: Create, edit, submit, view (no approve)\n\n## Error Handling\n\n### Error Scenario 1: Migration Fails Midway\n\n**Description**: Database migration encounters an error while dropping columns\n\n**Handling**:\n```typescript\nexport async function up(knex: Knex): Promise<void> {\n  // Wrap in transaction for atomicity\n  await knex.transaction(async (trx) => {\n    await trx.schema.alterTable('user_departments', (table) => {\n      table.dropColumn('can_create_requests');\n      table.dropColumn('can_edit_requests');\n      table.dropColumn('can_submit_requests');\n      table.dropColumn('can_approve_requests');\n      table.dropColumn('can_view_reports');\n    });\n  });\n  // If error occurs, entire transaction rolls back automatically\n}\n```\n\n**User Impact**:\n- Migration fails cleanly with error message\n- Database remains in original state (no partial changes)\n- Admin can investigate and retry\n\n### Error Scenario 2: Code Still Checks Removed Permission Flags\n\n**Description**: Some code path still tries to access `department.can_create_requests` after migration\n\n**Handling**:\n- **Prevention**: Comprehensive grep search before deployment:\n  ```bash\n  grep -r \"can_create_requests\\|can_edit_requests\\|can_submit_requests\\|can_approve_requests\\|can_view_reports\" apps/\n  ```\n- **Detection**: TypeScript compiler will catch undefined properties in typed code\n- **Runtime**: If untyped code accesses removed field, it returns `undefined` (fails safe)\n\n**User Impact**:\n- Permission checks fail (deny access) rather than fail open\n- User sees \"Access Denied\" message\n- Admin can identify and fix the code path\n\n### Error Scenario 3: User Loses Access After Migration\n\n**Description**: User had department permission flag but doesn't have equivalent RBAC permission\n\n**Handling**:\n```typescript\n// Pre-migration check script\nasync function verifyPermissionMapping(knex: Knex): Promise<void> {\n  const issues = [];\n\n  // Find users with department permissions but no matching RBAC permissions\n  const query = `\n    SELECT DISTINCT ud.user_id, u.email\n    FROM user_departments ud\n    JOIN users u ON ud.user_id = u.id\n    WHERE (\n      ud.can_create_requests = true OR\n      ud.can_edit_requests = true OR\n      ud.can_submit_requests = true OR\n      ud.can_approve_requests = true OR\n      ud.can_view_reports = true\n    )\n    AND NOT EXISTS (\n      SELECT 1 FROM user_roles ur\n      JOIN roles r ON ur.role_id = r.id\n      WHERE ur.user_id = ud.user_id\n    )\n  `;\n\n  const usersAtRisk = await knex.raw(query);\n\n  if (usersAtRisk.rows.length > 0) {\n    console.error(`⚠️  ${usersAtRisk.rows.length} users will lose access!`);\n    console.error('Assign roles before migration:', usersAtRisk.rows);\n    process.exit(1);\n  }\n}\n```\n\n**User Impact**:\n- Pre-migration check prevents this scenario\n- If it occurs anyway, user gets \"Access Denied\"\n- Admin uses audit logs to identify and fix (assign correct role)\n\n### Error Scenario 4: Rollback Required\n\n**Description**: Need to restore permission flags after migration\n\n**Handling**:\n```bash\n# Run down migration\nnpx knex migrate:down\n\n# Restore data from backup table (if created)\nnpx knex seed:run --specific=restore-department-permissions-backup.ts\n```\n\n**User Impact**:\n- System briefly unavailable during rollback (< 1 minute)\n- All permissions restored to pre-migration state\n- Users can continue working normally\n\n## Testing Strategy\n\n### Unit Testing\n\n**Test Files to Update**:\n- `user-departments.repository.spec.ts`: Remove permission-related tests\n- `user-departments.service.spec.ts`: Remove permission logic tests\n- Add tests for simplified validation\n\n**Key Tests**:\n```typescript\ndescribe('UserDepartmentsService', () => {\n  describe('assignUserToDepartment', () => {\n    it('should assign user without permission parameters', async () => {\n      const result = await service.assignUserToDepartment(userId, deptId, {\n        isPrimary: true,\n        assignedRole: 'staff',\n      });\n\n      expect(result).toBeDefined();\n      expect(result.isPrimary).toBe(true);\n      // ❌ No longer testing permission fields\n    });\n\n    it('should not call findById with role joins', async () => {\n      const spy = jest.spyOn(usersRepository, 'findById');\n\n      await service.assignUserToDepartment(userId, deptId, {});\n\n      expect(spy).not.toHaveBeenCalled(); // Uses simpler validation\n    });\n  });\n\n  describe('getUserDepartments', () => {\n    it('should return departments without permission fields', async () => {\n      const result = await service.getUserDepartments(userId);\n\n      expect(result[0]).not.toHaveProperty('can_create_requests');\n      expect(result[0]).toHaveProperty('departmentCode');\n      expect(result[0]).toHaveProperty('isPrimary');\n    });\n  });\n});\n```\n\n### Integration Testing\n\n**Test Scenarios**:\n1. **Migration Test**: Apply up/down migrations in test database\n2. **API Contract Test**: Verify department endpoints return correct schema\n3. **RBAC Integration**: Verify permission checks use RBAC not department flags\n\n**Example Test**:\n```typescript\ndescribe('Department API Integration', () => {\n  beforeAll(async () => {\n    // Apply migration\n    await runMigrations();\n  });\n\n  it('GET /users/me/departments should not include permission flags', async () => {\n    const response = await request(app)\n      .get('/api/v1/platform/users/me/departments')\n      .set('Authorization', `Bearer ${token}`);\n\n    expect(response.status).toBe(200);\n    expect(response.body.data.departments[0]).not.toHaveProperty('can_create_requests');\n  });\n\n  it('POST /departments/:id/users should work without permission parameters', async () => {\n    const response = await request(app)\n      .post('/api/v1/platform/departments/123/users')\n      .set('Authorization', `Bearer ${token}`)\n      .send({\n        userId: 'user-uuid',\n        isPrimary: true,\n        // ❌ No permission fields\n      });\n\n    expect(response.status).toBe(201);\n  });\n});\n```\n\n### End-to-End Testing\n\n**User Scenarios**:\n\n**Scenario 1: Admin Assigns User to Department**\n1. Admin logs in\n2. Navigates to user management\n3. Assigns user to department (without setting permission flags)\n4. User receives department assignment\n5. User's permissions come from their RBAC role, not department\n\n**Scenario 2: User Attempts to Approve Budget Request**\n1. User logs in (has \"supervisor\" role via RBAC)\n2. Navigates to budget requests\n3. Sees \"Approve\" button (RBAC check: `hasPermission('budget-requests:approve')`)\n4. Clicks approve\n5. Backend verifies permission via RBAC middleware\n6. Request approved successfully\n\n**Scenario 3: Migration and Rollback**\n1. Admin runs pre-migration check script (verifies all users have roles)\n2. Admin applies migration (permission columns dropped)\n3. Admin tests system (all permissions work via RBAC)\n4. Issue discovered → Admin rolls back migration\n5. Permission flags restored from down migration\n6. System returns to previous state\n\n## Migration Execution Plan\n\n### Phase 1: Pre-Migration (Week 1)\n\n1. **Audit Current State**:\n   ```bash\n   # Count users with department permissions\n   SELECT COUNT(DISTINCT user_id) FROM user_departments\n   WHERE can_create_requests = true\n      OR can_edit_requests = true\n      OR can_submit_requests = true\n      OR can_approve_requests = true\n      OR can_view_reports = true;\n   ```\n\n2. **Run Permission Mapping Script**:\n   ```bash\n   npx ts-node apps/api/src/database/scripts/map-department-permissions-to-rbac.ts\n   ```\n\n3. **Verify RBAC Assignments**:\n   ```bash\n   # Check all users have appropriate roles\n   SELECT u.id, u.email, COALESCE(COUNT(ur.role_id), 0) as role_count\n   FROM users u\n   LEFT JOIN user_roles ur ON u.id = ur.user_id\n   GROUP BY u.id, u.email\n   HAVING COUNT(ur.role_id) = 0;\n   ```\n\n### Phase 2: Code Updates (Week 1-2)\n\n1. Update UserDepartmentsRepository (remove permission queries)\n2. Update UserDepartmentsService (remove permission logic)\n3. Update TypeBox schemas (remove permission fields)\n4. Update frontend components (remove permission UI elements)\n5. Replace all permission checks with RBAC calls\n6. Update tests\n\n### Phase 3: Migration Execution (Week 2)\n\n1. **Staging Environment**:\n   ```bash\n   # Apply migration in staging\n   npx knex migrate:up\n\n   # Test thoroughly\n   npm run test:e2e\n\n   # Monitor for errors\n   ```\n\n2. **Production Deployment**:\n   ```bash\n   # Backup database\n   pg_dump aegisx_db > backup_before_migration.sql\n\n   # Apply migration\n   npx knex migrate:up\n\n   # Monitor logs\n   tail -f logs/api.log\n   ```\n\n3. **Post-Migration Verification**:\n   ```bash\n   # Verify columns dropped\n   psql -d aegisx_db -c \"\\d user_departments\"\n\n   # Verify no errors in logs\n   grep -i \"can_create_requests\\|can_edit_requests\" logs/api.log\n   ```\n\n### Phase 4: Monitoring (Week 2-3)\n\n1. Monitor error logs for undefined property access\n2. Track permission denied errors (should not increase)\n3. Verify no performance regression (cache working)\n4. Collect user feedback\n\n### Rollback Plan\n\nIf issues arise:\n```bash\n# Step 1: Roll back migration\nnpx knex migrate:down\n\n# Step 2: Restore data (if backup table was created)\npsql -d aegisx_db < backup_before_migration.sql\n\n# Step 3: Revert code changes\ngit revert <commit-hash>\n\n# Step 4: Redeploy previous version\nnpm run deploy:rollback\n```\n\n## Performance Considerations\n\n**No Performance Impact Expected**:\n- Removing unused columns may slightly improve query performance\n- RBAC permission cache already exists (no new cache needed)\n- Permission checks use existing cached queries\n- Database indexes on `user_departments` unchanged (except removed permission column indexes)\n\n**Potential Improvement**:\n- Smaller `user_departments` table = faster scans\n- Fewer columns = less network overhead\n- Simpler queries = easier for PostgreSQL query planner to optimize\n",
  "fileStats": {
    "size": 24592,
    "lines": 780,
    "lastModified": "2025-12-17T08:16:11.204Z"
  },
  "comments": []
}
