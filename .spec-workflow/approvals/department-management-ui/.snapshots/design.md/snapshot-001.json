{
  "id": "snapshot_1765826142921_vdfi83h50",
  "approvalId": "approval_1765826142882_psvsgzkoo",
  "approvalTitle": "Design: Department Management UI",
  "version": 1,
  "timestamp": "2025-12-15T19:15:42.921Z",
  "trigger": "initial",
  "status": "pending",
  "content": "# Design Document: Department Management UI\n\n## Overview\n\nThis design implements a comprehensive department management interface for the AegisX admin panel, integrating with the existing `/v1/platform/departments` API. The solution follows established Angular + Material UI patterns found in the codebase (particularly the user-management component) while leveraging AegisX UI components where appropriate.\n\n**Key Design Goals:**\n- Reuse existing service layer (`DepartmentService`) - no duplicate HTTP calls\n- Follow admin panel conventions (pages structure, Material UI components)\n- Support hierarchical department organization with visual tree representation\n- Seamless integration with user management for department assignment\n- Profile page enhancement to display department affiliations\n\n## Steering Document Alignment\n\n### Technical Standards (tech.md)\n\n**Frontend Stack:**\n- **Angular 17+** with standalone components\n- **Angular Material UI** for data tables, dialogs, forms\n- **AegisX UI** for custom components (badges, cards when appropriate)\n- **TailwindCSS** for layout utilities\n- **Signals** for reactive state management\n- **TypeScript strict mode** for type safety\n\n**Backend Integration:**\n- **Existing API**: `/v1/platform/departments` (fully implemented)\n- **Permission-based access**: RBAC with `departments:*` permissions\n- **Service layer pattern**: Reuse `DepartmentService`\n\n### Project Structure (structure.md)\n\n```\napps/admin/src/app/\n├── pages/\n│   ├── platform/                    # NEW: Platform management pages\n│   │   └── departments/             # NEW: Department management feature\n│   │       ├── departments.component.ts\n│   │       ├── departments.component.html\n│   │       ├── departments.component.scss\n│   │       ├── components/\n│   │       │   ├── department-form-dialog/      # Create/Edit dialog\n│   │       │   ├── department-hierarchy-view/   # Tree view component\n│   │       │   └── department-selector/         # Reusable dropdown selector\n│   │       ├── services/\n│   │       │   └── departments-ui.service.ts    # UI state management\n│   │       └── types/\n│   │           └── departments-ui.types.ts\n│   └── playground/\n│       └── pages/\n│           └── user-management/\n│               └── user-management.component.ts  # MODIFY: Add department field\n└── shared/\n    └── components/\n        └── profile-card/             # MODIFY: Add department display\n            └── profile-card.component.ts\n```\n\n**Service Reuse:**\n- Existing: `apps/web/src/app/features/inventory/modules/departments/services/departments.service.ts`\n- Will be imported and reused (no duplication)\n\n## Code Reuse Analysis\n\n### Existing Components to Leverage\n\n**1. DepartmentService (Existing)**\n- **Location**: `apps/web/src/app/features/inventory/modules/departments/services/departments.service.ts`\n- **Usage**: Import and inject directly - handles all API calls\n- **Methods Available**:\n  - `loadDepartmentList(params)` - GET /v1/platform/departments\n  - `getDepartmentById(id)` - GET /v1/platform/departments/:id\n  - `createDepartment(data)` - POST /v1/platform/departments\n  - `updateDepartment(id, data)` - PUT /v1/platform/departments/:id\n  - `deleteDepartment(id)` - DELETE /v1/platform/departments/:id\n\n**2. User Management Component Pattern (Existing)**\n- **Location**: `apps/admin/src/app/pages/playground/pages/user-management/user-management.component.ts`\n- **Patterns to Reuse**:\n  - MatTableDataSource with pagination\n  - MatDialog for create/edit forms\n  - SelectionModel for bulk actions\n  - Signal-based state management\n  - Search/filter implementation\n\n**3. Material UI Components (Existing)**\n- **MatTable** with sorting and pagination\n- **MatDialog** for modals\n- **MatFormField + MatInput** for forms\n- **MatSelect** for dropdowns (hierarchical department selector)\n- **MatTree** for hierarchy view (NEW usage in this feature)\n\n### Integration Points\n\n**1. Backend API (Ready)**\n- `/v1/platform/departments/*` - All CRUD endpoints exist\n- Permission system: `departments:read`, `departments:create`, `departments:update`, `departments:delete`\n\n**2. Database Schema (Existing)**\n- Table: `public.departments` (NOT inventory.departments)\n- Fields: `id`, `dept_code`, `dept_name`, `parent_id`, `is_active`, `hospital_id`, `created_at`, `updated_at`\n- Hierarchical: `parent_id` references `id` (self-referencing FK)\n\n**3. User Management Integration**\n- Add `department_id` field to user forms (nullable)\n- Display department name in user list table\n- Filter users by department\n\n**4. Profile Integration**\n- Add department display section to profile card\n- Show hierarchy breadcrumb (e.g., \"Engineering > Backend Team\")\n\n## Architecture\n\n### Modular Design Principles\n\n**Single File Responsibility:**\n- `departments.component.ts` - Main page orchestration and layout\n- `department-form-dialog.component.ts` - Create/edit form logic\n- `department-hierarchy-view.component.ts` - Tree view rendering\n- `department-selector.component.ts` - Reusable dropdown (used in user forms)\n- `departments-ui.service.ts` - UI state, filters, pagination state\n\n**Component Isolation:**\n- Form dialog is standalone - can be used anywhere\n- Selector component is reusable across user management and other features\n- Hierarchy view is independent - can be embedded in dashboards\n\n**Service Layer Separation:**\n- **Data Access**: `DepartmentService` (existing) - HTTP calls\n- **Business Logic**: `DepartmentService` - data transformation\n- **UI State**: `DepartmentsUIService` (new) - filters, pagination, selection state\n- **Presentation**: Components - rendering and user interaction\n\n```mermaid\ngraph TD\n    subgraph \"Admin App - Platform Pages\"\n        DeptPage[DepartmentsComponent<br/>Main Page]\n        DeptForm[DepartmentFormDialog<br/>Create/Edit]\n        DeptTree[DepartmentHierarchyView<br/>Tree Display]\n        DeptSelect[DepartmentSelector<br/>Dropdown]\n    end\n\n    subgraph \"Admin App - User Management\"\n        UserMgmt[UserManagementComponent]\n        UserForm[User Form with<br/>Department Field]\n    end\n\n    subgraph \"Admin App - Profile\"\n        Profile[ProfileCard<br/>with Department Info]\n    end\n\n    subgraph \"Services\"\n        DeptService[DepartmentService<br/>EXISTING]\n        UIService[DepartmentsUIService<br/>NEW - UI State]\n    end\n\n    subgraph \"Backend API\"\n        API[\"/v1/platform/departments/*\"<br/>READY]\n    end\n\n    DeptPage --> DeptForm\n    DeptPage --> DeptTree\n    DeptPage --> UIService\n    DeptForm --> DeptService\n    DeptTree --> DeptService\n    DeptSelect --> DeptService\n    UserForm --> DeptSelect\n    UserMgmt --> UserForm\n    Profile --> DeptService\n    DeptService --> API\n    UIService --> DeptService\n```\n\n## Components and Interfaces\n\n### Component 1: DepartmentsComponent (Main Page)\n\n**Purpose:** Main department management page with list, search, filter, and actions\n\n**File:** `apps/admin/src/app/pages/platform/departments/departments.component.ts`\n\n**Interfaces:**\n```typescript\nexport class DepartmentsComponent implements OnInit, AfterViewInit {\n  // Signals for reactive state\n  departments = signal<Department[]>([]);\n  isLoading = signal<boolean>(false);\n  totalCount = signal<number>(0);\n\n  // Material Table\n  displayedColumns = ['dept_code', 'dept_name', 'parent', 'is_active', 'actions'];\n  dataSource: MatTableDataSource<Department>;\n  @ViewChild(MatPaginator) paginator!: MatPaginator;\n  @ViewChild(MatSort) sort!: MatSort;\n\n  // Methods\n  ngOnInit(): void;\n  loadDepartments(): Promise<void>;\n  openCreateDialog(): void;\n  openEditDialog(department: Department): void;\n  deleteDepartment(id: number): void;\n  toggleActive(department: Department): void;\n  applyFilter(filterValue: string): void;\n}\n```\n\n**Dependencies:**\n- `DepartmentService` (existing)\n- `DepartmentsUIService` (new)\n- `MatDialog`\n\n**Reuses:**\n- User management component table pattern\n- Material UI data table components\n- Signal-based state management pattern\n\n**Template Features:**\n- Search bar (debounced)\n- Filter by active status\n- Filter by parent department\n- \"Add Department\" button (opens dialog)\n- Table with actions (edit, delete, toggle active)\n- Pagination (10/25/50/100 per page)\n- \"View Hierarchy\" button (shows tree view)\n\n### Component 2: DepartmentFormDialogComponent\n\n**Purpose:** Modal dialog for creating and editing departments\n\n**File:** `apps/admin/src/app/pages/platform/departments/components/department-form-dialog/department-form-dialog.component.ts`\n\n**Interfaces:**\n```typescript\nexport interface DepartmentFormData {\n  dept_code: string;\n  dept_name: string;\n  parent_id: number | null;\n  is_active: boolean;\n}\n\nexport interface DepartmentFormDialogData {\n  mode: 'create' | 'edit';\n  department?: Department;\n}\n\nexport class DepartmentFormDialogComponent implements OnInit {\n  form: FormGroup;\n  mode: 'create' | 'edit';\n  parentDepartments = signal<Department[]>([]);\n\n  constructor(\n    @Inject(MAT_DIALOG_DATA) public data: DepartmentFormDialogData,\n    private dialogRef: MatDialogRef<DepartmentFormDialogComponent>,\n    private fb: FormBuilder,\n    private departmentService: DepartmentService\n  ) {}\n\n  ngOnInit(): void;\n  loadParentDepartments(): void;\n  save(): void;\n  cancel(): void;\n  validateCircularReference(): ValidatorFn;\n}\n```\n\n**Dependencies:**\n- `DepartmentService`\n- `MatDialogRef`, `MAT_DIALOG_DATA`\n- `FormBuilder`, `Validators`\n\n**Reuses:**\n- Material dialog pattern from existing components\n- Reactive forms validation pattern\n- Hierarchical parent selector pattern\n\n**Form Fields:**\n- dept_code (required, unique)\n- dept_name (required)\n- parent_id (optional, mat-select with hierarchy)\n- is_active (boolean, mat-slide-toggle)\n\n**Validation:**\n- dept_code: required, minLength(2), maxLength(20), pattern(/^[A-Z0-9_-]+$/)\n- dept_name: required, minLength(2), maxLength(200)\n- parent_id: validateCircularReference (prevent dept being its own parent/ancestor)\n\n### Component 3: DepartmentHierarchyViewComponent\n\n**Purpose:** Display department hierarchy as expandable tree\n\n**File:** `apps/admin/src/app/pages/platform/departments/components/department-hierarchy-view/department-hierarchy-view.component.ts`\n\n**Interfaces:**\n```typescript\nexport interface DepartmentTreeNode {\n  id: number;\n  dept_code: string;\n  dept_name: string;\n  parent_id: number | null;\n  is_active: boolean;\n  children: DepartmentTreeNode[];\n  level: number;\n}\n\nexport class DepartmentHierarchyViewComponent implements OnInit {\n  treeControl: FlatTreeControl<DepartmentTreeNode>;\n  dataSource: MatTreeFlatDataSource<DepartmentTreeNode, DepartmentTreeNode>;\n  hierarchyData = signal<DepartmentTreeNode[]>([]);\n\n  ngOnInit(): void;\n  loadHierarchy(): void;\n  hasChild(node: DepartmentTreeNode): boolean;\n  getLevel(node: DepartmentTreeNode): number;\n}\n```\n\n**Dependencies:**\n- `DepartmentService`\n- `MatTree`, `FlatTreeControl`\n\n**Reuses:**\n- Material tree component (NEW usage - not used elsewhere yet)\n\n**Features:**\n- Expand/collapse tree nodes\n- Show department count per branch\n- Highlight inactive departments (grayed out)\n- Click to select/edit department\n- Drag-and-drop to move (optional - Phase 2)\n\n### Component 4: DepartmentSelectorComponent (Reusable)\n\n**Purpose:** Standalone dropdown selector for department selection (used in user forms, filters, etc.)\n\n**File:** `apps/admin/src/app/pages/platform/departments/components/department-selector/department-selector.component.ts`\n\n**Interfaces:**\n```typescript\n@Component({\n  selector: 'app-department-selector',\n  standalone: true,\n  ...\n})\nexport class DepartmentSelectorComponent implements OnInit, ControlValueAccessor {\n  @Input() label = 'Department';\n  @Input() placeholder = 'Select department';\n  @Input() required = false;\n  @Input() showInactive = false;\n  @Output() departmentSelected = new EventEmitter<Department | null>();\n\n  departments = signal<Department[]>([]);\n\n  // ControlValueAccessor implementation\n  writeValue(value: number | null): void;\n  registerOnChange(fn: any): void;\n  registerOnTouched(fn: any): void;\n  setDisabledState(isDisabled: boolean): void;\n\n  ngOnInit(): void;\n  loadDepartments(): void;\n  onDepartmentChange(departmentId: number | null): void;\n}\n```\n\n**Dependencies:**\n- `DepartmentService`\n- `ControlValueAccessor` (for reactive forms integration)\n\n**Reuses:**\n- FormControl integration pattern\n- Material select component\n\n**Features:**\n- Works with reactive forms (ControlValueAccessor)\n- Hierarchical display (indented child departments)\n- Filter active/inactive\n- Search within dropdown\n\n**Usage Example:**\n```html\n<!-- In User Management Form -->\n<app-department-selector\n  formControlName=\"department_id\"\n  label=\"Department\"\n  [required]=\"false\"\n/>\n```\n\n### Component 5: User Management Integration\n\n**File (MODIFY):** `apps/admin/src/app/pages/playground/pages/user-management/user-management.component.ts`\n\n**Changes:**\n- Add `department_id` field to User interface\n- Add `DepartmentSelectorComponent` to user create/edit forms\n- Add \"Department\" column to user list table\n- Add department filter to search controls\n- Load department name on user list (join data or fetch separately)\n\n**Modified User Interface:**\n```typescript\nexport interface User {\n  id: number;\n  name: string;\n  email: string;\n  role: 'admin' | 'user' | 'manager';\n  status: 'active' | 'inactive';\n  department_id?: number;        // NEW\n  department?: DepartmentSummary; // NEW - for display\n  createdAt: Date;\n  lastLogin?: Date;\n}\n\nexport interface DepartmentSummary {\n  id: number;\n  dept_code: string;\n  dept_name: string;\n}\n```\n\n### Component 6: Profile Card Integration\n\n**File (MODIFY):** `apps/admin/src/app/shared/components/profile-card/profile-card.component.ts` (or equivalent)\n\n**Changes:**\n- Add department display section\n- Fetch department details if user has department_id\n- Display hierarchy breadcrumb\n- Show warning if department is inactive\n\n**New Section in Profile:**\n```html\n<mat-card class=\"department-info\">\n  <mat-card-header>\n    <mat-card-title>Department Affiliation</mat-card-title>\n  </mat-card-header>\n  <mat-card-content>\n    @if (userDepartment()) {\n      <div class=\"department-details\">\n        <div class=\"hierarchy-path\">\n          <!-- e.g., Engineering > Backend Team -->\n          {{ departmentPath() }}\n        </div>\n        <div class=\"department-meta\">\n          <span class=\"dept-code\">{{ userDepartment()?.dept_code }}</span>\n          @if (!userDepartment()?.is_active) {\n            <mat-chip class=\"inactive-warning\">Inactive</mat-chip>\n          }\n        </div>\n      </div>\n    } @else {\n      <p class=\"no-department\">No department assigned</p>\n    }\n  </mat-card-content>\n</mat-card>\n```\n\n## Data Models\n\n### Department (Existing from API)\n```typescript\nexport interface Department {\n  id: number;\n  dept_code: string;\n  dept_name: string;\n  parent_id: number | null;\n  hospital_id: number | null;\n  is_active: boolean;\n  created_at: string;\n  updated_at: string;\n  deleted_at?: string | null;\n\n  // Computed/joined fields\n  parent_dept_name?: string;  // For display in table\n  children?: Department[];    // For hierarchy view\n}\n```\n\n### DepartmentFormData (New)\n```typescript\nexport interface DepartmentFormData {\n  dept_code: string;\n  dept_name: string;\n  parent_id: number | null;\n  is_active: boolean;\n}\n```\n\n### DepartmentHierarchyNode (New)\n```typescript\nexport interface DepartmentHierarchyNode {\n  id: number;\n  dept_code: string;\n  dept_name: string;\n  parent_id: number | null;\n  is_active: boolean;\n  children: DepartmentHierarchyNode[];\n  level: number;\n  expandable: boolean;\n}\n```\n\n### DepartmentFilterState (UI Service)\n```typescript\nexport interface DepartmentFilterState {\n  searchTerm: string;\n  isActive: boolean | null;  // null = all, true = active only, false = inactive only\n  parentId: number | null;   // Filter by parent department\n  page: number;\n  pageSize: number;\n  sortBy: string;\n  sortOrder: 'asc' | 'desc';\n}\n```\n\n## Error Handling\n\n### Error Scenarios\n\n**1. Department Not Found (404)**\n- **Scenario:** User tries to edit/delete department that no longer exists\n- **Handling:**\n  - Catch 404 error from API\n  - Show MatSnackBar: \"Department not found. It may have been deleted.\"\n  - Refresh department list\n- **User Impact:** Toast notification, list refreshes\n\n**2. Duplicate Department Code (409 Conflict)**\n- **Scenario:** Admin creates department with existing dept_code\n- **Handling:**\n  - Catch 409 error\n  - Display inline error on dept_code form field: \"Department code already exists\"\n  - Keep dialog open for correction\n- **User Impact:** Form validation error, user can fix without losing data\n\n**3. Circular Reference (422 Unprocessable Entity)**\n- **Scenario:** Admin tries to set department as its own parent or ancestor\n- **Handling:**\n  - Frontend validation: check before submission\n  - If backend returns 422, show error: \"Cannot create circular reference in hierarchy\"\n- **User Impact:** Form validation error\n\n**4. Department Has Users (422 on Delete)**\n- **Scenario:** Admin tries to delete department that has users assigned\n- **Handling:**\n  - Show confirmation dialog: \"This department has X users assigned. Please reassign users before deleting.\"\n  - Prevent deletion\n  - Suggest reassigning users first\n- **User Impact:** Informative error, clear next steps\n\n**5. Permission Denied (403)**\n- **Scenario:** User without `departments:delete` permission tries to delete\n- **Handling:**\n  - Hide delete button if permission not granted (frontend)\n  - If 403 occurs: \"You don't have permission to delete departments\"\n- **User Impact:** Button not visible, or clear error message\n\n**6. Network/Server Error (500)**\n- **Scenario:** API server error or network failure\n- **Handling:**\n  - Show MatSnackBar: \"Unable to load departments. Please try again.\"\n  - Retry button\n  - Fallback: show cached data if available\n- **User Impact:** Error toast with retry option\n\n**7. Invalid Parent Department (404 on Parent ID)**\n- **Scenario:** Parent department was deleted while user was editing\n- **Handling:**\n  - Refresh parent department list\n  - Clear invalid parent_id selection\n  - Show warning: \"Selected parent department no longer exists\"\n- **User Impact:** Form field cleared, list refreshed\n\n## Testing Strategy\n\n### Unit Testing\n\n**Components to Test:**\n1. **DepartmentsComponent**\n   - Load departments on init\n   - Filter application (search term)\n   - Pagination changes\n   - Open create/edit dialogs\n   - Delete confirmation\n\n2. **DepartmentFormDialogComponent**\n   - Form validation (required fields, patterns)\n   - Circular reference validation\n   - Save creates/updates correctly\n   - Cancel closes dialog without saving\n\n3. **DepartmentHierarchyViewComponent**\n   - Load hierarchy data\n   - Tree expand/collapse\n   - Display correct levels\n\n4. **DepartmentSelectorComponent**\n   - Load department options\n   - ControlValueAccessor implementation\n   - Filter active/inactive\n   - Emit selection event\n\n**Services to Test:**\n1. **DepartmentsUIService**\n   - Filter state management\n   - Pagination state\n   - Selection tracking\n\n### Integration Testing\n\n**Key Flows:**\n1. **Create Department Flow**\n   - Click \"Add Department\" → Dialog opens\n   - Fill form → Submit → API call → Success toast → List refresh\n   - Verify new department appears in list\n\n2. **Edit Department Flow**\n   - Click edit → Dialog opens with pre-filled data\n   - Modify fields → Submit → API call → Success toast → List refresh\n   - Verify changes reflected in list\n\n3. **Delete Department Flow**\n   - Click delete → Confirmation dialog\n   - Confirm → API call → Success toast → List refresh\n   - Verify department removed from list\n\n4. **Hierarchy View Flow**\n   - Click \"View Hierarchy\" → Load tree\n   - Expand nodes → Children loaded\n   - Verify nested structure\n\n5. **User Department Assignment Flow**\n   - Open user form → Department selector appears\n   - Select department → Save user\n   - Verify user list shows department name\n\n6. **Profile Department Display**\n   - User with department → Profile shows dept info\n   - User without department → \"No department assigned\"\n\n### End-to-End Testing\n\n**User Scenarios:**\n1. **Admin manages organizational structure**\n   - Create root department (Engineering)\n   - Create child department (Backend Team)\n   - Create nested child (Backend - API Team)\n   - View hierarchy tree\n   - Verify 3-level structure\n\n2. **Admin assigns user to department**\n   - Create new user\n   - Select \"Backend Team\" department\n   - Save user\n   - View user list → Department column shows \"Backend Team\"\n   - View user profile → Department section shows \"Engineering > Backend Team\"\n\n3. **Admin handles errors**\n   - Try to create department with duplicate code → See error\n   - Fix code → Save successfully\n   - Try to delete department with users → Prevented\n   - Try to set circular reference → Validation error\n\n4. **User views their department**\n   - Login as regular user\n   - Navigate to profile\n   - See department affiliation\n   - Department shows full path\n\n**Accessibility Testing:**\n- Keyboard navigation (Tab through all controls)\n- Screen reader support (ARIA labels)\n- Focus indicators\n- Error announcements\n\n**Performance Testing:**\n- Load 100 departments → Render in <200ms\n- Filter departments → Update in <100ms\n- Hierarchy tree with 50 nodes → Expand in <300ms\n\n## Implementation Notes\n\n### Phase 1: Core Department Management\n- Create `platform/departments` page structure\n- Implement main list view with table\n- Create form dialog (create/edit)\n- Implement CRUD operations\n- Add search and filter\n\n### Phase 2: Hierarchy Support\n- Implement hierarchy tree view component\n- Add parent department selector to form\n- Circular reference validation\n- Drag-and-drop (optional)\n\n### Phase 3: User Management Integration\n- Add department field to user forms\n- Create reusable department selector component\n- Add department column to user list\n- Add department filter\n\n### Phase 4: Profile Integration\n- Add department section to profile card\n- Display hierarchy breadcrumb\n- Handle inactive departments\n\n### Deployment Considerations\n- Feature flag: Enable department management for admins only initially\n- Migration: No database changes needed (departments table exists)\n- Permissions: Ensure RBAC permissions exist for `departments:*`\n- Documentation: Update admin user guide\n",
  "fileStats": {
    "size": 22565,
    "lines": 713,
    "lastModified": "2025-12-15T19:15:28.445Z"
  },
  "comments": []
}
