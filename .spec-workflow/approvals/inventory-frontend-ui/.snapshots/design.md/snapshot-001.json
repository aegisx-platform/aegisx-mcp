{
  "id": "snapshot_1765719951566_0w7hj08w2",
  "approvalId": "approval_1765719951555_s13ekzqts",
  "approvalTitle": "Design Document - Inventory Frontend UI (Angular 17+ with Signals architecture)",
  "version": 1,
  "timestamp": "2025-12-14T13:45:51.566Z",
  "trigger": "initial",
  "status": "pending",
  "content": "# Design Document - Inventory Frontend UI\n\n## Architecture Overview\n\nThe Inventory Frontend UI follows Angular 17+ standalone component architecture with Signals-based reactive state management. The design implements a feature module with lazy loading, smart/dumb component pattern, and comprehensive error handling.\n\n### High-Level Architecture\n\n```mermaid\ngraph TB\n    subgraph \"Inventory Feature Module\"\n        Router[Inventory Router]\n\n        subgraph \"Container Components (Smart)\"\n            StockView[StockViewPage]\n            TransactionHistory[TransactionHistoryPage]\n            StockValuation[StockValuationPage]\n        end\n\n        subgraph \"Presentation Components (Dumb)\"\n            StockList[StockListComponent]\n            QuickStats[QuickStatsComponent]\n            LotDialog[LotManagementDialog]\n            AdjustDialog[StockAdjustmentDialog]\n            TransactionTable[TransactionTableComponent]\n        end\n\n        subgraph \"Services\"\n            InventoryApi[InventoryApiService]\n            InventoryState[InventoryStateService]\n            InventoryWS[InventoryWebSocketService]\n        end\n\n        subgraph \"Models\"\n            Interfaces[TypeScript Interfaces]\n            Enums[Enums & Constants]\n        end\n    end\n\n    Router --> StockView\n    Router --> TransactionHistory\n    Router --> StockValuation\n\n    StockView --> StockList\n    StockView --> QuickStats\n    StockView --> LotDialog\n    StockView --> AdjustDialog\n\n    StockView --> InventoryState\n    InventoryState --> InventoryApi\n    InventoryState --> InventoryWS\n\n    InventoryApi --> Backend[Backend API]\n    InventoryWS --> WSServer[WebSocket Server]\n```\n\n### Technology Stack\n\n- **Framework**: Angular 17+ (standalone components)\n- **State Management**: Angular Signals + RxJS (for async operations)\n- **UI Library**: AegisX UI + Angular Material\n- **Styling**: TailwindCSS with custom design tokens\n- **Forms**: Angular Reactive Forms\n- **HTTP**: HttpClient with interceptors\n- **WebSocket**: Custom service with auto-reconnect\n- **Routing**: Feature-based lazy loading\n- **Date**: date-fns for formatting and calculations\n- **Charts**: Chart.js (if needed for visualizations)\n\n---\n\n## Component Specifications\n\n### 1. StockViewPage (Container Component)\n\n**Path**: `apps/admin/src/app/pages/inventory/stock-view/stock-view.page.ts`\n\n**Responsibility**: Main container for stock monitoring, manages state and coordinates child components.\n\n**TypeScript Interface**:\n```typescript\n@Component({\n  selector: 'inv-stock-view-page',\n  standalone: true,\n  imports: [\n    CommonModule,\n    StockListComponent,\n    QuickStatsComponent,\n    LotManagementDialog,\n    StockAdjustmentDialog,\n    AxDrawer,\n    AxSelect,\n    AxButton,\n  ],\n  templateUrl: './stock-view.page.html',\n})\nexport class StockViewPage implements OnInit, OnDestroy {\n  // Signals\n  stockItems = signal<StockItem[]>([]);\n  quickStats = computed(() => this.calculateStats(this.stockItems()));\n  selectedLocation = signal<number | null>(null);\n  searchTerm = signal<string>('');\n  isLoading = signal<boolean>(false);\n\n  // Filters\n  filteredStockItems = computed(() => {\n    let items = this.stockItems();\n    const location = this.selectedLocation();\n    const search = this.searchTerm().toLowerCase();\n\n    if (location) {\n      items = items.filter(item => item.location_id === location);\n    }\n\n    if (search) {\n      items = items.filter(item =>\n        item.drug_name.toLowerCase().includes(search)\n      );\n    }\n\n    return items;\n  });\n\n  constructor(\n    private inventoryState: InventoryStateService,\n    private dialog: MatDialog,\n  ) {}\n\n  ngOnInit(): void {\n    this.loadStockData();\n    this.subscribeToRealtimeUpdates();\n  }\n\n  loadStockData(): void {\n    this.isLoading.set(true);\n    this.inventoryState.fetchStockLevels(this.selectedLocation())\n      .subscribe({\n        next: (data) => {\n          this.stockItems.set(data);\n          this.isLoading.set(false);\n        },\n        error: (err) => {\n          this.isLoading.set(false);\n          this.handleError(err);\n        }\n      });\n  }\n\n  subscribeToRealtimeUpdates(): void {\n    this.inventoryState.stockUpdates$\n      .pipe(takeUntilDestroyed(this.destroyRef))\n      .subscribe((update) => {\n        this.handleStockUpdate(update);\n      });\n  }\n\n  onLocationChange(locationId: number): void {\n    this.selectedLocation.set(locationId);\n    this.loadStockData();\n  }\n\n  onSearchChange(term: string): void {\n    this.searchTerm.set(term);\n  }\n\n  onViewLots(stockItem: StockItem): void {\n    this.dialog.open(LotManagementDialog, {\n      width: '800px',\n      data: { drugId: stockItem.drug_id, locationId: stockItem.location_id }\n    });\n  }\n\n  onAdjustStock(stockItem: StockItem): void {\n    const dialogRef = this.dialog.open(StockAdjustmentDialog, {\n      width: '600px',\n      data: { stockItem }\n    });\n\n    dialogRef.afterClosed().subscribe((result) => {\n      if (result?.success) {\n        this.loadStockData(); // Refresh data\n      }\n    });\n  }\n\n  onExportReport(): void {\n    this.inventoryState.exportStockReport(this.filteredStockItems());\n  }\n\n  private calculateStats(items: StockItem[]): QuickStats {\n    return {\n      totalItems: items.length,\n      lowStock: items.filter(i => i.stock_status === 'LOW').length,\n      expired: items.filter(i => i.has_expired_lots).length,\n      nearExpiry: items.filter(i => i.has_expiring_lots).length,\n    };\n  }\n\n  private handleStockUpdate(update: StockUpdateEvent): void {\n    // Update specific item in signal array\n    this.stockItems.update(items =>\n      items.map(item =>\n        item.id === update.inventoryId\n          ? { ...item, ...update.changes }\n          : item\n      )\n    );\n  }\n}\n```\n\n**Template Structure**:\n```html\n<div class=\"stock-view-container\">\n  <!-- Header -->\n  <div class=\"header-section\">\n    <h1>Current Stock - {{ currentLocationName() }}</h1>\n    <ax-select\n      [(ngModel)]=\"selectedLocation\"\n      (ngModelChange)=\"onLocationChange($event)\"\n      placeholder=\"Select Location\">\n      @for (loc of locations(); track loc.id) {\n        <ax-option [value]=\"loc.id\">{{ loc.name }}</ax-option>\n      }\n    </ax-select>\n  </div>\n\n  <!-- Quick Stats -->\n  <inv-quick-stats\n    [stats]=\"quickStats()\"\n    (statClick)=\"onStatCardClick($event)\">\n  </inv-quick-stats>\n\n  <!-- Filters -->\n  <div class=\"filter-section\">\n    <ax-input\n      [(ngModel)]=\"searchTerm\"\n      (ngModelChange)=\"onSearchChange($event)\"\n      placeholder=\"Search drugs...\"\n      [prefixIcon]=\"'search'\">\n    </ax-input>\n  </div>\n\n  <!-- Stock List -->\n  @if (isLoading()) {\n    <ax-skeleton [rows]=\"10\"></ax-skeleton>\n  } @else {\n    <inv-stock-list\n      [stockItems]=\"filteredStockItems()\"\n      (viewLots)=\"onViewLots($event)\"\n      (adjustStock)=\"onAdjustStock($event)\">\n    </inv-stock-list>\n  }\n\n  <!-- Actions -->\n  <div class=\"actions-section\">\n    <ax-button (click)=\"onExportReport()\">\n      <mat-icon>download</mat-icon>\n      Export Report\n    </ax-button>\n  </div>\n</div>\n```\n\n---\n\n### 2. QuickStatsComponent (Presentation Component)\n\n**Path**: `apps/admin/src/app/pages/inventory/components/quick-stats/quick-stats.component.ts`\n\n**Responsibility**: Display summary statistics with click handling.\n\n**TypeScript Interface**:\n```typescript\n@Component({\n  selector: 'inv-quick-stats',\n  standalone: true,\n  imports: [CommonModule, AxKpiCard],\n  template: `\n    <div class=\"stats-grid grid grid-cols-1 md:grid-cols-4 gap-4\">\n      <ax-kpi-card\n        [title]=\"'Total Items'\"\n        [value]=\"stats().totalItems\"\n        [icon]=\"'inventory_2'\"\n        [color]=\"'primary'\"\n        (click)=\"statClick.emit('total')\">\n      </ax-kpi-card>\n\n      <ax-kpi-card\n        [title]=\"'Low Stock'\"\n        [value]=\"stats().lowStock\"\n        [icon]=\"'warning'\"\n        [color]=\"'warning'\"\n        (click)=\"statClick.emit('low')\">\n      </ax-kpi-card>\n\n      <ax-kpi-card\n        [title]=\"'Expired'\"\n        [value]=\"stats().expired\"\n        [icon]=\"'error'\"\n        [color]=\"'danger'\"\n        (click)=\"statClick.emit('expired')\">\n      </ax-kpi-card>\n\n      <ax-kpi-card\n        [title]=\"'Near Expiry'\"\n        [value]=\"stats().nearExpiry\"\n        [icon]=\"'schedule'\"\n        [color]=\"'info'\"\n        (click)=\"statClick.emit('expiring')\">\n      </ax-kpi-card>\n    </div>\n  `,\n})\nexport class QuickStatsComponent {\n  @Input({ required: true }) stats!: Signal<QuickStats>;\n  @Output() statClick = new EventEmitter<StatType>();\n}\n```\n\n---\n\n### 3. StockListComponent (Presentation Component)\n\n**Path**: `apps/admin/src/app/pages/inventory/components/stock-list/stock-list.component.ts`\n\n**Responsibility**: Display stock items in table format with action buttons.\n\n**TypeScript Interface**:\n```typescript\n@Component({\n  selector: 'inv-stock-list',\n  standalone: true,\n  imports: [\n    CommonModule,\n    MatTableModule,\n    MatSortModule,\n    MatPaginatorModule,\n    AxBadge,\n    AxButton,\n  ],\n  templateUrl: './stock-list.component.html',\n})\nexport class StockListComponent {\n  @Input({ required: true }) stockItems!: Signal<StockItem[]>;\n  @Output() viewLots = new EventEmitter<StockItem>();\n  @Output() adjustStock = new EventEmitter<StockItem>();\n\n  displayedColumns = [\n    'drug_name',\n    'location_name',\n    'quantity_on_hand',\n    'min_level',\n    'stock_status',\n    'oldest_expiry',\n    'actions',\n  ];\n\n  dataSource = computed(() => new MatTableDataSource(this.stockItems()));\n\n  getStatusColor(status: StockStatus): string {\n    const colors: Record<StockStatus, string> = {\n      'SUFFICIENT': 'success',\n      'LOW': 'warning',\n      'REORDER': 'danger',\n      'OVERSTOCK': 'info',\n    };\n    return colors[status] || 'default';\n  }\n\n  getStatusIcon(status: StockStatus): string {\n    const icons: Record<StockStatus, string> = {\n      'SUFFICIENT': 'check_circle',\n      'LOW': 'warning',\n      'REORDER': 'error',\n      'OVERSTOCK': 'trending_up',\n    };\n    return icons[status] || 'info';\n  }\n}\n```\n\n**Template**:\n```html\n<div class=\"stock-table-container\">\n  <table mat-table [dataSource]=\"dataSource()\" matSort>\n\n    <!-- Drug Name Column -->\n    <ng-container matColumnDef=\"drug_name\">\n      <th mat-header-cell *matHeaderCellDef mat-sort-header>Drug</th>\n      <td mat-cell *matCellDef=\"let item\">\n        <div class=\"drug-cell\">\n          <span class=\"drug-name\">{{ item.drug_name }}</span>\n          <span class=\"drug-generic text-sm text-gray-500\">{{ item.generic_name }}</span>\n        </div>\n      </td>\n    </ng-container>\n\n    <!-- Location Column -->\n    <ng-container matColumnDef=\"location_name\">\n      <th mat-header-cell *matHeaderCellDef mat-sort-header>Location</th>\n      <td mat-cell *matCellDef=\"let item\">{{ item.location_name }}</td>\n    </ng-container>\n\n    <!-- Stock Column -->\n    <ng-container matColumnDef=\"quantity_on_hand\">\n      <th mat-header-cell *matHeaderCellDef mat-sort-header>Stock</th>\n      <td mat-cell *matCellDef=\"let item\">\n        {{ item.quantity_on_hand | number }} {{ item.unit }}\n      </td>\n    </ng-container>\n\n    <!-- Min Level Column -->\n    <ng-container matColumnDef=\"min_level\">\n      <th mat-header-cell *matHeaderCellDef>Min</th>\n      <td mat-cell *matCellDef=\"let item\">{{ item.min_level | number }}</td>\n    </ng-container>\n\n    <!-- Status Column -->\n    <ng-container matColumnDef=\"stock_status\">\n      <th mat-header-cell *matHeaderCellDef>Status</th>\n      <td mat-cell *matCellDef=\"let item\">\n        <ax-badge\n          [variant]=\"getStatusColor(item.stock_status)\"\n          [icon]=\"getStatusIcon(item.stock_status)\">\n          {{ item.stock_status }}\n        </ax-badge>\n      </td>\n    </ng-container>\n\n    <!-- Expiry Column -->\n    <ng-container matColumnDef=\"oldest_expiry\">\n      <th mat-header-cell *matHeaderCellDef>Oldest Exp</th>\n      <td mat-cell *matCellDef=\"let item\">\n        @if (item.oldest_expiry_date) {\n          <span [class.text-danger]=\"item.days_until_expiry < 90\">\n            {{ item.oldest_expiry_date | date:'yyyy-MM' }}\n          </span>\n        } @else {\n          <span class=\"text-gray-400\">-</span>\n        }\n      </td>\n    </ng-container>\n\n    <!-- Actions Column -->\n    <ng-container matColumnDef=\"actions\">\n      <th mat-header-cell *matHeaderCellDef>Actions</th>\n      <td mat-cell *matCellDef=\"let item\">\n        <ax-button\n          variant=\"ghost\"\n          size=\"sm\"\n          (click)=\"viewLots.emit(item)\">\n          View Lots\n        </ax-button>\n        <ax-button\n          variant=\"ghost\"\n          size=\"sm\"\n          (click)=\"adjustStock.emit(item)\">\n          Adjust\n        </ax-button>\n      </td>\n    </ng-container>\n\n    <tr mat-header-row *matHeaderRowDef=\"displayedColumns\"></tr>\n    <tr mat-row *matRowDef=\"let row; columns: displayedColumns;\"></tr>\n  </table>\n\n  <mat-paginator\n    [pageSizeOptions]=\"[20, 50, 100]\"\n    showFirstLastButtons>\n  </mat-paginator>\n</div>\n```\n\n---\n\n### 4. LotManagementDialog (Smart Component)\n\n**Path**: `apps/admin/src/app/pages/inventory/dialogs/lot-management/lot-management.dialog.ts`\n\n**Responsibility**: Display and manage drug lots with FIFO/FEFO ordering.\n\n**TypeScript Interface**:\n```typescript\n@Component({\n  selector: 'inv-lot-management-dialog',\n  standalone: true,\n  imports: [\n    CommonModule,\n    MatDialogModule,\n    MatTableModule,\n    MatRadioModule,\n    AxBadge,\n    AxButton,\n  ],\n  templateUrl: './lot-management.dialog.html',\n})\nexport class LotManagementDialog implements OnInit {\n  drugId = signal<number>(0);\n  locationId = signal<number>(0);\n  lots = signal<DrugLot[]>([]);\n  orderBy = signal<'FIFO' | 'FEFO'>('FEFO');\n  isLoading = signal<boolean>(false);\n\n  sortedLots = computed(() => {\n    const lots = [...this.lots()];\n    const order = this.orderBy();\n\n    if (order === 'FIFO') {\n      return lots.sort((a, b) =>\n        new Date(a.received_date).getTime() - new Date(b.received_date).getTime()\n      );\n    } else {\n      return lots.sort((a, b) =>\n        new Date(a.expiry_date).getTime() - new Date(b.expiry_date).getTime()\n      );\n    }\n  });\n\n  nextToDispense = computed(() => this.sortedLots()[0] || null);\n\n  displayedColumns = [\n    'lot_number',\n    'quantity_available',\n    'unit_cost',\n    'expiry_date',\n    'days_until_expiry',\n    'fifo_order',\n    'fefo_order',\n  ];\n\n  constructor(\n    @Inject(MAT_DIALOG_DATA) public data: { drugId: number; locationId: number },\n    private inventoryApi: InventoryApiService,\n    private dialogRef: MatDialogRef<LotManagementDialog>,\n  ) {\n    this.drugId.set(data.drugId);\n    this.locationId.set(data.locationId);\n  }\n\n  ngOnInit(): void {\n    this.loadLots();\n  }\n\n  loadLots(): void {\n    this.isLoading.set(true);\n    this.inventoryApi.getDrugLots(\n      this.drugId(),\n      this.locationId(),\n      this.orderBy()\n    ).subscribe({\n      next: (lots) => {\n        this.lots.set(lots);\n        this.isLoading.set(false);\n      },\n      error: (err) => {\n        this.isLoading.set(false);\n        // Handle error\n      }\n    });\n  }\n\n  onOrderByChange(order: 'FIFO' | 'FEFO'): void {\n    this.orderBy.set(order);\n  }\n\n  getExpiryStatusColor(daysUntilExpiry: number): string {\n    if (daysUntilExpiry < 30) return 'danger';\n    if (daysUntilExpiry < 90) return 'warning';\n    if (daysUntilExpiry < 180) return 'info';\n    return 'success';\n  }\n\n  close(): void {\n    this.dialogRef.close();\n  }\n}\n```\n\n---\n\n### 5. StockAdjustmentDialog (Smart Component)\n\n**Path**: `apps/admin/src/app/pages/inventory/dialogs/stock-adjustment/stock-adjustment.dialog.ts`\n\n**Responsibility**: Handle stock adjustments with validation and API submission.\n\n**TypeScript Interface**:\n```typescript\n@Component({\n  selector: 'inv-stock-adjustment-dialog',\n  standalone: true,\n  imports: [\n    CommonModule,\n    ReactiveFormsModule,\n    MatDialogModule,\n    AxSelect,\n    AxInput,\n    AxTextarea,\n    AxButton,\n    AxAlert,\n  ],\n  templateUrl: './stock-adjustment.dialog.html',\n})\nexport class StockAdjustmentDialog implements OnInit {\n  stockItem = signal<StockItem | null>(null);\n  adjustmentForm!: FormGroup;\n  isSubmitting = signal<boolean>(false);\n  errorMessage = signal<string>('');\n\n  adjustmentResult = computed(() => {\n    if (!this.stockItem()) return null;\n\n    const type = this.adjustmentForm.get('adjustment_type')?.value;\n    const quantity = this.adjustmentForm.get('quantity')?.value || 0;\n    const current = this.stockItem()!.quantity_on_hand;\n\n    switch (type) {\n      case 'ADD':\n        return current + quantity;\n      case 'SUBTRACT':\n        return current - quantity;\n      case 'SET':\n        return quantity;\n      default:\n        return current;\n    }\n  });\n\n  constructor(\n    @Inject(MAT_DIALOG_DATA) public data: { stockItem: StockItem },\n    private fb: FormBuilder,\n    private inventoryApi: InventoryApiService,\n    private dialogRef: MatDialogRef<StockAdjustmentDialog>,\n    private toastService: ToastService,\n  ) {\n    this.stockItem.set(data.stockItem);\n  }\n\n  ngOnInit(): void {\n    this.initForm();\n  }\n\n  initForm(): void {\n    const item = this.stockItem()!;\n\n    this.adjustmentForm = this.fb.group({\n      drug_id: [item.drug_id, Validators.required],\n      location_id: [item.location_id, Validators.required],\n      adjustment_type: ['SUBTRACT', Validators.required],\n      quantity: [0, [Validators.required, Validators.min(1)]],\n      adjustment_reason_id: [null, Validators.required],\n      lot_id: [null],\n      notes: [''],\n    }, {\n      validators: this.adjustmentValidator.bind(this)\n    });\n  }\n\n  adjustmentValidator(group: AbstractControl): ValidationErrors | null {\n    const type = group.get('adjustment_type')?.value;\n    const quantity = group.get('quantity')?.value;\n    const current = this.stockItem()?.quantity_on_hand || 0;\n\n    if (type === 'SUBTRACT' && quantity > current) {\n      return {\n        insufficientStock: {\n          current,\n          requested: quantity,\n          shortage: quantity - current\n        }\n      };\n    }\n\n    return null;\n  }\n\n  onSubmit(): void {\n    if (this.adjustmentForm.invalid) {\n      this.adjustmentForm.markAllAsTouched();\n      return;\n    }\n\n    this.isSubmitting.set(true);\n    this.errorMessage.set('');\n\n    const adjustment: CreateAdjustment = this.adjustmentForm.value;\n\n    this.inventoryApi.createAdjustment(adjustment).subscribe({\n      next: (result) => {\n        this.toastService.success(\n          `Stock adjusted successfully. New quantity: ${result.new_quantity}`\n        );\n        this.dialogRef.close({ success: true, result });\n      },\n      error: (err) => {\n        this.isSubmitting.set(false);\n        this.errorMessage.set(err.error?.message || 'Adjustment failed');\n      }\n    });\n  }\n\n  cancel(): void {\n    this.dialogRef.close({ success: false });\n  }\n}\n```\n\n---\n\n## State Management with Angular Signals\n\n### InventoryStateService\n\n**Path**: `apps/admin/src/app/pages/inventory/services/inventory-state.service.ts`\n\n**Responsibility**: Centralized state management using Angular Signals.\n\n```typescript\n@Injectable()\nexport class InventoryStateService {\n  // Signals for state\n  private stockItemsSignal = signal<StockItem[]>([]);\n  private selectedLocationSignal = signal<number | null>(null);\n  private loadingSignal = signal<boolean>(false);\n\n  // Public readonly signals\n  readonly stockItems = this.stockItemsSignal.asReadonly();\n  readonly selectedLocation = this.selectedLocationSignal.asReadonly();\n  readonly isLoading = this.loadingSignal.asReadonly();\n\n  // Computed signals\n  readonly lowStockItems = computed(() =>\n    this.stockItems().filter(item => item.stock_status === 'LOW' || item.stock_status === 'REORDER')\n  );\n\n  readonly expiringItems = computed(() =>\n    this.stockItems().filter(item => item.has_expiring_lots)\n  );\n\n  // Observable for async operations\n  stockUpdates$ = new Subject<StockUpdateEvent>();\n\n  constructor(\n    private inventoryApi: InventoryApiService,\n    private inventoryWs: InventoryWebSocketService,\n  ) {\n    this.initWebSocketSubscriptions();\n  }\n\n  fetchStockLevels(locationId: number | null): Observable<StockItem[]> {\n    this.loadingSignal.set(true);\n\n    return this.inventoryApi.getStockLevels({ locationId }).pipe(\n      tap(items => {\n        this.stockItemsSignal.set(items);\n        this.loadingSignal.set(false);\n      }),\n      catchError(err => {\n        this.loadingSignal.set(false);\n        return throwError(() => err);\n      })\n    );\n  }\n\n  updateStockItem(inventoryId: number, changes: Partial<StockItem>): void {\n    this.stockItemsSignal.update(items =>\n      items.map(item =>\n        item.id === inventoryId ? { ...item, ...changes } : item\n      )\n    );\n  }\n\n  setSelectedLocation(locationId: number): void {\n    this.selectedLocationSignal.set(locationId);\n  }\n\n  private initWebSocketSubscriptions(): void {\n    this.inventoryWs.onAdjustmentCreated$.subscribe(event => {\n      this.updateStockItem(event.inventoryId, {\n        quantity_on_hand: event.new_quantity,\n        stock_status: event.new_status,\n      });\n\n      this.stockUpdates$.next(event);\n    });\n\n    this.inventoryWs.onReceiptPosted$.subscribe(event => {\n      // Handle receipt posted event\n      this.stockUpdates$.next(event);\n    });\n  }\n\n  exportStockReport(items: StockItem[]): void {\n    // Convert to CSV and trigger download\n    const csv = this.convertToCSV(items);\n    const blob = new Blob([csv], { type: 'text/csv' });\n    const url = window.URL.createObjectURL(blob);\n    const a = document.createElement('a');\n    a.href = url;\n    a.download = `stock-report-${new Date().toISOString()}.csv`;\n    a.click();\n  }\n\n  private convertToCSV(items: StockItem[]): string {\n    const headers = ['Drug', 'Location', 'Stock', 'Min', 'Max', 'Status'];\n    const rows = items.map(item => [\n      item.drug_name,\n      item.location_name,\n      item.quantity_on_hand,\n      item.min_level,\n      item.max_level,\n      item.stock_status,\n    ]);\n\n    return [headers, ...rows].map(row => row.join(',')).join('\\n');\n  }\n}\n```\n\n---\n\n## Service Layer\n\n### InventoryApiService\n\n**Path**: `apps/admin/src/app/pages/inventory/services/inventory-api.service.ts`\n\n**Responsibility**: HTTP communication with backend API.\n\n```typescript\n@Injectable()\nexport class InventoryApiService {\n  private readonly apiUrl = '/api/inventory/operations';\n\n  constructor(private http: HttpClient) {}\n\n  // Stock endpoints\n  getStockLevels(params: StockQueryParams): Observable<StockItem[]> {\n    return this.http.get<ApiResponse<StockItem[]>>(\n      `${this.apiUrl}/inventory/stock`,\n      { params: params as any }\n    ).pipe(\n      map(response => response.data)\n    );\n  }\n\n  getStockByDrugLocation(drugId: number, locationId: number): Observable<StockItem> {\n    return this.http.get<ApiResponse<StockItem>>(\n      `${this.apiUrl}/inventory/stock/${drugId}/${locationId}`\n    ).pipe(\n      map(response => response.data)\n    );\n  }\n\n  // Lot endpoints\n  getDrugLots(drugId: number, locationId: number, orderBy: 'FIFO' | 'FEFO'): Observable<DrugLot[]> {\n    return this.http.get<ApiResponse<DrugLot[]>>(\n      `${this.apiUrl}/drug-lots`,\n      { params: { drugId, locationId, orderBy } }\n    ).pipe(\n      map(response => response.data)\n    );\n  }\n\n  getExpiringLots(params: ExpiringLotsParams): Observable<ExpiringLotsResponse> {\n    return this.http.get<ApiResponse<ExpiringLotsResponse>>(\n      `${this.apiUrl}/drug-lots/expiring`,\n      { params: params as any }\n    ).pipe(\n      map(response => response.data)\n    );\n  }\n\n  // Adjustment endpoints\n  createAdjustment(adjustment: CreateAdjustment): Observable<AdjustmentResult> {\n    return this.http.post<ApiResponse<AdjustmentResult>>(\n      `${this.apiUrl}/inventory-adjustments`,\n      adjustment\n    ).pipe(\n      map(response => response.data)\n    );\n  }\n\n  getAdjustmentHistory(params: AdjustmentQueryParams): Observable<PaginatedResponse<Adjustment>> {\n    return this.http.get<PaginatedResponse<Adjustment>>(\n      `${this.apiUrl}/inventory-adjustments`,\n      { params: params as any }\n    );\n  }\n\n  // Transaction endpoints\n  getTransactionHistory(params: TransactionQueryParams): Observable<PaginatedResponse<Transaction>> {\n    return this.http.get<PaginatedResponse<Transaction>>(\n      `${this.apiUrl}/inventory-transactions`,\n      { params: params as any }\n    );\n  }\n\n  // Valuation endpoint\n  getStockValuation(params: ValuationQueryParams): Observable<ValuationReport> {\n    return this.http.get<ApiResponse<ValuationReport>>(\n      `${this.apiUrl}/inventory/valuation`,\n      { params: params as any }\n    ).pipe(\n      map(response => response.data)\n    );\n  }\n\n  // Low stock endpoint\n  getLowStockItems(params: LowStockParams): Observable<LowStockItem[]> {\n    return this.http.get<ApiResponse<LowStockItem[]>>(\n      `${this.apiUrl}/inventory/low-stock`,\n      { params: params as any }\n    ).pipe(\n      map(response => response.data)\n    );\n  }\n}\n```\n\n---\n\n### InventoryWebSocketService\n\n**Path**: `apps/admin/src/app/pages/inventory/services/inventory-websocket.service.ts`\n\n**Responsibility**: WebSocket connection management and event handling.\n\n```typescript\n@Injectable()\nexport class InventoryWebSocketService implements OnDestroy {\n  private socket: WebSocket | null = null;\n  private reconnectAttempts = 0;\n  private maxReconnectAttempts = 5;\n  private reconnectDelay = 1000; // Start with 1 second\n\n  // Event streams\n  onAdjustmentCreated$ = new Subject<AdjustmentCreatedEvent>();\n  onReceiptPosted$ = new Subject<ReceiptPostedEvent>();\n  onTransferCompleted$ = new Subject<TransferCompletedEvent>();\n  onConnectionStatus$ = new BehaviorSubject<'connected' | 'disconnected' | 'reconnecting'>('disconnected');\n\n  constructor(private authService: AuthService) {\n    this.connect();\n  }\n\n  private connect(): void {\n    const wsUrl = environment.wsUrl;\n    const token = this.authService.getToken();\n\n    this.socket = new WebSocket(`${wsUrl}?token=${token}`);\n\n    this.socket.onopen = () => {\n      console.log('[WS] Connected');\n      this.onConnectionStatus$.next('connected');\n      this.reconnectAttempts = 0;\n      this.reconnectDelay = 1000;\n\n      // Subscribe to inventory events\n      this.send({ type: 'subscribe', channel: 'inventory' });\n    };\n\n    this.socket.onmessage = (event) => {\n      const message = JSON.parse(event.data);\n      this.handleMessage(message);\n    };\n\n    this.socket.onerror = (error) => {\n      console.error('[WS] Error:', error);\n    };\n\n    this.socket.onclose = () => {\n      console.log('[WS] Disconnected');\n      this.onConnectionStatus$.next('disconnected');\n      this.attemptReconnect();\n    };\n  }\n\n  private handleMessage(message: WebSocketMessage): void {\n    switch (message.event) {\n      case 'inventory:adjustment_created':\n        this.onAdjustmentCreated$.next(message.data);\n        break;\n      case 'inventory:receipt_posted':\n        this.onReceiptPosted$.next(message.data);\n        break;\n      case 'inventory:transfer_completed':\n        this.onTransferCompleted$.next(message.data);\n        break;\n    }\n  }\n\n  private attemptReconnect(): void {\n    if (this.reconnectAttempts >= this.maxReconnectAttempts) {\n      console.error('[WS] Max reconnect attempts reached');\n      return;\n    }\n\n    this.reconnectAttempts++;\n    this.onConnectionStatus$.next('reconnecting');\n\n    console.log(`[WS] Reconnecting in ${this.reconnectDelay}ms (attempt ${this.reconnectAttempts})`);\n\n    setTimeout(() => {\n      this.connect();\n      this.reconnectDelay *= 2; // Exponential backoff\n    }, this.reconnectDelay);\n  }\n\n  private send(message: any): void {\n    if (this.socket?.readyState === WebSocket.OPEN) {\n      this.socket.send(JSON.stringify(message));\n    }\n  }\n\n  disconnect(): void {\n    if (this.socket) {\n      this.socket.close();\n      this.socket = null;\n    }\n  }\n\n  ngOnDestroy(): void {\n    this.disconnect();\n  }\n}\n```\n\n---\n\n## Data Models (TypeScript Interfaces)\n\n**Path**: `apps/admin/src/app/pages/inventory/models/inventory.models.ts`\n\n```typescript\n// Stock Item\nexport interface StockItem {\n  id: number;\n  drug_id: number;\n  drug_name: string;\n  generic_name: string;\n  location_id: number;\n  location_name: string;\n  quantity_on_hand: number;\n  unit: string;\n  min_level: number;\n  max_level: number;\n  reorder_point: number;\n  average_cost: number;\n  stock_status: StockStatus;\n  stock_value: number;\n  days_of_supply: number | null;\n  oldest_expiry_date: string | null;\n  has_expired_lots: boolean;\n  has_expiring_lots: boolean;\n  days_until_expiry: number | null;\n}\n\nexport type StockStatus = 'SUFFICIENT' | 'LOW' | 'REORDER' | 'OVERSTOCK';\n\n// Drug Lot\nexport interface DrugLot {\n  id: number;\n  lot_number: string;\n  drug_id: number;\n  location_id: number;\n  quantity_received: number;\n  quantity_available: number;\n  unit_cost: number;\n  expiry_date: string;\n  received_date: string;\n  is_active: boolean;\n  days_until_expiry: number;\n  expiry_status: ExpiryStatus;\n  utilization_percent: number;\n  fifo_order: number;\n  fefo_order: number;\n}\n\nexport type ExpiryStatus = 'OK' | 'WARN' | 'CRITICAL' | 'EXPIRED';\n\n// Adjustment\nexport interface CreateAdjustment {\n  drug_id: number;\n  location_id: number;\n  adjustment_type: 'ADD' | 'SUBTRACT' | 'SET';\n  quantity: number;\n  adjustment_reason_id: number;\n  lot_id?: number;\n  notes?: string;\n}\n\nexport interface AdjustmentResult {\n  id: number;\n  previous_quantity: number;\n  new_quantity: number;\n  variance: number;\n  created_at: string;\n  created_by: string;\n}\n\n// Transaction\nexport interface Transaction {\n  id: number;\n  inventory_id: number;\n  drug_name: string;\n  location_name: string;\n  transaction_type: TransactionType;\n  quantity: number;\n  unit_cost: number;\n  reference_type: string | null;\n  reference_id: number | null;\n  created_by: string;\n  created_at: string;\n}\n\nexport type TransactionType = 'RECEIVE' | 'ISSUE' | 'TRANSFER' | 'ADJUST' | 'RETURN';\n\n// Quick Stats\nexport interface QuickStats {\n  totalItems: number;\n  lowStock: number;\n  expired: number;\n  nearExpiry: number;\n}\n\n// WebSocket Events\nexport interface AdjustmentCreatedEvent {\n  inventoryId: number;\n  drugId: number;\n  locationId: number;\n  new_quantity: number;\n  new_status: StockStatus;\n  adjustmentId: number;\n}\n\nexport interface ReceiptPostedEvent {\n  receiptId: number;\n  affectedInventoryIds: number[];\n}\n\nexport interface TransferCompletedEvent {\n  transferId: number;\n  sourceInventoryId: number;\n  destinationInventoryId: number;\n}\n\n// API Response Types\nexport interface ApiResponse<T> {\n  success: boolean;\n  data: T;\n  message?: string;\n}\n\nexport interface PaginatedResponse<T> {\n  success: boolean;\n  data: T[];\n  pagination: {\n    page: number;\n    limit: number;\n    total: number;\n    totalPages: number;\n  };\n}\n```\n\n---\n\n## Routing Structure\n\n**Path**: `apps/admin/src/app/pages/inventory/inventory.routes.ts`\n\n```typescript\nimport { Routes } from '@angular/router';\nimport { authGuard } from '@app/core/guards/auth.guard';\nimport { permissionGuard } from '@app/core/guards/permission.guard';\n\nexport const INVENTORY_ROUTES: Routes = [\n  {\n    path: '',\n    redirectTo: 'stock',\n    pathMatch: 'full',\n  },\n  {\n    path: 'stock',\n    loadComponent: () => import('./stock-view/stock-view.page').then(m => m.StockViewPage),\n    canActivate: [authGuard, permissionGuard],\n    data: {\n      permission: { resource: 'inventory', action: 'read' },\n      breadcrumb: 'Current Stock'\n    },\n  },\n  {\n    path: 'low-stock',\n    loadComponent: () => import('./low-stock/low-stock.page').then(m => m.LowStockPage),\n    canActivate: [authGuard, permissionGuard],\n    data: {\n      permission: { resource: 'inventory', action: 'read' },\n      breadcrumb: 'Low Stock Alert'\n    },\n  },\n  {\n    path: 'expiring',\n    loadComponent: () => import('./expiring-drugs/expiring-drugs.page').then(m => m.ExpiringDrugsPage),\n    canActivate: [authGuard, permissionGuard],\n    data: {\n      permission: { resource: 'inventory', action: 'read' },\n      breadcrumb: 'Expiring Drugs'\n    },\n  },\n  {\n    path: 'transactions',\n    loadComponent: () => import('./transaction-history/transaction-history.page').then(m => m.TransactionHistoryPage),\n    canActivate: [authGuard, permissionGuard],\n    data: {\n      permission: { resource: 'inventory_transactions', action: 'read' },\n      breadcrumb: 'Transaction History'\n    },\n  },\n  {\n    path: 'valuation',\n    loadComponent: () => import('./stock-valuation/stock-valuation.page').then(m => m.StockValuationPage),\n    canActivate: [authGuard, permissionGuard],\n    data: {\n      permission: { resource: 'inventory_valuation', action: 'read' },\n      breadcrumb: 'Stock Valuation'\n    },\n  },\n];\n```\n\n---\n\n## Error Handling Strategy\n\n### Global HTTP Interceptor\n\n**Path**: `apps/admin/src/app/core/interceptors/error.interceptor.ts`\n\n```typescript\n@Injectable()\nexport class ErrorInterceptor implements HttpInterceptor {\n  constructor(private toastService: ToastService) {}\n\n  intercept(req: HttpRequest<any>, next: HttpHandler): Observable<HttpEvent<any>> {\n    return next.handle(req).pipe(\n      catchError((error: HttpErrorResponse) => {\n        let errorMessage = 'An error occurred';\n\n        if (error.error instanceof ErrorEvent) {\n          // Client-side error\n          errorMessage = `Error: ${error.error.message}`;\n        } else {\n          // Server-side error\n          switch (error.status) {\n            case 400:\n              errorMessage = error.error?.message || 'Invalid request';\n              break;\n            case 401:\n              errorMessage = 'Unauthorized. Please log in again.';\n              // Redirect to login\n              break;\n            case 403:\n              errorMessage = \"You don't have permission for this action\";\n              break;\n            case 404:\n              errorMessage = 'Resource not found';\n              break;\n            case 422:\n              errorMessage = error.error?.message || 'Validation failed';\n              break;\n            case 500:\n              errorMessage = 'Server error. Please try again or contact support.';\n              break;\n            default:\n              errorMessage = error.error?.message || 'An unexpected error occurred';\n          }\n        }\n\n        this.toastService.error(errorMessage);\n\n        return throwError(() => error);\n      })\n    );\n  }\n}\n```\n\n---\n\n## Testing Strategy\n\n### Component Testing\n\n**Unit Tests**: Test component logic in isolation with mocked dependencies.\n\n```typescript\ndescribe('StockViewPage', () => {\n  let component: StockViewPage;\n  let fixture: ComponentFixture<StockViewPage>;\n  let inventoryStateMock: jasmine.SpyObj<InventoryStateService>;\n\n  beforeEach(async () => {\n    inventoryStateMock = jasmine.createSpyObj('InventoryStateService', [\n      'fetchStockLevels',\n    ]);\n\n    await TestBed.configureTestingModule({\n      imports: [StockViewPage],\n      providers: [\n        { provide: InventoryStateService, useValue: inventoryStateMock },\n      ],\n    }).compileComponents();\n\n    fixture = TestBed.createComponent(StockViewPage);\n    component = fixture.componentInstance;\n  });\n\n  it('should load stock data on init', () => {\n    inventoryStateMock.fetchStockLevels.and.returnValue(of(mockStockItems));\n\n    component.ngOnInit();\n\n    expect(inventoryStateMock.fetchStockLevels).toHaveBeenCalled();\n    expect(component.stockItems().length).toBe(mockStockItems.length);\n  });\n\n  it('should filter items by location', () => {\n    component.stockItems.set(mockStockItems);\n    component.selectedLocation.set(1);\n\n    const filtered = component.filteredStockItems();\n\n    expect(filtered.every(item => item.location_id === 1)).toBe(true);\n  });\n\n  it('should calculate quick stats correctly', () => {\n    component.stockItems.set(mockStockItems);\n\n    const stats = component.quickStats();\n\n    expect(stats.totalItems).toBe(mockStockItems.length);\n    expect(stats.lowStock).toBe(mockStockItems.filter(i => i.stock_status === 'LOW').length);\n  });\n});\n```\n\n### Service Testing\n\n```typescript\ndescribe('InventoryApiService', () => {\n  let service: InventoryApiService;\n  let httpMock: HttpTestingController;\n\n  beforeEach(() => {\n    TestBed.configureTestingModule({\n      imports: [HttpClientTestingModule],\n      providers: [InventoryApiService],\n    });\n\n    service = TestBed.inject(InventoryApiService);\n    httpMock = TestBed.inject(HttpTestingController);\n  });\n\n  afterEach(() => {\n    httpMock.verify();\n  });\n\n  it('should fetch stock levels', () => {\n    const mockResponse: ApiResponse<StockItem[]> = {\n      success: true,\n      data: mockStockItems,\n    };\n\n    service.getStockLevels({ locationId: 1 }).subscribe(items => {\n      expect(items.length).toBe(mockStockItems.length);\n    });\n\n    const req = httpMock.expectOne(req =>\n      req.url.includes('/api/inventory/operations/inventory/stock')\n    );\n    expect(req.request.method).toBe('GET');\n    req.flush(mockResponse);\n  });\n\n  it('should create adjustment', () => {\n    const adjustment: CreateAdjustment = {\n      drug_id: 1,\n      location_id: 1,\n      adjustment_type: 'SUBTRACT',\n      quantity: 500,\n      adjustment_reason_id: 1,\n    };\n\n    const mockResult: AdjustmentResult = {\n      id: 1,\n      previous_quantity: 15000,\n      new_quantity: 14500,\n      variance: -500,\n      created_at: new Date().toISOString(),\n      created_by: 'user@example.com',\n    };\n\n    service.createAdjustment(adjustment).subscribe(result => {\n      expect(result.new_quantity).toBe(14500);\n    });\n\n    const req = httpMock.expectOne('/api/inventory/operations/inventory-adjustments');\n    expect(req.request.method).toBe('POST');\n    expect(req.request.body).toEqual(adjustment);\n    req.flush({ success: true, data: mockResult });\n  });\n});\n```\n\n### E2E Testing (Playwright)\n\n```typescript\nimport { test, expect } from '@playwright/test';\n\ntest.describe('Stock View Page', () => {\n  test.beforeEach(async ({ page }) => {\n    await page.goto('/inventory/stock');\n    await page.waitForSelector('[data-testid=\"stock-table\"]');\n  });\n\n  test('should display stock items', async ({ page }) => {\n    const rows = await page.locator('[data-testid=\"stock-row\"]').count();\n    expect(rows).toBeGreaterThan(0);\n  });\n\n  test('should filter by location', async ({ page }) => {\n    await page.selectOption('[data-testid=\"location-select\"]', '1');\n    await page.waitForTimeout(500); // Wait for filter\n\n    const rows = await page.locator('[data-testid=\"stock-row\"]').all();\n    for (const row of rows) {\n      const location = await row.locator('[data-testid=\"location-cell\"]').textContent();\n      expect(location).toBe('Central Pharmacy');\n    }\n  });\n\n  test('should open lot management dialog', async ({ page }) => {\n    await page.locator('[data-testid=\"view-lots-btn\"]').first().click();\n    await expect(page.locator('[data-testid=\"lot-management-dialog\"]')).toBeVisible();\n\n    const lots = await page.locator('[data-testid=\"lot-row\"]').count();\n    expect(lots).toBeGreaterThan(0);\n  });\n\n  test('should create stock adjustment', async ({ page }) => {\n    await page.locator('[data-testid=\"adjust-stock-btn\"]').first().click();\n    await expect(page.locator('[data-testid=\"adjustment-dialog\"]')).toBeVisible();\n\n    // Fill form\n    await page.selectOption('[data-testid=\"adjustment-type\"]', 'SUBTRACT');\n    await page.fill('[data-testid=\"quantity-input\"]', '500');\n    await page.selectOption('[data-testid=\"reason-select\"]', '1');\n\n    // Submit\n    await page.click('[data-testid=\"submit-btn\"]');\n\n    // Verify success\n    await expect(page.locator('.toast-success')).toBeVisible();\n  });\n});\n```\n\n---\n\n## Performance Optimization\n\n### 1. Virtual Scrolling for Large Tables\n\n```typescript\nimport { CdkVirtualScrollViewport } from '@angular/cdk/scrolling';\n\n@Component({\n  template: `\n    <cdk-virtual-scroll-viewport itemSize=\"50\" class=\"viewport\">\n      <table>\n        <tr *cdkVirtualFor=\"let item of stockItems()\">\n          <td>{{ item.drug_name }}</td>\n          <td>{{ item.quantity_on_hand }}</td>\n        </tr>\n      </table>\n    </cdk-virtual-scroll-viewport>\n  `\n})\n```\n\n### 2. Lazy Loading Images\n\n```html\n<img [src]=\"item.drug_image\" loading=\"lazy\" alt=\"{{ item.drug_name }}\">\n```\n\n### 3. OnPush Change Detection\n\n```typescript\n@Component({\n  changeDetection: ChangeDetectionStrategy.OnPush\n})\n```\n\n### 4. Memoization with Signals\n\n```typescript\n// Signals automatically memoize computed values\nreadonly filteredItems = computed(() => {\n  // Only recalculates when dependencies change\n  return this.items().filter(item => item.status === this.filter());\n});\n```\n\n---\n\n## Deployment Considerations\n\n### Environment Configuration\n\n**Path**: `apps/admin/src/environments/environment.ts`\n\n```typescript\nexport const environment = {\n  production: false,\n  apiUrl: 'http://localhost:3000',\n  wsUrl: 'ws://localhost:3000',\n};\n```\n\n### Build Configuration\n\n```bash\n# Development build\nnx build admin\n\n# Production build\nnx build admin --configuration=production\n\n# Build with source maps\nnx build admin --source-map\n```\n\n---\n\n## Summary\n\nThis design provides:\n\n1. **Scalable Architecture**: Feature module with lazy loading\n2. **Modern State Management**: Angular Signals for reactive UI\n3. **Type Safety**: Comprehensive TypeScript interfaces\n4. **Real-Time Updates**: WebSocket integration with auto-reconnect\n5. **User-Friendly UI**: AegisX UI + Angular Material components\n6. **Accessibility**: WCAG 2.1 AA compliance\n7. **Performance**: Virtual scrolling, memoization, lazy loading\n8. **Testing**: Unit, integration, and E2E test coverage\n9. **Error Handling**: Global interceptor with user-friendly messages\n10. **Maintainability**: Smart/dumb component pattern, service layer separation\n\nThe frontend architecture integrates seamlessly with the inventory-backend-api and follows Angular best practices for enterprise applications.\n",
  "fileStats": {
    "size": 41639,
    "lines": 1564,
    "lastModified": "2025-12-14T13:45:44.804Z"
  },
  "comments": []
}