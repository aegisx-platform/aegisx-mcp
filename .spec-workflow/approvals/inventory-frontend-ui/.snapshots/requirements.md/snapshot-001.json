{
  "id": "snapshot_1765719721268_zwbg5oirn",
  "approvalId": "approval_1765719721258_ykyc2q13a",
  "approvalTitle": "Requirements Document - Inventory Frontend UI (12 functional requirements)",
  "version": 1,
  "timestamp": "2025-12-14T13:42:01.268Z",
  "trigger": "initial",
  "status": "pending",
  "content": "# Requirements Document - Inventory Frontend UI\n\n## Introduction\n\nThe Inventory Frontend UI provides a modern, user-friendly interface for hospital pharmacists and inventory managers to monitor and manage drug inventory in real-time. This Angular-based application integrates with the inventory-backend-api to deliver FIFO/FEFO lot tracking, stock level monitoring, and inventory adjustment capabilities.\n\n**Purpose:** Enable efficient inventory management through intuitive UI workflows that support Ministry of Public Health compliance and reduce drug waste.\n\n**Value to Users:**\n- Real-time visibility of stock levels across all locations\n- Proactive alerts for low stock and expiring drugs\n- Simplified inventory adjustment workflows with full audit trail\n- FIFO/FEFO lot management to minimize waste\n\n## Alignment with Product Vision\n\nThis feature aligns with INVS Modern's core objectives:\n\n1. **Enhance Inventory Accuracy**: Real-time display with color-coded alerts reduces stockouts and overstocking\n2. **Minimize Drug Waste**: FIFO/FEFO lot tracking UI helps pharmacists dispense drugs before expiry (target: 30% reduction in expired drug waste)\n3. **Support Data-Driven Decisions**: Visual dashboards and reports enable informed inventory decisions\n4. **Ensure Compliance**: Complete audit trail for all inventory transactions meets Ministry requirements\n\n## Requirements\n\n### REQ-1: Stock View Dashboard\n\n**User Story:** As a pharmacist, I want to view real-time stock levels for all drugs at my location, so that I can quickly identify items needing attention.\n\n#### Acceptance Criteria\n\n1. **WHEN** user opens Stock View page **THEN** system **SHALL** display:\n   - List of all drugs with current stock levels\n   - Quick stats summary (Total Items, Low Stock Count, Expired Count, Near Expiry Count)\n   - Location selector dropdown\n   - Search bar and filter controls\n\n2. **WHEN** stock level is below minimum **THEN** system **SHALL** highlight row with ‚ö†Ô∏è warning (yellow) and \"Low Stock\" status\n\n3. **WHEN** stock level is below reorder point **THEN** system **SHALL** highlight row with üî¥ critical (red) and \"Reorder\" status\n\n4. **WHEN** drug has lots expiring within 90 days **THEN** system **SHALL** display ‚è∞ indicator with oldest expiry date\n\n5. **WHEN** user selects location from dropdown **THEN** system **SHALL** filter stock display to show only that location's inventory\n\n6. **WHEN** user types in search bar **THEN** system **SHALL** filter results by drug name (case-insensitive, partial match)\n\n7. **WHEN** user clicks \"View Lots\" button **THEN** system **SHALL** open Lot Management dialog for selected drug\n\n8. **WHEN** user clicks \"Adjust Stock\" button **THEN** system **SHALL** open Stock Adjustment dialog for selected drug\n\n9. **WHEN** user clicks \"Export Report\" button **THEN** system **SHALL** download stock report as Excel/CSV file\n\n### REQ-2: Quick Stats Cards\n\n**User Story:** As a inventory manager, I want to see summary statistics at a glance, so that I can prioritize my work.\n\n#### Acceptance Criteria\n\n1. **WHEN** Stock View page loads **THEN** system **SHALL** display 4 stat cards:\n   - üì¶ Total Items (count of unique drugs)\n   - ‚ö†Ô∏è Low Stock (count below reorder point)\n   - üî¥ Expired (count of drugs with expired lots)\n   - ‚è∞ Near Expiry (count of lots expiring within 180 days)\n\n2. **WHEN** user clicks on stat card **THEN** system **SHALL** filter table to show only relevant items\n\n3. **WHEN** backend data updates **THEN** system **SHALL** refresh stat cards automatically (via WebSocket)\n\n### REQ-3: Lot Management Dialog\n\n**User Story:** As a pharmacist, I want to view all lots for a specific drug with FIFO/FEFO ordering, so that I can dispense the appropriate lot first.\n\n#### Acceptance Criteria\n\n1. **WHEN** user opens Lot Management dialog **THEN** system **SHALL** display:\n   - Drug name and total stock quantity\n   - Current location\n   - Table of all active lots with columns: Lot Number, Quantity, Unit Cost, Expiry Date, Days Left, FIFO Order, FEFO Order\n\n2. **WHEN** lots are displayed **THEN** system **SHALL** sort by FEFO order by default (expiring first)\n\n3. **WHEN** user toggles to FIFO mode **THEN** system **SHALL** re-sort lots by received date (oldest first)\n\n4. **WHEN** lot has <90 days until expiry **THEN** system **SHALL** highlight row with üî¥ critical status\n\n5. **WHEN** lot has 90-180 days until expiry **THEN** system **SHALL** highlight row with ‚ö†Ô∏è warning status\n\n6. **WHEN** lot has >180 days until expiry **THEN** system **SHALL** show ‚úì green status\n\n7. **WHEN** dialog displays **THEN** system **SHALL** show \"Next to Dispense\" recommendation (first lot in selected order)\n\n8. **WHEN** user closes dialog **THEN** system **SHALL** return to Stock View page\n\n### REQ-4: Stock Adjustment Dialog\n\n**User Story:** As a pharmacist, I want to adjust inventory quantities for various reasons (damage, expiry, physical count), so that records match physical stock.\n\n#### Acceptance Criteria\n\n1. **WHEN** user opens Stock Adjustment dialog **THEN** system **SHALL** display form with fields:\n   - Drug selector (dropdown, searchable)\n   - Location selector (dropdown)\n   - Current Stock (read-only, displayed after drug/location selected)\n   - Adjustment Type (radio: Add/Subtract/Set to Specific Amount)\n   - Quantity to Adjust (number input)\n   - Result Preview (calculated: current ¬± adjustment)\n   - Reason dropdown (required, populated from adjustment_reasons master data)\n   - Lot Number dropdown (optional, filtered by drug/location)\n   - Notes (textarea, optional)\n\n2. **WHEN** user selects \"Subtract\" and enters quantity **THEN** system **SHALL** validate that result ‚â• 0\n\n3. **IF** result would be negative **THEN** system **SHALL** display error \"Insufficient stock. Current: X, Requested: Y, Shortage: Z\"\n\n4. **WHEN** user selects lot number **THEN** system **SHALL** display lot details (expiry date, available quantity) below dropdown\n\n5. **WHEN** user clicks \"Post Adjustment\" **THEN** system **SHALL**:\n   - Validate all required fields\n   - Call POST /api/inventory/operations/inventory-adjustments API\n   - Display success message with new quantity\n   - Emit WebSocket event to refresh Stock View\n   - Close dialog and return to Stock View\n\n6. **WHEN** adjustment fails (API error) **THEN** system **SHALL** display error message and keep dialog open\n\n7. **WHEN** user clicks \"Cancel\" **THEN** system **SHALL** close dialog without saving\n\n### REQ-5: Low Stock Alert List\n\n**User Story:** As a inventory manager, I want to see all items below reorder point with suggested order quantities, so that I can plan purchases.\n\n#### Acceptance Criteria\n\n1. **WHEN** user clicks \"Low Stock\" stat card **THEN** system **SHALL** display filtered table with:\n   - Drug name\n   - Current stock quantity\n   - Min level / Reorder point / Max level\n   - Days of supply remaining\n   - Average daily usage (from last 90 days)\n   - Suggested order quantity (calculated: max_level - current_stock)\n   - Last received date\n\n2. **WHEN** urgency is CRITICAL (qty < min_level) **THEN** system **SHALL** highlight row with üî¥ red background\n\n3. **WHEN** urgency is LOW (qty <= reorder_point && qty >= min_level) **THEN** system **SHALL** highlight row with ‚ö†Ô∏è yellow background\n\n4. **WHEN** user clicks \"Create Purchase Request\" button **THEN** system **SHALL** navigate to Procurement module (future integration point)\n\n### REQ-6: Expiring Drugs Alert List\n\n**User Story:** As a pharmacist, I want to see all drugs with lots expiring soon, so that I can prioritize their dispensing or quarantine.\n\n#### Acceptance Criteria\n\n1. **WHEN** user clicks \"Near Expiry\" stat card **THEN** system **SHALL** display filtered table with:\n   - Drug name\n   - Lot number\n   - Quantity available\n   - Expiry date\n   - Days until expiry\n   - Unit cost\n   - Total value (quantity √ó unit_cost)\n\n2. **WHEN** days until expiry <30 **THEN** system **SHALL** highlight row with üî¥ CRITICAL status\n\n3. **WHEN** days until expiry 30-90 **THEN** system **SHALL** highlight row with ‚ö†Ô∏è WARNING status\n\n4. **WHEN** days until expiry 90-180 **THEN** system **SHALL** highlight row with ‚ÑπÔ∏è INFO status\n\n5. **WHEN** table displays **THEN** system **SHALL** sort by expiry date ascending (soonest first)\n\n6. **WHEN** table displays **THEN** system **SHALL** show summary footer:\n   - Total lots count\n   - Total value of expiring drugs\n   - Critical lots count (<90 days)\n   - Warning lots count (90-180 days)\n\n### REQ-7: Transaction History View\n\n**User Story:** As an auditor, I want to view complete transaction history for any drug, so that I can verify inventory accuracy.\n\n#### Acceptance Criteria\n\n1. **WHEN** user opens Transaction History page **THEN** system **SHALL** display filter controls:\n   - Drug selector (dropdown, searchable, optional)\n   - Location selector (dropdown, optional)\n   - Transaction Type selector (dropdown: All/RECEIVE/ISSUE/TRANSFER/ADJUST/RETURN)\n   - Date range picker (from date, to date)\n   - Search bar\n\n2. **WHEN** user applies filters **THEN** system **SHALL** display transaction table with columns:\n   - Date/Time\n   - Transaction Type (badge with color: green=RECEIVE, red=ISSUE, blue=TRANSFER, yellow=ADJUST)\n   - Drug name\n   - Location\n   - Quantity (+/-)\n   - Unit cost\n   - Reference ID (link to source document if applicable)\n   - Created by (user name)\n\n3. **WHEN** transactions list displays **THEN** system **SHALL** sort by created_at DESC (newest first)\n\n4. **WHEN** user clicks Reference ID link **THEN** system **SHALL** navigate to source document (e.g., receipt, adjustment) if available\n\n5. **WHEN** user clicks \"Export\" button **THEN** system **SHALL** download filtered transactions as Excel/CSV file\n\n### REQ-8: Stock Valuation Report\n\n**User Story:** As a finance officer, I want to view current inventory valuation, so that I can report asset values.\n\n#### Acceptance Criteria\n\n1. **WHEN** user opens Stock Valuation page **THEN** system **SHALL** display:\n   - Location selector (dropdown: All Locations or specific)\n   - As of date picker (optional, defaults to current date)\n   - Summary cards: Total Value, Drug Count, Total Quantity\n\n2. **WHEN** user selects \"All Locations\" **THEN** system **SHALL** display grouped table:\n   - Section header for each location\n   - Subtotal per location (drug count, total quantity, total value)\n   - Grand total footer (sum across all locations)\n\n3. **WHEN** user selects specific location **THEN** system **SHALL** display detailed table for that location:\n   - Drug name\n   - Quantity on hand\n   - Average unit cost\n   - Total value (quantity √ó average_cost)\n\n4. **WHEN** user clicks \"Export\" button **THEN** system **SHALL** download valuation report as Excel file with:\n   - Summary sheet (totals by location)\n   - Detail sheet (line-by-line drug valuation)\n\n5. **WHEN** \"As of Date\" is selected **THEN** system **SHALL** calculate historical valuation from transaction log (if implemented)\n\n### REQ-9: Real-Time Updates via WebSocket\n\n**User Story:** As a pharmacist, I want stock levels to update automatically when colleagues make changes, so that I always see current data without refreshing.\n\n#### Acceptance Criteria\n\n1. **WHEN** user is viewing Stock View page **THEN** system **SHALL** subscribe to WebSocket channel for current location\n\n2. **WHEN** another user posts inventory adjustment **THEN** system **SHALL**:\n   - Receive WebSocket event \"inventory:adjustment_created\"\n   - Update affected row in table (quantity, status)\n   - Update quick stats cards\n   - Display toast notification: \"Stock updated: [Drug name]\"\n\n3. **WHEN** another user posts receipt (from Procurement) **THEN** system **SHALL**:\n   - Receive WebSocket event \"inventory:receipt_posted\"\n   - Update affected rows in table\n   - Update quick stats\n   - Display toast notification: \"Receipt posted: [Receipt ID]\"\n\n4. **WHEN** another user transfers stock **THEN** system **SHALL**:\n   - Receive WebSocket events for both source and destination locations\n   - Update affected rows if user is viewing either location\n   - Display toast notification: \"Transfer completed: [Drug name]\"\n\n5. **WHEN** WebSocket connection is lost **THEN** system **SHALL**:\n   - Display warning banner: \"Live updates disconnected. Attempting to reconnect...\"\n   - Attempt reconnection every 5 seconds\n   - Remove warning banner when reconnected\n\n### REQ-10: Responsive Design and Accessibility\n\n**User Story:** As a user, I want the interface to work well on tablets and be accessible, so that I can work efficiently in various situations.\n\n#### Acceptance Criteria\n\n1. **WHEN** application loads on desktop (>1024px) **THEN** system **SHALL** display full table layout with all columns\n\n2. **WHEN** application loads on tablet (768px-1024px) **THEN** system **SHALL**:\n   - Hide less critical columns (e.g., last received date, average daily usage)\n   - Maintain core data visibility (drug name, quantity, status)\n   - Enable horizontal scroll for full table access\n\n3. **WHEN** application loads on mobile (<768px) **THEN** system **SHALL**:\n   - Switch to card layout (one drug per card)\n   - Display essential info: drug name, quantity, status, expiry\n   - Provide \"View Details\" button to expand card\n\n4. **WHEN** user navigates with keyboard **THEN** system **SHALL**:\n   - Support Tab key for navigation\n   - Support Enter key to activate buttons\n   - Support Arrow keys in dropdowns and tables\n   - Show visible focus indicators\n\n5. **WHEN** screen reader is active **THEN** system **SHALL**:\n   - Provide ARIA labels for all interactive elements\n   - Announce status changes (e.g., \"Stock level low\")\n   - Provide table headers for screen readers\n   - Announce toast notifications\n\n### REQ-11: Error Handling and User Feedback\n\n**User Story:** As a user, I want clear feedback when operations succeed or fail, so that I know the system status.\n\n#### Acceptance Criteria\n\n1. **WHEN** API call succeeds (adjustment, transfer) **THEN** system **SHALL** display success toast notification with action summary\n\n2. **WHEN** API call fails with validation error (400) **THEN** system **SHALL** display error message in dialog with specific field errors\n\n3. **WHEN** API call fails with authorization error (403) **THEN** system **SHALL** display error toast: \"You don't have permission for this action\"\n\n4. **WHEN** API call fails with not found error (404) **THEN** system **SHALL** display error toast: \"Record not found. It may have been deleted.\"\n\n5. **WHEN** API call fails with server error (500) **THEN** system **SHALL** display error toast: \"System error. Please try again or contact support.\"\n\n6. **WHEN** network request is pending **THEN** system **SHALL** display loading indicator (spinner or progress bar)\n\n7. **WHEN** data table is empty **THEN** system **SHALL** display empty state component with message and icon\n\n### REQ-12: Performance Optimization\n\n**User Story:** As a user, I want the application to load and respond quickly, so that I can work efficiently.\n\n#### Acceptance Criteria\n\n1. **WHEN** Stock View page loads **THEN** system **SHALL** render initial view within 2 seconds (excluding API latency)\n\n2. **WHEN** user types in search bar **THEN** system **SHALL** debounce input (wait 300ms after last keypress before filtering)\n\n3. **WHEN** table contains >100 rows **THEN** system **SHALL** implement virtual scrolling or pagination (20-50 rows per page)\n\n4. **WHEN** user switches tabs or navigates **THEN** system **SHALL** cache API responses for 5 minutes to reduce redundant calls\n\n5. **WHEN** images/icons load **THEN** system **SHALL** use lazy loading for images below the fold\n\n6. **WHEN** dialogs open **THEN** system **SHALL** use Angular animations for smooth transitions (300ms duration)\n\n## Non-Functional Requirements\n\n### Code Architecture and Modularity\n\n- **Single Responsibility Principle**: Each component should handle one UI concern (e.g., StockListComponent displays stock, StockAdjustmentDialogComponent handles adjustments)\n- **Smart/Dumb Component Pattern**: Container components manage state and API calls, presentation components receive data via @Input and emit events via @Output\n- **Service Layer**: Dedicated services for API communication (InventoryApiService), state management (InventoryStateService), and WebSocket (InventoryWebSocketService)\n- **Shared Module**: Reusable UI components (stat cards, data tables, dialogs) in shared module\n- **Routing Module**: Feature-based routing with lazy loading for inventory module\n\n### Technology Stack\n\n- **Framework**: Angular 17+ with standalone components\n- **UI Components**: AegisX UI library + Angular Material\n- **Styling**: TailwindCSS with custom design tokens\n- **State Management**: Angular Signals for reactive state\n- **Forms**: Angular Reactive Forms with validation\n- **HTTP**: HttpClient with interceptors for auth and error handling\n- **WebSocket**: Custom WebSocket service with reconnection logic\n- **Date Handling**: date-fns for date formatting and calculations\n- **Charts**: Chart.js or ng2-charts for visualizations (if needed)\n\n### Performance\n\n- **Initial Load Time**: <3 seconds for first contentful paint\n- **Time to Interactive**: <5 seconds on 3G network\n- **API Response Time**: Stock list <500ms, lot list <300ms\n- **WebSocket Latency**: Real-time updates received within 100ms\n- **Bundle Size**: Inventory feature module <500KB (gzipped)\n- **Memory Usage**: <50MB for stock list with 1000 items\n\n### Security\n\n- **Authentication**: JWT token in Authorization header for all API calls\n- **Authorization**: RBAC checks on frontend (hide/disable actions user can't perform)\n- **Input Validation**: Client-side validation for all form inputs\n- **XSS Prevention**: Sanitize all user-generated content before display\n- **HTTPS Only**: All API calls over HTTPS in production\n\n### Usability\n\n- **Accessibility**: WCAG 2.1 Level AA compliance\n- **Browser Support**: Chrome 90+, Firefox 88+, Safari 14+, Edge 90+\n- **Keyboard Navigation**: Full keyboard support without mouse\n- **Touch Support**: Touch-friendly UI on tablets (44px min touch targets)\n- **Internationalization**: Ready for Thai/English language support (i18n structure in place)\n\n### Reliability\n\n- **Offline Handling**: Display \"You are offline\" banner when network disconnected\n- **Error Recovery**: Retry failed API calls with exponential backoff (max 3 attempts)\n- **WebSocket Reconnection**: Automatic reconnection with exponential backoff\n- **Data Consistency**: Optimistic UI updates with rollback on error\n\n## Out of Scope\n\nThe following features are explicitly out of scope for this spec:\n\n1. **Purchase Request Creation**: Initiated from Low Stock list but handled by Procurement module\n2. **Receipt Posting**: Handled by Procurement module, inventory updates via backend workflow\n3. **Distribution/Dispensing**: Handled by Distribution module, lot deduction via backend workflow\n4. **User Management**: Handled by Platform RBAC module\n5. **Master Data Management**: Drug catalog, locations, adjustment reasons managed separately\n6. **Mobile App**: This spec covers responsive web app only, not native mobile app\n7. **Barcode Scanning**: Future enhancement, not in initial release\n8. **Batch Operations**: Single-item adjustments only, no bulk update UI\n9. **Advanced Analytics**: Basic reports only, dashboards in separate Analytics module\n\n## Dependencies\n\n### Backend APIs (from inventory-backend-api spec)\n\n- `GET /api/inventory/operations/inventory/stock` - List stock levels\n- `GET /api/inventory/operations/inventory/stock/:drugId/:locationId` - Get specific stock\n- `GET /api/inventory/operations/drug-lots` - List active lots\n- `GET /api/inventory/operations/drug-lots/expiring` - Get expiring lots\n- `GET /api/inventory/operations/drug-lots/:id` - Get lot details\n- `POST /api/inventory/operations/inventory-adjustments` - Create adjustment\n- `GET /api/inventory/operations/inventory-adjustments` - List adjustments\n- `PUT /api/inventory/operations/inventory/:id/min-max` - Update min/max levels\n- `POST /api/inventory/operations/inventory-transfers` - Create transfer\n- `GET /api/inventory/operations/inventory/low-stock` - Get low stock items\n- `GET /api/inventory/operations/inventory-transactions` - Transaction history\n- `GET /api/inventory/operations/inventory/valuation` - Stock valuation\n\n### Master Data\n\n- **Drugs**: From `public.drugs` table via separate API\n- **Locations**: From `public.locations` table via separate API\n- **Adjustment Reasons**: From `inventory.adjustment_reasons` via inventory API\n- **Users**: From Platform RBAC for \"Created By\" display\n\n### Shared Services\n\n- **AuthService**: For JWT token and user context\n- **PermissionService**: For RBAC permission checks\n- **WebSocketService**: For real-time updates\n- **ToastService**: For user notifications\n- **DialogService**: For modal dialogs\n\n## Success Metrics\n\n1. **Adoption**: >80% of pharmacists use system daily within 2 weeks of deployment\n2. **Efficiency**: Average time to post stock adjustment <2 minutes (vs 5 minutes in legacy system)\n3. **Accuracy**: Stock discrepancy rate <2% in physical counts\n4. **User Satisfaction**: System Usability Scale (SUS) score >75\n5. **Performance**: 95th percentile page load time <3 seconds\n6. **Error Rate**: <1% of inventory adjustments fail due to system errors\n",
  "fileStats": {
    "size": 21388,
    "lines": 442,
    "lastModified": "2025-12-14T13:41:53.063Z"
  },
  "comments": []
}