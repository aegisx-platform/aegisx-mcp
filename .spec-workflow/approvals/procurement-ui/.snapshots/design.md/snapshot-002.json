{
  "id": "snapshot_1765720374422_pk44kvl9k",
  "approvalId": "approval_1765720259423_p8qmvt2fh",
  "approvalTitle": "Procurement UI - Design Document",
  "version": 2,
  "timestamp": "2025-12-14T13:52:54.422Z",
  "trigger": "approved",
  "status": "pending",
  "content": "# Design Document - Procurement UI\n\n## Overview\n\nThe Procurement UI is an Angular 18+ frontend application that provides a complete user interface for procurement workflow management. It consists of 8 core modules (Purchase Requests, Purchase Orders, Receipts, Receipt Inspectors, Approval Documents, Payment Documents, and supporting modules) built using AegisX-UI components and Angular Material design system.\n\n**System Integration**: The UI integrates with the Procurement API backend (documented in procurement-api spec) and supports real-time collaboration via WebSocket, Excel/CSV import for bulk data entry, and complex multi-step approval workflows.\n\n**Technology Stack**:\n- **Framework**: Angular 18+ standalone components\n- **State Management**: Angular Signals (not NgRx)\n- **UI Library**: AegisX-UI components + Angular Material\n- **HTTP Client**: Angular HttpClient with RxJS\n- **Real-time**: WebSocket integration\n- **Forms**: Reactive Forms with TypeScript validation\n\n## Steering Document Alignment\n\n### Technical Standards (tech.md)\n\nThe design follows project technical standards:\n- **Component Architecture**: Standalone components with lazy loading\n- **State Management**: Angular Signals for reactive state (matching existing contracts module pattern)\n- **API Integration**: HttpClient service layer with signal-based state\n- **Routing**: Angular Router with lazy-loaded routes\n- **Styling**: TailwindCSS + Angular Material theme\n- **TypeScript**: Strict mode with full type safety\n\n### Project Structure (structure.md)\n\nImplementation follows established project organization:\n```\napps/web/src/app/features/inventory/modules/\n├── purchase-requests/          # PR module\n│   ├── components/\n│   │   ├── purchase-requests-list.component.ts\n│   │   ├── purchase-requests-create.dialog.ts\n│   │   ├── purchase-requests-edit.dialog.ts\n│   │   ├── purchase-requests-view.dialog.ts\n│   │   ├── purchase-requests-form.component.ts\n│   │   ├── purchase-requests-workflow.component.ts  # NEW: Workflow actions\n│   │   └── purchase-requests-items-table.component.ts\n│   ├── services/\n│   │   └── purchase-requests.service.ts\n│   ├── types/\n│   │   └── purchase-requests.types.ts\n│   └── purchase-requests.routes.ts\n├── purchase-orders/            # PO module\n├── receipts/                   # Receipt module\n├── receipt-inspectors/         # Inspector module\n├── approval-documents/         # Approval docs\n└── payment-documents/          # Payment docs\n```\n\n## Code Reuse Analysis\n\n### Existing Components to Leverage\n\n- **ContractService Pattern**: Use Signal-based state management pattern from `apps/web/src/app/features/inventory/modules/contracts/services/contracts.service.ts`\n- **List Component Pattern**: Follow structure from `contracts-list.component.ts` (ax-table, filters, dialogs)\n- **Form Component Pattern**: Reuse reactive form patterns from `contracts-form.component.ts`\n- **Upload Service**: Use existing `apps/web/src/app/shared/services/upload.service.ts` for file uploads\n- **Attachment Service**: Leverage `apps/web/src/app/shared/services/attachment.service.ts` for approval documents\n- **File Manager Service**: Use `apps/web/src/app/shared/services/file-manager.service.ts` for Excel/CSV import\n\n### Integration Points\n\n- **Procurement API**: Backend REST API at `/inventory/procurement/*` endpoints (from procurement-api spec)\n- **Budget API**: External Budget Management API for availability checks and reservations\n- **WebSocket**: Real-time updates via WebSocket connection for status changes\n- **Inventory API**: Read inventory stock levels for receipt pages\n- **Master Data**: Shared endpoints for drugs, departments, vendors, locations\n\n## Architecture\n\nThe Procurement UI follows a modular, component-based architecture with clear separation of concerns:\n\n### Modular Design Principles\n\n- **Single File Responsibility**: Each component handles one specific UI concern (list view, create form, workflow actions)\n- **Component Isolation**: Small, focused components with well-defined inputs/outputs\n- **Service Layer Separation**: Services handle all HTTP communication and state management\n- **Utility Modularity**: Shared utilities for validation, formatting, date handling\n\n### System Architecture\n\n```mermaid\ngraph TD\n    subgraph \"User Interface Layer\"\n        A[PR List Component] --> B[PR Service]\n        C[PO List Component] --> D[PO Service]\n        E[Receipt List Component] --> F[Receipt Service]\n        G[Workflow Components] --> B\n        G --> D\n        G --> F\n    end\n\n    subgraph \"Service Layer\"\n        B --> H[HttpClient]\n        D --> H\n        F --> H\n        I[WebSocket Service] --> J[Real-time Events]\n        K[Import Service] --> L[File Processing]\n    end\n\n    subgraph \"Backend Integration\"\n        H --> M[Procurement API]\n        H --> N[Budget API]\n        H --> O[Inventory API]\n        J --> P[WebSocket Server]\n    end\n\n    subgraph \"Shared Services\"\n        Q[Upload Service] --> H\n        R[Attachment Service] --> H\n        S[Notification Service]\n    end\n\n    M --> T[(PostgreSQL)]\n    N --> T\n    O --> T\n```\n\n### Data Flow Architecture\n\n```mermaid\nsequenceDiagram\n    participant User\n    participant Component\n    participant Service\n    participant API\n    participant WebSocket\n\n    User->>Component: Submit PR\n    Component->>Service: submitPR(prId)\n    Service->>Service: Set loading signal\n    Service->>API: POST /purchase-requests/:id/submit\n    API-->>Service: PR updated (SUBMITTED)\n    Service->>Service: Update contractsList signal\n    Service->>Service: Clear loading signal\n    Service-->>Component: Signal emits new state\n    Component-->>User: Display success toast\n\n    WebSocket->>Service: PR approved event\n    Service->>Service: Update signal with new status\n    Service-->>Component: Auto-refresh UI\n    Component-->>User: Show notification\n```\n\n## Components and Interfaces\n\n### 1. PurchaseRequestsListComponent\n\n- **Purpose:** Display paginated table of all purchase requests with filters and actions\n- **Interfaces:**\n  - Inputs: None (uses service signals)\n  - Outputs: None (uses dialogs for actions)\n- **Dependencies:**\n  - `PurchaseRequestsService` (for data and state)\n  - `ax-table` (AegisX table component)\n  - `ax-badge` (for status display)\n  - `ax-dialog` (for create/edit/view dialogs)\n- **Reuses:**\n  - Follows pattern from `ContractsListComponent`\n  - Uses shared `DateRangeFilterComponent`\n\n### 2. PurchaseRequestsFormComponent\n\n- **Purpose:** Reusable reactive form for creating/editing purchase requests\n- **Interfaces:**\n  - Inputs: `initialData: PurchaseRequest | null`, `mode: 'create' | 'edit'`\n  - Outputs: `onSave: EventEmitter<CreatePurchaseRequestRequest>`, `onCancel: EventEmitter<void>`\n- **Dependencies:**\n  - `ReactiveFormsModule`\n  - `ax-form` components\n  - `ax-autocomplete` (drug selection)\n  - `BudgetService` (budget availability check)\n- **Reuses:**\n  - Reactive form validation utilities\n  - AegisX form components\n  - Shared autocomplete patterns\n\n### 3. PurchaseRequestsWorkflowComponent\n\n- **Purpose:** Workflow action buttons for PR submission, approval, rejection\n- **Interfaces:**\n  - Inputs: `purchaseRequest: PurchaseRequest`, `userPermissions: string[]`\n  - Outputs: `onAction: EventEmitter<WorkflowAction>`\n- **Dependencies:**\n  - `PurchaseRequestsService`\n  - `ax-button`\n  - `ax-dialog` (confirmation dialogs)\n- **Reuses:**\n  - Shared confirmation dialog patterns\n\n### 4. PurchaseRequestsItemsTableComponent\n\n- **Purpose:** Display and manage PR line items (drugs, quantities, prices)\n- **Interfaces:**\n  - Inputs: `items: PurchaseRequestItem[]`, `editable: boolean`\n  - Outputs: `onItemChange: EventEmitter<PurchaseRequestItem[]>`, `onAddItem: EventEmitter<void>`, `onRemoveItem: EventEmitter<number>`\n- **Dependencies:**\n  - `ax-table`\n  - `ax-autocomplete` (drug search)\n  - `DrugsService` (drug catalog)\n- **Reuses:**\n  - Similar to `ContractItemsTableComponent`\n\n### 5. PurchaseOrdersListComponent\n\n- **Purpose:** Display paginated table of purchase orders with vendor and status filters\n- **Interfaces:**\n  - Inputs: None\n  - Outputs: None\n- **Dependencies:**\n  - `PurchaseOrdersService`\n  - `ax-table`\n  - `ax-badge`\n- **Reuses:**\n  - Same list pattern as PR list\n\n### 6. PurchaseOrdersWorkflowComponent\n\n- **Purpose:** PO-specific workflow (approve, send, cancel)\n- **Interfaces:**\n  - Inputs: `purchaseOrder: PurchaseOrder`, `userPermissions: string[]`\n  - Outputs: `onAction: EventEmitter<WorkflowAction>`\n- **Dependencies:**\n  - `PurchaseOrdersService`\n  - `ApprovalDocumentsService` (validate documents for PO > 100K)\n- **Reuses:**\n  - Workflow confirmation dialogs\n\n### 7. ReceiptsListComponent\n\n- **Purpose:** Display receipts with PO references and posting status\n- **Interfaces:**\n  - Inputs: None\n  - Outputs: None\n- **Dependencies:**\n  - `ReceiptsService`\n  - `ax-table`\n- **Reuses:**\n  - Standard list pattern\n\n### 8. ReceiptsFormComponent\n\n- **Purpose:** Form for creating/editing receipts with lot information\n- **Interfaces:**\n  - Inputs: `initialData: Receipt | null`, `poId: number | null`\n  - Outputs: `onSave: EventEmitter<CreateReceiptRequest>`\n- **Dependencies:**\n  - `ReactiveFormsModule`\n  - `ReceiptsService`\n  - `PurchaseOrdersService` (load PO items)\n  - `InventoryService` (display current stock)\n- **Reuses:**\n  - Form validation utilities\n  - Lot number/expiry date validators\n\n### 9. ReceiptInspectorsComponent\n\n- **Purpose:** Multi-select component for assigning inspector committee (minimum 3)\n- **Interfaces:**\n  - Inputs: `selectedInspectors: Employee[]`, `receiptId: number | null`\n  - Outputs: `onInspectorsChange: EventEmitter<Employee[]>`\n- **Dependencies:**\n  - `ax-multi-select`\n  - `EmployeesService`\n- **Reuses:**\n  - Shared multi-select patterns\n\n### 10. ApprovalDocumentsUploadComponent\n\n- **Purpose:** File upload widget for approval documents (PO > 100K)\n- **Interfaces:**\n  - Inputs: `poId: number`, `existingDocuments: ApprovalDocument[]`\n  - Outputs: `onUploadComplete: EventEmitter<ApprovalDocument>`\n- **Dependencies:**\n  - `UploadService` (shared)\n  - `ApprovalDocumentsService`\n  - `ax-upload`\n- **Reuses:**\n  - Existing `UploadService` from shared services\n\n### 11. PaymentDocumentsListComponent\n\n- **Purpose:** Display payment documents with receipt references\n- **Interfaces:**\n  - Inputs: None\n  - Outputs: None\n- **Dependencies:**\n  - `PaymentDocumentsService`\n  - `ax-table`\n- **Reuses:**\n  - Standard list pattern\n\n### 12. ExcelImportDialogComponent\n\n- **Purpose:** Dialog for importing PR items from Excel/CSV files\n- **Interfaces:**\n  - Inputs: `prId: number | null`\n  - Outputs: `onImportComplete: EventEmitter<PurchaseRequestItem[]>`\n- **Dependencies:**\n  - `FileManagerService` (shared)\n  - `ImportService`\n  - `ax-dialog`\n- **Reuses:**\n  - Existing `FileManagerService` for file parsing\n\n## Data Models\n\n### PurchaseRequest\n\n```typescript\ninterface PurchaseRequest {\n  id: number;\n  pr_code: string;\n  fiscal_year: number;\n  quarter: number;\n  budget_type_id: number;\n  department_id: number;\n  request_date: Date;\n  required_date: Date;\n  status: 'DRAFT' | 'SUBMITTED' | 'APPROVED' | 'REJECTED' | 'CONVERTED';\n  grand_total: number;\n  requester_id: number;\n  approver_id?: number;\n  approved_at?: Date;\n  rejection_reason?: string;\n  items: PurchaseRequestItem[];\n}\n```\n\n### PurchaseOrder\n\n```typescript\ninterface PurchaseOrder {\n  id: number;\n  po_code: string;\n  pr_id: number;\n  vendor_id: number;\n  po_date: Date;\n  delivery_date: Date;\n  status: 'DRAFT' | 'PENDING' | 'APPROVED' | 'SENT' | 'PARTIAL' | 'COMPLETED' | 'CANCELLED';\n  grand_total: number;\n  approval_document_id?: number;\n  items: PurchaseOrderItem[];\n}\n```\n\n### Receipt\n\n```typescript\ninterface Receipt {\n  id: number;\n  receipt_code: string;\n  po_id: number;\n  location_id: number;\n  receipt_date: Date;\n  received_by: number;\n  status: 'DRAFT' | 'INSPECTING' | 'ACCEPTED' | 'POSTED';\n  posted_by?: number;\n  posted_at?: Date;\n  items: ReceiptItem[];\n  inspectors: Employee[];\n}\n```\n\n### ReceiptItem\n\n```typescript\ninterface ReceiptItem {\n  id: number;\n  receipt_id: number;\n  po_item_id: number;\n  generic_id: number;\n  quantity_ordered: number;\n  quantity_received: number;\n  quantity_accepted: number;\n  lot_number: string;\n  manufacture_date: Date;\n  expiry_date: Date;\n  unit_price: number;\n}\n```\n\n### WorkflowAction\n\n```typescript\ntype WorkflowAction =\n  | { type: 'submit'; prId: number }\n  | { type: 'approve'; prId: number }\n  | { type: 'reject'; prId: number; reason: string }\n  | { type: 'approve_po'; poId: number }\n  | { type: 'send_po'; poId: number }\n  | { type: 'cancel_po'; poId: number; reason: string }\n  | { type: 'post_receipt'; receiptId: number };\n```\n\n## Service Layer Architecture\n\n### PurchaseRequestsService\n\n```typescript\n@Injectable({ providedIn: 'root' })\nexport class PurchaseRequestsService {\n  private http = inject(HttpClient);\n  private baseUrl = '/inventory/procurement/purchase-requests';\n\n  // ===== SIGNALS FOR STATE MANAGEMENT =====\n  private purchaseRequestsListSignal = signal<PurchaseRequest[]>([]);\n  private loadingSignal = signal<boolean>(false);\n  private errorSignal = signal<string | null>(null);\n  private selectedPurchaseRequestSignal = signal<PurchaseRequest | null>(null);\n\n  // ===== PUBLIC READONLY SIGNALS =====\n  readonly purchaseRequestsList = this.purchaseRequestsListSignal.asReadonly();\n  readonly loading = this.loadingSignal.asReadonly();\n  readonly error = this.errorSignal.asReadonly();\n\n  // ===== CRUD METHODS =====\n  loadList(query: ListPurchaseRequestQuery): Observable<PaginatedResponse<PurchaseRequest>>\n  getById(id: number): Observable<PurchaseRequest>\n  create(data: CreatePurchaseRequestRequest): Observable<PurchaseRequest>\n  update(id: number, data: UpdatePurchaseRequestRequest): Observable<PurchaseRequest>\n  delete(id: number): Observable<void>\n\n  // ===== WORKFLOW METHODS =====\n  submit(id: number): Observable<PurchaseRequest>\n  approve(id: number): Observable<PurchaseRequest>\n  reject(id: number, reason: string): Observable<PurchaseRequest>\n}\n```\n\n### WebSocketService\n\n```typescript\n@Injectable({ providedIn: 'root' })\nexport class WebSocketService {\n  private socket: WebSocket | null = null;\n  private eventsSubject = new Subject<WebSocketEvent>();\n\n  // Connect to WebSocket server\n  connect(url: string): void\n\n  // Subscribe to specific event type\n  on<T>(eventType: string): Observable<T>\n\n  // Send event to server\n  emit(eventType: string, data: any): void\n\n  // Disconnect\n  disconnect(): void\n}\n```\n\n### BudgetService\n\n```typescript\n@Injectable({ providedIn: 'root' })\nexport class BudgetService {\n  private http = inject(HttpClient);\n  private budgetApiUrl = environment.budgetApiUrl;\n\n  // Check budget availability\n  checkAvailability(params: BudgetCheckParams): Observable<BudgetAvailability>\n\n  // Get budget allocation details\n  getAllocation(allocationId: number): Observable<BudgetAllocation>\n}\n```\n\n### ImportService\n\n```typescript\n@Injectable({ providedIn: 'root' })\nexport class ImportService {\n  private fileManager = inject(FileManagerService);\n\n  // Parse Excel/CSV file\n  parseFile(file: File): Observable<any[]>\n\n  // Validate import data against template\n  validate(data: any[], template: ImportTemplate): ValidationResult\n\n  // Download import template\n  downloadTemplate(templateName: string): void\n}\n```\n\n## Error Handling\n\n### Error Scenarios\n\n1. **Budget Insufficient Error**\n   - **Handling:** Catch 400 error from POST /submit, extract budget shortage details\n   - **User Impact:** Display ax-alert with \"Budget insufficient: ฿X available, ฿Y needed, shortage ฿Z\"\n\n2. **Approval Document Missing (PO > 100K)**\n   - **Handling:** Validate before approve, check if approval_document_id exists\n   - **User Impact:** Disable \"Approve\" button, display warning \"Upload approval document required for PO > 100,000\"\n\n3. **Receipt Inspector Validation Error**\n   - **Handling:** Catch 400 error from POST /post, check if < 3 inspectors\n   - **User Impact:** Display ax-alert list with all validation errors (inspectors, lot info, etc.)\n\n4. **PO Cancellation with Receipts**\n   - **Handling:** Catch 400 error from POST /cancel, detect \"receipts exist\" error\n   - **User Impact:** Display ax-dialog \"Cannot cancel PO with existing receipts. Receipt codes: REC-2025-001\"\n\n5. **WebSocket Connection Lost**\n   - **Handling:** Detect disconnect event, attempt reconnect with exponential backoff\n   - **User Impact:** Display ax-toast warning \"Real-time updates disconnected. Reconnecting...\"\n\n6. **Excel Import Validation Error**\n   - **Handling:** Validate each row, collect all errors (invalid drug codes, negative quantities)\n   - **User Impact:** Display ax-table with row numbers and error messages, allow user to fix and retry\n\n7. **Permission Denied (403)**\n   - **Handling:** Catch 403 error, set permissionError signal\n   - **User Impact:** Hide action buttons, display \"You don't have permission to perform this action\"\n\n## Testing Strategy\n\n### Unit Testing\n\n- **Component Testing:**\n  - Test component rendering with mock data\n  - Test user interactions (button clicks, form submissions)\n  - Test signal updates and computed values\n  - Test error state display\n\n- **Service Testing:**\n  - Test HTTP calls with HttpClientTestingModule\n  - Test signal state management\n  - Test error handling and retry logic\n  - Test WebSocket event subscription\n\n- **Utilities Testing:**\n  - Test form validators (lot number, expiry date)\n  - Test date formatters and calculations\n  - Test Excel/CSV parsing logic\n\n### Integration Testing\n\n- **Service Integration:**\n  - Test service calling real backend endpoints (test environment)\n  - Test WebSocket connection and event handling\n  - Test budget API integration\n  - Test file upload flow\n\n- **Component Integration:**\n  - Test parent-child component communication\n  - Test dialog open/close and data passing\n  - Test form submission to service\n  - Test table filtering and pagination\n\n### End-to-End Testing\n\n**Test Scenario 1: Complete PR Workflow**\n1. User creates new PR with 3 items\n2. User submits PR (budget reserved)\n3. Manager approves PR\n4. WebSocket updates PR status in real-time\n5. Verify PR status = APPROVED\n\n**Test Scenario 2: PO Creation and Sending**\n1. User creates PO from approved PR\n2. User uploads approval document (PO > 100K)\n3. Manager approves PO\n4. User sends PO to vendor\n5. Verify budget committed, PR converted\n\n**Test Scenario 3: Receipt Posting**\n1. User creates receipt from sent PO\n2. User adds 3 inspectors\n3. User enters lot information for all items\n4. User posts receipt to inventory\n5. Verify inventory updated, PO status = COMPLETED\n\n**Test Scenario 4: Excel Import**\n1. User downloads PR import template\n2. User fills Excel with 50 items\n3. User imports file\n4. Verify all items added to PR form\n5. User submits PR successfully\n\n## Performance Optimization\n\n### Lazy Loading\n\n- All modules lazy-loaded via Angular Router\n- Components loaded on-demand when routes activate\n- Reduces initial bundle size\n\n### Change Detection Optimization\n\n- Use OnPush change detection strategy for all components\n- Signals automatically optimize change detection\n- Immutable data updates\n\n### API Caching\n\n- Cache master data (drugs, departments, vendors) in service signals\n- Cache TTL: 5 minutes\n- Invalidate on create/update/delete operations\n\n### Virtual Scrolling\n\n- Use CDK Virtual Scroll for large tables (> 100 rows)\n- Render only visible rows\n- Improves performance for large datasets\n\n### WebSocket Optimization\n\n- Subscribe only to relevant channels (specific PR/PO/Receipt)\n- Unsubscribe when leaving component\n- Debounce rapid updates (300ms)\n",
  "fileStats": {
    "size": 19802,
    "lines": 620,
    "lastModified": "2025-12-14T13:50:52.667Z"
  },
  "comments": []
}