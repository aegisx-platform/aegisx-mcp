{
  "id": "snapshot_1765691758260_3arbr47dy",
  "approvalId": "approval_1765691758242_3dxttfe42",
  "approvalTitle": "Design: Core Departments",
  "version": 1,
  "timestamp": "2025-12-14T05:55:58.260Z",
  "trigger": "initial",
  "status": "pending",
  "content": "# Design Document: Core Departments\n\n## Overview\n\nCore Departments module จะเป็น centralized module สำหรับจัดการข้อมูลแผนก/หน่วยงานขององค์กร โดยย้ายจาก `inventory.departments` มาเป็น `public.departments` และสร้าง API layer ใหม่ใน `/apps/api/src/core/departments/`\n\nModule นี้จะเป็น foundation ให้ระบบอื่นๆ ใช้งาน เช่น:\n- User management (user_departments)\n- ระบบหนังสือเวียน\n- ระบบจองรถ\n- ระบบห้องประชุม\n- ระบบคลังยา (ผ่าน extension)\n\n## Steering Document Alignment\n\n### Technical Standards (tech.md)\n\n- ใช้ **TypeBox** สำหรับ schema validation ตาม pattern ที่มีอยู่\n- ใช้ **BaseRepository** pattern ที่มีอยู่ใน codebase\n- ใช้ **Fastify plugin** pattern สำหรับ route registration\n- ใช้ **Knex** สำหรับ database operations\n\n### Project Structure (structure.md)\n\n```\napps/api/src/core/departments/\n├── index.ts                      # Plugin export\n├── departments.schemas.ts        # TypeBox schemas\n├── departments.types.ts          # TypeScript types\n├── departments.repository.ts     # Database operations\n├── departments.service.ts        # Business logic\n├── departments.controller.ts     # HTTP handlers\n├── departments.routes.ts         # Route definitions\n├── departments-import.service.ts # Import service (ย้ายจาก inventory)\n└── __tests__/\n    └── departments.test.ts\n```\n\n## Code Reuse Analysis\n\n### Existing Components to Leverage\n\n- **BaseRepository**: Extend สำหรับ CRUD operations\n  - Location: `apps/api/src/core/base/base.repository.ts`\n  - ใช้ pattern เดียวกับ departments ใน inventory\n\n- **BaseService**: Extend สำหรับ business logic\n  - Location: `apps/api/src/core/base/base.service.ts`\n\n- **BaseImportService**: Extend สำหรับ import functionality\n  - Location: `apps/api/src/core/import/base/base-import.service.ts`\n  - ใช้ @ImportService decorator\n\n- **UserDepartmentsRepository**: มีอยู่แล้ว ต้องปรับ FK\n  - Location: `apps/api/src/core/users/user-departments.repository.ts`\n\n### Integration Points\n\n- **Users Module**: user_departments table FK ไปที่ departments\n- **System Init**: Import discovery จะ detect departments-import.service.ts\n- **RBAC**: ใช้ permission pattern ที่มี (departments:read, departments:create, etc.)\n- **Inventory Extension**: Optional table สำหรับ consumption_group, his_code\n\n## Architecture\n\n```mermaid\ngraph TD\n    subgraph \"Core Module\"\n        A[departments.routes.ts] --> B[departments.controller.ts]\n        B --> C[departments.service.ts]\n        C --> D[departments.repository.ts]\n        D --> E[(public.departments)]\n    end\n\n    subgraph \"User Integration\"\n        F[user-departments.repository.ts] --> E\n        F --> G[(user_departments)]\n    end\n\n    subgraph \"Import System\"\n        H[departments-import.service.ts] --> D\n        I[ImportDiscoveryService] --> H\n    end\n\n    subgraph \"Inventory Extension (Optional)\"\n        J[(department_inventory_config)] --> E\n    end\n```\n\n### Modular Design Principles\n\n- **Single File Responsibility**: แต่ละ file มีหน้าที่เดียว (schema, repository, service, controller)\n- **Component Isolation**: Departments module แยกจาก inventory โดยสมบูรณ์\n- **Service Layer Separation**: Repository (DB) → Service (Logic) → Controller (HTTP)\n- **Utility Modularity**: ใช้ shared utilities จาก core/base\n\n## Components and Interfaces\n\n### DepartmentsRepository\n\n- **Purpose:** Database operations สำหรับ departments table\n- **Interfaces:**\n  ```typescript\n  findAll(options: ListOptions): Promise<{ data: Department[], total: number }>\n  findById(id: number): Promise<Department | null>\n  findByCode(code: string): Promise<Department | null>\n  create(data: CreateDepartment): Promise<Department>\n  update(id: number, data: UpdateDepartment): Promise<Department>\n  delete(id: number): Promise<void>\n  getHierarchy(parentId?: number): Promise<Department[]>\n  getDropdown(): Promise<DropdownItem[]>\n  ```\n- **Dependencies:** Knex, BaseRepository\n- **Reuses:** BaseRepository pattern จาก inventory/departments\n\n### DepartmentsService\n\n- **Purpose:** Business logic และ validation\n- **Interfaces:**\n  ```typescript\n  list(options: ListOptions): Promise<PaginatedResult<Department>>\n  getById(id: number): Promise<Department>\n  create(data: CreateDepartment, userId: string): Promise<Department>\n  update(id: number, data: UpdateDepartment, userId: string): Promise<Department>\n  delete(id: number): Promise<void>\n  canDelete(id: number): Promise<{ canDelete: boolean, reason?: string }>\n  ```\n- **Dependencies:** DepartmentsRepository\n- **Reuses:** BaseService pattern\n\n### DepartmentsController\n\n- **Purpose:** Handle HTTP requests และ response formatting\n- **Interfaces:**\n  ```typescript\n  list(request, reply): Promise<void>\n  getById(request, reply): Promise<void>\n  create(request, reply): Promise<void>\n  update(request, reply): Promise<void>\n  delete(request, reply): Promise<void>\n  dropdown(request, reply): Promise<void>\n  ```\n- **Dependencies:** DepartmentsService\n- **Reuses:** Controller pattern จาก users module\n\n### DepartmentsImportService\n\n- **Purpose:** Import departments via System Init\n- **Interfaces:**\n  ```typescript\n  getMetadata(): ImportServiceMetadata\n  getTemplateColumns(): TemplateColumn[]\n  validateRow(row, rowNumber): Promise<ValidationError[]>\n  insertBatch(batch, trx, options): Promise<Department[]>\n  performRollback(batchId, knex): Promise<number>\n  ```\n- **Dependencies:** BaseImportService, DepartmentsRepository\n- **Reuses:** BaseImportService, @ImportService decorator\n\n## Data Models\n\n### Department (Core)\n\n```typescript\ninterface Department {\n  id: number;                    // Primary key (SERIAL)\n  dept_code: string;             // Unique code (VARCHAR 10)\n  dept_name: string;             // Department name (VARCHAR 100)\n  parent_id: number | null;      // Self-reference for hierarchy\n  is_active: boolean;            // Active status (default: true)\n  import_batch_id: string | null; // For rollback tracking\n  created_at: Date;\n  updated_at: Date;\n}\n```\n\n### CreateDepartment\n\n```typescript\ninterface CreateDepartment {\n  dept_code: string;\n  dept_name: string;\n  parent_id?: number;\n  is_active?: boolean;\n}\n```\n\n### UpdateDepartment\n\n```typescript\ninterface UpdateDepartment {\n  dept_code?: string;\n  dept_name?: string;\n  parent_id?: number | null;\n  is_active?: boolean;\n}\n```\n\n### DepartmentInventoryConfig (Extension - Optional)\n\n```typescript\ninterface DepartmentInventoryConfig {\n  id: number;\n  department_id: number;         // FK to departments\n  consumption_group: string;     // GROUP_1 to GROUP_9\n  his_code: string | null;       // HIS integration code\n  created_at: Date;\n  updated_at: Date;\n}\n```\n\n## Database Migration Plan\n\n### Step 1: Create new table in public schema\n\n```sql\nCREATE TABLE public.departments (\n  id SERIAL PRIMARY KEY,\n  dept_code VARCHAR(10) NOT NULL UNIQUE,\n  dept_name VARCHAR(100) NOT NULL,\n  parent_id INTEGER REFERENCES public.departments(id),\n  is_active BOOLEAN DEFAULT true,\n  import_batch_id VARCHAR(100),\n  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),\n  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()\n);\n\nCREATE INDEX idx_departments_parent ON public.departments(parent_id);\nCREATE INDEX idx_departments_active ON public.departments(is_active);\nCREATE INDEX idx_departments_batch ON public.departments(import_batch_id);\n```\n\n### Step 2: Migrate data from inventory.departments\n\n```sql\nINSERT INTO public.departments (id, dept_code, dept_name, parent_id, is_active, created_at, updated_at)\nSELECT id, dept_code, dept_name, parent_id, is_active, created_at, updated_at\nFROM inventory.departments;\n\n-- Reset sequence\nSELECT setval('public.departments_id_seq', (SELECT MAX(id) FROM public.departments));\n```\n\n### Step 3: Update user_departments FK\n\n```sql\nALTER TABLE user_departments\n  DROP CONSTRAINT user_departments_department_id_fkey,\n  ADD CONSTRAINT user_departments_department_id_fkey\n    FOREIGN KEY (department_id) REFERENCES public.departments(id) ON DELETE CASCADE;\n```\n\n### Step 4: Create inventory extension table (optional)\n\n```sql\nCREATE TABLE inventory.department_inventory_config (\n  id SERIAL PRIMARY KEY,\n  department_id INTEGER NOT NULL REFERENCES public.departments(id) ON DELETE CASCADE,\n  consumption_group VARCHAR(20),\n  his_code VARCHAR(20),\n  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),\n  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),\n  UNIQUE(department_id)\n);\n\n-- Migrate existing data\nINSERT INTO inventory.department_inventory_config (department_id, consumption_group, his_code)\nSELECT id, consumption_group, his_code\nFROM inventory.departments\nWHERE consumption_group IS NOT NULL OR his_code IS NOT NULL;\n```\n\n### Step 5: Update inventory FKs to point to public.departments\n\n```sql\n-- For each table that references inventory.departments\nALTER TABLE inventory.budget_allocations\n  DROP CONSTRAINT budget_allocations_department_id_fkey,\n  ADD CONSTRAINT budget_allocations_department_id_fkey\n    FOREIGN KEY (department_id) REFERENCES public.departments(id);\n\n-- Repeat for: budget_plans, purchase_requests, drug_distributions, drug_returns\n```\n\n### Step 6: Drop old table (after verification)\n\n```sql\nDROP TABLE inventory.departments;\n```\n\n## API Endpoints\n\n| Method | Endpoint | Description | Permission |\n|--------|----------|-------------|------------|\n| GET | `/api/departments` | List departments with pagination | departments:read |\n| GET | `/api/departments/:id` | Get department by ID | departments:read |\n| POST | `/api/departments` | Create department | departments:create |\n| PUT | `/api/departments/:id` | Update department | departments:update |\n| DELETE | `/api/departments/:id` | Delete department | departments:delete |\n| GET | `/api/departments/dropdown` | Get dropdown list | departments:read |\n| GET | `/api/departments/hierarchy` | Get hierarchical tree | departments:read |\n\n## Error Handling\n\n### Error Scenarios\n\n1. **Department not found**\n   - **Handling:** Return 404 with error code `DEPARTMENT_NOT_FOUND`\n   - **User Impact:** \"Department with ID {id} not found\"\n\n2. **Duplicate dept_code**\n   - **Handling:** Return 409 with error code `DEPARTMENT_CODE_EXISTS`\n   - **User Impact:** \"Department code '{code}' already exists\"\n\n3. **Cannot delete - has references**\n   - **Handling:** Return 422 with error code `DEPARTMENT_HAS_REFERENCES`\n   - **User Impact:** \"Cannot delete department. It has {count} user assignments and {count} child departments\"\n\n4. **Invalid parent_id**\n   - **Handling:** Return 400 with error code `INVALID_PARENT_ID`\n   - **User Impact:** \"Parent department with ID {id} does not exist\"\n\n5. **Circular hierarchy**\n   - **Handling:** Return 400 with error code `CIRCULAR_HIERARCHY`\n   - **User Impact:** \"Cannot set parent: would create circular hierarchy\"\n\n## Testing Strategy\n\n### Unit Testing\n\n- Repository methods: CRUD operations, hierarchy queries\n- Service methods: Validation logic, business rules\n- Controller: Request/response handling\n\n### Integration Testing\n\n- API endpoints: Full request/response cycle\n- Database operations: Transaction handling, FK constraints\n- Import service: Template generation, validation, batch insert\n\n### End-to-End Testing\n\n- Create department → Assign to user → Verify user profile\n- Import departments → Verify hierarchy → Test dropdown\n- Delete with references → Verify error handling\n\n## Implementation Order\n\n1. **Database Migration** - สร้าง table และ migrate data\n2. **Core Module** - Repository, Service, Controller, Routes\n3. **Import Service** - ย้ายและปรับปรุง import service\n4. **Update user_departments** - ปรับ FK และ test\n5. **Inventory Extension** - สร้าง extension table (optional)\n6. **Cleanup** - ลบ old table และ code\n",
  "fileStats": {
    "size": 12429,
    "lines": 355,
    "lastModified": "2025-12-14T05:55:52.861Z"
  },
  "comments": []
}
