{
  "id": "snapshot_1765794817625_qdhobqf17",
  "approvalId": "approval_1765794231490_e41fhne3o",
  "approvalTitle": "Phase 2: Design Document",
  "version": 2,
  "timestamp": "2025-12-15T10:33:37.625Z",
  "trigger": "approved",
  "status": "pending",
  "content": "# Design Document\n\n## Overview\n\nThis design document outlines the technical approach for refactoring inventory frontend routes to align with the backend's layer-based architecture. The refactoring corrects API endpoint assignments, ensuring Platform Layer resources (shared services) use `/v1/platform/*` endpoints while Domain Layer resources (inventory-specific) continue using `/inventory/*` endpoints. This eliminates 404 errors and establishes proper architectural boundaries.\n\n**Scope:**\n- 1 service requiring endpoint change (departments)\n- 1 component requiring refactoring (budget requests form)\n- 26 services verified as correct (no changes)\n- Testing strategy to ensure no regressions\n\n## Steering Document Alignment\n\n### Technical Standards (tech.md)\n\nThis design follows established architectural patterns:\n- **Layer-Based Routing**: Separates Platform Layer (shared) from Domain Layer (business-specific)\n- **Service Layer Pattern**: Components use services instead of direct HTTP calls\n- **Angular Proxy Configuration**: Relies on existing proxy to prepend `/api` prefix\n- **TypeScript Type Safety**: Maintains existing service interfaces and types\n\n### Project Structure (structure.md)\n\nFile organization follows existing conventions:\n- Services: `apps/web/src/app/features/inventory/modules/{module}/services/{module}.service.ts`\n- Components: `apps/web/src/app/features/inventory/modules/{module}/components/*.component.ts`\n- No new directories created\n- Minimal file modifications (2 files only)\n\n## Code Reuse Analysis\n\n### Existing Components to Leverage\n\n- **DepartmentService**: Existing service will be updated (baseUrl change only)\n- **HttpClient**: Angular's built-in HTTP client (no changes)\n- **Angular Proxy**: Existing `proxy.conf.js` handles `/api` prefix prepending\n- **Service Base Pattern**: All services follow consistent CRUD pattern\n\n### Integration Points\n\n- **Backend Platform API**: `/api/v1/platform/departments` endpoint (already exists)\n- **Backend Domain APIs**: `/api/inventory/*` endpoints (unchanged)\n- **Angular Router**: No changes to route configuration\n- **Authentication Guards**: No changes to existing auth middleware\n\n## Architecture\n\n### Routing Layer Distinction\n\nThe backend uses a two-layer routing architecture:\n\n```\nBackend API Structure:\n├── Platform Layer (/api/v1/platform/*)\n│   ├── departments     ← Shared across all domains\n│   ├── users\n│   ├── rbac\n│   └── settings\n│\n└── Domain Layer (/api/{domain}/*)\n    └── inventory\n        ├── master-data\n        │   ├── drugs           ← Inventory-specific\n        │   ├── budgets\n        │   ├── hospitals\n        │   └── ...\n        ├── operations\n        │   ├── budget-allocations\n        │   └── ...\n        └── budget\n            ├── budget-requests\n            └── ...\n```\n\n### Modular Design Principles\n\n- **Single File Responsibility**: Each service handles API calls for one resource only\n- **Component Isolation**: Components depend on services, not direct HTTP calls\n- **Service Layer Separation**: Clear boundary between presentation and data access\n- **No Breaking Changes**: Existing functionality maintained, only endpoint URLs change\n\n### Routing Decision Matrix\n\n| Resource Type | Characteristics | Correct Layer | Endpoint Pattern |\n|--------------|-----------------|---------------|------------------|\n| **Platform** | Shared across all domains | Platform Layer | `/v1/platform/{resource}` |\n|              | Organization structure | | Example: `/v1/platform/departments` |\n|              | User management | | |\n| **Domain** | Business-specific | Domain Layer | `/inventory/{section}/{resource}` |\n|            | Unique to inventory | | Example: `/inventory/master-data/drugs` |\n|            | Not shared | | |\n\n### Architecture Diagram\n\n```mermaid\ngraph TD\n    A[Angular Components] --> B[Service Layer]\n    B --> C{Angular Proxy}\n    C --> D[Platform API<br/>/api/v1/platform/*]\n    C --> E[Domain API<br/>/api/inventory/*]\n\n    D --> F[Departments<br/>Users<br/>RBAC]\n    E --> G[Drugs<br/>Budgets<br/>Contracts<br/>etc.]\n\n    style D fill:#e1f5fe\n    style E fill:#fff3e0\n    style F fill:#e1f5fe\n    style G fill:#fff3e0\n```\n\n## Components and Interfaces\n\n### Component 1: DepartmentService\n\n- **Purpose:** Handles all API calls for departments resource\n- **Current Issue:** Uses incorrect Domain Layer endpoint\n- **Fix:** Change baseUrl to Platform Layer endpoint\n- **Interfaces:**\n  ```typescript\n  interface DepartmentService {\n    getAll(params?: PaginationParams): Observable<PaginatedResponse<Department>>;\n    getById(id: string): Observable<Department>;\n    create(data: CreateDepartmentDto): Observable<Department>;\n    update(id: string, data: UpdateDepartmentDto): Observable<Department>;\n    delete(id: string): Observable<void>;\n  }\n  ```\n- **Dependencies:** HttpClient, Angular Router\n- **Reuses:** Standard CRUD service pattern used across all modules\n\n### Component 2: BudgetRequestsFormComponent\n\n- **Purpose:** Form for creating/editing budget requests\n- **Current Issue:** Makes direct HTTP call to departments endpoint\n- **Fix:** Inject and use DepartmentService instead\n- **Interfaces:**\n  ```typescript\n  interface BudgetRequestsFormComponent {\n    loadDepartments(): void;  // Refactor to use service\n    // Other form methods unchanged\n  }\n  ```\n- **Dependencies:** DepartmentService (to be injected), FormBuilder, HttpClient (to be removed)\n- **Reuses:** Service injection pattern used in other components\n\n### Component 3: All Other Inventory Services (26 services)\n\n- **Purpose:** Handle API calls for inventory-specific resources\n- **Status:** ✅ Already correct, no changes needed\n- **Verification:** Confirm all continue to work after refactoring\n- **Reuses:** Same service pattern as departments (ensures consistency)\n\n## Data Models\n\n### Department Model (Unchanged)\n\n```typescript\ninterface Department {\n  id: string;                    // UUID\n  name: string;                  // Department name\n  code?: string;                 // Optional department code\n  description?: string;          // Optional description\n  active: boolean;               // Active status\n  createdAt: string;            // ISO timestamp\n  updatedAt: string;            // ISO timestamp\n}\n```\n\n### PaginatedResponse<T> (Unchanged)\n\n```typescript\ninterface PaginatedResponse<T> {\n  data: T[];                     // Array of items\n  total: number;                 // Total count\n  page: number;                  // Current page\n  limit: number;                 // Items per page\n  totalPages: number;            // Total pages\n}\n```\n\n### API Request/Response Formats (Unchanged)\n\nAll request and response formats remain the same. Only the endpoint URL changes.\n\n## Error Handling\n\n### Error Scenarios\n\n1. **404 Not Found (Current Issue)**\n   - **Handling:** Fixed by using correct endpoint\n   - **Before:** `/api/inventory/master-data/departments` → 404\n   - **After:** `/api/v1/platform/departments` → 200 OK\n   - **User Impact:** Departments page will load successfully\n\n2. **Service Injection Failure**\n   - **Handling:** Angular DI will throw error at compile time\n   - **Prevention:** Ensure DepartmentService is provided in root\n   - **User Impact:** Development error only, caught before deployment\n\n3. **Network Errors**\n   - **Handling:** Existing error handling in services (unchanged)\n   - **User Impact:** Same error messages as before\n   - **Recovery:** Standard retry mechanisms apply\n\n4. **Permission Errors (403)**\n   - **Handling:** Existing RBAC error handling (unchanged)\n   - **User Impact:** Same permission denied messages\n   - **Recovery:** User must request appropriate permissions\n\n## Testing Strategy\n\n### Unit Testing\n\n**DepartmentService:**\n- Test baseUrl is set to `/v1/platform/departments`\n- Mock HttpClient to verify correct endpoint is called\n- Test all CRUD methods still work with new endpoint\n- Verify existing service tests pass with updated baseUrl\n\n**BudgetRequestsFormComponent:**\n- Test loadDepartments() uses DepartmentService\n- Mock DepartmentService instead of HttpClient\n- Verify departments dropdown populates correctly\n- Ensure form submission includes selected department\n\n### Integration Testing\n\n**Departments Module:**\n- Test complete CRUD workflow:\n  1. List departments → verify data loads from platform API\n  2. Create department → verify POST to platform API\n  3. Update department → verify PUT to platform API\n  4. Delete department → verify DELETE to platform API\n- Verify pagination, search, and filtering work correctly\n\n**Budget Requests Form:**\n- Test form workflow:\n  1. Open form → verify departments dropdown loads\n  2. Select department → verify form state updates\n  3. Submit form → verify department ID saved correctly\n- Verify integration with DepartmentService\n\n**Regression Testing:**\n- Test all 26 inventory modules still work:\n  - Drugs CRUD\n  - Budgets CRUD\n  - Contracts CRUD\n  - Budget Allocations\n  - Budget Plans\n  - All other modules in inventory\n\n### End-to-End Testing\n\n**Critical User Journeys:**\n\n1. **Departments Management:**\n   - Navigate to inventory → master-data → departments\n   - Verify list loads without errors\n   - Create new department\n   - Edit existing department\n   - Delete department\n   - Verify no console errors or network 404s\n\n2. **Budget Request Creation:**\n   - Navigate to inventory → budget → budget-requests\n   - Click \"Create New\"\n   - Verify departments dropdown loads\n   - Fill form and select department\n   - Submit and verify success\n\n3. **Regression Test - Other Modules:**\n   - Spot check 3-5 other modules (drugs, budgets, contracts)\n   - Verify list pages load\n   - Test one CRUD operation per module\n   - Confirm no unintended side effects\n\n### Network Tab Verification\n\nUse browser DevTools to verify:\n- ✅ All requests to `/api/v1/platform/departments` return 200 OK\n- ❌ No requests to `/api/inventory/master-data/departments` (old endpoint)\n- ✅ All inventory domain requests continue to work\n- ✅ Response formats match expected schemas\n\n### Manual Testing Checklist\n\n**Before Deployment:**\n- [ ] Run `pnpm run build` → must pass without errors\n- [ ] Start dev server → no console errors on startup\n- [ ] Test departments module → all CRUD operations work\n- [ ] Test budget requests form → departments dropdown loads\n- [ ] Spot check 5 other inventory modules → verify still work\n- [ ] Check Network tab → no 404 errors\n- [ ] Verify console logs → no new errors or warnings\n\n## Rollback Plan\n\n### Immediate Rollback (If Critical Issues)\n\n```bash\n# Revert the commit\ngit revert <commit-hash>\n\n# Rebuild\npnpm run build\n\n# Redeploy\n# (follow standard deployment process)\n```\n\n### Temporary Backend Alias (Alternative)\n\nIf frontend rollback isn't possible, add temporary backend alias:\n\n```typescript\n// Backend: Add alias route\napp.get('/api/inventory/master-data/departments', (req, res) => {\n  // Forward to platform endpoint\n  return platformDepartmentsController.handle(req, res);\n});\n```\n\nThis provides backward compatibility while frontend is fixed.\n\n### Rollback Decision Criteria\n\nRollback if ANY of these occur:\n- Departments CRUD completely broken\n- Other inventory modules stop working\n- Critical 500 errors in production\n- Data corruption detected\n\nDo NOT rollback for:\n- Minor UI glitches (fix forward)\n- Non-critical console warnings\n- Performance issues (optimize forward)\n\n## File Modification Details\n\n### File 1: departments.service.ts\n\n**Path:** `apps/web/src/app/features/inventory/modules/departments/services/departments.service.ts`\n\n**Change:** Single line modification\n\n```typescript\n// BEFORE:\nprivate baseUrl = '/inventory/master-data/departments';\n\n// AFTER:\nprivate baseUrl = '/v1/platform/departments';\n```\n\n**Impact:** All department API calls now target platform endpoint\n**Risk Level:** Low (only URL change, logic unchanged)\n**Testing:** Existing unit tests should pass with updated baseUrl\n\n### File 2: budget-requests-form.component.ts\n\n**Path:** `apps/web/src/app/features/inventory/modules/budget-requests/components/budget-requests-form.component.ts`\n\n**Changes:**\n1. Inject DepartmentService\n2. Replace direct HTTP call with service call\n3. Update error handling if needed\n\n```typescript\n// BEFORE:\nloadDepartments(): void {\n  this.http.get<any>('/api/inventory/master-data/departments', {\n    params: new HttpParams().set('page', '1').set('limit', '1000')\n  }).subscribe({ /* ... */ });\n}\n\n// AFTER:\nprivate departmentService = inject(DepartmentService);\n\nloadDepartments(): void {\n  this.departmentService.getAll({ page: 1, limit: 1000 }).subscribe({\n    next: (response) => {\n      this.departments.set(response.data);\n      this.loadingDepartments.set(false);\n    },\n    error: (error) => {\n      console.error('Error loading departments:', error);\n      this.loadingDepartments.set(false);\n    }\n  });\n}\n```\n\n**Impact:** Component now follows service layer pattern\n**Risk Level:** Low (improves architecture, easier to test)\n**Testing:** Existing component tests should be updated to mock DepartmentService\n\n## Success Criteria\n\n### Technical Success Metrics\n\n- ✅ All API calls to departments return 200 OK (not 404)\n- ✅ TypeScript compilation succeeds without errors\n- ✅ All existing tests pass (with updated mocks)\n- ✅ No new ESLint warnings introduced\n- ✅ Build completes successfully\n\n### Functional Success Metrics\n\n- ✅ Departments list page loads data correctly\n- ✅ Departments CRUD operations all work\n- ✅ Budget requests form departments dropdown populates\n- ✅ All 26 inventory modules continue to work\n- ✅ No 404 errors in Network tab\n\n### Quality Success Metrics\n\n- ✅ Code follows existing patterns and conventions\n- ✅ Service layer architecture maintained\n- ✅ No direct HTTP calls in components\n- ✅ Clear distinction between Platform and Domain layers\n\n## Future Enhancements\n\n### Shared Platform Services\n\nCreate centralized platform services instead of duplicating across domains:\n\n```\napps/web/src/app/core/services/platform/\n├── departments.service.ts    → /v1/platform/departments\n├── users.service.ts          → /v1/platform/users\n├── rbac.service.ts           → /v1/platform/rbac/*\n└── settings.service.ts       → /v1/platform/settings\n```\n\n**Benefits:**\n- Single source of truth for platform resources\n- Reduce code duplication\n- Easier to maintain and test\n- Better type safety and IntelliSense\n\n### Environment-Based API Configuration\n\nConsider adding API prefix configuration to environment files:\n\n```typescript\n// environment.ts\nexport const environment = {\n  production: false,\n  apiPrefix: '/api',\n  platformPrefix: '/api/v1/platform',\n  inventoryPrefix: '/api/inventory',\n};\n\n// Usage in service:\nprivate baseUrl = `${environment.platformPrefix}/departments`;\n```\n\n**Benefits:**\n- Easier to change API structure in future\n- Support different environments (dev, staging, prod)\n- Clearer intent in code\n\n### Service Generator Update\n\nUpdate CRUD generator to automatically detect Platform vs Domain resources:\n\n```bash\n# Generator asks: \"Is this a platform resource?\"\n# If yes → uses /v1/platform/{resource}\n# If no → uses /inventory/{section}/{resource}\n```\n\nThis prevents future misconfigurations.\n",
  "fileStats": {
    "size": 15377,
    "lines": 475,
    "lastModified": "2025-12-15T10:23:42.950Z"
  },
  "comments": []
}
