{
  "id": "snapshot_1765722011464_wshy05cbb",
  "approvalId": "approval_1765721961844_aatsyavcy",
  "approvalTitle": "Design Document - Distribution Frontend UI",
  "version": 2,
  "timestamp": "2025-12-14T14:20:11.464Z",
  "trigger": "approved",
  "status": "pending",
  "content": "# Design Document - Distribution Frontend UI\n\n## Architecture Overview\n\nThe Distribution Frontend UI follows Angular 18+ standalone component architecture with Signals-based reactive state management. The design implements a feature module with lazy loading, smart/dumb component pattern, comprehensive workflow dialogs, and real-time updates via WebSocket.\n\n### High-Level Architecture\n\n```mermaid\ngraph TB\n    subgraph \"Distribution Feature Module\"\n        Router[Distribution Router]\n\n        subgraph \"Container Components (Smart)\"\n            DistList[DistributionListPage]\n            DistDetail[DistributionDetailPage]\n            DeptHistory[DepartmentHistoryPage]\n            UsageReport[UsageReportPage]\n        end\n\n        subgraph \"Presentation Components (Dumb)\"\n            DistTable[DistributionTableComponent]\n            QuickStats[QuickStatsComponent]\n            StatusBadge[StatusBadgeComponent]\n            ItemsTable[DistributionItemsTableComponent]\n            TimelineComponent[AuditTimelineComponent]\n        end\n\n        subgraph \"Dialogs (Smart)\"\n            CreateDialog[CreateDistributionDialog]\n            ApproveDialog[ApproveDistributionDialog]\n            CancelDialog[CancelDistributionDialog]\n            DispenseDialog[DispenseDistributionDialog]\n            CompleteDialog[CompleteDistributionDialog]\n            PreviewLotsDialog[PreviewFifoLotsDialog]\n        end\n\n        subgraph \"Services\"\n            DistApi[DistributionApiService]\n            DistState[DistributionStateService]\n            DistWS[DistributionWebSocketService]\n        end\n\n        subgraph \"Models\"\n            Interfaces[TypeScript Interfaces]\n            Enums[Enums & Constants]\n        end\n    end\n\n    Router --> DistList\n    Router --> DistDetail\n    Router --> DeptHistory\n    Router --> UsageReport\n\n    DistList --> DistTable\n    DistList --> QuickStats\n    DistList --> CreateDialog\n\n    DistDetail --> ItemsTable\n    DistDetail --> StatusBadge\n    DistDetail --> TimelineComponent\n    DistDetail --> ApproveDialog\n    DistDetail --> CancelDialog\n    DistDetail --> DispenseDialog\n    DistDetail --> CompleteDialog\n    DistDetail --> PreviewLotsDialog\n\n    DistList --> DistState\n    DistDetail --> DistState\n    DistState --> DistApi\n    DistState --> DistWS\n\n    DistApi --> Backend[Backend API - 15 Endpoints]\n    DistWS --> WSServer[WebSocket Server]\n```\n\n### Technology Stack\n\n- **Framework**: Angular 18+ (standalone components)\n- **State Management**: Angular Signals + RxJS (for async operations)\n- **UI Library**: AegisX UI + Angular Material\n- **Styling**: TailwindCSS with custom design tokens\n- **Forms**: Angular Reactive Forms with custom validators\n- **HTTP**: HttpClient with interceptors\n- **WebSocket**: Custom service with auto-reconnect\n- **Routing**: Feature-based lazy loading\n- **Date**: date-fns for formatting and calculations\n- **Export**: xlsx library for Excel export\n- **Validation**: Real-time stock validation\n\n---\n\n## Component Specifications\n\n### 1. DistributionListPage (Container Component)\n\n**Path**: `apps/admin/src/app/pages/distribution/distribution-list/distribution-list.page.ts`\n\n**Responsibility**: Main container for distribution list with filtering, search, and quick stats.\n\n**TypeScript Interface**:\n\n```typescript\n@Component({\n  selector: 'dist-distribution-list-page',\n  standalone: true,\n  imports: [\n    CommonModule,\n    RouterModule,\n    DistributionTableComponent,\n    QuickStatsComponent,\n    CreateDistributionDialog,\n    AxSelect,\n    AxInput,\n    AxButton,\n    AxDateRangePicker,\n    AxSkeleton\n  ],\n  templateUrl: './distribution-list.page.html',\n})\nexport class DistributionListPage implements OnInit, OnDestroy {\n  // Signals\n  distributions = signal<Distribution[]>([]);\n  quickStats = computed(() => this.calculateStats(this.distributions()));\n\n  // Filters\n  statusFilter = signal<DistributionStatus | 'ALL'>('ALL');\n  departmentFilter = signal<string | null>(null);\n  locationFilter = signal<string | null>(null);\n  dateRange = signal<{ from: Date | null; to: Date | null }>({ from: null, to: null });\n  searchTerm = signal<string>('');\n  isLoading = signal<boolean>(false);\n\n  // Filtered distributions\n  filteredDistributions = computed(() => {\n    let items = this.distributions();\n    const status = this.statusFilter();\n    const dept = this.departmentFilter();\n    const location = this.locationFilter();\n    const search = this.searchTerm().toLowerCase();\n    const dateRange = this.dateRange();\n\n    if (status !== 'ALL') {\n      items = items.filter(d => d.status === status);\n    }\n\n    if (dept) {\n      items = items.filter(d => d.requestingDeptId === dept);\n    }\n\n    if (location) {\n      items = items.filter(d => d.fromLocationId === location);\n    }\n\n    if (search) {\n      items = items.filter(d =>\n        d.distributionNumber.toLowerCase().includes(search) ||\n        d.requestingDept.name.toLowerCase().includes(search)\n      );\n    }\n\n    if (dateRange.from && dateRange.to) {\n      items = items.filter(d => {\n        const distDate = new Date(d.distributionDate);\n        return distDate >= dateRange.from! && distDate <= dateRange.to!;\n      });\n    }\n\n    return items;\n  });\n\n  // Master data\n  departments = signal<Department[]>([]);\n  locations = signal<Location[]>([]);\n\n  constructor(\n    private distributionState: DistributionStateService,\n    private dialog: MatDialog,\n    private router: Router,\n  ) {}\n\n  ngOnInit(): void {\n    this.loadDistributions();\n    this.loadMasterData();\n    this.subscribeToRealtimeUpdates();\n  }\n\n  loadDistributions(): void {\n    this.isLoading.set(true);\n    this.distributionState.fetchDistributions().subscribe({\n      next: (data) => {\n        this.distributions.set(data);\n        this.isLoading.set(false);\n      },\n      error: (err) => {\n        this.isLoading.set(false);\n        this.handleError(err);\n      },\n    });\n  }\n\n  loadMasterData(): void {\n    // Load departments and locations for filters\n    // ...\n  }\n\n  subscribeToRealtimeUpdates(): void {\n    this.distributionState.distributionUpdates$\n      .pipe(takeUntilDestroyed(this.destroyRef))\n      .subscribe((update) => {\n        this.handleDistributionUpdate(update);\n      });\n  }\n\n  onStatusFilterChange(status: DistributionStatus | 'ALL'): void {\n    this.statusFilter.set(status);\n  }\n\n  onDepartmentFilterChange(deptId: string | null): void {\n    this.departmentFilter.set(deptId);\n  }\n\n  onLocationFilterChange(locationId: string | null): void {\n    this.locationFilter.set(locationId);\n  }\n\n  onDateRangeChange(range: { from: Date | null; to: Date | null }): void {\n    this.dateRange.set(range);\n  }\n\n  onSearchChange(term: string): void {\n    this.searchTerm.set(term);\n  }\n\n  onCreateDistribution(): void {\n    const dialogRef = this.dialog.open(CreateDistributionDialog, {\n      width: '900px',\n      maxHeight: '90vh',\n    });\n\n    dialogRef.afterClosed().subscribe((result) => {\n      if (result?.success) {\n        this.loadDistributions(); // Refresh list\n        this.router.navigate(['/distributions', result.data.id]);\n      }\n    });\n  }\n\n  onViewDistribution(distribution: Distribution): void {\n    this.router.navigate(['/distributions', distribution.id]);\n  }\n\n  onExportReport(): void {\n    this.distributionState.exportDistributions(this.filteredDistributions());\n  }\n\n  private calculateStats(items: Distribution[]): QuickStats {\n    return {\n      total: items.length,\n      pending: items.filter(d => d.status === 'PENDING').length,\n      approved: items.filter(d => d.status === 'APPROVED').length,\n      dispensed: items.filter(d => d.status === 'DISPENSED').length,\n      completed: items.filter(d => d.status === 'COMPLETED').length,\n      cancelled: items.filter(d => d.status === 'CANCELLED').length,\n      totalValue: items.reduce((sum, d) => sum + d.totalAmount, 0),\n    };\n  }\n\n  private handleDistributionUpdate(update: DistributionUpdateEvent): void {\n    // Update specific distribution in signal array\n    this.distributions.update((items) =>\n      items.map((item) =>\n        item.id === update.distributionId ? { ...item, ...update.changes } : item\n      )\n    );\n  }\n}\n```\n\n**Template Structure**:\n\n```html\n<div class=\"distribution-list-container p-6\">\n  <!-- Header -->\n  <div class=\"header-section flex justify-between items-center mb-6\">\n    <div>\n      <h1 class=\"text-2xl font-bold\">Drug Distributions</h1>\n      <p class=\"text-gray-600\">Manage distribution requests and workflow</p>\n    </div>\n    <ax-button (click)=\"onCreateDistribution()\" [variant]=\"'primary'\">\n      <mat-icon>add</mat-icon>\n      New Distribution\n    </ax-button>\n  </div>\n\n  <!-- Quick Stats -->\n  <dist-quick-stats [stats]=\"quickStats()\" class=\"mb-6\"></dist-quick-stats>\n\n  <!-- Filters -->\n  <div class=\"filter-section grid grid-cols-1 md:grid-cols-5 gap-4 mb-6\">\n    <ax-select\n      [(ngModel)]=\"statusFilter\"\n      (ngModelChange)=\"onStatusFilterChange($event)\"\n      placeholder=\"All Statuses\">\n      <ax-option value=\"ALL\">All Statuses</ax-option>\n      <ax-option value=\"PENDING\">Pending</ax-option>\n      <ax-option value=\"APPROVED\">Approved</ax-option>\n      <ax-option value=\"DISPENSED\">Dispensed</ax-option>\n      <ax-option value=\"COMPLETED\">Completed</ax-option>\n      <ax-option value=\"CANCELLED\">Cancelled</ax-option>\n    </ax-select>\n\n    <ax-select\n      [(ngModel)]=\"departmentFilter\"\n      (ngModelChange)=\"onDepartmentFilterChange($event)\"\n      placeholder=\"All Departments\">\n      <ax-option [value]=\"null\">All Departments</ax-option>\n      @for (dept of departments(); track dept.id) {\n        <ax-option [value]=\"dept.id\">{{ dept.name }}</ax-option>\n      }\n    </ax-select>\n\n    <ax-select\n      [(ngModel)]=\"locationFilter\"\n      (ngModelChange)=\"onLocationFilterChange($event)\"\n      placeholder=\"All Locations\">\n      <ax-option [value]=\"null\">All Locations</ax-option>\n      @for (loc of locations(); track loc.id) {\n        <ax-option [value]=\"loc.id\">{{ loc.name }}</ax-option>\n      }\n    </ax-select>\n\n    <ax-date-range-picker\n      [(ngModel)]=\"dateRange\"\n      (ngModelChange)=\"onDateRangeChange($event)\"\n      placeholder=\"Date Range\">\n    </ax-date-range-picker>\n\n    <ax-input\n      [(ngModel)]=\"searchTerm\"\n      (ngModelChange)=\"onSearchChange($event)\"\n      placeholder=\"Search...\"\n      [prefixIcon]=\"'search'\">\n    </ax-input>\n  </div>\n\n  <!-- Distribution Table -->\n  @if (isLoading()) {\n    <ax-skeleton [rows]=\"10\"></ax-skeleton>\n  } @else {\n    <dist-distribution-table\n      [distributions]=\"filteredDistributions()\"\n      (viewDistribution)=\"onViewDistribution($event)\">\n    </dist-distribution-table>\n  }\n\n  <!-- Actions -->\n  <div class=\"actions-section mt-4\">\n    <ax-button (click)=\"onExportReport()\" [variant]=\"'ghost'\">\n      <mat-icon>download</mat-icon>\n      Export Report\n    </ax-button>\n  </div>\n</div>\n```\n\n---\n\n### 2. QuickStatsComponent (Presentation Component)\n\n**Path**: `apps/admin/src/app/pages/distribution/components/quick-stats/quick-stats.component.ts`\n\n**Responsibility**: Display summary statistics.\n\n**TypeScript Interface**:\n\n```typescript\n@Component({\n  selector: 'dist-quick-stats',\n  standalone: true,\n  imports: [CommonModule, AxKpiCard],\n  template: `\n    <div class=\"stats-grid grid grid-cols-2 md:grid-cols-4 lg:grid-cols-7 gap-4\">\n      <ax-kpi-card\n        [title]=\"'Total'\"\n        [value]=\"stats().total\"\n        [icon]=\"'inventory'\"\n        [color]=\"'primary'\">\n      </ax-kpi-card>\n\n      <ax-kpi-card\n        [title]=\"'Pending'\"\n        [value]=\"stats().pending\"\n        [icon]=\"'pending'\"\n        [color]=\"'warning'\">\n      </ax-kpi-card>\n\n      <ax-kpi-card\n        [title]=\"'Approved'\"\n        [value]=\"stats().approved\"\n        [icon]=\"'check_circle'\"\n        [color]=\"'info'\">\n      </ax-kpi-card>\n\n      <ax-kpi-card\n        [title]=\"'Dispensed'\"\n        [value]=\"stats().dispensed\"\n        [icon]=\"'local_shipping'\"\n        [color]=\"'success'\">\n      </ax-kpi-card>\n\n      <ax-kpi-card\n        [title]=\"'Completed'\"\n        [value]=\"stats().completed\"\n        [icon]=\"'done_all'\"\n        [color]=\"'success'\">\n      </ax-kpi-card>\n\n      <ax-kpi-card\n        [title]=\"'Cancelled'\"\n        [value]=\"stats().cancelled\"\n        [icon]=\"'cancel'\"\n        [color]=\"'danger'\">\n      </ax-kpi-card>\n\n      <ax-kpi-card\n        [title]=\"'Total Value'\"\n        [value]=\"stats().totalValue | currency:'THB'\"\n        [icon]=\"'attach_money'\"\n        [color]=\"'primary'\">\n      </ax-kpi-card>\n    </div>\n  `,\n})\nexport class QuickStatsComponent {\n  @Input({ required: true }) stats!: Signal<QuickStats>;\n}\n```\n\n---\n\n### 3. DistributionTableComponent (Presentation Component)\n\n**Path**: `apps/admin/src/app/pages/distribution/components/distribution-table/distribution-table.component.ts`\n\n**Responsibility**: Display distributions in table format with status badges and actions.\n\n**TypeScript Interface**:\n\n```typescript\n@Component({\n  selector: 'dist-distribution-table',\n  standalone: true,\n  imports: [\n    CommonModule,\n    MatTableModule,\n    MatSortModule,\n    MatPaginatorModule,\n    StatusBadgeComponent,\n    AxButton\n  ],\n  templateUrl: './distribution-table.component.html',\n})\nexport class DistributionTableComponent {\n  @Input({ required: true }) distributions!: Signal<Distribution[]>;\n  @Output() viewDistribution = new EventEmitter<Distribution>();\n\n  displayedColumns = [\n    'distributionNumber',\n    'distributionDate',\n    'requestingDept',\n    'fromLocation',\n    'status',\n    'totalItems',\n    'totalAmount',\n    'actions'\n  ];\n\n  dataSource = computed(() => new MatTableDataSource(this.distributions()));\n\n  getStatusColor(status: DistributionStatus): string {\n    const colors: Record<DistributionStatus, string> = {\n      PENDING: 'warning',\n      APPROVED: 'info',\n      DISPENSED: 'primary',\n      COMPLETED: 'success',\n      CANCELLED: 'danger',\n    };\n    return colors[status] || 'default';\n  }\n\n  getStatusIcon(status: DistributionStatus): string {\n    const icons: Record<DistributionStatus, string> = {\n      PENDING: 'pending',\n      APPROVED: 'check_circle',\n      DISPENSED: 'local_shipping',\n      COMPLETED: 'done_all',\n      CANCELLED: 'cancel',\n    };\n    return icons[status] || 'info';\n  }\n}\n```\n\n**Template**:\n\n```html\n<div class=\"distribution-table-container\">\n  <table mat-table [dataSource]=\"dataSource()\" matSort class=\"w-full\">\n    <!-- Distribution Number Column -->\n    <ng-container matColumnDef=\"distributionNumber\">\n      <th mat-header-cell *matHeaderCellDef mat-sort-header>Number</th>\n      <td mat-cell *matCellDef=\"let dist\">\n        <span class=\"font-mono font-semibold text-primary-600\">\n          {{ dist.distributionNumber }}\n        </span>\n      </td>\n    </ng-container>\n\n    <!-- Date Column -->\n    <ng-container matColumnDef=\"distributionDate\">\n      <th mat-header-cell *matHeaderCellDef mat-sort-header>Date</th>\n      <td mat-cell *matCellDef=\"let dist\">\n        {{ dist.distributionDate | date:'yyyy-MM-dd' }}\n      </td>\n    </ng-container>\n\n    <!-- Department Column -->\n    <ng-container matColumnDef=\"requestingDept\">\n      <th mat-header-cell *matHeaderCellDef>Department</th>\n      <td mat-cell *matCellDef=\"let dist\">\n        <div>\n          <div class=\"font-medium\">{{ dist.requestingDept.name }}</div>\n          <div class=\"text-sm text-gray-500\">{{ dist.requestedBy }}</div>\n        </div>\n      </td>\n    </ng-container>\n\n    <!-- Location Column -->\n    <ng-container matColumnDef=\"fromLocation\">\n      <th mat-header-cell *matHeaderCellDef>From Location</th>\n      <td mat-cell *matCellDef=\"let dist\">\n        {{ dist.fromLocation.name }}\n      </td>\n    </ng-container>\n\n    <!-- Status Column -->\n    <ng-container matColumnDef=\"status\">\n      <th mat-header-cell *matHeaderCellDef>Status</th>\n      <td mat-cell *matCellDef=\"let dist\">\n        <dist-status-badge\n          [status]=\"dist.status\"\n          [color]=\"getStatusColor(dist.status)\"\n          [icon]=\"getStatusIcon(dist.status)\">\n        </dist-status-badge>\n      </td>\n    </ng-container>\n\n    <!-- Total Items Column -->\n    <ng-container matColumnDef=\"totalItems\">\n      <th mat-header-cell *matHeaderCellDef mat-sort-header>Items</th>\n      <td mat-cell *matCellDef=\"let dist\">\n        {{ dist.totalItems }}\n      </td>\n    </ng-container>\n\n    <!-- Total Amount Column -->\n    <ng-container matColumnDef=\"totalAmount\">\n      <th mat-header-cell *matHeaderCellDef mat-sort-header>Amount</th>\n      <td mat-cell *matCellDef=\"let dist\">\n        {{ dist.totalAmount | currency:'THB':'symbol-narrow' }}\n      </td>\n    </ng-container>\n\n    <!-- Actions Column -->\n    <ng-container matColumnDef=\"actions\">\n      <th mat-header-cell *matHeaderCellDef>Actions</th>\n      <td mat-cell *matCellDef=\"let dist\">\n        <ax-button\n          [variant]=\"'ghost'\"\n          [size]=\"'sm'\"\n          (click)=\"viewDistribution.emit(dist)\">\n          View Details\n        </ax-button>\n      </td>\n    </ng-container>\n\n    <tr mat-header-row *matHeaderRowDef=\"displayedColumns\"></tr>\n    <tr mat-row *matRowDef=\"let row; columns: displayedColumns;\" class=\"hover:bg-gray-50\"></tr>\n  </table>\n\n  <mat-paginator\n    [pageSizeOptions]=\"[20, 50, 100]\"\n    showFirstLastButtons>\n  </mat-paginator>\n</div>\n```\n\n---\n\n### 4. DistributionDetailPage (Container Component)\n\n**Path**: `apps/admin/src/app/pages/distribution/distribution-detail/distribution-detail.page.ts`\n\n**Responsibility**: Display distribution details with workflow actions.\n\n**TypeScript Interface**:\n\n```typescript\n@Component({\n  selector: 'dist-distribution-detail-page',\n  standalone: true,\n  imports: [\n    CommonModule,\n    RouterModule,\n    StatusBadgeComponent,\n    DistributionItemsTableComponent,\n    AuditTimelineComponent,\n    ApproveDistributionDialog,\n    CancelDistributionDialog,\n    DispenseDistributionDialog,\n    CompleteDistributionDialog,\n    PreviewFifoLotsDialog,\n    AxCard,\n    AxButton,\n    AxAlert,\n    AxSkeleton\n  ],\n  templateUrl: './distribution-detail.page.html',\n})\nexport class DistributionDetailPage implements OnInit {\n  distributionId = signal<string>('');\n  distribution = signal<Distribution | null>(null);\n  isLoading = signal<boolean>(false);\n  errorMessage = signal<string>('');\n\n  // Computed\n  canApprove = computed(() => {\n    const dist = this.distribution();\n    return dist?.status === 'PENDING' && this.hasPermission('distribution:approve');\n  });\n\n  canCancel = computed(() => {\n    const dist = this.distribution();\n    return (dist?.status === 'PENDING' || dist?.status === 'APPROVED') &&\n           this.hasPermission('distribution:cancel');\n  });\n\n  canDispense = computed(() => {\n    const dist = this.distribution();\n    return dist?.status === 'APPROVED' && this.hasPermission('distribution:dispense');\n  });\n\n  canComplete = computed(() => {\n    const dist = this.distribution();\n    return dist?.status === 'DISPENSED' && this.hasPermission('distribution:complete');\n  });\n\n  canPreviewLots = computed(() => {\n    const dist = this.distribution();\n    return dist?.status === 'APPROVED' && this.hasPermission('distribution:read');\n  });\n\n  constructor(\n    private route: ActivatedRoute,\n    private router: Router,\n    private distributionApi: DistributionApiService,\n    private authService: AuthService,\n    private dialog: MatDialog,\n    private toastService: ToastService,\n  ) {}\n\n  ngOnInit(): void {\n    this.route.params.subscribe((params) => {\n      this.distributionId.set(params['id']);\n      this.loadDistribution();\n    });\n\n    this.subscribeToRealtimeUpdates();\n  }\n\n  loadDistribution(): void {\n    this.isLoading.set(true);\n    this.errorMessage.set('');\n\n    this.distributionApi.getDistributionById(this.distributionId()).subscribe({\n      next: (data) => {\n        this.distribution.set(data);\n        this.isLoading.set(false);\n      },\n      error: (err) => {\n        this.isLoading.set(false);\n        this.errorMessage.set(err.error?.message || 'Failed to load distribution');\n      },\n    });\n  }\n\n  subscribeToRealtimeUpdates(): void {\n    // Subscribe to WebSocket updates for this distribution\n  }\n\n  onApprove(): void {\n    const dialogRef = this.dialog.open(ApproveDistributionDialog, {\n      width: '500px',\n      data: { distribution: this.distribution() },\n    });\n\n    dialogRef.afterClosed().subscribe((result) => {\n      if (result?.success) {\n        this.loadDistribution();\n      }\n    });\n  }\n\n  onCancel(): void {\n    const dialogRef = this.dialog.open(CancelDistributionDialog, {\n      width: '500px',\n      data: { distribution: this.distribution() },\n    });\n\n    dialogRef.afterClosed().subscribe((result) => {\n      if (result?.success) {\n        this.loadDistribution();\n      }\n    });\n  }\n\n  onDispense(): void {\n    const dialogRef = this.dialog.open(DispenseDistributionDialog, {\n      width: '900px',\n      maxHeight: '90vh',\n      data: { distribution: this.distribution() },\n    });\n\n    dialogRef.afterClosed().subscribe((result) => {\n      if (result?.success) {\n        this.loadDistribution();\n      }\n    });\n  }\n\n  onComplete(): void {\n    const dialogRef = this.dialog.open(CompleteDistributionDialog, {\n      width: '500px',\n      data: { distribution: this.distribution() },\n    });\n\n    dialogRef.afterClosed().subscribe((result) => {\n      if (result?.success) {\n        this.loadDistribution();\n      }\n    });\n  }\n\n  onPreviewLots(): void {\n    this.dialog.open(PreviewFifoLotsDialog, {\n      width: '800px',\n      maxHeight: '90vh',\n      data: { distributionId: this.distributionId() },\n    });\n  }\n\n  onBack(): void {\n    this.router.navigate(['/distributions']);\n  }\n\n  private hasPermission(permission: string): boolean {\n    return this.authService.hasPermission(permission);\n  }\n}\n```\n\n---\n\n### 5. CreateDistributionDialog (Smart Component)\n\n**Path**: `apps/admin/src/app/pages/distribution/dialogs/create-distribution/create-distribution.dialog.ts`\n\n**Responsibility**: Create new distribution request with real-time stock validation.\n\n**TypeScript Interface**:\n\n```typescript\n@Component({\n  selector: 'dist-create-distribution-dialog',\n  standalone: true,\n  imports: [\n    CommonModule,\n    ReactiveFormsModule,\n    MatDialogModule,\n    AxSelect,\n    AxInput,\n    AxButton,\n    AxAlert,\n    AxDatePicker,\n    MatTableModule\n  ],\n  templateUrl: './create-distribution.dialog.html',\n})\nexport class CreateDistributionDialog implements OnInit {\n  distributionForm!: FormGroup;\n  itemsFormArray!: FormArray;\n\n  isSubmitting = signal<boolean>(false);\n  errorMessage = signal<string>('');\n\n  // Master data\n  locations = signal<Location[]>([]);\n  departments = signal<Department[]>([]);\n  drugs = signal<Drug[]>([]);\n\n  // Stock validation results\n  stockValidation = signal<Map<string, StockValidationResult>>(new Map());\n\n  itemsDisplayedColumns = ['drugId', 'quantityRequested', 'currentStock', 'status', 'actions'];\n\n  constructor(\n    private fb: FormBuilder,\n    private dialogRef: MatDialogRef<CreateDistributionDialog>,\n    private distributionApi: DistributionApiService,\n    private inventoryApi: InventoryApiService,\n    private toastService: ToastService,\n  ) {}\n\n  ngOnInit(): void {\n    this.initForm();\n    this.loadMasterData();\n  }\n\n  initForm(): void {\n    this.distributionForm = this.fb.group({\n      fromLocationId: [null, Validators.required],\n      toLocationId: [null],\n      requestingDeptId: [null, Validators.required],\n      requestedBy: ['', Validators.required],\n      distributionDate: [new Date(), Validators.required],\n    });\n\n    this.itemsFormArray = this.fb.array([]);\n    this.addItem(); // Start with one item\n  }\n\n  loadMasterData(): void {\n    // Load locations, departments, drugs\n    // ...\n  }\n\n  addItem(): void {\n    const itemGroup = this.fb.group({\n      drugId: [null, Validators.required],\n      quantityRequested: [0, [Validators.required, Validators.min(1)]],\n    });\n\n    // Subscribe to drug and quantity changes for real-time validation\n    combineLatest([\n      itemGroup.get('drugId')!.valueChanges,\n      itemGroup.get('quantityRequested')!.valueChanges,\n      this.distributionForm.get('fromLocationId')!.valueChanges\n    ]).pipe(\n      debounceTime(500),\n      distinctUntilChanged()\n    ).subscribe(([drugId, qty, locationId]) => {\n      if (drugId && qty > 0 && locationId) {\n        this.validateStock(drugId, locationId, qty);\n      }\n    });\n\n    this.itemsFormArray.push(itemGroup);\n  }\n\n  removeItem(index: number): void {\n    this.itemsFormArray.removeAt(index);\n  }\n\n  async validateStock(drugId: string, locationId: string, quantity: number): Promise<void> {\n    try {\n      const result = await firstValueFrom(\n        this.inventoryApi.checkStockAvailability(drugId, locationId, quantity)\n      );\n\n      this.stockValidation.update(map => {\n        map.set(drugId, result);\n        return new Map(map);\n      });\n    } catch (err) {\n      console.error('Stock validation error:', err);\n    }\n  }\n\n  getStockStatus(drugId: string): 'available' | 'insufficient' | 'pending' {\n    const validation = this.stockValidation().get(drugId);\n    if (!validation) return 'pending';\n    return validation.available ? 'available' : 'insufficient';\n  }\n\n  onSubmit(): void {\n    if (this.distributionForm.invalid || this.itemsFormArray.length === 0) {\n      this.distributionForm.markAllAsTouched();\n      this.itemsFormArray.controls.forEach(control => control.markAllAsTouched());\n      return;\n    }\n\n    // Check all items have sufficient stock\n    const hasInsufficientStock = Array.from(this.stockValidation().values())\n      .some(validation => !validation.available);\n\n    if (hasInsufficientStock) {\n      this.errorMessage.set('Some items have insufficient stock. Please adjust quantities.');\n      return;\n    }\n\n    this.isSubmitting.set(true);\n    this.errorMessage.set('');\n\n    const payload: CreateDistributionRequest = {\n      ...this.distributionForm.value,\n      items: this.itemsFormArray.value,\n    };\n\n    this.distributionApi.createDistribution(payload).subscribe({\n      next: (result) => {\n        this.toastService.success(`Distribution ${result.distributionNumber} created successfully`);\n        this.dialogRef.close({ success: true, data: result });\n      },\n      error: (err) => {\n        this.isSubmitting.set(false);\n        this.errorMessage.set(err.error?.message || 'Failed to create distribution');\n      },\n    });\n  }\n\n  cancel(): void {\n    this.dialogRef.close({ success: false });\n  }\n}\n```\n\n---\n\n### 6. DispenseDistributionDialog (Smart Component)\n\n**Path**: `apps/admin/src/app/pages/distribution/dialogs/dispense-distribution/dispense-distribution.dialog.ts`\n\n**Responsibility**: Dispense distribution with FIFO guidance and confirmation checklist.\n\n**TypeScript Interface**:\n\n```typescript\n@Component({\n  selector: 'dist-dispense-distribution-dialog',\n  standalone: true,\n  imports: [\n    CommonModule,\n    ReactiveFormsModule,\n    MatDialogModule,\n    MatTableModule,\n    MatCheckboxModule,\n    AxButton,\n    AxAlert,\n    AxInput\n  ],\n  templateUrl: './dispense-distribution.dialog.html',\n})\nexport class DispenseDistributionDialog implements OnInit {\n  distribution = signal<Distribution | null>(null);\n  fifoPreview = signal<FifoLotPreview[]>([]);\n  isLoading = signal<boolean>(false);\n  isSubmitting = signal<boolean>(false);\n  errorMessage = signal<string>('');\n\n  // Confirmation checkboxes\n  confirmationForm!: FormGroup;\n\n  lotsDisplayedColumns = ['itemNumber', 'drugName', 'quantityNeeded', 'lots'];\n\n  constructor(\n    @Inject(MAT_DIALOG_DATA) public data: { distribution: Distribution },\n    private fb: FormBuilder,\n    private dialogRef: MatDialogRef<DispenseDistributionDialog>,\n    private distributionApi: DistributionApiService,\n    private toastService: ToastService,\n  ) {\n    this.distribution.set(data.distribution);\n  }\n\n  ngOnInit(): void {\n    this.initForm();\n    this.loadFifoPreview();\n  }\n\n  initForm(): void {\n    this.confirmationForm = this.fb.group({\n      dispensedBy: ['', Validators.required],\n      allItemsChecked: [false, Validators.requiredTrue],\n      quantitiesVerified: [false, Validators.requiredTrue],\n      expiryChecked: [false, Validators.requiredTrue],\n    });\n  }\n\n  loadFifoPreview(): void {\n    this.isLoading.set(true);\n\n    this.distributionApi.previewFifoLots(this.distribution()!.id).subscribe({\n      next: (preview) => {\n        this.fifoPreview.set(preview);\n        this.isLoading.set(false);\n      },\n      error: (err) => {\n        this.isLoading.set(false);\n        this.errorMessage.set('Failed to load FIFO lots preview');\n      },\n    });\n  }\n\n  onDispense(): void {\n    if (this.confirmationForm.invalid) {\n      this.confirmationForm.markAllAsTouched();\n      return;\n    }\n\n    this.isSubmitting.set(true);\n    this.errorMessage.set('');\n\n    const payload = {\n      dispensedBy: this.confirmationForm.value.dispensedBy,\n      userId: 'current-user-id', // Get from auth service\n    };\n\n    this.distributionApi.dispenseDistribution(this.distribution()!.id, payload).subscribe({\n      next: (result) => {\n        this.toastService.success('Distribution dispensed successfully');\n        this.dialogRef.close({ success: true, data: result });\n      },\n      error: (err) => {\n        this.isSubmitting.set(false);\n        this.errorMessage.set(err.error?.message || 'Failed to dispense distribution');\n      },\n    });\n  }\n\n  cancel(): void {\n    this.dialogRef.close({ success: false });\n  }\n}\n```\n\n---\n\n## State Management with Angular Signals\n\n### DistributionStateService\n\n**Path**: `apps/admin/src/app/pages/distribution/services/distribution-state.service.ts`\n\n**Responsibility**: Centralized state management using Angular Signals.\n\n```typescript\n@Injectable()\nexport class DistributionStateService {\n  // Signals for state\n  private distributionsSignal = signal<Distribution[]>([]);\n  private selectedDistributionSignal = signal<Distribution | null>(null);\n  private loadingSignal = signal<boolean>(false);\n\n  // Public readonly signals\n  readonly distributions = this.distributionsSignal.asReadonly();\n  readonly selectedDistribution = this.selectedDistributionSignal.asReadonly();\n  readonly isLoading = this.loadingSignal.asReadonly();\n\n  // Computed signals\n  readonly pendingDistributions = computed(() =>\n    this.distributions().filter(d => d.status === 'PENDING')\n  );\n\n  readonly approvedDistributions = computed(() =>\n    this.distributions().filter(d => d.status === 'APPROVED')\n  );\n\n  // Observable for async operations\n  distributionUpdates$ = new Subject<DistributionUpdateEvent>();\n\n  constructor(\n    private distributionApi: DistributionApiService,\n    private distributionWs: DistributionWebSocketService,\n  ) {\n    this.initWebSocketSubscriptions();\n  }\n\n  fetchDistributions(filters?: DistributionFilters): Observable<Distribution[]> {\n    this.loadingSignal.set(true);\n\n    return this.distributionApi.getDistributions(filters).pipe(\n      tap((items) => {\n        this.distributionsSignal.set(items);\n        this.loadingSignal.set(false);\n      }),\n      catchError((err) => {\n        this.loadingSignal.set(false);\n        return throwError(() => err);\n      }),\n    );\n  }\n\n  updateDistribution(distributionId: string, changes: Partial<Distribution>): void {\n    this.distributionsSignal.update((items) =>\n      items.map((item) =>\n        item.id === distributionId ? { ...item, ...changes } : item\n      )\n    );\n\n    if (this.selectedDistribution()?.id === distributionId) {\n      this.selectedDistributionSignal.update(dist =>\n        dist ? { ...dist, ...changes } : dist\n      );\n    }\n  }\n\n  setSelectedDistribution(distribution: Distribution | null): void {\n    this.selectedDistributionSignal.set(distribution);\n  }\n\n  private initWebSocketSubscriptions(): void {\n    this.distributionWs.onDistributionCreated$.subscribe((event) => {\n      // Add new distribution to list\n      this.distributionsSignal.update(items => [event.distribution, ...items]);\n      this.distributionUpdates$.next(event);\n    });\n\n    this.distributionWs.onDistributionApproved$.subscribe((event) => {\n      this.updateDistribution(event.distributionId, {\n        status: 'APPROVED',\n        approvedBy: event.approvedBy,\n      });\n      this.distributionUpdates$.next(event);\n    });\n\n    this.distributionWs.onDistributionDispensed$.subscribe((event) => {\n      this.updateDistribution(event.distributionId, {\n        status: 'DISPENSED',\n        dispensedBy: event.dispensedBy,\n      });\n      this.distributionUpdates$.next(event);\n    });\n\n    this.distributionWs.onDistributionCompleted$.subscribe((event) => {\n      this.updateDistribution(event.distributionId, {\n        status: 'COMPLETED',\n      });\n      this.distributionUpdates$.next(event);\n    });\n\n    this.distributionWs.onDistributionCancelled$.subscribe((event) => {\n      this.updateDistribution(event.distributionId, {\n        status: 'CANCELLED',\n        notes: event.reason,\n      });\n      this.distributionUpdates$.next(event);\n    });\n  }\n\n  exportDistributions(distributions: Distribution[]): void {\n    // Convert to Excel and trigger download using XLSX library\n    const worksheetData = distributions.map(d => ({\n      'Distribution Number': d.distributionNumber,\n      'Date': d.distributionDate,\n      'Department': d.requestingDept.name,\n      'Location': d.fromLocation.name,\n      'Status': d.status,\n      'Items': d.totalItems,\n      'Amount': d.totalAmount,\n    }));\n\n    const worksheet = XLSX.utils.json_to_sheet(worksheetData);\n    const workbook = XLSX.utils.book_new();\n    XLSX.utils.book_append_sheet(workbook, worksheet, 'Distributions');\n\n    XLSX.writeFile(workbook, `distributions-${new Date().toISOString()}.xlsx`);\n  }\n}\n```\n\n---\n\n## Service Layer\n\n### DistributionApiService\n\n**Path**: `apps/admin/src/app/pages/distribution/services/distribution-api.service.ts`\n\n**Responsibility**: HTTP communication with backend API (15 endpoints).\n\n```typescript\n@Injectable()\nexport class DistributionApiService {\n  private readonly apiUrl = '/api/inventory/operations/drug-distributions';\n\n  constructor(private http: HttpClient) {}\n\n  // Distribution CRUD\n  getDistributions(filters?: DistributionFilters): Observable<Distribution[]> {\n    return this.http\n      .get<PaginatedResponse<Distribution>>(this.apiUrl, { params: filters as any })\n      .pipe(map((response) => response.data));\n  }\n\n  getDistributionById(id: string): Observable<Distribution> {\n    return this.http\n      .get<ApiResponse<Distribution>>(`${this.apiUrl}/${id}`)\n      .pipe(map((response) => response.data));\n  }\n\n  createDistribution(data: CreateDistributionRequest): Observable<Distribution> {\n    return this.http\n      .post<ApiResponse<Distribution>>(this.apiUrl, data)\n      .pipe(map((response) => response.data));\n  }\n\n  // Workflow actions\n  approveDistribution(id: string, data: ApproveRequest): Observable<Distribution> {\n    return this.http\n      .post<ApiResponse<Distribution>>(`${this.apiUrl}/${id}/approve`, data)\n      .pipe(map((response) => response.data));\n  }\n\n  cancelDistribution(id: string, data: CancelRequest): Observable<Distribution> {\n    return this.http\n      .post<ApiResponse<Distribution>>(`${this.apiUrl}/${id}/cancel`, data)\n      .pipe(map((response) => response.data));\n  }\n\n  dispenseDistribution(id: string, data: DispenseRequest): Observable<DispenseResult> {\n    return this.http\n      .post<ApiResponse<DispenseResult>>(`${this.apiUrl}/${id}/dispense`, data)\n      .pipe(map((response) => response.data));\n  }\n\n  completeDistribution(id: string, data: CompleteRequest): Observable<Distribution> {\n    return this.http\n      .post<ApiResponse<Distribution>>(`${this.apiUrl}/${id}/complete`, data)\n      .pipe(map((response) => response.data));\n  }\n\n  previewFifoLots(id: string): Observable<FifoLotPreview[]> {\n    return this.http\n      .get<ApiResponse<FifoLotPreview[]>>(`${this.apiUrl}/${id}/preview-lots`)\n      .pipe(map((response) => response.data));\n  }\n\n  // Reporting\n  getDistributionsByDepartment(\n    deptId: string,\n    params?: DepartmentDistributionParams\n  ): Observable<DepartmentDistributionResponse> {\n    return this.http\n      .get<ApiResponse<DepartmentDistributionResponse>>(\n        `${this.apiUrl}/by-department/${deptId}`,\n        { params: params as any }\n      )\n      .pipe(map((response) => response.data));\n  }\n\n  getUsageReport(params: UsageReportParams): Observable<UsageReport> {\n    return this.http\n      .get<ApiResponse<UsageReport>>(`${this.apiUrl}/usage-report`, {\n        params: params as any,\n      })\n      .pipe(map((response) => response.data));\n  }\n\n  exportMinistryData(params: MinistryExportParams): Observable<Blob> {\n    return this.http.get(`${this.apiUrl}/ministry-export`, {\n      params: params as any,\n      responseType: 'blob',\n    });\n  }\n\n  // Item management\n  getDistributionItems(filters?: ItemFilters): Observable<DistributionItem[]> {\n    return this.http\n      .get<ApiResponse<DistributionItem[]>>('/api/inventory/operations/drug-distribution-items', {\n        params: filters as any,\n      })\n      .pipe(map((response) => response.data));\n  }\n\n  updateDistributionItem(id: string, data: UpdateItemRequest): Observable<DistributionItem> {\n    return this.http\n      .put<ApiResponse<DistributionItem>>(\n        `/api/inventory/operations/drug-distribution-items/${id}`,\n        data\n      )\n      .pipe(map((response) => response.data));\n  }\n\n  deleteDistributionItem(id: string): Observable<void> {\n    return this.http.delete<void>(`/api/inventory/operations/drug-distribution-items/${id}`);\n  }\n\n  // Distribution types\n  getDistributionTypes(activeOnly = true): Observable<DistributionType[]> {\n    return this.http\n      .get<ApiResponse<DistributionType[]>>('/api/inventory/operations/distribution-types', {\n        params: { activeOnly },\n      })\n      .pipe(map((response) => response.data));\n  }\n}\n```\n\n---\n\n### DistributionWebSocketService\n\n**Path**: `apps/admin/src/app/pages/distribution/services/distribution-websocket.service.ts`\n\n**Responsibility**: WebSocket connection management for real-time updates.\n\n```typescript\n@Injectable()\nexport class DistributionWebSocketService implements OnDestroy {\n  private socket: WebSocket | null = null;\n  private reconnectAttempts = 0;\n  private maxReconnectAttempts = 5;\n  private reconnectDelay = 1000;\n\n  // Event streams\n  onDistributionCreated$ = new Subject<DistributionCreatedEvent>();\n  onDistributionApproved$ = new Subject<DistributionApprovedEvent>();\n  onDistributionCancelled$ = new Subject<DistributionCancelledEvent>();\n  onDistributionDispensed$ = new Subject<DistributionDispensedEvent>();\n  onDistributionCompleted$ = new Subject<DistributionCompletedEvent>();\n  onConnectionStatus$ = new BehaviorSubject<'connected' | 'disconnected' | 'reconnecting'>(\n    'disconnected'\n  );\n\n  constructor(private authService: AuthService) {\n    this.connect();\n  }\n\n  private connect(): void {\n    const wsUrl = environment.wsUrl;\n    const token = this.authService.getToken();\n\n    this.socket = new WebSocket(`${wsUrl}?token=${token}`);\n\n    this.socket.onopen = () => {\n      console.log('[WS] Connected');\n      this.onConnectionStatus$.next('connected');\n      this.reconnectAttempts = 0;\n      this.reconnectDelay = 1000;\n\n      // Subscribe to distribution events\n      this.send({ type: 'subscribe', channel: 'distribution' });\n    };\n\n    this.socket.onmessage = (event) => {\n      const message = JSON.parse(event.data);\n      this.handleMessage(message);\n    };\n\n    this.socket.onerror = (error) => {\n      console.error('[WS] Error:', error);\n    };\n\n    this.socket.onclose = () => {\n      console.log('[WS] Disconnected');\n      this.onConnectionStatus$.next('disconnected');\n      this.attemptReconnect();\n    };\n  }\n\n  private handleMessage(message: WebSocketMessage): void {\n    switch (message.event) {\n      case 'distribution:created':\n        this.onDistributionCreated$.next(message.data);\n        break;\n      case 'distribution:approved':\n        this.onDistributionApproved$.next(message.data);\n        break;\n      case 'distribution:cancelled':\n        this.onDistributionCancelled$.next(message.data);\n        break;\n      case 'distribution:dispensed':\n        this.onDistributionDispensed$.next(message.data);\n        break;\n      case 'distribution:completed':\n        this.onDistributionCompleted$.next(message.data);\n        break;\n    }\n  }\n\n  private attemptReconnect(): void {\n    if (this.reconnectAttempts >= this.maxReconnectAttempts) {\n      console.error('[WS] Max reconnect attempts reached');\n      return;\n    }\n\n    this.reconnectAttempts++;\n    this.onConnectionStatus$.next('reconnecting');\n\n    console.log(`[WS] Reconnecting in ${this.reconnectDelay}ms (attempt ${this.reconnectAttempts})`);\n\n    setTimeout(() => {\n      this.connect();\n      this.reconnectDelay *= 2; // Exponential backoff\n    }, this.reconnectDelay);\n  }\n\n  private send(message: any): void {\n    if (this.socket?.readyState === WebSocket.OPEN) {\n      this.socket.send(JSON.stringify(message));\n    }\n  }\n\n  disconnect(): void {\n    if (this.socket) {\n      this.socket.close();\n      this.socket = null;\n    }\n  }\n\n  ngOnDestroy(): void {\n    this.disconnect();\n  }\n}\n```\n\n---\n\n## Data Models (TypeScript Interfaces)\n\n**Path**: `apps/admin/src/app/pages/distribution/models/distribution.models.ts`\n\n```typescript\n// Distribution\nexport interface Distribution {\n  id: string;\n  distributionNumber: string;\n  distributionDate: string;\n  fromLocationId: string;\n  toLocationId: string | null;\n  requestingDeptId: string;\n  requestedBy: string;\n  approvedBy: string | null;\n  dispensedBy: string | null;\n  status: DistributionStatus;\n  totalItems: number;\n  totalAmount: number;\n  notes: string | null;\n  createdAt: string;\n  updatedAt: string;\n  // Populated relations\n  fromLocation: Location;\n  toLocation: Location | null;\n  requestingDept: Department;\n  items?: DistributionItem[];\n}\n\nexport type DistributionStatus = 'PENDING' | 'APPROVED' | 'DISPENSED' | 'COMPLETED' | 'CANCELLED';\n\n// Distribution Item\nexport interface DistributionItem {\n  id: string;\n  distributionId: string;\n  itemNumber: number;\n  drugId: string;\n  lotNumber: string;\n  quantityDispensed: number;\n  unitCost: number;\n  expiryDate: string;\n  createdAt: string;\n  drug: Drug;\n}\n\n// Distribution Type\nexport interface DistributionType {\n  id: string;\n  name: string;\n  description: string | null;\n  isActive: boolean;\n  createdAt: string;\n}\n\n// Request/Response Types\nexport interface CreateDistributionRequest {\n  fromLocationId: string;\n  toLocationId?: string;\n  requestingDeptId: string;\n  requestedBy: string;\n  distributionDate?: string;\n  items: Array<{\n    drugId: string;\n    quantityRequested: number;\n  }>;\n}\n\nexport interface ApproveRequest {\n  approvedBy: string;\n}\n\nexport interface CancelRequest {\n  reason: string;\n}\n\nexport interface DispenseRequest {\n  dispensedBy: string;\n  userId: string;\n}\n\nexport interface CompleteRequest {\n  notes?: string;\n}\n\nexport interface DispenseResult {\n  id: string;\n  status: 'DISPENSED';\n  dispensedBy: string;\n  updatedAt: string;\n  lotsUsed: Array<{\n    itemNumber: number;\n    drugName: string;\n    lots: Array<{\n      lotNumber: string;\n      quantity: number;\n      expiryDate: string;\n    }>;\n  }>;\n}\n\n// FIFO Lot Preview\nexport interface FifoLotPreview {\n  itemNumber: number;\n  drugId: string;\n  drugName: string;\n  quantityNeeded: number;\n  lots: Array<{\n    lotId: string;\n    lotNumber: string;\n    quantityToDispense: number;\n    unitCost: number;\n    expiryDate: string;\n    daysUntilExpiry: number;\n  }>;\n}\n\n// Quick Stats\nexport interface QuickStats {\n  total: number;\n  pending: number;\n  approved: number;\n  dispensed: number;\n  completed: number;\n  cancelled: number;\n  totalValue: number;\n}\n\n// WebSocket Events\nexport interface DistributionCreatedEvent {\n  distributionId: string;\n  distribution: Distribution;\n}\n\nexport interface DistributionApprovedEvent {\n  distributionId: string;\n  approvedBy: string;\n}\n\nexport interface DistributionCancelledEvent {\n  distributionId: string;\n  reason: string;\n}\n\nexport interface DistributionDispensedEvent {\n  distributionId: string;\n  dispensedBy: string;\n}\n\nexport interface DistributionCompletedEvent {\n  distributionId: string;\n}\n\nexport interface DistributionUpdateEvent {\n  distributionId: string;\n  changes: Partial<Distribution>;\n}\n\n// Stock Validation\nexport interface StockValidationResult {\n  available: boolean;\n  currentStock: number;\n  requested: number;\n  drugName: string;\n}\n\n// API Response Types\nexport interface ApiResponse<T> {\n  success: boolean;\n  data: T;\n  message?: string;\n}\n\nexport interface PaginatedResponse<T> {\n  success: boolean;\n  data: T[];\n  meta: {\n    page: number;\n    limit: number;\n    total: number;\n    totalPages: number;\n  };\n}\n```\n\n---\n\n## Routing Structure\n\n**Path**: `apps/admin/src/app/pages/distribution/distribution.routes.ts`\n\n```typescript\nimport { Routes } from '@angular/router';\nimport { authGuard } from '@app/core/guards/auth.guard';\nimport { permissionGuard } from '@app/core/guards/permission.guard';\n\nexport const DISTRIBUTION_ROUTES: Routes = [\n  {\n    path: '',\n    redirectTo: 'list',\n    pathMatch: 'full',\n  },\n  {\n    path: 'list',\n    loadComponent: () =>\n      import('./distribution-list/distribution-list.page').then((m) => m.DistributionListPage),\n    canActivate: [authGuard, permissionGuard],\n    data: {\n      permission: { resource: 'distribution', action: 'read' },\n      breadcrumb: 'Distributions',\n    },\n  },\n  {\n    path: ':id',\n    loadComponent: () =>\n      import('./distribution-detail/distribution-detail.page').then(\n        (m) => m.DistributionDetailPage\n      ),\n    canActivate: [authGuard, permissionGuard],\n    data: {\n      permission: { resource: 'distribution', action: 'read' },\n      breadcrumb: 'Distribution Details',\n    },\n  },\n  {\n    path: 'department/:deptId',\n    loadComponent: () =>\n      import('./department-history/department-history.page').then(\n        (m) => m.DepartmentHistoryPage\n      ),\n    canActivate: [authGuard, permissionGuard],\n    data: {\n      permission: { resource: 'distribution', action: 'read' },\n      breadcrumb: 'Department History',\n    },\n  },\n  {\n    path: 'reports/usage',\n    loadComponent: () =>\n      import('./usage-report/usage-report.page').then((m) => m.UsageReportPage),\n    canActivate: [authGuard, permissionGuard],\n    data: {\n      permission: { resource: 'distribution', action: 'read' },\n      breadcrumb: 'Usage Report',\n    },\n  },\n];\n```\n\n---\n\n## Error Handling Strategy\n\n### Global HTTP Interceptor\n\nReuses the existing error interceptor from core module with distribution-specific error messages.\n\n**Distribution Error Codes**:\n- `DISTRIBUTION_NOT_FOUND`: Distribution not found\n- `INSUFFICIENT_STOCK`: Insufficient stock for dispensing\n- `INVALID_STATUS`: Invalid status for requested action\n- `NO_FIFO_LOTS`: No FIFO lots available\n- `INVALID_LOCATION`: Invalid location\n- `INVALID_DEPARTMENT`: Invalid department\n- `CANNOT_DELETE_LAST_ITEM`: Cannot delete last item from distribution\n\n---\n\n## Testing Strategy\n\n### Component Testing\n\n```typescript\ndescribe('DistributionListPage', () => {\n  let component: DistributionListPage;\n  let fixture: ComponentFixture<DistributionListPage>;\n  let distributionStateMock: jasmine.SpyObj<DistributionStateService>;\n\n  beforeEach(async () => {\n    distributionStateMock = jasmine.createSpyObj('DistributionStateService', [\n      'fetchDistributions',\n    ]);\n\n    await TestBed.configureTestingModule({\n      imports: [DistributionListPage],\n      providers: [{ provide: DistributionStateService, useValue: distributionStateMock }],\n    }).compileComponents();\n\n    fixture = TestBed.createComponent(DistributionListPage);\n    component = fixture.componentInstance;\n  });\n\n  it('should load distributions on init', () => {\n    distributionStateMock.fetchDistributions.and.returnValue(of(mockDistributions));\n\n    component.ngOnInit();\n\n    expect(distributionStateMock.fetchDistributions).toHaveBeenCalled();\n    expect(component.distributions().length).toBe(mockDistributions.length);\n  });\n\n  it('should filter distributions by status', () => {\n    component.distributions.set(mockDistributions);\n    component.statusFilter.set('PENDING');\n\n    const filtered = component.filteredDistributions();\n\n    expect(filtered.every((d) => d.status === 'PENDING')).toBe(true);\n  });\n\n  it('should calculate quick stats correctly', () => {\n    component.distributions.set(mockDistributions);\n\n    const stats = component.quickStats();\n\n    expect(stats.total).toBe(mockDistributions.length);\n    expect(stats.pending).toBe(mockDistributions.filter((d) => d.status === 'PENDING').length);\n  });\n});\n```\n\n### E2E Testing (Playwright)\n\n```typescript\nimport { test, expect } from '@playwright/test';\n\ntest.describe('Distribution Workflow', () => {\n  test.beforeEach(async ({ page }) => {\n    await page.goto('/distributions');\n    await page.waitForSelector('[data-testid=\"distribution-table\"]');\n  });\n\n  test('should create new distribution request', async ({ page }) => {\n    await page.click('[data-testid=\"new-distribution-btn\"]');\n    await expect(page.locator('[data-testid=\"create-distribution-dialog\"]')).toBeVisible();\n\n    // Fill form\n    await page.selectOption('[data-testid=\"from-location-select\"]', 'location-1');\n    await page.selectOption('[data-testid=\"dept-select\"]', 'dept-1');\n    await page.fill('[data-testid=\"requested-by-input\"]', 'Test User');\n\n    // Add item\n    await page.selectOption('[data-testid=\"drug-select-0\"]', 'drug-1');\n    await page.fill('[data-testid=\"quantity-input-0\"]', '100');\n\n    // Wait for stock validation\n    await expect(page.locator('[data-testid=\"stock-status-0\"]')).toHaveText('Available');\n\n    // Submit\n    await page.click('[data-testid=\"submit-btn\"]');\n\n    // Verify success\n    await expect(page.locator('.toast-success')).toBeVisible();\n  });\n\n  test('should complete full distribution workflow', async ({ page }) => {\n    // 1. Create distribution (assume already created)\n    const distributionRow = page.locator('[data-testid=\"distribution-row\"]').first();\n    await distributionRow.click();\n\n    // 2. Approve\n    await page.click('[data-testid=\"approve-btn\"]');\n    await page.fill('[data-testid=\"approved-by-input\"]', 'Supervisor');\n    await page.click('[data-testid=\"confirm-approve-btn\"]');\n    await expect(page.locator('[data-testid=\"status-badge\"]')).toHaveText('APPROVED');\n\n    // 3. Dispense\n    await page.click('[data-testid=\"dispense-btn\"]');\n    await expect(page.locator('[data-testid=\"fifo-preview-table\"]')).toBeVisible();\n    await page.fill('[data-testid=\"dispensed-by-input\"]', 'Pharmacist');\n    await page.check('[data-testid=\"confirm-items-checkbox\"]');\n    await page.check('[data-testid=\"confirm-quantities-checkbox\"]');\n    await page.check('[data-testid=\"confirm-expiry-checkbox\"]');\n    await page.click('[data-testid=\"confirm-dispense-btn\"]');\n    await expect(page.locator('[data-testid=\"status-badge\"]')).toHaveText('DISPENSED');\n\n    // 4. Complete\n    await page.click('[data-testid=\"complete-btn\"]');\n    await page.fill('[data-testid=\"notes-input\"]', 'Received by Ward Nurse');\n    await page.click('[data-testid=\"confirm-complete-btn\"]');\n    await expect(page.locator('[data-testid=\"status-badge\"]')).toHaveText('COMPLETED');\n  });\n});\n```\n\n---\n\n## Performance Optimization\n\n### 1. Virtual Scrolling for Large Tables\n```typescript\nimport { CdkVirtualScrollViewport } from '@angular/cdk/scrolling';\n```\n\n### 2. Lazy Loading Images\n```html\n<img [src]=\"item.drugImage\" loading=\"lazy\" alt=\"{{ item.drugName }}\" />\n```\n\n### 3. OnPush Change Detection\n```typescript\n@Component({\n  changeDetection: ChangeDetectionStrategy.OnPush\n})\n```\n\n### 4. Debounced Search and Filters\n```typescript\nsearchControl.valueChanges.pipe(\n  debounceTime(300),\n  distinctUntilChanged()\n).subscribe(...)\n```\n\n---\n\n## Summary\n\nThis design provides:\n\n1. **Scalable Architecture**: Feature module with lazy loading\n2. **Modern State Management**: Angular Signals for reactive UI\n3. **Type Safety**: Comprehensive TypeScript interfaces aligned with backend\n4. **Real-Time Updates**: WebSocket integration for distribution workflow\n5. **User-Friendly UI**: AegisX UI + Angular Material components\n6. **Workflow Guidance**: FIFO lot preview, confirmation checklists\n7. **Accessibility**: WCAG 2.1 AA compliance\n8. **Performance**: Virtual scrolling, debounced filters, lazy loading\n9. **Testing**: Unit, integration, and E2E test coverage\n10. **Maintainability**: Smart/dumb component pattern, service layer separation\n\nThe frontend architecture integrates seamlessly with the distribution-backend-api (15 endpoints) and follows Angular best practices for enterprise applications.\n\n---\n\n**Document Version**: 1.0\n**Last Updated**: 2025-12-14\n**Author**: Distribution Frontend UI Team\n",
  "fileStats": {
    "size": 52750,
    "lines": 1867,
    "lastModified": "2025-12-14T14:19:11.765Z"
  },
  "comments": []
}