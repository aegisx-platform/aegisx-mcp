{
  "id": "snapshot_1765639624532_uzjfaa858",
  "approvalId": "approval_1765639624525_9tzk79cfm",
  "approvalTitle": "Design: Import Wizard Bug Fixes",
  "version": 1,
  "timestamp": "2025-12-13T15:27:04.532Z",
  "trigger": "initial",
  "status": "pending",
  "content": "# Design Document: Import Wizard Bug Fixes\n\n## Overview\n\nThis design addresses 4 bugs in the System Initialization Import Wizard:\n1. File size display showing \"0.00 MB\" for small files\n2. Excel template download failing\n3. Validation step navigation not working (Next button stuck)\n4. Import History & Settings buttons not implemented\n\nAll fixes are isolated changes with minimal impact on surrounding code.\n\n## Code Reuse Analysis\n\n### Existing Components to Leverage\n\n- **ValidationResultsComponent.formattedFileSize**: Already has proper dynamic unit calculation (B, KB, MB, GB) - will use same pattern for import-wizard file size display\n- **BaseImportService**: Existing Excel generation logic - just needs await fix\n- **MatTooltipModule**: Already imported - will use for disabled button tooltips\n\n### Integration Points\n\n- **Import Wizard Dialog**: Main component receiving fixes (file size, navigation)\n- **Base Import Service**: Backend service for Excel template generation\n- **Dashboard Page**: UI buttons for History/Settings\n\n## Architecture\n\n```mermaid\nflowchart TB\n    subgraph Frontend[\"Frontend (Angular)\"]\n        Dashboard[\"Dashboard Page<br/>#4: Buttons\"]\n        ImportWizard[\"Import Wizard Dialog<br/>#1: File Size<br/>#3: Navigation\"]\n    end\n\n    subgraph Backend[\"Backend (Fastify)\"]\n        BaseImport[\"Base Import Service<br/>#2: Excel Generation\"]\n    end\n\n    Dashboard --> ImportWizard\n    ImportWizard --> BaseImport\n```\n\n## Components and Interfaces\n\n### Fix 1: File Size Display (import-wizard.dialog.ts)\n\n**Purpose:** Fix file size display to show appropriate units\n\n**Current Code (lines 117-135):**\n```typescript\nfileInfo = computed(() => {\n  const file = this.selectedFile();\n  if (!file) return null;\n  const sizeInMB = (file.size / (1024 * 1024)).toFixed(2);\n  // Always shows MB, even for small files\n});\n```\n\n**Fixed Code:**\n```typescript\nfileInfo = computed(() => {\n  const file = this.selectedFile();\n  if (!file) return null;\n\n  // Dynamic unit selection (same pattern as ValidationResultsComponent)\n  const units = ['B', 'KB', 'MB', 'GB'];\n  let size = file.size;\n  let unitIndex = 0;\n  while (size >= 1024 && unitIndex < units.length - 1) {\n    size /= 1024;\n    unitIndex++;\n  }\n  const formattedSize = `${size.toFixed(2)} ${units[unitIndex]}`;\n\n  const isValidSize = file.size <= 10 * 1024 * 1024;\n  const isValidType = file.name.endsWith('.csv') ||\n                      file.name.endsWith('.xlsx') ||\n                      file.name.endsWith('.xls');\n\n  return {\n    name: file.name,\n    size: formattedSize,  // Now includes unit\n    isValidSize,\n    isValidType,\n    isValid: isValidSize && isValidType,\n  };\n});\n```\n\n**HTML Change (import-wizard.dialog.html line 164):**\n```html\n<!-- Before -->\n<span class=\"file-size\">{{ fileInfo()?.size }} MB</span>\n\n<!-- After -->\n<span class=\"file-size\">{{ fileInfo()?.size }}</span>\n```\n\n---\n\n### Fix 2: Excel Template Download (base-import.service.ts)\n\n**Purpose:** Fix async handling in Excel buffer generation\n\n**File:** `apps/api/src/core/import/base/base-import.service.ts`\n\n**Current Code (line 205):**\n```typescript\nreturn workbook.xlsx.writeBuffer() as Promise<Buffer>;\n```\n\n**Fixed Code:**\n```typescript\nconst buffer = await workbook.xlsx.writeBuffer();\nreturn buffer as Buffer;\n```\n\n---\n\n### Fix 3: Validation Navigation (import-wizard.dialog.ts)\n\n**Purpose:** Fix async flow so validation completes before step transition\n\n**Current Code (lines 417-428):**\n```typescript\nnextStep() {\n  if (!this.canProceedToNextStep() || !this.canNavigate()) return;\n\n  if (this.currentStep() === 2 && !this.validationResult()) {\n    this.validateFile();  // Not awaited!\n  }\n\n  if (this.currentStep() < this.totalSteps) {\n    this.currentStep.update((s) => s + 1);  // Runs immediately\n  }\n}\n```\n\n**Fixed Code:**\n```typescript\nasync nextStep() {\n  if (!this.canProceedToNextStep() || !this.canNavigate()) return;\n\n  // Auto-validate when moving from step 2 to step 3\n  if (this.currentStep() === 2 && !this.validationResult()) {\n    await this.validateFile();\n    // Check if validation allows proceeding\n    if (!this.canProceedToNextStep()) return;\n  }\n\n  if (this.currentStep() < this.totalSteps) {\n    this.currentStep.update((s) => s + 1);\n  }\n}\n```\n\n---\n\n### Fix 4: Dashboard Buttons (system-init-dashboard.page.html)\n\n**Purpose:** Disable non-implemented buttons with tooltip\n\n**Current Code (lines 22-30):**\n```html\n<button mat-raised-button color=\"primary\" class=\"action-btn\">\n  <mat-icon>history</mat-icon>\n  <span>Import History</span>\n</button>\n\n<button mat-raised-button color=\"primary\" class=\"action-btn\">\n  <mat-icon>settings</mat-icon>\n  <span>Settings</span>\n</button>\n```\n\n**Fixed Code:**\n```html\n<button mat-raised-button color=\"primary\" class=\"action-btn\"\n        [disabled]=\"true\"\n        matTooltip=\"Coming Soon\">\n  <mat-icon>history</mat-icon>\n  <span>Import History</span>\n</button>\n\n<button mat-raised-button color=\"primary\" class=\"action-btn\"\n        [disabled]=\"true\"\n        matTooltip=\"Coming Soon\">\n  <mat-icon>settings</mat-icon>\n  <span>Settings</span>\n</button>\n```\n\n**Component Update (system-init-dashboard.page.ts):**\nAdd `MatTooltipModule` to imports if not already present.\n\n---\n\n## Data Models\n\nNo data model changes required. All fixes are behavioral/display fixes.\n\n## Error Handling\n\n### Error Scenarios\n\n1. **Excel Generation Failure**\n   - **Handling:** Exception will now properly propagate with await\n   - **User Impact:** Shows error snackbar \"Failed to download template\"\n\n2. **Validation API Failure**\n   - **Handling:** Existing try/catch in validateFile() handles this\n   - **User Impact:** Shows error snackbar, user stays on current step\n\n3. **File Too Large**\n   - **Handling:** Existing validation prevents upload\n   - **User Impact:** Shows error message, file not accepted\n\n## Testing Strategy\n\n### Manual Testing\n\n1. **File Size Display:**\n   - Upload file < 1KB → verify shows \"X.XX B\"\n   - Upload file ~500KB → verify shows \"X.XX KB\"\n   - Upload file ~2MB → verify shows \"X.XX MB\"\n\n2. **Excel Template Download:**\n   - Click \"Download Excel Template\" → verify .xlsx downloads\n   - Open file in Excel → verify headers and example data present\n\n3. **Validation Navigation:**\n   - Upload valid CSV → click Next → verify validation runs → verify can proceed\n   - Upload invalid CSV → verify error shown → verify cannot proceed\n\n4. **Dashboard Buttons:**\n   - Hover over History button → verify tooltip \"Coming Soon\"\n   - Hover over Settings button → verify tooltip \"Coming Soon\"\n   - Click buttons → verify no action (disabled)\n\n## Files to Modify\n\n| File | Changes |\n|------|---------|\n| `apps/web/src/app/features/system-init/components/import-wizard/import-wizard.dialog.ts` | Fix fileInfo computed, make nextStep async |\n| `apps/web/src/app/features/system-init/components/import-wizard/import-wizard.dialog.html` | Remove \" MB\" suffix from file size display |\n| `apps/api/src/core/import/base/base-import.service.ts` | Add await to writeBuffer() |\n| `apps/web/src/app/features/system-init/pages/system-init-dashboard/system-init-dashboard.page.html` | Disable buttons with tooltip |\n| `apps/web/src/app/features/system-init/pages/system-init-dashboard/system-init-dashboard.page.ts` | Add MatTooltipModule import (if needed) |\n",
  "fileStats": {
    "size": 7302,
    "lines": 250,
    "lastModified": "2025-12-13T15:26:58.360Z"
  },
  "comments": []
}
