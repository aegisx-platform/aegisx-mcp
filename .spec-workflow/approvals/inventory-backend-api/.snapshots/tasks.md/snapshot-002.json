{
  "id": "snapshot_1765719545251_s3xdn8uns",
  "approvalId": "approval_1765719239872_7z46cnwj5",
  "approvalTitle": "Tasks Document - Inventory Backend API (29 tasks across 7 phases)",
  "version": 2,
  "timestamp": "2025-12-14T13:39:05.251Z",
  "trigger": "approved",
  "status": "pending",
  "content": "# Tasks Document - Inventory Backend API\n\n> **Implementation Order**: Follow tasks sequentially. Each task is designed to be completed independently with 1-3 files.\n\n## Phase 1: Database Foundation (Week 1, Days 1-2)\n\n- [ ] 1.1. Create database schema and initial migrations\n  - Files:\n    - `apps/api/src/database/migrations-inventory/001_create_inventory_schema.ts`\n    - `apps/api/src/database/migrations-inventory/002_create_inventory_table.ts`\n    - `apps/api/src/database/migrations-inventory/003_create_drug_lots_table.ts`\n    - `apps/api/src/database/migrations-inventory/004_create_inventory_transactions_table.ts`\n  - Purpose: Create `inventory` schema and core tables\n  - _Leverage: Existing migration patterns from migrations-public/_\n  - _Requirements: Database schema from design.md, REQ-1 to REQ-12_\n  - _Prompt: Implement the task for spec inventory-backend-api, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Database Engineer with PostgreSQL expertise | Task: Create Knex migration files to set up inventory schema with three core tables (inventory, drug_lots, inventory_transactions) following the data models in design.md. Include proper indexes, constraints, and foreign keys. | Restrictions: Use DECIMAL(15,3) for quantities, DECIMAL(15,4) for costs, ensure unique constraint on (drug_id, location_id) for inventory table, make inventory_transactions immutable (no UPDATE trigger) | _Leverage: Existing migration patterns from apps/api/src/database/migrations-public/ | _Requirements: All database models from design.md | Success: Migrations execute successfully, all tables created with correct schema, foreign keys validated, indexes created for query optimization_\n\n- [ ] 1.2. Create database functions for FIFO/FEFO logic\n  - Files:\n    - `apps/api/src/database/migrations-inventory/005_create_fifo_fefo_functions.ts`\n  - Purpose: Implement get_fifo_lots() and get_fefo_lots() PostgreSQL functions\n  - _Leverage: SQL function syntax, existing database function patterns_\n  - _Requirements: WF-2 FIFO/FEFO Dispensing workflow_\n  - _Prompt: Implement the task for spec inventory-backend-api, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Database Engineer with expertise in PostgreSQL functions and query optimization | Task: Create PostgreSQL functions get_fifo_lots(drug_id, location_id, quantity_needed) and get_fefo_lots(drug_id, location_id, quantity_needed) that return lots in FIFO and FEFO order respectively. Functions should return lot_id, lot_number, quantity to deduct, unit_cost. | Restrictions: Use SETOF RECORD return type, ensure functions handle partial lot depletion correctly, optimize with proper ORDER BY (received_date for FIFO, expiry_date for FEFO) | _Leverage: PostgreSQL function syntax, SQL aggregate functions | _Requirements: WF-2 from requirements.md | Success: Functions execute efficiently (<200ms), return correct lot order, handle edge cases (no lots available, quantity exceeds total), tested with sample data_\n\n- [ ] 1.3. Create database function for receipt posting workflow\n  - Files:\n    - `apps/api/src/database/migrations-inventory/006_create_receipt_posting_function.ts`\n  - Purpose: Implement update_inventory_from_receipt(receipt_id) function\n  - _Leverage: PostgreSQL transaction management, existing function patterns_\n  - _Requirements: WF-1 Stock Receipt from Procurement_\n  - _Prompt: Implement the task for spec inventory-backend-api, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Database Engineer with expertise in PostgreSQL stored procedures and transactions | Task: Create PostgreSQL function update_inventory_from_receipt(receipt_id BIGINT) that atomically creates/updates inventory records, creates drug lots, calculates average cost, and creates RECEIVE transactions for all receipt items. | Restrictions: Must be atomic (single transaction), calculate weighted average cost correctly: (old_qty × old_cost + new_qty × new_cost) / total_qty, handle non-existent inventory records (INSERT), update existing records (UPDATE), must return BOOLEAN (success/failure) | _Leverage: PostgreSQL transaction blocks (BEGIN/COMMIT/ROLLBACK), UPSERT patterns | _Requirements: WF-1 from requirements.md | Success: Function executes atomically, average cost calculated correctly, all related records created in single transaction, rolls back on any error, tested with sample receipts | After completion: Mark this task as in_progress in tasks.md before starting, log implementation details with artifacts using log-implementation tool after completion (including function signature, SQL code location, test results), then mark as complete [x]_\n\n## Phase 2: Repository Layer (Week 1, Days 3-5)\n\n- [ ] 2.1. Create Inventory repository with base CRUD operations\n  - Files:\n    - `apps/api/src/layers/inventory/operations/inventory/inventory.repository.ts`\n    - `apps/api/src/layers/inventory/operations/inventory/inventory.schemas.ts`\n    - `apps/api/src/layers/inventory/operations/inventory/inventory.types.ts`\n  - Purpose: Implement data access layer for inventory table\n  - _Leverage: BaseRepository from shared/repositories/base.repository.ts_\n  - _Requirements: REQ-1, REQ-2 Stock inquiry endpoints_\n  - _Prompt: Implement the task for spec inventory-backend-api, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Backend Developer with TypeScript and Knex.js expertise | Task: Create InventoryRepository extending BaseRepository with custom methods: findByDrugAndLocation(), findLowStock(), getStockValuation(), updateQuantity(), recalculateAverageCost(). Create TypeBox schemas (InventorySchema, CreateInventorySchema, UpdateInventorySchema) and type definitions. | Restrictions: Must extend BaseRepository, use inventory schema (not public), define searchable fields as ['inventory.drug_id', 'inventory.location_id'], implement transformToEntity() correctly, validate quantity_on_hand >= 0 | _Leverage: apps/api/src/shared/repositories/base.repository.ts, apps/api/src/layers/platform/departments/departments.repository.ts as reference | _Requirements: REQ-1, REQ-2 from requirements.md | Success: Repository extends BaseRepository correctly, all custom methods implemented and typed, schemas validated, transformations work both ways, compiles without TypeScript errors | After completion: Mark task in_progress [-], implement code, log with log-implementation (artifacts: classes with methods, file locations), mark complete [x]_\n\n- [ ] 2.2. Create DrugLots repository with FIFO/FEFO integration\n  - Files:\n    - `apps/api/src/layers/inventory/operations/drug-lots/drug-lots.repository.ts`\n    - `apps/api/src/layers/inventory/operations/drug-lots/drug-lots.schemas.ts`\n    - `apps/api/src/layers/inventory/operations/drug-lots/drug-lots.types.ts`\n  - Purpose: Implement data access layer for drug_lots table with database function integration\n  - _Leverage: BaseRepository, database functions (get_fifo_lots, get_fefo_lots)_\n  - _Requirements: REQ-3, REQ-4 Lot management endpoints_\n  - _Prompt: Implement the task for spec inventory-backend-api, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Backend Developer with expertise in TypeScript, Knex, and PostgreSQL functions | Task: Create DrugLotsRepository extending BaseRepository with custom methods: findByDrugAndLocation(orderBy: 'FIFO'|'FEFO'), findExpiringLots(), updateQuantityAvailable(), deactivateLot(). Add wrappers for database functions: getFifoLots() using knex.raw(), getFefoLots() using knex.raw(). Create complete TypeBox schemas and types. | Restrictions: Must call database functions via knex.raw(`SELECT * FROM inventory.get_fifo_lots($1, $2, $3)`, [drugId, locationId, qty]), handle BIGINT types correctly, validate expiry_date > received_date, ensure quantity_available >= 0 | _Leverage: BaseRepository, database function integration patterns, bigint handling in TypeScript | _Requirements: REQ-3, REQ-4, WF-2 from requirements.md | Success: Repository methods work correctly, database functions integrated successfully, FIFO/FEFO order validated, schemas type-safe, lot status calculations accurate | After completion: Mark in_progress, implement, log artifacts (methods, function wrappers, database integration), mark complete_\n\n- [ ] 2.3. Create InventoryTransactions repository (read-only)\n  - Files:\n    - `apps/api/src/layers/inventory/operations/inventory-transactions/inventory-transactions.repository.ts`\n    - `apps/api/src/layers/inventory/operations/inventory-transactions/inventory-transactions.schemas.ts`\n    - `apps/api/src/layers/inventory/operations/inventory-transactions/inventory-transactions.types.ts`\n  - Purpose: Implement immutable transaction log repository\n  - _Leverage: BaseRepository (read-only variant)_\n  - _Requirements: REQ-11 Transaction history_\n  - _Prompt: Implement the task for spec inventory-backend-api, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Backend Developer with expertise in audit trail implementation | Task: Create InventoryTransactionsRepository extending BaseRepository but OVERRIDE update() and delete() methods to throw errors ('Inventory transactions are immutable', 'Transactions cannot be deleted'). Implement custom query methods: findByInventory(), findByDrugAndLocation(), findByReference(), getTransactionHistory(). Create schemas without UpdateInventoryTransactionSchema (only Create). | Restrictions: Must prevent updates/deletes at repository level, transaction_type enum must match DB enum (RECEIVE, ISSUE, TRANSFER, ADJUST, RETURN), quantity can be negative for deductions, created_at is immutable | _Leverage: BaseRepository patterns, TypeBox enum schemas | _Requirements: REQ-11, immutability requirement from design.md | Success: Update/delete methods throw errors, read operations work correctly, transaction queries filter properly, immutability enforced, audit trail integrity maintained | After completion: Mark in_progress, implement, log artifacts, mark complete_\n\n## Phase 3: Service Layer (Week 2, Days 1-3)\n\n- [ ] 3.1. Create Inventory service with business logic\n  - Files:\n    - `apps/api/src/layers/inventory/operations/inventory/inventory.service.ts`\n  - Purpose: Implement business logic for stock management\n  - _Leverage: BaseService, InventoryRepository, DrugLotsRepository_\n  - _Requirements: REQ-1, REQ-2, REQ-8 Stock level operations_\n  - _Prompt: Implement the task for spec inventory-backend-api, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Backend Developer with expertise in service layer architecture | Task: Create InventoryService extending BaseService with methods: getStockLevel(drugId, locationId), getLowStockItems(query), getStockValuation(query), updateMinMaxLevels(id, data), validateStockAvailability(drugId, locationId, qty), calculateStockStatus(inventory), calculateDaysOfSupply(inventory). Implement business rules: min < reorder < max validation, stock status logic (OK/LOW/CRITICAL/OVERSTOCK), days of supply calculation from 90-day average. | Restrictions: Must validate min_level < reorder_point < max_level, throw AppError with appropriate error codes, use repository methods (not direct DB access), calculate stock_status based on quantity vs min/max levels | _Leverage: apps/api/src/shared/services/base.service.ts, apps/api/src/core/errors/app-error.ts, calculation utilities | _Requirements: REQ-1, REQ-2, REQ-8, business rules from design.md | Success: All service methods implemented, business rules enforced, validations prevent invalid data, calculations accurate, error handling robust | After completion: Mark in_progress, implement, log artifacts (service class, methods, business logic), mark complete_\n\n- [ ] 3.2. Create DrugLots service with expiry logic\n  - Files:\n    - `apps/api/src/layers/inventory/operations/drug-lots/drug-lots.service.ts`\n  - Purpose: Implement business logic for lot management and expiry tracking\n  - _Leverage: BaseService, DrugLotsRepository_\n  - _Requirements: REQ-3, REQ-4, REQ-5 Lot operations_\n  - _Prompt: Implement the task for spec inventory-backend-api, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Backend Developer with expertise in business logic and date calculations | Task: Create DrugLotsService extending BaseService with methods: getLotsByDrug(drugId, locationId, orderBy), getExpiringLots(query), getLotDetails(id), createLotFromReceipt(receiptItem), deductLotQuantity(lotId, qty), validateLotNotExpired(lot), validateLotActive(lot), calculateExpiryStatus(expiryDate), calculateDaysUntilExpiry(expiryDate). Implement expiry status logic: OK (>180 days), WARN (90-180 days), CRITICAL (<90 days), EXPIRED (<0 days). | Restrictions: Block dispensing if expiry_date < current_date + 30 days, validate lot.is_active = true before operations, calculate days from milliseconds: Math.ceil((expiryDate - now) / (24*60*60*1000)), throw LOT_EXPIRED error for expired lots | _Leverage: BaseService, date utilities, AppError | _Requirements: REQ-3, REQ-4, REQ-5, expiry rules from design.md | Success: Lot queries return correct order (FIFO/FEFO), expiry calculations accurate, status logic correct, validations prevent use of expired/inactive lots | After completion: Mark in_progress, implement, log artifacts, mark complete_\n\n- [ ] 3.3. Create InventoryAdjustments service for stock adjustments\n  - Files:\n    - `apps/api/src/layers/inventory/operations/inventory-adjustments/inventory-adjustments.service.ts`\n    - `apps/api/src/layers/inventory/operations/inventory-adjustments/inventory-adjustments.schemas.ts`\n    - `apps/api/src/layers/inventory/operations/inventory-adjustments/inventory-adjustments.types.ts`\n  - Purpose: Handle stock adjustments with validation and audit\n  - _Leverage: InventoryRepository, DrugLotsRepository, InventoryTransactionsRepository, Knex transactions_\n  - _Requirements: REQ-6, REQ-7 Adjustment operations_\n  - _Prompt: Implement the task for spec inventory-backend-api, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Backend Developer with expertise in transactional workflows | Task: Create InventoryAdjustmentsService with methods: createAdjustment(data, userId), getAdjustmentHistory(query). Implement atomic workflow in Knex transaction: validate adjustment data, check SUBTRACT doesn't cause negative stock, update inventory.quantity_on_hand (+/- quantity), create inventory_transaction (type: ADJUST), record previous/new quantities. If lot_id provided, also adjust lot quantity proportionally. | Restrictions: Must use knex.transaction() for atomicity, validate quantity_on_hand >= 0 after SUBTRACT, record variance = new - old, store adjustment_reason_id reference, rollback entire transaction on any error | _Leverage: Knex transaction patterns, repository methods, AppError for INSUFFICIENT_STOCK | _Requirements: REQ-6, REQ-7 from requirements.md | Success: Adjustments execute atomically, validations prevent negative stock, transactions logged correctly, audit trail complete, rollback works on errors | After completion: Mark in_progress, implement, log artifacts (service, transaction flow), mark complete_\n\n- [ ] 3.4. Create InventoryTransfers service for location transfers\n  - Files:\n    - `apps/api/src/layers/inventory/operations/inventory-transfers/inventory-transfers.service.ts`\n    - `apps/api/src/layers/inventory/operations/inventory-transfers/inventory-transfers.schemas.ts`\n    - `apps/api/src/layers/inventory/operations/inventory-transfers/inventory-transfers.types.ts`\n  - Purpose: Handle stock transfers between locations\n  - _Leverage: InventoryRepository, DrugLotsRepository, InventoryTransactionsRepository, FIFO function_\n  - _Requirements: REQ-9 Transfer operations_\n  - _Prompt: Implement the task for spec inventory-backend-api, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Backend Developer with expertise in complex transactional workflows | Task: Create InventoryTransfersService with methods: createTransfer(data, userId), getTransferHistory(query). Implement atomic workflow: validate source != destination, check source stock availability, call get_fifo_lots() to select lots, deduct from source inventory, add to destination inventory (UPSERT), create lots at destination with same lot_number/expiry, create two transactions (TRANSFER_OUT source, TRANSFER_IN destination), link via reference_id. | Restrictions: All operations must be in single transaction, use FIFO lot selection, preserve lot information (lot_number, expiry_date) at destination, validate from_location_id != to_location_id, rollback if any step fails | _Leverage: Knex transactions, get_fifo_lots function, repository UPSERT patterns | _Requirements: REQ-9, transfer workflow from design.md | Success: Transfers execute atomically, FIFO logic applied correctly, lot information preserved, both source and destination updated, dual transactions created, rollback on errors | After completion: Mark in_progress, implement, log artifacts, mark complete_\n\n- [ ] 3.5. Create InventoryTransactions service (query only)\n  - Files:\n    - `apps/api/src/layers/inventory/operations/inventory-transactions/inventory-transactions.service.ts`\n  - Purpose: Provide transaction history query service\n  - _Leverage: BaseService, InventoryTransactionsRepository_\n  - _Requirements: REQ-11 Transaction history_\n  - _Prompt: Implement the task for spec inventory-backend-api, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Backend Developer with expertise in query services | Task: Create InventoryTransactionsService extending BaseService (read-only) with methods: getTransactionHistory(query), getTransactionsByInventory(inventoryId, query), getTransactionsByDrug(drugId, locationId, query), getTransactionByReference(referenceId, referenceType). Support filtering by transaction_type, date range (fromDate, toDate), pagination. | Restrictions: No create/update/delete methods (transactions created by other services), only read operations, must join with inventory table for drug/location context, order by created_at DESC by default | _Leverage: BaseService read patterns, repository query methods | _Requirements: REQ-11 from requirements.md | Success: Query methods return correct filtered results, pagination works, date range filtering accurate, transaction types filterable, joined data includes context | After completion: Mark in_progress, implement, log artifacts, mark complete_\n\n## Phase 4: Workflow Layer (Week 2, Days 4-5)\n\n- [ ] 4.1. Create Receipt Posting workflow\n  - Files:\n    - `apps/api/src/layers/inventory/operations/workflows/receipt-posting.workflow.ts`\n  - Purpose: Automate inventory update from Procurement receipt posting\n  - _Leverage: All repositories, Knex transactions, database function_\n  - _Requirements: WF-1 Receipt posting workflow, INT-1 Procurement integration_\n  - _Prompt: Implement the task for spec inventory-backend-api, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Backend Developer with expertise in workflow automation and system integration | Task: Create ReceiptPostingWorkflow class with processReceipt(receiptId) method that calls database function update_inventory_from_receipt(receiptId). Add helper methods: fetchReceiptData(receiptId) from Procurement schema, validateReceiptNotPosted(receipt), handlePostingSuccess(), handlePostingError(error). Implement idempotency check (receipt.posted_at IS NOT NULL). | Restrictions: Must call database function for actual posting, fetch receipt from procurement.receipts table, validate receipt.status = 'APPROVED', check receipt not already posted (idempotent), log errors with correlation IDs, return boolean success/failure | _Leverage: Database function update_inventory_from_receipt, cross-schema queries (procurement schema), error handling patterns | _Requirements: WF-1, INT-1 from requirements.md | Success: Workflow calls database function correctly, idempotency works (duplicate calls return success without re-posting), integration with Procurement schema successful, error handling robust, tested with sample receipts | After completion: Mark in_progress, implement, log artifacts (workflow class, integration points, database function calls), mark complete_\n\n- [ ] 4.2. Create FIFO Dispensing workflow\n  - Files:\n    - `apps/api/src/layers/inventory/operations/workflows/fifo-dispensing.workflow.ts`\n  - Purpose: Automate lot selection and stock deduction for distributions\n  - _Leverage: DrugLotsRepository, InventoryRepository, FIFO/FEFO functions_\n  - _Requirements: WF-2 FIFO/FEFO workflow, INT-2 Distribution integration_\n  - _Prompt: Implement the task for spec inventory-backend-api, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Backend Developer with expertise in inventory algorithms and transactional workflows | Task: Create FifoDispensingWorkflow class with methods: dispenseFifo(data), dispenseFefo(data). Implement atomic workflow: validate stock availability, call get_fifo_lots() or get_fefo_lots(), deduct quantity from each lot in order, update lot.quantity_available, deactivate lots where quantity_available = 0 (set is_active = false), reduce inventory.quantity_on_hand, create ISSUE transaction with negative quantity, return dispensed lot details. | Restrictions: Must use appropriate database function (FIFO vs FEFO), deduct in loop handling partial lot depletion, deactivate depleted lots atomically, all operations in single transaction, validate no negative quantities, throw INSUFFICIENT_STOCK if total available < requested | _Leverage: get_fifo_lots/get_fefo_lots functions, Knex transactions, repository update methods | _Requirements: WF-2, INT-2 from requirements.md | Success: Lots selected in correct order (oldest/expiring first), quantities deducted accurately, depleted lots deactivated, inventory reduced, transaction logged, rollback on errors, integration tested | After completion: Mark in_progress, implement, log artifacts (workflow, lot selection logic, deactivation), mark complete_\n\n- [ ] 4.3. Create Expiry Management workflow (scheduled job)\n  - Files:\n    - `apps/api/src/layers/inventory/operations/workflows/expiry-management.workflow.ts`\n  - Purpose: Daily scheduled job for expiry alerts and auto-quarantine\n  - _Leverage: DrugLotsRepository, InventoryTransfersService, NotificationService_\n  - _Requirements: WF-3 Expiry management workflow_\n  - _Prompt: Implement the task for spec inventory-backend-api, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Backend Developer with expertise in scheduled jobs and notification systems | Task: Create ExpiryManagementWorkflow class with checkExpiringDrugs() method (called by cron job). Implement workflow: findExpiringLots(180 days), categorizeByUrgency() into INFO (180-90 days), WARNING (90-30 days), CRITICAL (<30 days), EXPIRED (<0 days), sendExpiryAlerts() via NotificationService, quarantineExpiredLots() by calling transfersService to move to QUARANTINE location, deactivate expired lots, generateExpiryReport(). | Restrictions: Run daily at 8:00 AM (cron: '0 8 * * *'), find QUARANTINE location by location_code = 'QUARANTINE', transfer expired lots automatically, send alerts to roles: ['PHARMACIST', 'INVENTORY_MANAGER'], categorize by days_until_expiry thresholds, include lot details and total value in alerts | _Leverage: DrugLotsRepository.findExpiringLots(), InventoryTransfersService.createTransfer(), notification service patterns | _Requirements: WF-3, expiry rules from design.md | Success: Job runs on schedule, lots categorized correctly by urgency, alerts sent to appropriate users, expired lots quarantined automatically, report generated with summary, tested with expiring lot data | After completion: Mark in_progress, implement, log artifacts (workflow, cron configuration, alert logic), mark complete_\n\n## Phase 5: Controllers & Routes (Week 3)\n\n### Phase 5A: Stock Inquiry Endpoints (Days 1-2)\n\n- [ ] 5.1. Implement GET /api/inventory/operations/inventory/stock (list stock levels)\n  - Files:\n    - `apps/api/src/layers/inventory/operations/inventory/inventory.controller.ts` (create or extend)\n    - `apps/api/src/layers/inventory/operations/inventory/inventory.routes.ts` (create or extend)\n  - Purpose: List stock levels with filtering\n  - _Leverage: InventoryService, BaseController patterns, TypeBox schemas_\n  - _Requirements: REQ-1 List stock levels_\n  - _Prompt: Implement the task for spec inventory-backend-api, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Backend Developer with Fastify expertise | Task: Create InventoryController with list() method handling GET /stock endpoint. Accept query params: locationId, drugId, belowMin (boolean), search (string), page, limit. Call inventoryService.findMany(query), return paginated response with stock data including drug/location details, stock_status, days_of_supply, stock_value. Create Fastify route with schema validation (ListInventoryQuerySchema, FlexibleInventoryListResponseSchema), authentication hook, permission check ('inventory', 'read'). | Restrictions: Must use reply.paginated() helper, validate query parameters via TypeBox, require authentication (fastify.authenticate) and authorization (fastify.verifyPermission), handle errors with try/catch and fastify.log.error, support field selection for performance | _Leverage: apps/api/src/layers/platform/departments/departments.controller.ts and departments.routes.ts as reference, BaseController patterns | _Requirements: REQ-1 from requirements.md | Success: Endpoint returns paginated stock list, filtering works correctly, stock calculations accurate, authentication/authorization enforced, OpenAPI documentation generated, tested via Postman/curl | After completion: Mark in_progress, implement, log artifacts (apiEndpoints with method/path/purpose/location, controller methods), mark complete_\n\n- [ ] 5.2. Implement GET /api/inventory/operations/inventory/stock/:drugId/:locationId (specific stock)\n  - Files:\n    - `apps/api/src/layers/inventory/operations/inventory/inventory.controller.ts` (extend)\n    - `apps/api/src/layers/inventory/operations/inventory/inventory.routes.ts` (extend)\n  - Purpose: Get stock details for specific drug/location\n  - _Leverage: InventoryService.getStockLevel(), controller patterns_\n  - _Requirements: REQ-2 Get specific stock_\n  - _Prompt: Implement the task for spec inventory-backend-api, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Backend Developer with API development expertise | Task: Add getByDrugLocation() method to InventoryController handling GET /stock/:drugId/:locationId. Call inventoryService.getStockLevel(params.drugId, params.locationId), return detailed stock info including drug details, location details, stock_status, days_of_supply, stock_value, active_lots_count, oldest_expiry_date. Create route with param schema (DrugIdLocationIdParamSchema) and response schema (StockLevelDetailsResponseSchema). Handle 404 STOCK_NOT_FOUND error. | Restrictions: Validate drugId and locationId are valid bigints/numbers, return 404 if stock not found, include computed fields (stock_status, days_of_supply), require 'inventory' 'read' permission, log request with correlation ID | _Leverage: Controller error handling patterns, TypeBox param schemas | _Requirements: REQ-2 from requirements.md | Success: Endpoint returns detailed stock information, 404 on not found, calculations included, params validated, authenticated/authorized, tested with various drug/location combinations | After completion: Mark in_progress, implement, log artifacts (apiEndpoints), mark complete_\n\n- [ ] 5.3. Implement GET /api/inventory/operations/drug-lots (list lots)\n  - Files:\n    - `apps/api/src/layers/inventory/operations/drug-lots/drug-lots.controller.ts` (create)\n    - `apps/api/src/layers/inventory/operations/drug-lots/drug-lots.routes.ts` (create)\n  - Purpose: List lots with FIFO/FEFO ordering\n  - _Leverage: DrugLotsService, controller patterns_\n  - _Requirements: REQ-3 List active lots_\n  - _Prompt: Implement the task for spec inventory-backend-api, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Backend Developer with expertise in API development | Task: Create DrugLotsController with list() method for GET /drug-lots. Accept query params: drugId (required), locationId (required), orderBy ('FIFO'|'FEFO', default 'FIFO'), includeExpired (boolean, default false), page, limit. Call drugLotsService.getLotsByDrug(drugId, locationId, orderBy), return paginated lots with computed fields (is_expired, days_until_expiry, expiry_status, utilization_percent). Create route with query validation and response schema. | Restrictions: Require drugId and locationId (400 if missing), validate orderBy enum value, default to FIFO if not specified, filter expired lots unless includeExpired=true, calculate expiry fields in service, require 'drug_lots' 'read' permission | _Leverage: Pagination patterns, enum validation in TypeBox | _Requirements: REQ-3 from requirements.md | Success: Lots returned in correct order (FIFO/FEFO), expiry calculations accurate, filtering works, pagination functional, query validation enforced, tested with different orderBy values | After completion: Mark in_progress, implement, log artifacts (apiEndpoints, controller), mark complete_\n\n- [ ] 5.4. Implement GET /api/inventory/operations/drug-lots/expiring (expiring lots)\n  - Files:\n    - `apps/api/src/layers/inventory/operations/drug-lots/drug-lots.controller.ts` (extend)\n    - `apps/api/src/layers/inventory/operations/drug-lots/drug-lots.routes.ts` (extend)\n  - Purpose: Get lots expiring within threshold\n  - _Leverage: DrugLotsService.getExpiringLots()_\n  - _Requirements: REQ-4 Get expiring lots_\n  - _Prompt: Implement the task for spec inventory-backend-api, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Backend Developer with API expertise | Task: Add getExpiring() method to DrugLotsController for GET /drug-lots/expiring. Accept query params: daysThreshold (default 180), locationId (optional), page, limit. Call drugLotsService.getExpiringLots(query), return lots with drug details, location details, expiry calculations, total value. Include summary: total_lots, total_value, critical_lots (<90 days), warning_lots (90-180 days). Create route with schema validation. | Restrictions: Default daysThreshold to 180 if not provided, order by expiry_date ASC (soonest first), calculate total_value = quantity × unit_cost, group summary by urgency levels, require permission, handle empty results gracefully | _Leverage: Aggregation patterns, summary calculation utilities | _Requirements: REQ-4 from requirements.md | Success: Expiring lots returned correctly, threshold filtering accurate, summary calculated properly, value totals correct, tested with various thresholds | After completion: Mark in_progress, implement, log artifacts (apiEndpoints), mark complete_\n\n- [ ] 5.5. Implement GET /api/inventory/operations/drug-lots/:id (lot details)\n  - Files:\n    - `apps/api/src/layers/inventory/operations/drug-lots/drug-lots.controller.ts` (extend)\n    - `apps/api/src/layers/inventory/operations/drug-lots/drug-lots.routes.ts` (extend)\n  - Purpose: Get complete lot details\n  - _Leverage: DrugLotsService.getLotDetails()_\n  - _Requirements: REQ-5 Get lot details_\n  - _Prompt: Implement the task for spec inventory-backend-api, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Backend Developer with API development skills | Task: Add getById() method to DrugLotsController for GET /drug-lots/:id. Call drugLotsService.getLotDetails(params.id), return complete lot info including drug details (with generic name), location details, receipt info if available, expiry calculations, lot status (active/depleted/expired). Handle 404 LOT_NOT_FOUND. Create route with param schema and response schema. | Restrictions: Validate id is valid bigint, return 404 if not found, include all computed fields, join drug with generic for complete drug name, include receipt_id reference, require permission, log access for audit | _Leverage: Repository join patterns, param validation | _Requirements: REQ-5 from requirements.md | Success: Detailed lot information returned, related data joined correctly, calculations accurate, 404 handling works, tested with existing and non-existent IDs | After completion: Mark in_progress, implement, log artifacts (apiEndpoints), mark complete_\n\n### Phase 5B: Stock Management Endpoints (Days 3-4)\n\n- [ ] 5.6. Implement POST /api/inventory/operations/inventory-adjustments (create adjustment)\n  - Files:\n    - `apps/api/src/layers/inventory/operations/inventory-adjustments/inventory-adjustments.controller.ts` (create)\n    - `apps/api/src/layers/inventory/operations/inventory-adjustments/inventory-adjustments.routes.ts` (create)\n  - Purpose: Create stock adjustment with validation\n  - _Leverage: InventoryAdjustmentsService, EventService for WebSocket_\n  - _Requirements: REQ-6 Create adjustment_\n  - _Prompt: Implement the task for spec inventory-backend-api, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Backend Developer with transaction handling expertise | Task: Create InventoryAdjustmentsController with create() method for POST /inventory-adjustments. Accept body: drug_id, location_id, adjustment_type ('ADD'|'SUBTRACT'), quantity, adjustment_reason_id, lot_id (optional), notes, adjustment_date. Extract userId from request.user, call adjustmentsService.createAdjustment(body, userId). Emit WebSocket event 'inventory:adjustment_created'. Return 201 with adjustment result (previous_quantity, new_quantity, variance). Create route with CreateAdjustmentSchema validation. | Restrictions: Validate adjustment_type enum, require adjustment_reason_id, extract userId from JWT token (request.user.id), return 400 INSUFFICIENT_STOCK if subtract exceeds available, require 'inventory_adjustments' 'create' permission, emit event after success | _Leverage: EventService.for('inventory', 'adjustment'), AppError handling | _Requirements: REQ-6 from requirements.md | Success: Adjustments created successfully, validation prevents invalid operations, WebSocket events emitted, audit trail recorded, 201 status returned, tested with ADD/SUBTRACT scenarios | After completion: Mark in_progress, implement, log artifacts (apiEndpoints, integration with WebSocket), mark complete_\n\n- [ ] 5.7. Implement GET /api/inventory/operations/inventory-adjustments (list adjustments)\n  - Files:\n    - `apps/api/src/layers/inventory/operations/inventory-adjustments/inventory-adjustments.controller.ts` (extend)\n    - `apps/api/src/layers/inventory/operations/inventory-adjustments/inventory-adjustments.routes.ts` (extend)\n  - Purpose: List adjustment history with filtering\n  - _Leverage: InventoryAdjustmentsService.getAdjustmentHistory()_\n  - _Requirements: REQ-7 List adjustments_\n  - _Prompt: Implement the task for spec inventory-backend-api, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Backend Developer with query API expertise | Task: Add list() method to InventoryAdjustmentsController for GET /inventory-adjustments. Accept query params: drugId, locationId, fromDate, toDate, page, limit. Call adjustmentsService.getAdjustmentHistory(query), return paginated adjustments with drug details, location details, adjustment type, quantity, reason, created_by user info. Create route with query schema validation. | Restrictions: Parse dates correctly (ISO format), order by created_at DESC, join with users table for created_by name, include adjustment_reason lookup, require 'inventory_adjustments' 'read' permission, support date range filtering | _Leverage: Date parsing utilities, join patterns for user info | _Requirements: REQ-7 from requirements.md | Success: Adjustment history returned, filtering by drug/location/date works, user info included, pagination functional, tested with various filters | After completion: Mark in_progress, implement, log artifacts (apiEndpoints), mark complete_\n\n- [ ] 5.8. Implement PUT /api/inventory/operations/inventory/:id/min-max (update min/max levels)\n  - Files:\n    - `apps/api/src/layers/inventory/operations/inventory/inventory.controller.ts` (extend)\n    - `apps/api/src/layers/inventory/operations/inventory/inventory.routes.ts` (extend)\n  - Purpose: Update min/max/reorder levels for inventory\n  - _Leverage: InventoryService.updateMinMaxLevels()_\n  - _Requirements: REQ-8 Update min/max levels_\n  - _Prompt: Implement the task for spec inventory-backend-api, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Backend Developer with validation expertise | Task: Add updateMinMax() method to InventoryController for PUT /inventory/:id/min-max. Accept body: min_level, max_level, reorder_point. Call inventoryService.updateMinMaxLevels(params.id, body), validate min < reorder < max business rule, emit WebSocket event 'inventory:levels_updated'. Return updated inventory with warning if current stock <= new min_level. Create route with param and body schemas. | Restrictions: Validate min_level < reorder_point < max_level (400 error if violated), allow partial updates (all fields optional), return 404 if inventory not found, require 'inventory' 'update' permission, log level changes for audit | _Leverage: Business rule validation in service, AppError for MIN_MAX_VIOLATION | _Requirements: REQ-8, business rules from design.md | Success: Min/max levels updated, validation enforced, warnings returned, WebSocket events emitted, tested with valid/invalid level combinations | After completion: Mark in_progress, implement, log artifacts (apiEndpoints), mark complete_\n\n- [ ] 5.9. Implement POST /api/inventory/operations/inventory-transfers (create transfer)\n  - Files:\n    - `apps/api/src/layers/inventory/operations/inventory-transfers/inventory-transfers.controller.ts` (create)\n    - `apps/api/src/layers/inventory/operations/inventory-transfers/inventory-transfers.routes.ts` (create)\n  - Purpose: Transfer stock between locations\n  - _Leverage: InventoryTransfersService, EventService_\n  - _Requirements: REQ-9 Stock transfer_\n  - _Prompt: Implement the task for spec inventory-backend-api, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Backend Developer with complex transaction expertise | Task: Create InventoryTransfersController with create() method for POST /inventory-transfers. Accept body: drug_id, from_location_id, to_location_id, quantity, lot_id (optional), transfer_date, notes. Extract userId from request.user, call transfersService.createTransfer(body, userId). Emit WebSocket events for both locations. Return 201 with transfer details including source/destination inventory updates and transactions created. Create route with schema validation. | Restrictions: Validate from_location_id != to_location_id (400 TRANSFER_SAME_LOCATION), check user has access to both locations, verify sufficient stock at source, require 'inventory_transfers' 'create' permission, emit separate events for source and destination locations | _Leverage: Location-based WebSocket rooms (eventService.broadcast(`location:${locationId}`)), multi-entity updates | _Requirements: REQ-9 from requirements.md | Success: Transfers execute successfully, both locations updated, lot info preserved, dual transactions created, events emitted, 201 returned, tested with inter-location transfers | After completion: Mark in_progress, implement, log artifacts (apiEndpoints, integrations), mark complete_\n\n### Phase 5C: Reporting & Alerts Endpoints (Day 5)\n\n- [ ] 5.10. Implement GET /api/inventory/operations/inventory/low-stock (low stock items)\n  - Files:\n    - `apps/api/src/layers/inventory/operations/inventory/inventory.controller.ts` (extend)\n    - `apps/api/src/layers/inventory/operations/inventory/inventory.routes.ts` (extend)\n  - Purpose: Get items below reorder point\n  - _Leverage: InventoryService.getLowStockItems()_\n  - _Requirements: REQ-10 Low stock items_\n  - _Prompt: Implement the task for spec inventory-backend-api, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Backend Developer with reporting expertise | Task: Add getLowStock() method to InventoryController for GET /inventory/low-stock. Accept query params: locationId, urgency ('LOW'|'CRITICAL'), page, limit. Call inventoryService.getLowStockItems(query), return items with drug details, current stock, min/max/reorder levels, days of supply, average daily usage, suggested order quantity, last received date. Include summary: critical_items_count, low_items_count, total_value_needed. Create route with schema. | Restrictions: Filter by urgency: CRITICAL = qty < min_level, LOW = qty <= reorder_point && qty >= min_level, calculate suggested_order_quantity = max_level - current_stock, compute average_daily_usage from last 90 days transactions, require 'inventory' 'read' permission | _Leverage: Transaction aggregation for usage calculation, summary totals | _Requirements: REQ-10 from requirements.md | Success: Low stock items returned correctly, urgency filtering works, calculations accurate, summary included, tested with low stock data | After completion: Mark in_progress, implement, log artifacts (apiEndpoints), mark complete_\n\n- [ ] 5.11. Implement GET /api/inventory/operations/inventory-transactions (transaction history)\n  - Files:\n    - `apps/api/src/layers/inventory/operations/inventory-transactions/inventory-transactions.controller.ts` (create)\n    - `apps/api/src/layers/inventory/operations/inventory-transactions/inventory-transactions.routes.ts` (create)\n  - Purpose: View complete transaction history\n  - _Leverage: InventoryTransactionsService.getTransactionHistory()_\n  - _Requirements: REQ-11 Transaction history_\n  - _Prompt: Implement the task for spec inventory-backend-api, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Backend Developer with audit trail expertise | Task: Create InventoryTransactionsController with list() method for GET /inventory-transactions. Accept query params: inventoryId, drugId, locationId, transactionType, fromDate, toDate, page, limit. Call transactionsService.getTransactionHistory(query), return paginated transactions with inventory context (drug name, location name), transaction type, quantity (+/-), unit cost, reference info, created_by user, created_at timestamp. Create route with extensive query filtering support. | Restrictions: Order by created_at DESC by default, filter by transaction_type enum if provided, parse date range correctly, join with inventory, drugs, locations, users tables for complete context, require 'inventory_transactions' 'read' permission, support filtering by reference_type | _Leverage: Complex join patterns, date range filtering, enum validation | _Requirements: REQ-11 from requirements.md | Success: Transaction history complete, filtering by all params works, joins provide context, immutability preserved, tested with various filter combinations | After completion: Mark in_progress, implement, log artifacts (apiEndpoints), mark complete_\n\n- [ ] 5.12. Implement GET /api/inventory/operations/inventory/valuation (stock valuation)\n  - Files:\n    - `apps/api/src/layers/inventory/operations/inventory/inventory.controller.ts` (extend)\n    - `apps/api/src/layers/inventory/operations/inventory/inventory.routes.ts` (extend)\n  - Purpose: Get inventory valuation report\n  - _Leverage: InventoryService.getStockValuation()_\n  - _Requirements: REQ-12 Stock valuation_\n  - _Prompt: Implement the task for spec inventory-backend-api, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Backend Developer with financial reporting expertise | Task: Add getValuation() method to InventoryController for GET /inventory/valuation. Accept query params: locationId, asOfDate (optional), format ('json'|'csv'|'excel'). Call inventoryService.getStockValuation(query), return valuation grouped by location with drug_count, total_quantity, total_value (quantity × average_cost) per location, plus grand totals. Support CSV/Excel export if format specified. Create route with schema. | Restrictions: Calculate value = sum(quantity_on_hand × average_cost), group by location with subtotals, include grand total across all locations, if asOfDate provided calculate historical valuation from transaction log, require 'inventory_valuation' 'read' permission (finance role), support export formats | _Leverage: Aggregation queries (GROUP BY location_id), SUM calculations, CSV/Excel export utilities | _Requirements: REQ-12 from requirements.md | Success: Valuation calculated correctly, grouped by location, grand totals accurate, historical valuation works if implemented, exports functional, tested with financial data | After completion: Mark in_progress, implement, log artifacts (apiEndpoints), mark complete_\n\n## Phase 6: Testing (Week 4)\n\n- [ ] 6.1. Create unit tests for repositories\n  - Files:\n    - `apps/api/src/layers/inventory/operations/inventory/__tests__/inventory.repository.spec.ts`\n    - `apps/api/src/layers/inventory/operations/drug-lots/__tests__/drug-lots.repository.spec.ts`\n    - `apps/api/src/layers/inventory/operations/inventory-transactions/__tests__/inventory-transactions.repository.spec.ts`\n  - Purpose: Test repository methods and data transformations\n  - _Leverage: Vitest, mock Knex, test utilities_\n  - _Requirements: All repository methods_\n  - _Prompt: Implement the task for spec inventory-backend-api, first run spec-workflow-guide to get the workflow guide then implement the task: Role: QA Engineer with expertise in unit testing and mocking | Task: Create unit tests for all repository classes testing: transformToEntity() both directions, custom query methods (findByDrugAndLocation, getFifoLots, etc.), query building with filters/sorting/pagination, database function wrappers. Mock Knex for all database calls. Achieve 80%+ code coverage. | Restrictions: Mock Knex completely (no real DB access), test data transformations accurately, verify query construction without execution, test error scenarios (null results, query failures), use Vitest test framework | _Leverage: Vitest, Knex mocking patterns, test data fixtures | _Requirements: Testing strategy from design.md | Success: All repository methods tested, 80%+ coverage achieved, mocks work correctly, tests run independently, edge cases covered | After completion: Mark in_progress, implement tests, log artifacts (test files, coverage results), mark complete_\n\n- [ ] 6.2. Create unit tests for services\n  - Files:\n    - `apps/api/src/layers/inventory/operations/inventory/__tests__/inventory.service.spec.ts`\n    - `apps/api/src/layers/inventory/operations/drug-lots/__tests__/drug-lots.service.spec.ts`\n    - `apps/api/src/layers/inventory/operations/inventory-adjustments/__tests__/inventory-adjustments.service.spec.ts`\n    - `apps/api/src/layers/inventory/operations/inventory-transfers/__tests__/inventory-transfers.service.spec.ts`\n  - Purpose: Test business logic and validations\n  - _Leverage: Vitest, mock repositories, test utilities_\n  - _Requirements: All service methods and business rules_\n  - _Prompt: Implement the task for spec inventory-backend-api, first run spec-workflow-guide to get the workflow guide then implement the task: Role: QA Engineer with expertise in service testing | Task: Create unit tests for all service classes testing: business logic (min < reorder < max validation, stock status calculation, expiry status logic), validation methods (validateStockAvailability, validateLotNotExpired), error handling (INSUFFICIENT_STOCK, LOT_EXPIRED), calculation methods (average cost, days of supply). Mock all repository dependencies. | Restrictions: Mock repositories completely, test business rules in isolation, verify calculations accurately, test both success and failure paths, ensure error codes correct, use Vitest | _Leverage: Repository mocks, AppError testing patterns | _Requirements: Testing strategy from design.md | Success: All service methods tested, business rules validated, calculations verified, error handling covered, 80%+ coverage, tests isolated | After completion: Mark in_progress, implement tests, log artifacts, mark complete_\n\n- [ ] 6.3. Create unit tests for controllers\n  - Files:\n    - `apps/api/src/layers/inventory/operations/inventory/__tests__/inventory.controller.spec.ts`\n    - `apps/api/src/layers/inventory/operations/drug-lots/__tests__/drug-lots.controller.spec.ts`\n    - `apps/api/src/layers/inventory/operations/inventory-adjustments/__tests__/inventory-adjustments.controller.spec.ts`\n    - `apps/api/src/layers/inventory/operations/inventory-transfers/__tests__/inventory-transfers.controller.spec.ts`\n  - Purpose: Test HTTP request/response handling\n  - _Leverage: Vitest, mock services, Fastify testing utilities_\n  - _Requirements: All controller methods and error responses_\n  - _Prompt: Implement the task for spec inventory-backend-api, first run spec-workflow-guide to get the workflow guide then implement the task: Role: QA Engineer with API testing expertise | Task: Create unit tests for all controller classes testing: request parsing and validation, service method calls with correct params, response formatting (reply.paginated, reply.success), error responses (400, 404, 500) with correct error codes, authentication/authorization (mocked), WebSocket event emission. Mock all service dependencies and Fastify reply. | Restrictions: Mock services completely, verify reply methods called correctly, test error scenarios (validation failures, service errors), check status codes accurate, ensure request.user extracted correctly, use Vitest | _Leverage: Fastify test utilities, service mocks, reply mocks | _Requirements: Testing strategy from design.md | Success: All controller methods tested, request/response flow verified, error handling covered, status codes correct, events emitted, 80%+ coverage | After completion: Mark in_progress, implement tests, log artifacts, mark complete_\n\n- [ ] 6.4. Create integration tests for workflows\n  - Files:\n    - `apps/api/src/layers/inventory/operations/workflows/__tests__/receipt-posting.workflow.spec.ts`\n    - `apps/api/src/layers/inventory/operations/workflows/__tests__/fifo-dispensing.workflow.spec.ts`\n    - `apps/api/src/layers/inventory/operations/workflows/__tests__/expiry-management.workflow.spec.ts`\n  - Purpose: Test complete workflows with real database\n  - _Leverage: Vitest, TestContainers (PostgreSQL), test data setup_\n  - _Requirements: WF-1, WF-2, WF-3 workflows_\n  - _Prompt: Implement the task for spec inventory-backend-api, first run spec-workflow-guide to get the workflow guide then implement the task: Role: QA Engineer with integration testing expertise | Task: Create integration tests for workflows using TestContainers PostgreSQL: test receipt posting creates inventory/lots/transactions, test FIFO dispensing selects oldest lots first and deducts correctly, test FEFO selects expiring lots first, test expiry workflow categorizes and quarantines. Setup test database, seed test data, verify multi-step workflows end-to-end. | Restrictions: Use real PostgreSQL via TestContainers, run migrations before tests, seed master data (drugs, locations), verify database state after workflows, test rollback on errors, clean up after tests, use Vitest | _Leverage: TestContainers, database seeding scripts, transaction testing patterns | _Requirements: All workflow requirements, integration testing from design.md | Success: Workflows execute end-to-end successfully, database state correct after execution, FIFO/FEFO order verified, rollback tested, tests reliable and repeatable | After completion: Mark in_progress, implement tests, log artifacts (integration tests, database setup), mark complete_\n\n- [ ] 6.5. Create E2E API tests for all endpoints\n  - Files:\n    - `apps/api/src/layers/inventory/operations/__tests__/e2e/inventory-api.e2e.spec.ts`\n  - Purpose: Test complete API flows from HTTP request to database\n  - _Leverage: Vitest, Fastify test injection, TestContainers_\n  - _Requirements: All 12 API endpoints (REQ-1 to REQ-12)_\n  - _Prompt: Implement the task for spec inventory-backend-api, first run spec-workflow-guide to get the workflow guide then implement the task: Role: QA Automation Engineer with E2E testing expertise | Task: Create E2E tests for all endpoints using Fastify's inject() method: test complete request/response cycle including authentication, authorization, schema validation, service calls, database updates. Test scenarios: successful operations, validation errors (400), not found (404), authorization failures (403), server errors (500). Use TestContainers for real database. | Restrictions: Use Fastify.inject() for HTTP testing, include JWT tokens in requests, verify database state changes, test all HTTP methods (GET, POST, PUT), validate response schemas, ensure tests run in sequence (setup → test → teardown), use TestContainers | _Leverage: Fastify testing patterns, TestContainers PostgreSQL, JWT token generation for tests | _Requirements: All endpoint requirements (REQ-1 to REQ-12) | Success: All endpoints tested E2E, authentication/authorization verified, database changes validated, error scenarios covered, response schemas correct, tests stable and reliable | After completion: Mark in_progress, implement tests, log artifacts (E2E test suite, test coverage), mark complete_\n\n## Phase 7: Documentation & Deployment (Week 4, Final Days)\n\n- [ ] 7.1. Generate OpenAPI/Swagger documentation\n  - Files:\n    - `apps/api/src/layers/inventory/operations/index.ts` (register routes with Fastify Swagger)\n  - Purpose: Auto-generate API documentation from TypeBox schemas\n  - _Leverage: Fastify Swagger plugin, TypeBox schema metadata_\n  - _Requirements: All API endpoints_\n  - _Prompt: Implement the task for spec inventory-backend-api, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Technical Writer with API documentation expertise | Task: Configure Fastify Swagger plugin for inventory routes, add schema tags (['Inventory: Stock', 'Inventory: Lots', 'Inventory: Adjustments', 'Inventory: Transfers', 'Inventory: Transactions']), add descriptions to all schemas and routes, generate OpenAPI 3.0 spec. Verify documentation accessible at /documentation endpoint with all inventory endpoints grouped correctly. | Restrictions: Use existing Fastify Swagger setup, add meaningful descriptions to schemas, group endpoints by resource type, include example request/response bodies, document error responses, ensure authorization requirements visible | _Leverage: Fastify Swagger plugin, TypeBox schema descriptions, OpenAPI 3.0 spec | _Requirements: API documentation requirement from design.md | Success: Swagger UI displays all endpoints, schemas documented with descriptions, examples included, tags organize endpoints logically, authentication requirements shown, accessible and user-friendly | After completion: Mark in_progress, implement, log artifacts (API documentation generation, Swagger configuration), mark complete_\n\n- [ ] 7.2. Create database migration deployment script\n  - Files:\n    - `scripts/deploy-inventory-migrations.sh`\n  - Purpose: Automate database migration deployment\n  - _Leverage: Knex migration CLI, deployment best practices_\n  - _Requirements: Database deployment_\n  - _Prompt: Implement the task for spec inventory-backend-api, first run spec-workflow-guide to get the workflow guide then implement the task: Role: DevOps Engineer with database deployment expertise | Task: Create bash script to deploy inventory migrations: check database connectivity, verify inventory schema doesn't exist (first-time) or exists (updates), run Knex migrations for migrations-inventory/ folder, verify database functions created (get_fifo_lots, get_fefo_lots, update_inventory_from_receipt), create database views (low_stock_items, expiring_drugs), seed master data if needed. Include rollback capability. | Restrictions: Check connection before running migrations, use Knex CLI (knex migrate:latest --knexfile knexfile.ts --migrations-directory migrations-inventory), verify functions exist after migration (SELECT * FROM pg_proc WHERE proname = 'get_fifo_lots'), handle errors gracefully, log migration results, support --rollback flag | _Leverage: Knex migration CLI, PostgreSQL verification queries, bash scripting | _Requirements: Deployment considerations from design.md | Success: Script deploys migrations successfully, functions verified, views created, idempotent (can run multiple times), rollback works, tested on clean database | After completion: Mark in_progress, implement, log artifacts (deployment script, verification steps), mark complete_\n\n- [ ] 7.3. Create inventory service health check endpoint\n  - Files:\n    - `apps/api/src/layers/inventory/operations/health/inventory-health.controller.ts`\n    - `apps/api/src/layers/inventory/operations/health/inventory-health.routes.ts`\n  - Purpose: Monitor inventory system health\n  - _Leverage: Health check patterns, database connectivity checks_\n  - _Requirements: Monitoring requirement from design.md_\n  - _Prompt: Implement the task for spec inventory-backend-api, first run spec-workflow-guide to get the workflow guide then implement the task: Role: DevOps Engineer with monitoring expertise | Task: Create health check endpoint GET /api/inventory/health that verifies: database connection to inventory schema, database functions exist (get_fifo_lots, get_fefo_lots, update_inventory_from_receipt), sample query execution (SELECT COUNT(*) FROM inventory.inventory), cache connectivity if used. Return 200 if healthy, 503 if unhealthy with failure details. Include component status breakdown. | Restrictions: Return 200 only if ALL checks pass, return 503 if ANY check fails, include individual check results in response, execute quickly (<1 second), no authentication required (public endpoint), log health check failures | _Leverage: Database connectivity patterns, health check response format | _Requirements: Health checks from design.md | Success: Health check executes quickly, all components verified, 200/503 status correct, failure details informative, tested with database down scenario | After completion: Mark in_progress, implement, log artifacts (health check endpoint, monitoring integration), mark complete_\n\n- [ ] 7.4. Final integration testing and bug fixes\n  - Files: (Various files as needed for bug fixes)\n  - Purpose: Comprehensive integration testing and issue resolution\n  - _Leverage: All tests, Postman/curl, integration environment_\n  - _Requirements: All requirements_\n  - _Prompt: Implement the task for spec inventory-backend-api, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Senior QA Engineer with full-stack testing expertise | Task: Perform comprehensive integration testing: test all 12 endpoints with real data, verify Procurement integration (receipt posting), verify Distribution integration (FIFO/FEFO dispensing), test expiry workflow on scheduled job, verify WebSocket events emit correctly, test error scenarios across all endpoints, validate performance meets targets (<500ms stock queries, <200ms FIFO/FEFO), verify audit trail completeness. Fix any bugs discovered. | Restrictions: Test in isolated environment, use realistic test data, verify all integrations work, ensure performance targets met, validate all error codes correct, check WebSocket events reach frontend, fix bugs before marking complete | _Leverage: All implemented endpoints, test data generators, performance profiling tools | _Requirements: All requirements (REQ-1 to REQ-12), all workflows (WF-1 to WF-3), all integrations (INT-1 to INT-4) | Success: All endpoints functional, integrations verified, performance targets met, no critical bugs, audit trail complete, WebSocket events working, comprehensive test coverage, system production-ready | After completion: Mark in_progress, perform testing, fix bugs, log artifacts (test results, bug fixes, performance metrics), mark complete_\n\n---\n\n## Completion Checklist\n\nBefore considering spec complete, verify:\n\n- [ ] 1. **Database**: Schema created, tables migrated, functions deployed, indexes created\n- [ ] 2. **Repositories**: All 3 repositories implemented, extending BaseRepository, schemas defined\n- [ ] 3. **Services**: All 5 services implemented, business logic enforced, validations working\n- [ ] 4. **Workflows**: All 3 workflows implemented, integrations functional, tested\n- [ ] 5. **Controllers**: All 12 endpoints implemented, authentication/authorization enforced\n- [ ] 6. **Routes**: All routes registered, schemas validated, OpenAPI documented\n- [ ] 7. **Testing**: Unit tests (80%+ coverage), integration tests, E2E tests passing\n- [ ] 8. **Documentation**: OpenAPI/Swagger complete, inline code comments, README updated\n- [ ] 9. **Deployment**: Migration script tested, health checks functional, environment configured\n- [ ] 10. **Integration**: Procurement integration verified, Distribution integration verified\n- [ ] 11. **Performance**: Query performance meets targets, FIFO/FEFO < 200ms, stock queries < 500ms\n- [ ] 12. **Security**: Authentication enforced, RBAC verified, audit trail complete\n\n---\n\n**Total Estimated Effort**: 4 weeks (160 hours)\n- Week 1: Database + Repositories (40h)\n- Week 2: Services + Workflows (40h)\n- Week 3: Controllers + Routes (40h)\n- Week 4: Testing + Documentation (40h)\n\n**Dependencies**:\n- PostgreSQL 14+ with inventory schema\n- Knex.js migration tool\n- Fastify framework with authentication\n- TypeBox schema validation\n- Vitest test framework\n- TestContainers for integration tests\n\n**Critical Path**:\n1. Database foundation (blocks everything)\n2. Repositories (blocks services)\n3. Services (blocks controllers)\n4. Workflows (blocks integrations)\n5. Controllers/Routes (blocks frontend)\n6. Testing (blocks production deployment)\n",
  "fileStats": {
    "size": 62587,
    "lines": 382,
    "lastModified": "2025-12-14T13:33:48.156Z"
  },
  "comments": []
}