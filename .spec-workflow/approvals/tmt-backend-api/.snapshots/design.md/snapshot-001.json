{
  "id": "snapshot_1765726101542_igu3606if",
  "approvalId": "approval_1765726101529_qj4oq55n2",
  "approvalTitle": "Design Document - TMT Backend API",
  "version": 1,
  "timestamp": "2025-12-14T15:28:21.541Z",
  "trigger": "initial",
  "status": "pending",
  "content": "# Design Document: TMT Backend API\n\n## Overview\n\nThe TMT Backend API is designed as a modular, maintainable RESTful service following the established AegisX platform patterns. This API provides:\n\n1. **TMT Concepts Management** - Search and browse 76,904 Thai Medical Terminology concepts across 5 hierarchical levels\n2. **Drug-to-TMT Mapping** - Create, update, and verify mappings between hospital drugs and TMT codes\n3. **Compliance Tracking** - Real-time monitoring of TMT mapping coverage (target ≥95%)\n4. **Ministry Export** - Generate DMSIC-compliant reports for Ministry of Public Health\n\n**Design Philosophy:**\n- **API-First Development**: TypeBox schemas define all request/response contracts before implementation\n- **Domain-Driven Design**: Clear separation between master-data (TMT concepts) and operations (mappings)\n- **Modular Architecture**: Plugin-based design for easy testing and maintenance\n- **Performance-Optimized**: Redis caching for read-heavy TMT concept lookups\n\n**Technology Stack:**\n- **Framework**: Fastify (high-performance Node.js web framework)\n- **Database**: PostgreSQL 14+ (`inventory` schema)\n- **ORM**: Knex.js with BaseRepository pattern\n- **Validation**: TypeBox (compile-time type safety + runtime validation)\n- **Caching**: Redis (TMT concepts cache, TTL: 1 hour)\n- **Authentication**: JWT with RBAC\n- **Documentation**: Auto-generated OpenAPI/Swagger\n\n## Steering Document Alignment\n\n### Technical Standards (tech.md)\n\n**Following Established Backend Patterns:**\n\n1. **Fastify Plugin Pattern** (from `apps/api/src/layers/platform/users/users.plugin.ts`)\n   - Plain async function (no `fp()` wrapper for leaf modules)\n   - Dependency injection: Repository → Service → Controller\n   - Lifecycle hooks for monitoring\n   - Decorate Fastify instance for cross-plugin access\n\n2. **TypeBox Schema-First Design** (from `apps/api/src/layers/platform/users/users.routes.ts`)\n   - All routes defined with TypeBox schemas\n   - Request validation (body, params, querystring)\n   - Response type safety (200, 400, 401, 403, 404, 409, 500)\n   - Auto-generated OpenAPI documentation via `SchemaRefs`\n\n3. **BaseRepository Pattern** (from `apps/api/src/shared/repositories/base.repository.ts`)\n   - Generic CRUD operations (findById, create, update, delete, list)\n   - Pagination support (`BaseListQuery`, `PaginatedListResult`)\n   - Search functionality across configurable fields\n   - UUID validation with `smartValidateUUIDs`\n   - Audit fields management (created_at, updated_at, created_by, updated_by)\n\n4. **Authentication & Authorization** (from existing routes)\n   - JWT authentication: `fastify.authenticate` preValidation hook\n   - RBAC: `fastify.verifyPermission(resource, action)` hook\n   - Role-based access control for Finance Manager, Pharmacist, Dept Head, Nurse\n\n### Project Structure (structure.md)\n\n**Following Layer-Based Organization:**\n\n```\napps/api/src/\n├── layers/\n│   ├── inventory/                    # Inventory domain (NEW)\n│   │   ├── master-data/              # TMT concepts (reference data)\n│   │   │   └── tmt-concepts/\n│   │   │       ├── tmt-concepts.plugin.ts\n│   │   │       ├── tmt-concepts.routes.ts\n│   │   │       ├── tmt-concepts.controller.ts\n│   │   │       ├── tmt-concepts.service.ts\n│   │   │       ├── tmt-concepts.repository.ts\n│   │   │       ├── tmt-concepts.schemas.ts\n│   │   │       └── index.ts\n│   │   └── operations/               # TMT mappings (transactional)\n│   │       └── tmt-mappings/\n│   │           ├── tmt-mappings.plugin.ts\n│   │           ├── tmt-mappings.routes.ts\n│   │           ├── tmt-mappings.controller.ts\n│   │           ├── tmt-mappings.service.ts\n│   │           ├── tmt-mappings.repository.ts\n│   │           ├── tmt-mappings.schemas.ts\n│   │           ├── utils/\n│   │           │   ├── confidence-scorer.ts  # AI confidence calculation\n│   │           │   └── mapping-validator.ts  # Business rule validation\n│   │           └── index.ts\n│   ├── platform/                     # Existing platform features\n│   └── core/                         # Existing core utilities\n└── shared/\n    └── repositories/\n        └── base.repository.ts        # Reuse existing BaseRepository\n```\n\n**Domain Classification Rationale:**\n\nFollowing `docs/architecture/DOMAIN_ARCHITECTURE_GUIDE.md`:\n\n- **inventory/master-data/tmt-concepts**: TMT concepts are reference data (lookup tables)\n  - ✅ Rarely change (Ministry updates quarterly)\n  - ✅ Used in dropdown/select (search TMT for mapping)\n  - ✅ Referenced by foreign key (`tmt_mappings.tmt_concept_id`)\n\n- **inventory/operations/tmt-mappings**: Drug-TMT mappings are transactional\n  - ✅ Created from user actions (pharmacist mapping drugs)\n  - ✅ Have status changes (unverified → verified)\n  - ✅ Reference master-data (`drug_id`, `tmt_concept_id`)\n\n## Code Reuse Analysis\n\n### Existing Components to Leverage\n\n**1. BaseRepository** (`apps/api/src/shared/repositories/base.repository.ts`)\n- **Reuse for**: TMTConceptsRepository, TMTMappingsRepository\n- **Provides**:\n  - `findById(id)` - Get TMT concept/mapping by ID\n  - `list(query)` - Paginated list with search\n  - `create(data, userId)` - Insert with audit fields\n  - `update(id, data, userId)` - Update with audit fields\n  - `delete(id)` - Soft/hard delete\n  - UUID validation\n  - Pagination metadata generation\n\n**Example Extension:**\n```typescript\nexport class TMTConceptsRepository extends BaseRepository<\n  TMTConcept,\n  CreateTMTConceptDto,\n  UpdateTMTConceptDto\n> {\n  constructor(knex: Knex) {\n    super(\n      knex,\n      'tmt_concepts',           // Table name\n      ['preferred_term', 'fsn', 'concept_code'], // Search fields\n      [],                        // UUID fields (none for this table)\n      { hasCreatedBy: false, hasUpdatedBy: false } // No audit fields (readonly data)\n    );\n  }\n\n  // Add custom methods for TMT-specific queries\n  async findByLevel(level: TMTLevel): Promise<TMTConcept[]> {\n    return this.query().where({ level, is_active: true });\n  }\n\n  async getHierarchy(conceptId: bigint): Promise<TMTHierarchy> {\n    // Custom query with recursive CTE for parent/child relationships\n  }\n}\n```\n\n**2. TypeBox Schema Patterns** (from `apps/api/src/layers/platform/users/`)\n- **Reuse for**: TMT request/response schemas\n- **Provides**:\n  - `SchemaRefs.UuidParam` - UUID validation for `:id` params\n  - `SchemaRefs.Unauthorized` - 401 error response\n  - `SchemaRefs.Forbidden` - 403 error response\n  - `SchemaRefs.NotFound` - 404 error response\n  - `SchemaRefs.ValidationError` - 400/422 error response\n  - `SchemaRefs.Conflict` - 409 error response\n  - `SchemaRefs.ServerError` - 500 error response\n\n**Example Usage:**\n```typescript\n// tmt-concepts.schemas.ts\nexport const TMTConceptSchemas = {\n  'list-tmt-concepts-query': Type.Object({\n    page: Type.Optional(Type.Integer({ minimum: 1 })),\n    limit: Type.Optional(Type.Integer({ minimum: 1, maximum: 100 })),\n    search: Type.Optional(Type.String({ minLength: 3 })),\n    level: Type.Optional(Type.Enum(TMTLevel)),\n  }),\n  'list-tmt-concepts-response': Type.Object({\n    success: Type.Boolean(),\n    data: Type.Array(Type.Ref('TMTConcept')),\n    pagination: Type.Ref('PaginationMeta'),\n  }),\n};\n```\n\n**3. Authentication Middleware** (from existing routes)\n- **Reuse for**: All TMT endpoints\n- **Provides**:\n  - `fastify.authenticate` - JWT token validation\n  - `fastify.verifyPermission(resource, action)` - RBAC check\n- **Usage**: Add to `preValidation` array in routes\n\n**4. EventService** (from WebSocket plugin)\n- **Reuse for**: Real-time updates when mappings created/updated\n- **Provides**: Broadcast events to connected clients\n- **Usage**: `fastify.eventService.broadcast('tmt:mapping-created', data)`\n\n### Integration Points\n\n**1. Existing Database Schema** (`inventory` schema)\n- **tmt_concepts table**: Already exists with 76,904 records\n- **tmt_relationships table**: Parent-child hierarchy\n- **drugs table**: Has `tmt_tpu_id` foreign key (existing mapping field)\n- **Integration**: TMT Mappings will create entries linking `drugs.id` to `tmt_concepts.id`\n\n**2. Master Data API** (future integration)\n- **Integration Point**: Drugs API will include TMT mapping status\n- **Endpoint**: `GET /api/inventory/drugs/:id` will return `tmt_mapping` object\n- **Benefit**: Frontend can show TMT code when viewing drug details\n\n**3. Ministry Reporting API** (future integration)\n- **Integration Point**: DRUGLIST export will pull TMT code from mappings\n- **Query**: Join `drugs` ← `tmt_mappings` ← `tmt_concepts`\n- **Benefit**: Automated compliance reporting\n\n**4. Redis Cache** (if available)\n- **Integration Point**: Cache TMT concepts for faster search\n- **Key Pattern**: `tmt:concepts:{level}:{page}`, `tmt:concept:{id}`\n- **TTL**: 1 hour (TMT data rarely changes)\n\n## Architecture\n\n### Overall System Design\n\nThe TMT Backend API follows a **3-layer architecture** with clear separation of concerns:\n\n```\n┌─────────────────────────────────────────────────────────────┐\n│                         Client Layer                        │\n│  (Frontend, Postman, other services)                        │\n└────────────────────────┬────────────────────────────────────┘\n                         │ HTTP/REST\n                         ↓\n┌─────────────────────────────────────────────────────────────┐\n│                    Presentation Layer                       │\n│  ┌──────────────┐  ┌─────────────────┐  ┌────────────────┐ │\n│  │   Routes     │→ │  Controllers    │→ │  TypeBox       │ │\n│  │  (Fastify)   │  │  (HTTP I/O)     │  │  Validation    │ │\n│  └──────────────┘  └─────────────────┘  └────────────────┘ │\n│         │                   │                      │         │\n│         └───────────────────┴──────────────────────┘         │\n└────────────────────────┬────────────────────────────────────┘\n                         │\n                         ↓\n┌─────────────────────────────────────────────────────────────┐\n│                      Business Layer                         │\n│  ┌──────────────────┐  ┌─────────────────────────────────┐ │\n│  │    Services      │  │  Business Logic & Rules         │ │\n│  │                  │  │  - Mapping validation           │ │\n│  │  - TMTService    │  │  - Confidence scoring           │ │\n│  │  - MappingService│  │  - Compliance calculation       │ │\n│  └──────────────────┘  └─────────────────────────────────┘ │\n└────────────────────────┬────────────────────────────────────┘\n                         │\n                         ↓\n┌─────────────────────────────────────────────────────────────┐\n│                       Data Layer                            │\n│  ┌──────────────────┐  ┌─────────────────────────────────┐ │\n│  │  Repositories    │  │  Database Access                │ │\n│  │                  │  │  - CRUD operations              │ │\n│  │  - TMTConceptRepo│  │  - Complex queries              │ │\n│  │  - MappingRepo   │  │  - Transactions                 │ │\n│  └────────┬─────────┘  └─────────────────────────────────┘ │\n│           │                                                 │\n│           └──────────────┐                                  │\n└──────────────────────────┼──────────────────────────────────┘\n                           │\n                           ↓\n                  ┌────────────────┐\n                  │   PostgreSQL   │\n                  │ (inventory DB) │\n                  └────────────────┘\n```\n\n### Modular Design Principles\n\n**1. Single File Responsibility**\n- **Routes**: Only route definitions and schema references (no business logic)\n- **Controllers**: Request/response mapping, input extraction, error handling\n- **Services**: Business logic, orchestration, validation rules\n- **Repositories**: Database queries only (no business logic)\n- **Utilities**: Pure functions for specific tasks (confidence scoring, fuzzy search)\n\n**2. Component Isolation**\n- Each module (tmt-concepts, tmt-mappings) is self-contained\n- No circular dependencies between modules\n- Shared utilities in `utils/` folder\n\n**3. Service Layer Separation**\n```\n┌────────────────────────────────────────────────────┐\n│                 TMTConceptsService                 │\n│  - searchConcepts(query, filters)                  │\n│  - getConceptById(id)                              │\n│  - getHierarchy(conceptId)                         │\n│  - loadConceptsFromCSV(file)                       │\n└────────────────────────────────────────────────────┘\n                          ↓ uses\n┌────────────────────────────────────────────────────┐\n│              TMTConceptsRepository                 │\n│  - findById(id)                                    │\n│  - list(query)                                     │\n│  - findByLevel(level)                              │\n│  - getHierarchy(id) // recursive CTE               │\n└────────────────────────────────────────────────────┘\n```\n\n**4. Utility Modularity**\n\n**Confidence Scorer** (`utils/confidence-scorer.ts`):\n```typescript\n// Single responsibility: Calculate AI confidence score\nexport function calculateMappingConfidence(\n  drug: Drug,\n  tmtConcept: TMTConcept\n): { score: number; level: 'HIGH' | 'MEDIUM' | 'LOW'; matchedFields: string[] } {\n  let score = 0;\n  const matched: string[] = [];\n\n  // Name similarity (50 points)\n  if (similarityScore(drug.generic_name, tmtConcept.preferred_term) > 0.8) {\n    score += 50;\n    matched.push('name');\n  }\n\n  // Strength match (30 points)\n  if (drug.strength === tmtConcept.strength) {\n    score += 30;\n    matched.push('strength');\n  }\n\n  // Dosage form match (20 points)\n  if (drug.dosage_form === tmtConcept.dosage_form) {\n    score += 20;\n    matched.push('dosage_form');\n  }\n\n  const level = score >= 90 ? 'HIGH' : score >= 70 ? 'MEDIUM' : 'LOW';\n  return { score, level, matchedFields: matched };\n}\n```\n\n**Mapping Validator** (`utils/mapping-validator.ts`):\n```typescript\n// Single responsibility: Validate mapping business rules\nexport class MappingValidator {\n  static validateMapping(drug: Drug, tmtConcept: TMTConcept): ValidationResult {\n    const errors: string[] = [];\n\n    // Rule 1: TMT level must be GP or TP (preferred)\n    if (!['GP', 'TP', 'VTM'].includes(tmtConcept.level)) {\n      errors.push(`Invalid TMT level: ${tmtConcept.level}. Prefer GP or TP.`);\n    }\n\n    // Rule 2: Concept must be active\n    if (!tmtConcept.is_active) {\n      errors.push('TMT concept is inactive');\n    }\n\n    // Rule 3: Drug must be active\n    if (!drug.is_active) {\n      errors.push('Drug is inactive');\n    }\n\n    return { isValid: errors.length === 0, errors };\n  }\n}\n```\n\n### Data Flow Architecture\n\n**Sequence Diagram: Create Drug-TMT Mapping**\n\n```mermaid\nsequenceDiagram\n    actor User as Pharmacist\n    participant C as Controller\n    participant S as MappingService\n    participant TR as TMTRepo\n    participant MR as MappingRepo\n    participant V as MappingValidator\n    participant CS as ConfidenceScorer\n    participant DB as PostgreSQL\n    participant E as EventService\n\n    User->>C: POST /api/tmt/mappings<br/>{drug_id, tmt_concept_id}\n    C->>S: createMapping(dto, userId)\n\n    Note over S: Begin Transaction\n\n    S->>TR: findById(tmt_concept_id)\n    TR->>DB: SELECT * FROM tmt_concepts WHERE id=?\n    DB-->>TR: TMT concept row\n    TR-->>S: TMTConcept entity\n\n    S->>MR: findExistingMapping(drug_id)\n    MR->>DB: SELECT * FROM tmt_mappings WHERE drug_id=?\n    DB-->>MR: NULL (no existing)\n    MR-->>S: null\n\n    S->>V: validateMapping(drug, tmtConcept)\n    V-->>S: { isValid: true }\n\n    S->>CS: calculateConfidence(drug, tmtConcept)\n    CS-->>S: { score: 95, level: 'HIGH', matchedFields: ['name', 'strength'] }\n\n    S->>MR: create(mappingDto, userId)\n    MR->>DB: INSERT INTO tmt_mappings (...)\n    DB-->>MR: New mapping row\n    MR-->>S: TMTMapping entity\n\n    Note over S: Commit Transaction\n\n    S->>E: broadcast('tmt:mapping-created', mapping)\n    E-->>User: WebSocket notification\n\n    S-->>C: { success: true, data: mapping }\n    C-->>User: 201 Created\n```\n\n### Plugin Registration Flow\n\n```mermaid\ngraph TD\n    A[Fastify App Start] --> B[Load Bootstrap Plugins]\n    B --> C[Load Inventory Layer]\n    C --> D[Register TMT Concepts Plugin]\n    D --> E[Instantiate TMTConceptsRepository]\n    E --> F[Instantiate TMTConceptsService]\n    F --> G[Instantiate TMTConceptsController]\n    G --> H[Register TMT Concepts Routes]\n\n    C --> I[Register TMT Mappings Plugin]\n    I --> J[Instantiate TMTMappingsRepository]\n    J --> K[Instantiate TMTMappingsService]\n    K --> L[Inject Dependencies:<br/>TMTConceptsRepo, EventService]\n    L --> M[Instantiate TMTMappingsController]\n    M --> N[Register TMT Mappings Routes]\n\n    H --> O[Decorate Fastify:<br/>tmtConceptsService]\n    N --> P[Decorate Fastify:<br/>tmtMappingsService]\n\n    O --> Q[Server Ready]\n    P --> Q\n```\n\n## Components and Interfaces\n\n### Component 1: TMT Concepts Module\n\n**Purpose**: Manage TMT concept data (search, browse, hierarchy navigation)\n\n**File Structure**:\n```\nlayers/inventory/master-data/tmt-concepts/\n├── tmt-concepts.plugin.ts      # Plugin entry, DI setup\n├── tmt-concepts.routes.ts      # Route definitions\n├── tmt-concepts.controller.ts  # HTTP handlers\n├── tmt-concepts.service.ts     # Business logic\n├── tmt-concepts.repository.ts  # Database access\n├── tmt-concepts.schemas.ts     # TypeBox schemas\n└── index.ts                    # Module exports\n```\n\n**Public Interfaces**:\n\n**TMTConceptsService**:\n```typescript\nclass TMTConceptsService {\n  // Search TMT concepts with fuzzy matching\n  async searchConcepts(\n    query: string,\n    filters: { level?: TMTLevel; limit?: number }\n  ): Promise<TMTConcept[]>\n\n  // Get concept with full details\n  async getConceptById(id: bigint): Promise<TMTConcept | null>\n\n  // Get hierarchical view (parent → current → children)\n  async getHierarchy(conceptId: bigint): Promise<TMTHierarchy>\n\n  // Load concepts from Ministry CSV (admin only)\n  async loadConceptsFromCSV(\n    file: Buffer,\n    userId: bigint\n  ): Promise<LoadResult>\n}\n```\n\n**TMTConceptsRepository** (extends BaseRepository):\n```typescript\nclass TMTConceptsRepository extends BaseRepository<TMTConcept> {\n  // Inherited from BaseRepository:\n  // - findById(id)\n  // - list(query) with pagination\n  // - create(data)\n  // - update(id, data)\n  // - delete(id)\n\n  // Custom TMT-specific queries:\n  async findByLevel(level: TMTLevel): Promise<TMTConcept[]>\n  async getHierarchy(conceptId: bigint): Promise<{\n    concept: TMTConcept;\n    parents: TMTConcept[];\n    children: TMTConcept[];\n  }>\n  async bulkInsert(concepts: TMTConcept[]): Promise<number>\n}\n```\n\n**Dependencies**:\n- Knex.js for database queries\n- Redis (optional) for caching concepts\n- CSV parser for data loading\n\n**Reuses**:\n- `BaseRepository` - CRUD operations, pagination\n- `SchemaRefs` - Standard error responses\n- `fastify.authenticate` - JWT auth\n\n---\n\n### Component 2: TMT Mappings Module\n\n**Purpose**: Create, update, and verify drug-to-TMT mappings\n\n**File Structure**:\n```\nlayers/inventory/operations/tmt-mappings/\n├── tmt-mappings.plugin.ts      # Plugin entry, DI setup\n├── tmt-mappings.routes.ts      # Route definitions\n├── tmt-mappings.controller.ts  # HTTP handlers\n├── tmt-mappings.service.ts     # Business logic\n├── tmt-mappings.repository.ts  # Database access\n├── tmt-mappings.schemas.ts     # TypeBox schemas\n├── utils/\n│   ├── confidence-scorer.ts    # AI confidence calculation\n│   └── mapping-validator.ts    # Business rule validation\n└── index.ts                    # Module exports\n```\n\n**Public Interfaces**:\n\n**TMTMappingsService**:\n```typescript\nclass TMTMappingsService {\n  // Create new drug-TMT mapping with validation\n  async createMapping(\n    dto: CreateMappingDto,\n    userId: bigint\n  ): Promise<TMTMapping>\n\n  // Update existing mapping (e.g., change TMT concept)\n  async updateMapping(\n    id: bigint,\n    dto: UpdateMappingDto,\n    userId: bigint\n  ): Promise<TMTMapping | null>\n\n  // Delete mapping (soft delete)\n  async deleteMapping(id: bigint, userId: bigint): Promise<boolean>\n\n  // Get mapping for specific drug\n  async getMappingByDrugId(drugId: bigint): Promise<TMTMapping | null>\n\n  // AI-assisted suggestions for unmapped drugs\n  async suggestMappings(\n    drugId: bigint\n  ): Promise<Array<{ tmtConcept: TMTConcept; confidence: ConfidenceScore }>>\n\n  // Compliance monitoring\n  async getComplianceReport(): Promise<ComplianceReport>\n  async getUnmappedDrugs(): Promise<Drug[]>\n\n  // Ministry export\n  async generateMinistryExport(format: 'CSV' | 'XLSX' | 'JSON'): Promise<Buffer>\n}\n```\n\n**TMTMappingsRepository** (extends BaseRepository):\n```typescript\nclass TMTMappingsRepository extends BaseRepository<TMTMapping> {\n  // Inherited from BaseRepository:\n  // - findById(id)\n  // - list(query)\n  // - create(data, userId)\n  // - update(id, data, userId)\n  // - delete(id)\n\n  // Custom mapping-specific queries:\n  async findByDrugId(drugId: bigint): Promise<TMTMapping | null>\n  async findUnmappedDrugs(): Promise<Drug[]>\n  async getComplianceStats(): Promise<{\n    total: number;\n    mapped: number;\n    unmapped: number;\n    rate: number;\n  }>\n  async getMappingsByConfidence(level: 'HIGH' | 'MEDIUM' | 'LOW'): Promise<TMTMapping[]>\n}\n```\n\n**Dependencies**:\n- `TMTConceptsRepository` - Validate TMT concept exists\n- `EventService` - Real-time updates on mapping changes\n- `ConfidenceScorer` - Calculate AI confidence scores\n- `MappingValidator` - Validate business rules\n\n**Reuses**:\n- `BaseRepository` - CRUD + audit trails\n- `SchemaRefs` - Standard error responses\n- `fastify.authenticate`, `fastify.verifyPermission` - Auth/RBAC\n\n---\n\n### Component 3: Confidence Scorer (Utility)\n\n**Purpose**: Calculate AI confidence score for drug-TMT matching\n\n**File**: `layers/inventory/operations/tmt-mappings/utils/confidence-scorer.ts`\n\n**Interface**:\n```typescript\nexport interface ConfidenceScore {\n  score: number; // 0-100\n  level: 'HIGH' | 'MEDIUM' | 'LOW'; // HIGH: ≥90, MEDIUM: 70-89, LOW: <70\n  matchedFields: string[]; // ['name', 'strength', 'dosage_form']\n  breakdown: {\n    nameScore: number;     // 0-50\n    strengthScore: number; // 0-30\n    formScore: number;     // 0-20\n  };\n}\n\nexport function calculateMappingConfidence(\n  drug: { generic_name: string; strength: string; dosage_form: string },\n  tmtConcept: { preferred_term: string; strength: string; dosage_form: string }\n): ConfidenceScore\n```\n\n**Algorithm**:\n1. **Name Similarity (50 points)**: Use Levenshtein distance or trigram matching\n2. **Strength Match (30 points)**: Exact match (e.g., \"500mg\" === \"500mg\")\n3. **Dosage Form Match (20 points)**: Exact match (e.g., \"Tablet\" === \"Tablet\")\n\n**Dependencies**: None (pure function)\n\n**Reuses**: None (standalone utility)\n\n---\n\n### Component 4: Mapping Validator (Utility)\n\n**Purpose**: Validate business rules for drug-TMT mappings\n\n**File**: `layers/inventory/operations/tmt-mappings/utils/mapping-validator.ts`\n\n**Interface**:\n```typescript\nexport interface ValidationResult {\n  isValid: boolean;\n  errors: string[];\n  warnings: string[];\n}\n\nexport class MappingValidator {\n  static validateMapping(drug: Drug, tmtConcept: TMTConcept): ValidationResult\n  static validateTMTLevel(level: TMTLevel): boolean\n  static checkDuplicateMapping(drugId: bigint, existingMapping: TMTMapping | null): ValidationResult\n}\n```\n\n**Validation Rules**:\n1. TMT concept must exist and be active\n2. Drug must exist and be active\n3. TMT level should be GP or TP (warn if VTM or SUBS)\n4. No duplicate mapping for same drug\n5. Mapping must be verified by pharmacist\n\n**Dependencies**: None (pure functions)\n\n**Reuses**: None\n\n## Data Models\n\n### TMTConcept Model\n\n```typescript\ninterface TMTConcept {\n  id: bigint;                    // Primary key\n  tmt_id: bigint;                // Official TMT ID from ministry\n  concept_code: string;          // Concept code (e.g., \"10028536\")\n  level: TMTLevel;               // VTM | GP | GPU | TP | TPU\n  fsn: string;                   // Fully Specified Name (English)\n  preferred_term: string;        // Preferred term (Thai)\n  strength: string | null;       // Drug strength (e.g., \"500mg\")\n  dosage_form: string | null;    // Dosage form (e.g., \"Tablet\")\n  is_active: boolean;            // Active status\n  created_at: Date;              // Timestamp (DB-managed)\n  updated_at: Date;              // Timestamp (DB-managed)\n\n  // Relations (populated via joins)\n  parent?: TMTConcept;           // Parent concept\n  children?: TMTConcept[];       // Child concepts\n  _count?: {\n    children: number;\n    drug_mappings: number;\n  };\n}\n\nenum TMTLevel {\n  VTM = 'VTM',   // Virtual Therapeutic Moiety\n  GP = 'GP',     // Generic Product (recommended)\n  GPU = 'GPU',   // Generic Product with Unit\n  TP = 'TP',     // Trade Product (recommended)\n  TPU = 'TPU',   // Trade Product with Unit\n}\n```\n\n**TypeBox Schema**:\n```typescript\nexport const TMTConceptSchema = Type.Object({\n  id: Type.String(),  // BigInt as string in JSON\n  tmt_id: Type.String(),\n  concept_code: Type.String(),\n  level: Type.Enum(TMTLevel),\n  fsn: Type.String(),\n  preferred_term: Type.String(),\n  strength: Type.Union([Type.String(), Type.Null()]),\n  dosage_form: Type.Union([Type.String(), Type.Null()]),\n  is_active: Type.Boolean(),\n  created_at: Type.String({ format: 'date-time' }),\n  updated_at: Type.String({ format: 'date-time' }),\n});\n```\n\n---\n\n### TMTMapping Model\n\n```typescript\ninterface TMTMapping {\n  id: bigint;                    // Primary key\n  drug_id: bigint;               // FK to drugs table\n  tmt_concept_id: bigint;        // FK to tmt_concepts table\n  tmt_level: TMTLevel;           // Mapped TMT level\n  mapping_confidence: ConfidenceLevel; // HIGH | MEDIUM | LOW\n  confidence_score: number;      // 0-100\n  matched_fields: string[];      // JSON array: ['name', 'strength']\n  is_verified: boolean;          // Pharmacist verification flag\n  verified_by: bigint | null;    // FK to users table\n  verified_at: Date | null;      // Verification timestamp\n  notes: string | null;          // Optional notes\n  created_at: Date;              // Creation timestamp\n  updated_at: Date;              // Last update timestamp\n  created_by: bigint;            // FK to users table\n  updated_by: bigint | null;     // FK to users table\n\n  // Relations (populated via joins)\n  drug?: Drug;\n  tmt_concept?: TMTConcept;\n  verified_by_user?: User;\n}\n\nenum ConfidenceLevel {\n  HIGH = 'HIGH',      // ≥90%\n  MEDIUM = 'MEDIUM',  // 70-89%\n  LOW = 'LOW',        // <70%\n}\n```\n\n**TypeBox Schema**:\n```typescript\nexport const TMTMappingSchema = Type.Object({\n  id: Type.String(),\n  drug_id: Type.String(),\n  tmt_concept_id: Type.String(),\n  tmt_level: Type.Enum(TMTLevel),\n  mapping_confidence: Type.Enum(ConfidenceLevel),\n  confidence_score: Type.Number({ minimum: 0, maximum: 100 }),\n  matched_fields: Type.Array(Type.String()),\n  is_verified: Type.Boolean(),\n  verified_by: Type.Union([Type.String(), Type.Null()]),\n  verified_at: Type.Union([Type.String({ format: 'date-time' }), Type.Null()]),\n  notes: Type.Union([Type.String(), Type.Null()]),\n  created_at: Type.String({ format: 'date-time' }),\n  updated_at: Type.String({ format: 'date-time' }),\n});\n```\n\n---\n\n### ComplianceReport Model\n\n```typescript\ninterface ComplianceReport {\n  summary: {\n    total_drugs: number;\n    mapped_drugs: number;\n    unmapped_drugs: number;\n    coverage_percent: number;    // (mapped / total) × 100\n    is_compliant: boolean;       // coverage_percent ≥ 95\n  };\n\n  by_confidence: {\n    high: number;\n    medium: number;\n    low: number;\n  };\n\n  by_tmt_level: {\n    VTM: number;\n    GP: number;\n    GPU: number;\n    TP: number;\n    TPU: number;\n  };\n\n  top_unmapped_drugs: Array<{\n    drug_id: bigint;\n    drug_code: string;\n    trade_name: string;\n    usage_count: number;\n    days_unmapped: number;\n    priority: 'HIGH' | 'MEDIUM' | 'LOW';\n  }>;\n\n  recent_mappings: Array<{\n    drug_id: bigint;\n    drug_name: string;\n    tmt_code: string;\n    mapped_at: Date;\n    mapped_by: string;\n  }>;\n\n  generated_at: Date;\n}\n```\n\n## Error Handling\n\n### Error Scenarios\n\n**1. TMT Concept Not Found**\n- **Scenario**: User requests concept with invalid ID\n- **Handling**:\n  ```typescript\n  if (!concept) {\n    throw new NotFoundError({\n      code: 'TMT_CONCEPT_NOT_FOUND',\n      message: 'ไม่พบรหัส TMT',\n      message_en: 'TMT concept not found',\n      details: { tmt_concept_id: id }\n    });\n  }\n  ```\n- **HTTP Status**: 404\n- **User Impact**: Error message displayed, can retry with correct ID\n\n**2. Duplicate Mapping**\n- **Scenario**: User tries to map a drug that already has TMT mapping\n- **Handling**:\n  ```typescript\n  const existing = await this.mappingRepo.findByDrugId(dto.drug_id);\n  if (existing) {\n    throw new ConflictError({\n      code: 'MAPPING_EXISTS',\n      message: 'ยานี้มีการ map TMT แล้ว',\n      message_en: 'Drug already has TMT mapping',\n      details: {\n        drug_id: dto.drug_id,\n        existing_mapping_id: existing.id,\n        existing_tmt_code: existing.tmt_concept.concept_code\n      },\n      suggestion: 'ใช้ PUT /api/tmt/mappings/:id เพื่ออัปเดตแทน'\n    });\n  }\n  ```\n- **HTTP Status**: 409 Conflict\n- **User Impact**: Error message + suggestion to update instead\n\n**3. Invalid TMT Level**\n- **Scenario**: User selects TMT concept at wrong hierarchy level (e.g., SUBS)\n- **Handling**:\n  ```typescript\n  if (!['VTM', 'GP', 'GPU', 'TP', 'TPU'].includes(concept.level)) {\n    throw new ValidationError({\n      code: 'INVALID_TMT_LEVEL',\n      message: 'ระดับ TMT ไม่ถูกต้อง',\n      message_en: 'Invalid TMT level',\n      details: {\n        current_level: concept.level,\n        allowed_levels: ['VTM', 'GP', 'GPU', 'TP', 'TPU']\n      }\n    });\n  }\n  ```\n- **HTTP Status**: 400 Bad Request\n- **User Impact**: Error message with allowed levels\n\n**4. Unauthorized Access**\n- **Scenario**: Nurse tries to create mapping (requires Pharmacist role)\n- **Handling**: Via `fastify.verifyPermission` middleware\n  ```typescript\n  preValidation: [\n    fastify.authenticate,\n    fastify.verifyPermission('tmt', 'create')  // Checks user.role\n  ]\n  ```\n- **HTTP Status**: 403 Forbidden\n- **User Impact**: \"คุณไม่มีสิทธิ์ในการดำเนินการนี้ (Pharmacist only)\"\n\n**5. Database Transaction Failure**\n- **Scenario**: Database error during mapping creation (e.g., network issue)\n- **Handling**:\n  ```typescript\n  try {\n    await knex.transaction(async (trx) => {\n      // Validate TMT concept exists\n      // Check for duplicate\n      // Insert mapping\n      // Broadcast event\n    });\n  } catch (error) {\n    logger.error('Failed to create mapping', { error, dto });\n    throw new ServerError({\n      code: 'MAPPING_CREATE_FAILED',\n      message: 'ไม่สามารถบันทึกการ map ได้',\n      message_en: 'Failed to create mapping',\n      details: { error: error.message }\n    });\n  }\n  ```\n- **HTTP Status**: 500 Internal Server Error\n- **User Impact**: Generic error message, admin notified via logs\n\n**6. CSV Load Validation Failure**\n- **Scenario**: Admin uploads invalid CSV file (missing columns, wrong format)\n- **Handling**:\n  ```typescript\n  const requiredColumns = ['TMT_ID', 'CONCEPT_CODE', 'LEVEL', 'FSN', 'PREFERRED_TERM_TH'];\n  const missingColumns = requiredColumns.filter(col => !csvHeaders.includes(col));\n\n  if (missingColumns.length > 0) {\n    throw new ValidationError({\n      code: 'INVALID_CSV_FORMAT',\n      message: 'ไฟล์ CSV ไม่ถูกต้อง',\n      message_en: 'Invalid CSV format',\n      details: {\n        missing_columns: missingColumns,\n        required_columns: requiredColumns\n      }\n    });\n  }\n  ```\n- **HTTP Status**: 400 Bad Request\n- **User Impact**: Error message with missing columns list\n\n## Testing Strategy\n\n### Unit Testing\n\n**Tools**: Jest, @fast​ify/testing\n\n**Approach**:\n- Test each component in isolation with mocked dependencies\n- Focus on business logic in Services and Utilities\n- Aim for ≥80% code coverage\n\n**Key Components to Test**:\n\n**1. TMTConceptsService** (10 tests)\n```typescript\ndescribe('TMTConceptsService', () => {\n  let service: TMTConceptsService;\n  let mockRepo: jest.Mocked<TMTConceptsRepository>;\n\n  beforeEach(() => {\n    mockRepo = createMockRepository();\n    service = new TMTConceptsService(mockRepo);\n  });\n\n  it('should search concepts by name', async () => {\n    mockRepo.list.mockResolvedValue({\n      data: [mockTMTConcept1, mockTMTConcept2],\n      total: 2\n    });\n\n    const result = await service.searchConcepts('Paracetamol', { level: 'GP' });\n\n    expect(result.data).toHaveLength(2);\n    expect(mockRepo.list).toHaveBeenCalledWith({\n      search: 'Paracetamol',\n      level: 'GP'\n    });\n  });\n\n  it('should throw NotFoundError if concept not found', async () => {\n    mockRepo.findById.mockResolvedValue(null);\n\n    await expect(service.getConceptById(999n))\n      .rejects\n      .toThrow(NotFoundError);\n  });\n\n  // ... 8 more tests\n});\n```\n\n**2. TMTMappingsService** (15 tests)\n```typescript\ndescribe('TMTMappingsService', () => {\n  // Test createMapping validation\n  it('should reject duplicate mapping', async () => {\n    mockMappingRepo.findByDrugId.mockResolvedValue(existingMapping);\n\n    await expect(service.createMapping(dto, userId))\n      .rejects\n      .toThrow(ConflictError);\n  });\n\n  // Test confidence scoring integration\n  it('should calculate confidence score on creation', async () => {\n    const result = await service.createMapping(dto, userId);\n\n    expect(result.confidence_score).toBeGreaterThan(0);\n    expect(result.mapping_confidence).toBe('HIGH');\n  });\n\n  // Test compliance calculation\n  it('should calculate correct compliance rate', async () => {\n    mockMappingRepo.getComplianceStats.mockResolvedValue({\n      total: 1000,\n      mapped: 950,\n      unmapped: 50,\n      rate: 95.0\n    });\n\n    const report = await service.getComplianceReport();\n\n    expect(report.summary.is_compliant).toBe(true);\n  });\n\n  // ... 12 more tests\n});\n```\n\n**3. ConfidenceScorer** (8 tests)\n```typescript\ndescribe('ConfidenceScorer', () => {\n  it('should return HIGH confidence for exact match', () => {\n    const drug = { generic_name: 'Paracetamol', strength: '500mg', dosage_form: 'Tablet' };\n    const tmt = { preferred_term: 'Paracetamol', strength: '500mg', dosage_form: 'Tablet' };\n\n    const result = calculateMappingConfidence(drug, tmt);\n\n    expect(result.score).toBe(100);\n    expect(result.level).toBe('HIGH');\n    expect(result.matchedFields).toEqual(['name', 'strength', 'dosage_form']);\n  });\n\n  it('should return LOW confidence for name mismatch', () => {\n    const drug = { generic_name: 'Aspirin', strength: '100mg', dosage_form: 'Tablet' };\n    const tmt = { preferred_term: 'Paracetamol', strength: '100mg', dosage_form: 'Tablet' };\n\n    const result = calculateMappingConfidence(drug, tmt);\n\n    expect(result.score).toBeLessThan(70);\n    expect(result.level).toBe('LOW');\n  });\n\n  // ... 6 more tests\n});\n```\n\n**4. MappingValidator** (6 tests)\n```typescript\ndescribe('MappingValidator', () => {\n  it('should validate TMT level restrictions', () => {\n    const result = MappingValidator.validateTMTLevel('SUBS');\n\n    expect(result.isValid).toBe(false);\n    expect(result.errors).toContain('Invalid TMT level: SUBS. Prefer GP or TP.');\n  });\n\n  // ... 5 more tests\n});\n```\n\n---\n\n### Integration Testing\n\n**Tools**: Supertest, test database (PostgreSQL)\n\n**Approach**:\n- Test full API flows with real database (test schema)\n- Test authentication and authorization\n- Test error handling and edge cases\n\n**Key Flows to Test**:\n\n**1. TMT Concepts Search Flow** (5 tests)\n```typescript\ndescribe('GET /api/tmt/concepts/search', () => {\n  it('should search concepts with authentication', async () => {\n    const response = await request(app)\n      .get('/api/tmt/concepts/search?q=Paracetamol&level=GP')\n      .set('Authorization', `Bearer ${pharmacistToken}`);\n\n    expect(response.status).toBe(200);\n    expect(response.body.success).toBe(true);\n    expect(response.body.data.length).toBeGreaterThan(0);\n  });\n\n  it('should return 401 without token', async () => {\n    const response = await request(app)\n      .get('/api/tmt/concepts/search?q=Paracetamol');\n\n    expect(response.status).toBe(401);\n  });\n\n  // ... 3 more tests\n});\n```\n\n**2. Create Mapping Flow** (8 tests)\n```typescript\ndescribe('POST /api/tmt/mappings', () => {\n  it('should create mapping with valid data', async () => {\n    const response = await request(app)\n      .post('/api/tmt/mappings')\n      .set('Authorization', `Bearer ${pharmacistToken}`)\n      .send({\n        drug_id: '123',\n        tmt_concept_id: '456',\n      });\n\n    expect(response.status).toBe(201);\n    expect(response.body.data.is_verified).toBe(true);\n    expect(response.body.data.confidence_score).toBeGreaterThan(0);\n  });\n\n  it('should reject duplicate mapping', async () => {\n    // Create first mapping\n    await createMapping(drugId, tmtConceptId);\n\n    // Try to create duplicate\n    const response = await request(app)\n      .post('/api/tmt/mappings')\n      .set('Authorization', `Bearer ${pharmacistToken}`)\n      .send({ drug_id: drugId, tmt_concept_id: tmtConceptId });\n\n    expect(response.status).toBe(409);\n    expect(response.body.error.code).toBe('MAPPING_EXISTS');\n  });\n\n  it('should enforce Pharmacist role', async () => {\n    const response = await request(app)\n      .post('/api/tmt/mappings')\n      .set('Authorization', `Bearer ${nurseToken}`) // Nurse can't create\n      .send({ drug_id: '123', tmt_concept_id: '456' });\n\n    expect(response.status).toBe(403);\n  });\n\n  // ... 5 more tests\n});\n```\n\n**3. Compliance Report Flow** (4 tests)\n```typescript\ndescribe('GET /api/tmt/coverage-report', () => {\n  beforeEach(async () => {\n    // Seed test data: 1000 drugs, 950 mapped\n    await seedTestData();\n  });\n\n  it('should calculate compliance rate correctly', async () => {\n    const response = await request(app)\n      .get('/api/tmt/coverage-report')\n      .set('Authorization', `Bearer ${financeManagerToken}`);\n\n    expect(response.status).toBe(200);\n    expect(response.body.data.summary.total_drugs).toBe(1000);\n    expect(response.body.data.summary.mapped_drugs).toBe(950);\n    expect(response.body.data.summary.coverage_percent).toBe(95.0);\n    expect(response.body.data.summary.is_compliant).toBe(true);\n  });\n\n  // ... 3 more tests\n});\n```\n\n---\n\n### End-to-End Testing\n\n**Tools**: Playwright (frontend E2E), Supertest (API E2E)\n\n**Approach**:\n- Test complete user scenarios from frontend to database\n- Test real-world workflows (pharmacist mapping drugs)\n- Test cross-module integration (TMT + Drugs + Users)\n\n**User Scenarios to Test**:\n\n**Scenario 1: Pharmacist Maps Unmapped Drug** (E2E)\n```typescript\ntest('Pharmacist can map unmapped drug to TMT concept', async ({ page }) => {\n  // 1. Login as pharmacist\n  await page.goto('/login');\n  await page.fill('#username', 'pharmacist@hospital.com');\n  await page.fill('#password', 'password123');\n  await page.click('button[type=submit]');\n\n  // 2. Navigate to TMT Mapping page\n  await page.click('text=TMT Mapping');\n  await expect(page).toHaveURL('/tmt/mapping');\n\n  // 3. Search for unmapped drug\n  await page.fill('#drug-search', 'Paracetamol 500mg');\n  await page.click('button:text(\"Search\")');\n  await page.click('text=Tylenol 500mg Tablet');\n\n  // 4. System shows TMT search dialog\n  await expect(page.locator('.tmt-search-dialog')).toBeVisible();\n\n  // 5. Search TMT concepts\n  await page.fill('#tmt-search', 'Paracetamol 500');\n  await page.selectOption('#tmt-level', 'GP');\n\n  // 6. System shows AI suggestions\n  await expect(page.locator('.suggestion-badge:text(\"95% HIGH\")')).toBeVisible();\n\n  // 7. Select top suggestion\n  await page.click('.suggestion-item:first-child');\n\n  // 8. Verify mapping details\n  await expect(page.locator('#tmt-code')).toHaveValue('10028536');\n  await expect(page.locator('#tmt-level')).toHaveValue('GP');\n\n  // 9. Verify and save\n  await page.check('#verify-mapping');\n  await page.click('button:text(\"Save Mapping\")');\n\n  // 10. System shows success + updated compliance\n  await expect(page.locator('.success-message')).toContainText('✅ Mapped');\n  await expect(page.locator('.compliance-rate')).toContainText('96.5%');\n});\n```\n\n**Scenario 2: Finance Manager Exports Ministry Report** (E2E)\n```typescript\ntest('Finance Manager can export ministry report', async ({ page }) => {\n  // 1. Login as finance manager\n  await loginAs(page, 'finance@hospital.com');\n\n  // 2. Navigate to Compliance Dashboard\n  await page.click('text=TMT Compliance');\n\n  // 3. View compliance summary\n  await expect(page.locator('.compliance-rate')).toContainText('96.5%');\n  await expect(page.locator('.compliant-badge')).toHaveText('✓ COMPLIANT');\n\n  // 4. Generate ministry export\n  await page.click('button:text(\"Generate Ministry Report\")');\n  await page.selectOption('#export-format', 'XLSX');\n  await page.click('button:text(\"Download\")');\n\n  // 5. Verify download started\n  const [download] = await Promise.all([\n    page.waitForEvent('download'),\n  ]);\n\n  expect(download.suggestedFilename()).toMatch(/DRUGLIST_.*\\.xlsx/);\n});\n```\n\n**Scenario 3: Compliance Tracking Over Time** (Integration)\n```typescript\ntest('System tracks compliance rate changes over time', async () => {\n  // 1. Initial state: 561 mapped (47.99%)\n  let report = await getTMTComplianceReport(app, token);\n  expect(report.summary.coverage_percent).toBe(47.99);\n\n  // 2. Map 100 more drugs\n  for (let i = 0; i < 100; i++) {\n    await createMapping(app, token, unmappedDrugs[i].id, suggestedTMT[i].id);\n  }\n\n  // 3. Check updated compliance\n  report = await getTMTComplianceReport(app, token);\n  expect(report.summary.mapped_drugs).toBe(661);\n  expect(report.summary.coverage_percent).toBeGreaterThan(56);\n\n  // 4. Verify trend data\n  const trend = await getTMTComplianceTrend(app, token, { months: 6 });\n  expect(trend.data[trend.data.length - 1].rate).toBe(report.summary.coverage_percent);\n});\n```\n\n**Cross-Module Integration Test**: TMT + Drugs + Users\n```typescript\ntest('TMT mapping reflects in drug details API', async () => {\n  // 1. Create mapping\n  const mapping = await createMapping(app, pharmacistToken, drugId, tmtConceptId);\n\n  // 2. Fetch drug details (from Drugs API)\n  const drugResponse = await request(app)\n    .get(`/api/inventory/drugs/${drugId}`)\n    .set('Authorization', `Bearer ${pharmacistToken}`);\n\n  // 3. Verify TMT mapping included\n  expect(drugResponse.body.data.tmt_mapping).toBeDefined();\n  expect(drugResponse.body.data.tmt_mapping.tmt_code).toBe('10028536');\n  expect(drugResponse.body.data.tmt_mapping.verified_by.name).toBe('John Pharmacist');\n});\n```\n\n---\n\n## Summary\n\nThis design provides a solid foundation for the TMT Backend API with:\n\n✅ **Modular Architecture**: Clear separation of concerns (Repository → Service → Controller)\n✅ **Reusable Components**: Leverages BaseRepository, TypeBox schemas, existing auth\n✅ **Domain-Driven Structure**: Proper classification (master-data vs operations)\n✅ **Comprehensive Error Handling**: User-friendly Thai/English messages\n✅ **Testable Design**: Unit, integration, and E2E test strategies\n✅ **Performance Optimized**: Redis caching, pagination, indexed queries\n✅ **Ministry Compliant**: Supports DMSIC Standards พ.ศ. 2568 reporting\n",
  "fileStats": {
    "size": 46242,
    "lines": 1327,
    "lastModified": "2025-12-14T15:28:13.018Z"
  },
  "comments": []
}