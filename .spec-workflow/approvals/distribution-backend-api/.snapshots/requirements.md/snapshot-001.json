{
  "id": "snapshot_1765720223858_qrmkmybr9",
  "approvalId": "approval_1765720223841_34hjwfst2",
  "approvalTitle": "Requirements Document - Distribution Backend API",
  "version": 1,
  "timestamp": "2025-12-14T13:50:23.858Z",
  "trigger": "initial",
  "status": "pending",
  "content": "# Requirements Document - Distribution Backend API\n\n## Introduction\n\nThe **Distribution Backend API** provides comprehensive backend services for hospital drug distribution management with multi-level approval workflows, FIFO/FEFO lot tracking, and complete audit trails. This API serves as the core backend for the Drug Distribution system, managing:\n\n- **Distribution Requests**: Department-to-department drug requests with stock availability validation\n- **Approval Workflows**: Multi-level approval process (PENDING → APPROVED → DISPENSED → COMPLETED)\n- **FIFO/FEFO Dispensing**: Automatic lot selection using inventory system's lot tracking functions\n- **Real-time Stock Control**: Atomic inventory deduction with transaction logging\n- **Department Usage Tracking**: Consumption reports and cost center allocation\n- **Ministry Compliance**: DMSIC 2568 DISTRIBUTION export (11 fields) for regulatory reporting\n\n**Value to Users:**\n- Department staff can request drugs from pharmacy with real-time stock validation\n- Supervisors can approve/reject distribution requests based on policy and availability\n- Pharmacists can dispense drugs using FIFO/FEFO logic with automatic lot selection\n- Department staff can confirm receipt and complete the distribution workflow\n- Inventory managers can track drug consumption by department for usage analysis\n- Finance officers can access distribution cost data for budget allocation\n- Auditors can trace complete distribution history with lot-level traceability\n\n## Alignment with Product Vision\n\nThis feature supports the **INVS Modern** vision of a comprehensive hospital drug inventory management system by:\n\n1. **Streamline Procurement Process**: Reduces distribution request processing time by 50% through automated workflows and real-time stock validation\n2. **Enhance Inventory Accuracy**: FIFO/FEFO lot tracking ensures proper drug rotation and minimizes waste from expired medications (target: 30% reduction)\n3. **Ensure Ministry Compliance**: Supports DMSIC 2568 DISTRIBUTION export (11 fields) for regulatory reporting\n4. **Support Data-Driven Decisions**: Department usage analysis enables informed inventory planning and budget allocation\n5. **Improve Budget Control**: Tracks drug consumption by department for accurate cost center allocation\n\n**Technical Alignment:**\n- Follows AegisX platform standards (TypeBox schemas, Fastify routes, service layer pattern)\n- Implements domain-driven design in `inventory/operations` domain\n- Uses PostgreSQL schema `inventory` with 3 core tables (drug_distributions, drug_distribution_items, distribution_types)\n- Integrates with Inventory API for FIFO/FEFO lot selection and stock updates\n- Integrates with Master Data API for locations, departments, and drugs reference data\n- Uses database functions for FIFO/FEFO logic (get_fifo_lots, get_fefo_lots)\n\n**Integration Points:**\n- **Distribution → Inventory**: Stock reduction using FIFO/FEFO logic, creates ISSUE transactions\n- **Master Data → Distribution**: Locations, departments, drugs reference data\n- **Distribution → Budget**: Department consumption tracking for cost allocation\n- **Distribution → Ministry Reporting**: export_distribution view for compliance\n\n## Requirements\n\n### Phase 1: Distribution CRUD & Inquiry (Week 1)\n\n#### REQ-1: List Distribution Requests\n\n**User Story:** As a pharmacist, I want to view all distribution requests with status filtering, so that I can prioritize pending approvals and dispensing tasks.\n\n##### Acceptance Criteria\n\n1. **WHEN** user calls `GET /api/inventory/operations/drug-distributions` **THEN** system **SHALL** return paginated list of distribution records\n2. **WHEN** `status` query parameter provided **THEN** system **SHALL** filter by status (PENDING, APPROVED, DISPENSED, COMPLETED, CANCELLED)\n3. **WHEN** `requestingDeptId` query parameter provided **THEN** system **SHALL** filter by requesting department\n4. **WHEN** `fromLocationId` query parameter provided **THEN** system **SHALL** filter by source location\n5. **WHEN** `fromDate` and `toDate` query parameters provided **THEN** system **SHALL** filter by distribution date range\n6. **WHEN** `search` query parameter provided **THEN** system **SHALL** search by distribution number or requester name\n7. **WHEN** distribution data returned **THEN** system **SHALL** include distribution header (number, date, status), requesting department, from/to locations, totals\n8. **WHEN** distribution data returned **THEN** system **SHALL** include item count and total amount\n9. **WHEN** `includeItems=true` parameter provided **THEN** system **SHALL** include distribution items with drug details\n10. **IF** user has department restriction **THEN** system **SHALL** filter to show only authorized department requests\n\n#### REQ-2: Get Distribution Details\n\n**User Story:** As a department staff member, I want to view complete details of a distribution request including all items and lot information, so that I can verify what drugs were requested and dispensed.\n\n##### Acceptance Criteria\n\n1. **WHEN** user calls `GET /api/inventory/operations/drug-distributions/:id` **THEN** system **SHALL** return complete distribution record\n2. **IF** distribution not found **THEN** system **SHALL** return 404 with error code `DISTRIBUTION_NOT_FOUND`\n3. **WHEN** distribution data returned **THEN** system **SHALL** include all header fields (number, date, status, locations, departments, totals)\n4. **WHEN** distribution data returned **THEN** system **SHALL** include all distribution items with drug details (code, name, generic)\n5. **WHEN** distribution data returned **THEN** system **SHALL** include lot information for each item (lot number, expiry date, unit cost)\n6. **WHEN** distribution data returned **THEN** system **SHALL** include approval information (requested_by, approved_by, dispensed_by)\n7. **WHEN** distribution data returned **THEN** system **SHALL** include timestamps (created_at, updated_at)\n8. **WHEN** distribution data returned **THEN** system **SHALL** include notes field\n\n#### REQ-3: List Distribution Items\n\n**User Story:** As a pharmacist, I want to view all items for a specific distribution with lot details, so that I can prepare drugs for dispensing.\n\n##### Acceptance Criteria\n\n1. **WHEN** user calls `GET /api/inventory/operations/drug-distribution-items?distributionId={id}` **THEN** system **SHALL** return list of items for that distribution\n2. **WHEN** items returned **THEN** system **SHALL** include item number, drug details, quantity dispensed, lot information\n3. **WHEN** items returned **THEN** system **SHALL** include unit cost and line total (quantity × unit_cost)\n4. **WHEN** items returned **THEN** system **SHALL** include expiry date and days until expiry\n5. **WHEN** items returned **THEN** system **SHALL** order by item_number ascending\n6. **WHEN** distribution status is PENDING **THEN** system **SHALL** include preview of FIFO lots that will be used\n7. **IF** distribution not found **THEN** system **SHALL** return empty array\n\n#### REQ-4: Get Distribution Types\n\n**User Story:** As a system administrator, I want to view available distribution types, so that I can categorize distributions properly.\n\n##### Acceptance Criteria\n\n1. **WHEN** user calls `GET /api/inventory/operations/distribution-types` **THEN** system **SHALL** return list of distribution types\n2. **WHEN** distribution types returned **THEN** system **SHALL** include id, name, description\n3. **WHEN** distribution types returned **THEN** system **SHALL** include is_active flag\n4. **WHEN** `activeOnly=true` parameter provided **THEN** system **SHALL** filter to active types only\n5. **WHEN** distribution types returned **THEN** system **SHALL** order by name ascending\n\n### Phase 2: Distribution Workflow Operations (Week 2)\n\n#### REQ-5: Create Distribution Request\n\n**User Story:** As a department staff member, I want to create a distribution request for drugs from pharmacy, so that my department can receive needed medications.\n\n##### Acceptance Criteria\n\n1. **WHEN** user calls `POST /api/inventory/operations/drug-distributions` **THEN** system **SHALL** validate that from_location_id exists in locations table\n2. **WHEN** user calls `POST /api/inventory/operations/drug-distributions` **THEN** system **SHALL** validate that requesting_dept_id exists in departments table\n3. **WHEN** distribution created **THEN** system **SHALL** check stock availability for each item at from_location\n4. **IF** insufficient stock for any item **THEN** system **SHALL** return 400 error `INSUFFICIENT_STOCK` with details (requested vs available)\n5. **WHEN** distribution created **THEN** system **SHALL** generate unique distribution_number in format DIST-{YYYY}-{MM}-{###}\n6. **WHEN** distribution created **THEN** system **SHALL** set distribution_date to current date\n7. **WHEN** distribution created **THEN** system **SHALL** set initial status to PENDING\n8. **WHEN** distribution created **THEN** system **SHALL** create distribution items with item_number sequence (1, 2, 3...)\n9. **WHEN** distribution created **THEN** system **SHALL** preview FIFO lots for each item using `get_fifo_lots()` function\n10. **WHEN** distribution created **THEN** system **SHALL** populate lot_number, unit_cost, expiry_date from preview lots\n11. **WHEN** distribution created **THEN** system **SHALL** calculate total_items (count of items)\n12. **WHEN** distribution created **THEN** system **SHALL** calculate total_amount (sum of quantity × unit_cost)\n13. **WHEN** distribution created **THEN** system **SHALL** record requested_by from authenticated user\n14. **WHEN** all validations pass **THEN** system **SHALL** execute all operations in single atomic transaction\n15. **IF** any step fails **THEN** system **SHALL** rollback all changes and return error\n\n#### REQ-6: Approve Distribution Request\n\n**User Story:** As a supervisor, I want to approve distribution requests after verifying policy compliance and stock availability, so that pharmacy can proceed with dispensing.\n\n##### Acceptance Criteria\n\n1. **WHEN** user calls `POST /api/inventory/operations/drug-distributions/:id/approve` **THEN** system **SHALL** validate that distribution exists\n2. **IF** distribution not found **THEN** system **SHALL** return 404 with error code `DISTRIBUTION_NOT_FOUND`\n3. **IF** distribution status is not PENDING **THEN** system **SHALL** return 400 error `INVALID_STATUS` with message \"Distribution must be PENDING to approve\"\n4. **WHEN** approval requested **THEN** system **SHALL** re-check stock availability for all items (stock may have changed)\n5. **IF** stock becomes insufficient **THEN** system **SHALL** return 400 error `INSUFFICIENT_STOCK` with details\n6. **WHEN** approval successful **THEN** system **SHALL** update status to APPROVED\n7. **WHEN** approval successful **THEN** system **SHALL** record approved_by from authenticated user\n8. **WHEN** approval successful **THEN** system **SHALL** update updated_at timestamp\n9. **WHEN** approval successful **THEN** system **SHALL** return updated distribution record\n10. **IF** user lacks approval permission **THEN** system **SHALL** return 403 error `FORBIDDEN`\n\n#### REQ-7: Reject/Cancel Distribution Request\n\n**User Story:** As a supervisor, I want to reject or cancel distribution requests when they don't comply with policy or stock is unavailable, so that resources are managed properly.\n\n##### Acceptance Criteria\n\n1. **WHEN** user calls `POST /api/inventory/operations/drug-distributions/:id/cancel` **THEN** system **SHALL** validate that distribution exists\n2. **IF** distribution status is DISPENSED or COMPLETED **THEN** system **SHALL** return 400 error `INVALID_STATUS` with message \"Cannot cancel dispensed/completed distribution\"\n3. **WHEN** cancellation requested **THEN** system **SHALL** require cancellation reason in request body\n4. **WHEN** cancellation successful **THEN** system **SHALL** update status to CANCELLED\n5. **WHEN** cancellation successful **THEN** system **SHALL** store cancellation reason in notes field\n6. **WHEN** cancellation successful **THEN** system **SHALL** update updated_at timestamp\n7. **WHEN** cancellation successful **THEN** system **SHALL** return updated distribution record\n8. **WHEN** distribution cancelled **THEN** system **SHALL NOT** make any inventory changes\n\n#### REQ-8: Dispense Distribution (FIFO/FEFO)\n\n**User Story:** As a pharmacist, I want to dispense drugs for approved distributions using FIFO/FEFO logic, so that inventory is automatically updated with proper lot tracking.\n\n##### Acceptance Criteria\n\n1. **WHEN** user calls `POST /api/inventory/operations/drug-distributions/:id/dispense` **THEN** system **SHALL** validate that distribution exists\n2. **IF** distribution status is not APPROVED **THEN** system **SHALL** return 400 error `INVALID_STATUS` with message \"Distribution must be APPROVED to dispense\"\n3. **WHEN** dispensing starts **THEN** system **SHALL** process each distribution item sequentially\n4. **FOR** each item **WHEN** dispensing **THEN** system **SHALL** call `get_fifo_lots(drug_id, location_id, quantity)` to get lots in FIFO order\n5. **IF** no lots available **THEN** system **SHALL** return 400 error `NO_FIFO_LOTS` with drug details\n6. **FOR** each lot selected **WHEN** dispensing **THEN** system **SHALL** deduct quantity from drug_lots.quantity_available\n7. **WHEN** lot quantity_available reaches 0 **THEN** system **SHALL** set lot is_active to false\n8. **FOR** each item **WHEN** dispensing **THEN** system **SHALL** deduct quantity_dispensed from inventory.quantity_on_hand\n9. **FOR** each item **WHEN** dispensing **THEN** system **SHALL** create inventory_transaction record with type ISSUE\n10. **WHEN** transaction created **THEN** system **SHALL** record negative quantity (-quantity_dispensed), unit_cost, reference_id (distribution.id), reference_type 'distribution'\n11. **WHEN** transaction created **THEN** system **SHALL** record notes \"Distribution {number} to {department_name}\"\n12. **WHEN** all items dispensed **THEN** system **SHALL** update distribution status to DISPENSED\n13. **WHEN** dispensing successful **THEN** system **SHALL** record dispensed_by from authenticated user\n14. **WHEN** dispensing successful **THEN** system **SHALL** update updated_at timestamp\n15. **WHEN** all steps complete **THEN** system **SHALL** execute all operations in single atomic transaction\n16. **IF** any step fails **THEN** system **SHALL** rollback all changes and return error\n17. **IF** user lacks dispensing permission **THEN** system **SHALL** return 403 error `FORBIDDEN`\n\n#### REQ-9: Complete Distribution (Receipt Confirmation)\n\n**User Story:** As a department staff member, I want to confirm receipt of dispensed drugs, so that the distribution workflow is properly closed.\n\n##### Acceptance Criteria\n\n1. **WHEN** user calls `POST /api/inventory/operations/drug-distributions/:id/complete` **THEN** system **SHALL** validate that distribution exists\n2. **IF** distribution status is not DISPENSED **THEN** system **SHALL** return 400 error `INVALID_STATUS` with message \"Distribution must be DISPENSED to complete\"\n3. **WHEN** completion requested **THEN** system **SHALL** update status to COMPLETED\n4. **WHEN** completion requested **THEN** system **SHALL** optionally record notes from request body (e.g., \"Received by Ward Nurse Jane\")\n5. **WHEN** completion successful **THEN** system **SHALL** update updated_at timestamp\n6. **WHEN** completion successful **THEN** system **SHALL** return updated distribution record\n7. **IF** user lacks completion permission **THEN** system **SHALL** return 403 error `FORBIDDEN`\n\n#### REQ-10: Preview FIFO Lots Before Dispensing\n\n**User Story:** As a pharmacist, I want to preview which lots will be used before dispensing, so that I can verify lot numbers and expiry dates.\n\n##### Acceptance Criteria\n\n1. **WHEN** user calls `GET /api/inventory/operations/drug-distributions/:id/preview-lots` **THEN** system **SHALL** validate that distribution exists\n2. **IF** distribution status is not APPROVED **THEN** system **SHALL** return 400 error `INVALID_STATUS`\n3. **WHEN** preview requested **THEN** system **SHALL** call `get_fifo_lots()` for each distribution item\n4. **WHEN** lots returned **THEN** system **SHALL** include lot_id, lot_number, quantity to dispense from this lot, unit_cost, expiry_date, days until expiry\n5. **WHEN** lots returned **THEN** system **SHALL** group by distribution item with item_number and drug details\n6. **WHEN** lots returned **THEN** system **SHALL** order lots within each item by FIFO order (oldest first)\n7. **IF** insufficient lots for any item **THEN** system **SHALL** return warning with details\n\n### Phase 3: Distribution Reporting & Integration (Week 3)\n\n#### REQ-11: Get Distribution History by Department\n\n**User Story:** As an inventory manager, I want to view distribution history for a department, so that I can analyze drug consumption patterns.\n\n##### Acceptance Criteria\n\n1. **WHEN** user calls `GET /api/inventory/operations/drug-distributions/by-department/:deptId` **THEN** system **SHALL** return distributions for that department\n2. **WHEN** `fromDate` and `toDate` parameters provided **THEN** system **SHALL** filter by date range\n3. **WHEN** `status` parameter provided **THEN** system **SHALL** filter by status\n4. **WHEN** distributions returned **THEN** system **SHALL** include distribution summary (number, date, status, total_amount)\n5. **WHEN** distributions returned **THEN** system **SHALL** order by distribution_date descending (newest first)\n6. **WHEN** `includeItems=true` parameter provided **THEN** system **SHALL** include detailed items with drug information\n7. **WHEN** distributions returned **THEN** system **SHALL** include summary totals: count of distributions, total value dispensed\n\n#### REQ-12: Get Distribution Usage Report\n\n**User Story:** As a finance manager, I want to see drug usage by department for cost allocation, so that I can charge departments accurately.\n\n##### Acceptance Criteria\n\n1. **WHEN** user calls `GET /api/inventory/operations/drug-distributions/usage-report` **THEN** system **SHALL** return department drug usage summary\n2. **WHEN** `deptId` parameter provided **THEN** system **SHALL** filter to specific department\n3. **WHEN** `drugId` parameter provided **THEN** system **SHALL** filter to specific drug\n4. **WHEN** `fromDate` and `toDate` parameters provided **THEN** system **SHALL** filter by date range\n5. **WHEN** report returned **THEN** system **SHALL** group by department and drug\n6. **WHEN** report returned **THEN** system **SHALL** include department name, drug name (trade and generic), total quantity dispensed, total value\n7. **WHEN** report returned **THEN** system **SHALL** include count of distributions for each department-drug combination\n8. **WHEN** report returned **THEN** system **SHALL** order by total_value descending (highest cost first)\n9. **WHEN** report returned **THEN** system **SHALL** include grand totals across all departments\n\n#### REQ-13: Get Ministry Compliance Export\n\n**User Story:** As a compliance officer, I want to export distribution data in DMSIC 2568 format, so that I can submit required reports to Ministry of Public Health.\n\n##### Acceptance Criteria\n\n1. **WHEN** user calls `GET /api/inventory/operations/drug-distributions/ministry-export` **THEN** system **SHALL** query export_distribution view\n2. **WHEN** `fromDate` and `toDate` parameters provided **THEN** system **SHALL** filter by distribution date range\n3. **WHEN** export data returned **THEN** system **SHALL** include all 11 DMSIC fields: DISTNO, DISTDATE, DEPTCODE, DEPT_TYPE, DRUGCODE, QTY, UNITCOST, LOTNO, EXPDATE, AMOUNT, DISPENSER\n4. **WHEN** export data returned **THEN** system **SHALL** only include distributions with status DISPENSED or COMPLETED\n5. **WHEN** export data returned **THEN** system **SHALL** format dates as YYYY-MM-DD\n6. **WHEN** export data returned **THEN** system **SHALL** format decimals with 4 decimal places for costs, 3 for quantities\n7. **WHEN** `format=csv` parameter provided **THEN** system **SHALL** return CSV file with headers\n8. **WHEN** `format=excel` parameter provided **THEN** system **SHALL** return Excel file\n9. **WHEN** export data returned **THEN** system **SHALL** include summary row with totals\n\n#### REQ-14: Update Distribution Item\n\n**User Story:** As a pharmacist, I want to update distribution item quantities before approval, so that I can correct mistakes in pending requests.\n\n##### Acceptance Criteria\n\n1. **WHEN** user calls `PUT /api/inventory/operations/drug-distribution-items/:id` **THEN** system **SHALL** validate that item exists\n2. **WHEN** user calls `PUT /api/inventory/operations/drug-distribution-items/:id` **THEN** system **SHALL** get parent distribution status\n3. **IF** parent distribution status is not PENDING **THEN** system **SHALL** return 400 error `INVALID_STATUS` with message \"Cannot update items for non-pending distributions\"\n4. **WHEN** quantity updated **THEN** system **SHALL** re-check stock availability at from_location\n5. **IF** new quantity exceeds available stock **THEN** system **SHALL** return 400 error `INSUFFICIENT_STOCK`\n6. **WHEN** item updated **THEN** system **SHALL** re-preview FIFO lots for new quantity\n7. **WHEN** item updated **THEN** system **SHALL** update lot_number, unit_cost, expiry_date from new preview\n8. **WHEN** item updated **THEN** system **SHALL** recalculate parent distribution total_amount\n9. **WHEN** update successful **THEN** system **SHALL** return updated item record\n\n#### REQ-15: Delete Distribution Item\n\n**User Story:** As a pharmacist, I want to remove items from pending distribution requests, so that I can correct mistakes before approval.\n\n##### Acceptance Criteria\n\n1. **WHEN** user calls `DELETE /api/inventory/operations/drug-distribution-items/:id` **THEN** system **SHALL** validate that item exists\n2. **WHEN** user calls `DELETE /api/inventory/operations/drug-distribution-items/:id` **THEN** system **SHALL** get parent distribution status\n3. **IF** parent distribution status is not PENDING **THEN** system **SHALL** return 400 error `INVALID_STATUS`\n4. **WHEN** item deleted **THEN** system **SHALL** recalculate parent distribution total_items and total_amount\n5. **IF** deleting last item **THEN** system **SHALL** return 400 error \"Cannot delete last item, cancel distribution instead\"\n6. **WHEN** deletion successful **THEN** system **SHALL** return success response\n\n## Workflow Requirements\n\n### WF-1: Integration with Inventory System\n\n**User Story:** As the system, I want to integrate with Inventory API for FIFO/FEFO lot selection and stock updates, so that distributions use proper lot tracking.\n\n#### Acceptance Criteria\n\n1. **WHEN** creating distribution **THEN** system **SHALL** call Inventory API to check stock availability\n2. **WHEN** creating distribution **THEN** system **SHALL** call `get_fifo_lots()` database function to preview lots\n3. **WHEN** dispensing distribution **THEN** system **SHALL** call `get_fifo_lots()` to select actual lots in FIFO order\n4. **WHEN** dispensing distribution **THEN** system **SHALL** update inventory.quantity_on_hand via direct database access\n5. **WHEN** dispensing distribution **THEN** system **SHALL** update drug_lots.quantity_available via direct database access\n6. **WHEN** dispensing distribution **THEN** system **SHALL** create inventory_transactions records\n7. **WHEN** any inventory operation fails **THEN** system **SHALL** rollback entire distribution transaction\n\n### WF-2: Integration with Master Data\n\n**User Story:** As the system, I want to validate locations and departments against Master Data, so that only valid references are used.\n\n#### Acceptance Criteria\n\n1. **WHEN** creating distribution **THEN** system **SHALL** validate from_location_id exists in locations table\n2. **WHEN** creating distribution **THEN** system **SHALL** validate to_location_id exists in locations table (if provided)\n3. **WHEN** creating distribution **THEN** system **SHALL** validate requesting_dept_id exists in departments table\n4. **WHEN** creating distribution items **THEN** system **SHALL** validate drug_id exists in drugs table\n5. **IF** any foreign key validation fails **THEN** system **SHALL** return 400 error with specific field name\n\n### WF-3: Automatic Distribution Number Generation\n\n**User Story:** As the system, I want to generate unique distribution numbers automatically, so that each distribution has a traceable identifier.\n\n#### Acceptance Criteria\n\n1. **WHEN** creating distribution **THEN** system **SHALL** generate distribution_number in format DIST-{YYYY}-{MM}-{###}\n2. **WHEN** generating number **THEN** system **SHALL** find highest number for current year-month\n3. **WHEN** generating number **THEN** system **SHALL** increment by 1 with zero-padding (001, 002, 003...)\n4. **WHEN** new month starts **THEN** system **SHALL** reset sequence to 001\n5. **WHEN** concurrent creations occur **THEN** system **SHALL** ensure unique numbers via database constraints\n\n## Non-Functional Requirements\n\n### Code Architecture and Modularity\n\n- **Single Responsibility Principle**: Each module (repository, service, controller) has single, well-defined purpose\n- **Modular Design**: Distribution, DistributionItems, DistributionTypes isolated with clear boundaries\n- **Dependency Management**: Service layer coordinates between repositories, no direct DB access in controllers\n- **Clear Interfaces**: TypeBox schemas define contracts between layers\n- **Transaction Management**: All multi-step operations wrapped in database transactions\n\n### Performance\n\n- **Response Time**: API endpoints respond within 500ms for 95% of requests\n- **Pagination**: List endpoints support pagination with default page size 20, max 100\n- **Database Indexing**: Indexes on distribution_number, status, requesting_dept_id, from_location_id, distribution_date for fast queries\n- **FIFO Query Optimization**: get_fifo_lots() function uses indexed queries for sub-second response\n- **Concurrent Operations**: Support 50 concurrent distribution creations without deadlocks\n\n### Security\n\n- **Authentication**: All endpoints require valid JWT token\n- **Authorization**: Role-based access control (RBAC) enforced via permissions\n- **Department Restriction**: Users can only create distributions for their assigned departments\n- **Audit Trail**: All state changes logged with user ID and timestamp\n- **Input Validation**: TypeBox schemas validate all inputs, prevent SQL injection\n- **Rate Limiting**: 100 requests per minute per user\n\n### Reliability\n\n- **Atomic Transactions**: All multi-step operations succeed or fail completely (no partial updates)\n- **Error Recovery**: Failed operations rollback cleanly without data corruption\n- **Data Integrity**: Foreign key constraints prevent orphaned records\n- **Idempotency**: Approval/dispensing operations can be retried safely\n- **Availability**: 99.9% uptime during business hours (7am-7pm)\n\n### Usability\n\n- **Error Messages**: Clear, actionable error messages with error codes (INSUFFICIENT_STOCK, INVALID_STATUS, etc.)\n- **API Documentation**: Auto-generated Swagger/OpenAPI docs at /documentation endpoint\n- **Consistent Response Format**: All endpoints return standardized JSON structure\n- **Search and Filter**: Flexible query parameters for list endpoints\n- **Export Formats**: Support CSV and Excel export for reports\n\n### Compliance\n\n- **Ministry Reporting**: 100% compliance with DMSIC 2568 DISTRIBUTION format (11 fields)\n- **Audit Trail**: Immutable transaction log for all inventory movements\n- **Lot Traceability**: Complete lot-level tracking from receipt to dispensing\n- **Data Retention**: Distribution records retained for 7 years minimum\n- **Privacy**: No patient data stored in distribution records (department-level only)\n\n### Scalability\n\n- **Database Design**: PostgreSQL schema `inventory` supports millions of distributions\n- **Partition Strategy**: Distribution tables can be partitioned by year for performance\n- **Read Replicas**: Support read-only replicas for reporting queries\n- **Caching**: Frequently accessed master data (locations, departments) cached in Redis\n- **Horizontal Scaling**: Stateless API design allows multiple instances behind load balancer\n\n### Maintainability\n\n- **Code Quality**: ESLint, Prettier enforced via pre-commit hooks\n- **Test Coverage**: 80% minimum code coverage for services and repositories\n- **Documentation**: All public methods documented with JSDoc\n- **Logging**: Structured JSON logs with correlation IDs for distributed tracing\n- **Monitoring**: Prometheus metrics for request rate, error rate, response time\n",
  "fileStats": {
    "size": 28784,
    "lines": 400,
    "lastModified": "2025-12-14T13:50:07.443Z"
  },
  "comments": []
}