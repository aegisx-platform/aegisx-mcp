{
  "id": "snapshot_1765720961459_57ubnmcre",
  "approvalId": "approval_1765720632883_ex1lkc8gl",
  "approvalTitle": "Design Document - Distribution Backend API",
  "version": 2,
  "timestamp": "2025-12-14T14:02:41.459Z",
  "trigger": "approved",
  "status": "pending",
  "content": "# Design Document - Distribution Backend API\n\n## Overview\n\nThe Distribution Backend API implements a comprehensive hospital drug distribution management system with multi-level approval workflows, FIFO/FEFO lot tracking, and complete audit trails. The system is designed following domain-driven design principles, implementing the `inventory/operations` domain with three core entities and fifteen RESTful endpoints.\n\n**Key Design Principles:**\n- **API-First Development**: Complete API specification before implementation\n- **Domain-Driven Design**: Operations domain with clear bounded contexts\n- **TypeBox Schema Validation**: Type-safe request/response contracts\n- **Repository Pattern**: Clean separation of data access from business logic\n- **Service Layer**: Centralized business logic and workflow orchestration\n- **State Machine Pattern**: Explicit state transitions with validation\n- **Immutable Audit Trail**: Transaction log for regulatory compliance\n- **Database Functions**: FIFO/FEFO lot selection in PostgreSQL\n- **Atomic Transactions**: All multi-step operations execute atomically\n\n## Steering Document Alignment\n\n### Technical Standards (tech.md)\n\nThis design follows AegisX platform standards:\n\n1. **Fastify Framework**: All endpoints use Fastify with TypeBox schema validation\n2. **Layered Architecture**: Repository → Service → Controller → Routes pattern\n3. **TypeScript Strict Mode**: Full type safety across all layers\n4. **BaseRepository Pattern**: Extends platform BaseRepository for CRUD operations\n5. **Authentication**: JWT-based authentication via `fastify.authenticate` hook\n6. **Authorization**: RBAC via `fastify.verifyPermission` hook\n7. **Error Handling**: Standardized AppError with error codes\n8. **Logging**: Structured logging with correlation IDs\n9. **WebSocket Events**: Real-time updates via EventService (optional)\n10. **Database**: PostgreSQL with Knex query builder\n\n### Project Structure (structure.md)\n\nImplementation follows project organization conventions:\n\n```\napps/api/src/layers/inventory/operations/\n├── drug-distributions/\n│   ├── drug-distributions.repository.ts\n│   ├── drug-distributions.service.ts\n│   ├── drug-distributions.controller.ts\n│   ├── drug-distributions.routes.ts\n│   ├── drug-distributions.schemas.ts\n│   ├── drug-distributions.types.ts\n│   ├── index.ts\n│   └── __tests__/\n│       ├── drug-distributions.repository.spec.ts\n│       ├── drug-distributions.service.spec.ts\n│       └── drug-distributions.controller.spec.ts\n├── drug-distribution-items/\n│   ├── drug-distribution-items.repository.ts\n│   ├── drug-distribution-items.service.ts\n│   ├── drug-distribution-items.controller.ts\n│   ├── drug-distribution-items.routes.ts\n│   ├── drug-distribution-items.schemas.ts\n│   ├── drug-distribution-items.types.ts\n│   ├── index.ts\n│   └── __tests__/\n├── distribution-types/\n│   ├── distribution-types.repository.ts\n│   ├── distribution-types.service.ts\n│   ├── distribution-types.controller.ts\n│   ├── distribution-types.routes.ts\n│   ├── distribution-types.schemas.ts\n│   ├── distribution-types.types.ts\n│   ├── index.ts\n│   └── __tests__/\n└── workflows/\n    ├── distribution-state-machine.ts\n    ├── fifo-dispensing.workflow.ts\n    ├── stock-validation.workflow.ts\n    └── __tests__/\n```\n\n**Database Schema**: `inventory` (separate schema from `public`)\n\n**Migration Path**: `apps/api/src/database/migrations-inventory/`\n\n## Code Reuse Analysis\n\n### Existing Components to Leverage\n\n1. **BaseRepository** (`shared/repositories/base.repository.ts`)\n   - **Usage**: All repositories extend BaseRepository for standard CRUD operations\n   - **Features**: Automatic pagination, filtering, sorting, field selection, UUID validation\n   - **Benefits**: Reduces boilerplate, ensures consistent query patterns\n   - **Methods**: findAll, findById, create, update, delete, search\n\n2. **BaseService** (`shared/services/base.service.ts`)\n   - **Usage**: All services extend BaseService for common operations\n   - **Features**: getById, getList, create, update, delete with validation\n   - **Benefits**: Centralized business logic patterns, error handling\n   - **Methods**: Standard CRUD + custom business methods\n\n3. **EventService** (`shared/websocket/event.service.ts`)\n   - **Usage**: Real-time WebSocket notifications for distribution changes (optional)\n   - **Features**: CRUD event helper, room-based broadcasting\n   - **Benefits**: Automatic frontend updates on status changes\n   - **Events**: distribution.created, distribution.approved, distribution.dispensed\n\n4. **AppError** (`core/errors/app-error.ts`)\n   - **Usage**: Standardized error responses with error codes\n   - **Features**: HTTP status mapping, localized error messages\n   - **Benefits**: Consistent error handling across all endpoints\n   - **Error Codes**: DISTRIBUTION_NOT_FOUND, INSUFFICIENT_STOCK, INVALID_STATUS, etc.\n\n5. **TypeBox Base Schemas** (`schemas/base.schemas.ts`)\n   - **Usage**: Pagination, sorting, filtering query schemas\n   - **Features**: ApiSuccessResponseSchema, PaginatedResponseSchema\n   - **Benefits**: Reusable schema patterns, OpenAPI documentation\n\n6. **Authentication Hooks** (`core/auth/hooks/`)\n   - **Usage**: fastify.authenticate, fastify.verifyPermission\n   - **Features**: JWT validation, RBAC enforcement\n   - **Benefits**: Secured endpoints with minimal configuration\n\n7. **Response Helpers** (`core/response/response-helper.ts`)\n   - **Usage**: reply.paginated(), reply.success(), reply.error()\n   - **Features**: Standardized response formats\n   - **Benefits**: Consistent API responses\n\n### Integration Points\n\n1. **Inventory System Integration**\n   - **Purpose**: FIFO/FEFO lot selection and stock updates\n   - **Method**: Database functions `get_fifo_lots()`, `get_fefo_lots()`\n   - **Data Flow**:\n     - Distribution request → Check stock availability\n     - Dispensing → Select lots via FIFO/FEFO → Deduct quantities\n     - Update inventory.quantity_on_hand → Update drug_lots.quantity_available\n     - Create inventory_transactions with type ISSUE\n   - **Tables**: inventory, drug_lots, inventory_transactions\n   - **Error Handling**: Atomic transaction with rollback on failure\n\n2. **Master Data Integration**\n   - **Purpose**: Validate locations, departments, drugs\n   - **Method**: Foreign key constraints + service-level validation\n   - **Data Flow**:\n     - Validate from_location_id exists in locations table\n     - Validate requesting_dept_id exists in departments table\n     - Validate drug_id exists in drugs table\n   - **Tables**: locations, departments, drugs\n   - **Error Handling**: Return 400 error if foreign keys invalid\n\n3. **Budget System Integration** (Future)\n   - **Purpose**: Track department drug consumption for cost allocation\n   - **Method**: Service-to-service API call (optional)\n   - **Data Flow**: Distribution completed → Calculate total_amount → Update budget usage\n   - **Error Handling**: Graceful degradation if Budget API unavailable\n\n4. **Ministry Reporting Integration**\n   - **Purpose**: Export distribution data for DMSIC 2568 compliance\n   - **Method**: Database view `export_distribution`\n   - **Data Flow**: Query view → Format 11 fields → Export CSV/Excel\n   - **Fields**: DISTNO, DISTDATE, DEPTCODE, DEPT_TYPE, DRUGCODE, QTY, UNITCOST, LOTNO, EXPDATE, AMOUNT, DISPENSER\n\n## Architecture\n\n### System Architecture\n\n```mermaid\ngraph TB\n    subgraph \"Client Layer\"\n        A[Angular Frontend]\n        B[External Systems]\n    end\n\n    subgraph \"API Layer\"\n        C[Fastify Routes]\n        D[Authentication Middleware]\n        E[RBAC Middleware]\n    end\n\n    subgraph \"Business Layer\"\n        F[Distribution Controller]\n        G[Distribution Service]\n        H[Workflow Orchestrator]\n        I[State Machine]\n    end\n\n    subgraph \"Data Layer\"\n        J[Distribution Repository]\n        K[Items Repository]\n        L[Types Repository]\n        M[Inventory Repository]\n    end\n\n    subgraph \"Database\"\n        N[(PostgreSQL)]\n        O[get_fifo_lots Function]\n        P[export_distribution View]\n    end\n\n    A --> C\n    B --> C\n    C --> D\n    D --> E\n    E --> F\n    F --> G\n    G --> H\n    G --> I\n    H --> J\n    H --> M\n    J --> N\n    K --> N\n    L --> N\n    M --> N\n    G --> O\n    G --> P\n\n    style A fill:#e1f5e1\n    style C fill:#fff4e6\n    style G fill:#e3f2fd\n    style N fill:#f3e5f5\n```\n\n### Modular Design Principles\n\n- **Single File Responsibility**: Each file handles one specific entity or workflow\n- **Component Isolation**: Distribution, Items, Types are separate modules\n- **Service Layer Separation**: Clear separation of concerns (Repository, Service, Controller)\n- **Workflow Modularity**: State machine, FIFO logic, validation in separate files\n- **Database Functions**: Complex FIFO/FEFO logic encapsulated in PostgreSQL functions\n\n### Layered Architecture\n\n```mermaid\ngraph TB\n    subgraph \"Layer 1: Routes\"\n        R1[POST /distributions]\n        R2[GET /distributions]\n        R3[POST /distributions/:id/approve]\n        R4[POST /distributions/:id/dispense]\n    end\n\n    subgraph \"Layer 2: Controller\"\n        C1[createDistribution]\n        C2[listDistributions]\n        C3[approveDistribution]\n        C4[dispenseDistribution]\n    end\n\n    subgraph \"Layer 3: Service\"\n        S1[Business Logic]\n        S2[Workflow Orchestration]\n        S3[State Validation]\n        S4[Stock Validation]\n    end\n\n    subgraph \"Layer 4: Repository\"\n        D1[CRUD Operations]\n        D2[Query Building]\n        D3[Transaction Management]\n    end\n\n    subgraph \"Layer 5: Database\"\n        DB1[(drug_distributions)]\n        DB2[(drug_distribution_items)]\n        DB3[(inventory)]\n        DB4[Functions]\n    end\n\n    R1 --> C1\n    R2 --> C2\n    R3 --> C3\n    R4 --> C4\n\n    C1 --> S1\n    C2 --> S1\n    C3 --> S2\n    C4 --> S2\n\n    S1 --> D1\n    S2 --> S3\n    S2 --> S4\n    S3 --> D1\n    S4 --> D1\n\n    D1 --> DB1\n    D1 --> DB2\n    D1 --> DB3\n    S2 --> DB4\n\n    style R1 fill:#e3f2fd\n    style C1 fill:#fff4e6\n    style S1 fill:#f3e5f5\n    style D1 fill:#e8f5e9\n    style DB1 fill:#fce4ec\n```\n\n## API Endpoints Specification\n\n### 1. Distribution CRUD Endpoints\n\n#### GET /api/inventory/operations/drug-distributions\n**Purpose**: List distribution requests with filtering and pagination\n\n**Request Schema**:\n```typescript\n{\n  status?: 'PENDING' | 'APPROVED' | 'DISPENSED' | 'COMPLETED' | 'CANCELLED',\n  requestingDeptId?: string (UUID),\n  fromLocationId?: string (UUID),\n  fromDate?: string (ISO date),\n  toDate?: string (ISO date),\n  search?: string,\n  includeItems?: boolean,\n  page?: number,\n  limit?: number,\n  sortBy?: string,\n  sortOrder?: 'asc' | 'desc'\n}\n```\n\n**Response Schema**:\n```typescript\n{\n  data: [\n    {\n      id: string (UUID),\n      distributionNumber: string,\n      distributionDate: string,\n      fromLocationId: string (UUID),\n      toLocationId: string | null,\n      requestingDeptId: string (UUID),\n      requestedBy: string,\n      approvedBy: string | null,\n      dispensedBy: string | null,\n      status: 'PENDING' | 'APPROVED' | 'DISPENSED' | 'COMPLETED' | 'CANCELLED',\n      totalItems: number,\n      totalAmount: number,\n      notes: string | null,\n      createdAt: string,\n      updatedAt: string,\n      // Populated relations\n      fromLocation: { id, code, name },\n      toLocation: { id, code, name } | null,\n      requestingDept: { id, code, name },\n      items?: [ /* if includeItems=true */ ]\n    }\n  ],\n  meta: {\n    page: number,\n    limit: number,\n    total: number,\n    totalPages: number\n  }\n}\n```\n\n**Permissions**: `distribution:read`\n\n---\n\n#### GET /api/inventory/operations/drug-distributions/:id\n**Purpose**: Get single distribution with complete details\n\n**Response Schema**:\n```typescript\n{\n  data: {\n    id: string (UUID),\n    distributionNumber: string,\n    distributionDate: string,\n    fromLocationId: string (UUID),\n    toLocationId: string | null,\n    requestingDeptId: string (UUID),\n    requestedBy: string,\n    approvedBy: string | null,\n    dispensedBy: string | null,\n    status: 'PENDING' | 'APPROVED' | 'DISPENSED' | 'COMPLETED' | 'CANCELLED',\n    totalItems: number,\n    totalAmount: number,\n    notes: string | null,\n    createdAt: string,\n    updatedAt: string,\n    // Relations\n    fromLocation: { id, code, name, type },\n    toLocation: { id, code, name, type } | null,\n    requestingDept: { id, code, name },\n    items: [\n      {\n        id: string (UUID),\n        itemNumber: number,\n        drugId: string (UUID),\n        lotNumber: string,\n        quantityDispensed: number,\n        unitCost: number,\n        expiryDate: string,\n        createdAt: string,\n        drug: {\n          id, code, tradeName, genericName, unit\n        }\n      }\n    ]\n  }\n}\n```\n\n**Permissions**: `distribution:read`\n\n---\n\n#### POST /api/inventory/operations/drug-distributions\n**Purpose**: Create new distribution request\n\n**Request Schema**:\n```typescript\n{\n  fromLocationId: string (UUID, required),\n  toLocationId?: string (UUID, optional),\n  requestingDeptId: string (UUID, required),\n  requestedBy: string (required),\n  distributionDate?: string (ISO date, defaults to today),\n  items: [\n    {\n      drugId: string (UUID, required),\n      quantityRequested: number (required, > 0)\n    }\n  ] (min 1 item, required)\n}\n```\n\n**Response Schema**:\n```typescript\n{\n  data: {\n    id: string (UUID),\n    distributionNumber: string, // Auto-generated: DIST-YYYY-MM-###\n    distributionDate: string,\n    status: 'PENDING',\n    totalItems: number,\n    totalAmount: number,\n    items: [ /* preview with lot info */ ]\n  }\n}\n```\n\n**Business Logic**:\n1. Validate from_location_id, requesting_dept_id exist\n2. Check stock availability for each item\n3. Generate unique distribution_number\n4. Preview FIFO lots for each item using `get_fifo_lots()`\n5. Populate lot_number, unit_cost, expiry_date from preview\n6. Calculate total_items, total_amount\n7. Create distribution + items in transaction\n\n**Permissions**: `distribution:create`\n\n---\n\n### 2. Workflow Endpoints\n\n#### POST /api/inventory/operations/drug-distributions/:id/approve\n**Purpose**: Approve distribution request (supervisor action)\n\n**Request Schema**:\n```typescript\n{\n  approvedBy: string (required)\n}\n```\n\n**Response Schema**:\n```typescript\n{\n  data: {\n    id: string (UUID),\n    status: 'APPROVED',\n    approvedBy: string,\n    updatedAt: string\n  }\n}\n```\n\n**Business Logic**:\n1. Validate distribution exists and status is PENDING\n2. Re-check stock availability (may have changed)\n3. Update status to APPROVED\n4. Record approved_by and timestamp\n\n**Permissions**: `distribution:approve`\n\n---\n\n#### POST /api/inventory/operations/drug-distributions/:id/cancel\n**Purpose**: Cancel distribution request\n\n**Request Schema**:\n```typescript\n{\n  reason: string (required)\n}\n```\n\n**Response Schema**:\n```typescript\n{\n  data: {\n    id: string (UUID),\n    status: 'CANCELLED',\n    notes: string, // Contains cancellation reason\n    updatedAt: string\n  }\n}\n```\n\n**Business Logic**:\n1. Validate distribution exists\n2. Validate status is PENDING or APPROVED (cannot cancel DISPENSED/COMPLETED)\n3. Update status to CANCELLED\n4. Store reason in notes\n\n**Permissions**: `distribution:cancel`\n\n---\n\n#### POST /api/inventory/operations/drug-distributions/:id/dispense\n**Purpose**: Dispense drugs using FIFO/FEFO logic (pharmacist action)\n\n**Request Schema**:\n```typescript\n{\n  dispensedBy: string (required),\n  userId: string (UUID, required) // For audit trail\n}\n```\n\n**Response Schema**:\n```typescript\n{\n  data: {\n    id: string (UUID),\n    status: 'DISPENSED',\n    dispensedBy: string,\n    updatedAt: string,\n    lotsUsed: [\n      {\n        itemNumber: number,\n        drugName: string,\n        lots: [\n          { lotNumber, quantity, expiryDate }\n        ]\n      }\n    ]\n  }\n}\n```\n\n**Business Logic** (Atomic Transaction):\n1. Validate distribution exists and status is APPROVED\n2. For each item:\n   - Call `get_fifo_lots(drug_id, location_id, quantity)`\n   - Deduct from drug_lots.quantity_available\n   - Set lot.is_active = false when quantity_available = 0\n   - Deduct from inventory.quantity_on_hand\n   - Create inventory_transaction (type: ISSUE)\n3. Update distribution status to DISPENSED\n4. Record dispensed_by and timestamp\n\n**Permissions**: `distribution:dispense`\n\n---\n\n#### POST /api/inventory/operations/drug-distributions/:id/complete\n**Purpose**: Mark distribution as completed (department receipt confirmation)\n\n**Request Schema**:\n```typescript\n{\n  notes?: string (optional) // e.g., \"Received by Ward Nurse Jane\"\n}\n```\n\n**Response Schema**:\n```typescript\n{\n  data: {\n    id: string (UUID),\n    status: 'COMPLETED',\n    notes: string,\n    updatedAt: string\n  }\n}\n```\n\n**Business Logic**:\n1. Validate distribution exists and status is DISPENSED\n2. Update status to COMPLETED\n3. Record notes and timestamp\n\n**Permissions**: `distribution:complete`\n\n---\n\n#### GET /api/inventory/operations/drug-distributions/:id/preview-lots\n**Purpose**: Preview FIFO lots before dispensing\n\n**Response Schema**:\n```typescript\n{\n  data: [\n    {\n      itemNumber: number,\n      drugId: string (UUID),\n      drugName: string,\n      quantityNeeded: number,\n      lots: [\n        {\n          lotId: string (UUID),\n          lotNumber: string,\n          quantityToDispense: number,\n          unitCost: number,\n          expiryDate: string,\n          daysUntilExpiry: number\n        }\n      ]\n    }\n  ]\n}\n```\n\n**Business Logic**:\n1. Validate distribution exists and status is APPROVED\n2. For each item, call `get_fifo_lots()` without updating\n3. Return preview of lots that will be used\n\n**Permissions**: `distribution:read`\n\n---\n\n### 3. Reporting Endpoints\n\n#### GET /api/inventory/operations/drug-distributions/by-department/:deptId\n**Purpose**: Get distribution history by department\n\n**Request Schema**:\n```typescript\n{\n  fromDate?: string (ISO date),\n  toDate?: string (ISO date),\n  status?: 'PENDING' | 'APPROVED' | 'DISPENSED' | 'COMPLETED' | 'CANCELLED',\n  includeItems?: boolean\n}\n```\n\n**Response Schema**:\n```typescript\n{\n  data: [ /* distributions */ ],\n  summary: {\n    totalDistributions: number,\n    totalValue: number,\n    avgValuePerDistribution: number\n  }\n}\n```\n\n**Permissions**: `distribution:read`\n\n---\n\n#### GET /api/inventory/operations/drug-distributions/usage-report\n**Purpose**: Department drug usage summary\n\n**Request Schema**:\n```typescript\n{\n  deptId?: string (UUID),\n  drugId?: string (UUID),\n  fromDate?: string (ISO date),\n  toDate?: string (ISO date)\n}\n```\n\n**Response Schema**:\n```typescript\n{\n  data: [\n    {\n      deptCode: string,\n      deptName: string,\n      drugCode: string,\n      drugTradeName: string,\n      drugGenericName: string,\n      totalQuantity: number,\n      totalValue: number,\n      distributionCount: number\n    }\n  ],\n  grandTotal: {\n    totalValue: number,\n    totalDistributions: number\n  }\n}\n```\n\n**Permissions**: `distribution:read`, `reports:read`\n\n---\n\n#### GET /api/inventory/operations/drug-distributions/ministry-export\n**Purpose**: Export DMSIC 2568 compliance data\n\n**Request Schema**:\n```typescript\n{\n  fromDate: string (ISO date, required),\n  toDate: string (ISO date, required),\n  format?: 'csv' | 'excel' (default: 'csv')\n}\n```\n\n**Response**: CSV or Excel file with 11 fields\n\n**Fields**:\n- DISTNO (distribution_number)\n- DISTDATE (distribution_date)\n- DEPTCODE (dept_code)\n- DEPT_TYPE (consumption_group)\n- DRUGCODE (drug_code)\n- QTY (quantity_dispensed)\n- UNITCOST (unit_cost)\n- LOTNO (lot_number)\n- EXPDATE (expiry_date)\n- AMOUNT (quantity × unit_cost)\n- DISPENSER (dispensed_by)\n\n**Permissions**: `distribution:export`, `ministry:export`\n\n---\n\n### 4. Item Management Endpoints\n\n#### GET /api/inventory/operations/drug-distribution-items\n**Purpose**: List distribution items\n\n**Request Schema**:\n```typescript\n{\n  distributionId?: string (UUID),\n  drugId?: string (UUID)\n}\n```\n\n**Permissions**: `distribution:read`\n\n---\n\n#### PUT /api/inventory/operations/drug-distribution-items/:id\n**Purpose**: Update item quantity (only for PENDING distributions)\n\n**Request Schema**:\n```typescript\n{\n  quantityRequested: number (> 0, required)\n}\n```\n\n**Business Logic**:\n1. Validate parent distribution status is PENDING\n2. Re-check stock availability\n3. Re-preview FIFO lots\n4. Update item with new lot info\n5. Recalculate parent total_amount\n\n**Permissions**: `distribution:update`\n\n---\n\n#### DELETE /api/inventory/operations/drug-distribution-items/:id\n**Purpose**: Remove item from PENDING distribution\n\n**Business Logic**:\n1. Validate parent distribution status is PENDING\n2. Prevent deleting last item (cancel distribution instead)\n3. Recalculate parent total_items and total_amount\n\n**Permissions**: `distribution:update`\n\n---\n\n### 5. Distribution Types Endpoint\n\n#### GET /api/inventory/operations/distribution-types\n**Purpose**: List distribution types\n\n**Request Schema**:\n```typescript\n{\n  activeOnly?: boolean (default: true)\n}\n```\n\n**Response Schema**:\n```typescript\n{\n  data: [\n    {\n      id: string (UUID),\n      name: string,\n      description: string,\n      isActive: boolean\n    }\n  ]\n}\n```\n\n**Permissions**: `distribution:read`\n\n---\n\n## Data Models\n\n### 1. DrugDistribution (drug_distributions table)\n\n```typescript\ninterface DrugDistribution {\n  id: string; // UUID, PK\n  distributionNumber: string; // UNIQUE, \"DIST-YYYY-MM-###\"\n  distributionDate: Date; // NOT NULL\n  fromLocationId: string; // UUID, FK → locations(id), NOT NULL\n  toLocationId: string | null; // UUID, FK → locations(id)\n  requestingDeptId: string; // UUID, FK → departments(id), NOT NULL\n  requestedBy: string; // VARCHAR(100)\n  approvedBy: string | null; // VARCHAR(100)\n  dispensedBy: string | null; // VARCHAR(100)\n  status: DistributionStatus; // ENUM, NOT NULL, DEFAULT 'PENDING'\n  totalItems: number; // INT, DEFAULT 0\n  totalAmount: number; // DECIMAL(15,2), DEFAULT 0\n  notes: string | null; // TEXT\n  createdAt: Date; // TIMESTAMP\n  updatedAt: Date; // TIMESTAMP\n}\n\nenum DistributionStatus {\n  PENDING = 'PENDING',\n  APPROVED = 'APPROVED',\n  DISPENSED = 'DISPENSED',\n  COMPLETED = 'COMPLETED',\n  CANCELLED = 'CANCELLED'\n}\n```\n\n**Indexes**:\n- `idx_dist_number` ON distribution_number\n- `idx_dist_status` ON status\n- `idx_dist_dept` ON requesting_dept_id\n- `idx_dist_from_location` ON from_location_id\n- `idx_dist_date` ON distribution_date\n- `idx_dist_created` ON created_at DESC\n\n**Unique Constraints**:\n- `UNIQUE(distribution_number)`\n\n---\n\n### 2. DrugDistributionItem (drug_distribution_items table)\n\n```typescript\ninterface DrugDistributionItem {\n  id: string; // UUID, PK\n  distributionId: string; // UUID, FK → drug_distributions(id), NOT NULL\n  itemNumber: number; // INT, NOT NULL (1, 2, 3...)\n  drugId: string; // UUID, FK → drugs(id), NOT NULL\n  lotNumber: string; // VARCHAR(50), NOT NULL\n  quantityDispensed: number; // DECIMAL(15,3), NOT NULL\n  unitCost: number; // DECIMAL(15,4), NOT NULL\n  expiryDate: Date; // DATE, NOT NULL\n  createdAt: Date; // TIMESTAMP\n}\n```\n\n**Indexes**:\n- `idx_dist_items_distribution` ON distribution_id\n- `idx_dist_items_drug` ON drug_id\n- `idx_dist_items_lot` ON lot_number\n- `idx_dist_items_expiry` ON expiry_date\n\n**Unique Constraints**:\n- `UNIQUE(distribution_id, item_number)`\n\n---\n\n### 3. DistributionType (distribution_types table)\n\n```typescript\ninterface DistributionType {\n  id: string; // UUID, PK\n  name: string; // VARCHAR(100), NOT NULL\n  description: string | null; // TEXT\n  isActive: boolean; // BOOLEAN, DEFAULT true\n  createdAt: Date; // TIMESTAMP\n}\n```\n\n**Seed Data**:\n- จ่ายถาวร (Permanent distribution)\n- ยืม-คืน (Loan-return)\n\n---\n\n## Workflow State Machine\n\n### Distribution Status State Machine\n\n```mermaid\nstateDiagram-v2\n    [*] --> PENDING: Create Distribution\n    PENDING --> APPROVED: Supervisor Approves\n    PENDING --> CANCELLED: Requester/Supervisor Cancels\n\n    APPROVED --> DISPENSED: Pharmacist Dispenses\n    APPROVED --> CANCELLED: Cancel Before Dispensing\n\n    DISPENSED --> COMPLETED: Department Receives\n\n    COMPLETED --> [*]\n    CANCELLED --> [*]\n\n    note right of PENDING\n        Stock validated\n        Lots previewed\n    end note\n\n    note right of APPROVED\n        Stock re-validated\n        Ready for dispensing\n    end note\n\n    note right of DISPENSED\n        Inventory updated\n        Lots deducted\n        Transactions logged\n    end note\n\n    note right of COMPLETED\n        Workflow complete\n        Receipt confirmed\n    end note\n```\n\n### State Transition Rules\n\n```typescript\ninterface StateTransition {\n  from: DistributionStatus;\n  to: DistributionStatus;\n  action: string;\n  permissions: string[];\n  validations: ValidationRule[];\n}\n\nconst STATE_MACHINE: StateTransition[] = [\n  {\n    from: null,\n    to: 'PENDING',\n    action: 'CREATE',\n    permissions: ['distribution:create'],\n    validations: [\n      'validate_locations_exist',\n      'validate_department_exists',\n      'check_stock_availability',\n      'validate_items_not_empty'\n    ]\n  },\n  {\n    from: 'PENDING',\n    to: 'APPROVED',\n    action: 'APPROVE',\n    permissions: ['distribution:approve'],\n    validations: [\n      'recheck_stock_availability'\n    ]\n  },\n  {\n    from: 'PENDING',\n    to: 'CANCELLED',\n    action: 'CANCEL',\n    permissions: ['distribution:cancel'],\n    validations: [\n      'require_cancellation_reason'\n    ]\n  },\n  {\n    from: 'APPROVED',\n    to: 'DISPENSED',\n    action: 'DISPENSE',\n    permissions: ['distribution:dispense'],\n    validations: [\n      'validate_fifo_lots_available',\n      'ensure_atomic_transaction'\n    ]\n  },\n  {\n    from: 'APPROVED',\n    to: 'CANCELLED',\n    action: 'CANCEL',\n    permissions: ['distribution:cancel'],\n    validations: [\n      'require_cancellation_reason'\n    ]\n  },\n  {\n    from: 'DISPENSED',\n    to: 'COMPLETED',\n    action: 'COMPLETE',\n    permissions: ['distribution:complete'],\n    validations: []\n  }\n];\n```\n\n---\n\n## Integration with Inventory System\n\n### FIFO/FEFO Lot Selection\n\n```typescript\n// Database Function: get_fifo_lots(drug_id, location_id, quantity_needed)\ninterface FifoLot {\n  lot_id: string; // UUID\n  lot_number: string;\n  quantity: number; // Quantity to dispense from this lot\n  unit_cost: number;\n  expiry_date: Date;\n  received_date: Date;\n}\n\n// Service method\nasync getFifoLotsForItem(\n  drugId: string,\n  locationId: string,\n  quantityNeeded: number\n): Promise<FifoLot[]> {\n  const result = await this.db.raw(`\n    SELECT * FROM inventory.get_fifo_lots(\n      ?::UUID,\n      ?::UUID,\n      ?::DECIMAL\n    )\n  `, [drugId, locationId, quantityNeeded]);\n\n  return result.rows;\n}\n```\n\n### Stock Availability Check\n\n```typescript\nasync checkStockAvailability(\n  drugId: string,\n  locationId: string,\n  quantityNeeded: number\n): Promise<{ available: boolean; currentStock: number }> {\n  const inventory = await this.inventoryRepository.findOne({\n    drug_id: drugId,\n    location_id: locationId\n  });\n\n  if (!inventory) {\n    return { available: false, currentStock: 0 };\n  }\n\n  return {\n    available: inventory.quantity_on_hand >= quantityNeeded,\n    currentStock: inventory.quantity_on_hand\n  };\n}\n```\n\n### Inventory Deduction (Atomic Transaction)\n\n```typescript\nasync dispenseDistribution(\n  distributionId: string,\n  dispensedBy: string,\n  userId: string\n): Promise<DrugDistribution> {\n  return await this.db.transaction(async (trx) => {\n    // 1. Get distribution with items\n    const distribution = await this.repository.findById(distributionId, { trx });\n\n    if (distribution.status !== 'APPROVED') {\n      throw new AppError('INVALID_STATUS', 'Distribution must be APPROVED to dispense');\n    }\n\n    // 2. Process each item\n    for (const item of distribution.items) {\n      // 2.1 Get FIFO lots\n      const fifoLots = await this.getFifoLotsForItem(\n        item.drugId,\n        distribution.fromLocationId,\n        item.quantityDispensed,\n        trx\n      );\n\n      if (!fifoLots || fifoLots.length === 0) {\n        throw new AppError('NO_FIFO_LOTS', `No available lots for drug ${item.drugId}`);\n      }\n\n      // 2.2 Deduct from each lot\n      let remainingQty = item.quantityDispensed;\n      for (const lot of fifoLots) {\n        const deductQty = Math.min(lot.quantity, remainingQty);\n\n        // Update lot quantity\n        await trx('inventory.drug_lots')\n          .where('id', lot.lot_id)\n          .decrement('quantity_available', deductQty);\n\n        // Check if lot depleted\n        const updatedLot = await trx('inventory.drug_lots')\n          .where('id', lot.lot_id)\n          .first();\n\n        if (updatedLot.quantity_available === 0) {\n          await trx('inventory.drug_lots')\n            .where('id', lot.lot_id)\n            .update({ is_active: false });\n        }\n\n        remainingQty -= deductQty;\n        if (remainingQty <= 0) break;\n      }\n\n      // 2.3 Update inventory\n      await trx('inventory.inventory')\n        .where({\n          drug_id: item.drugId,\n          location_id: distribution.fromLocationId\n        })\n        .decrement('quantity_on_hand', item.quantityDispensed)\n        .update({ last_updated: new Date() });\n\n      // 2.4 Create transaction\n      const inventory = await trx('inventory.inventory')\n        .where({\n          drug_id: item.drugId,\n          location_id: distribution.fromLocationId\n        })\n        .first();\n\n      await trx('inventory.inventory_transactions').insert({\n        inventory_id: inventory.id,\n        transaction_type: 'ISSUE',\n        quantity: -item.quantityDispensed,\n        unit_cost: item.unitCost,\n        reference_id: distribution.id,\n        reference_type: 'distribution',\n        notes: `Distribution ${distribution.distributionNumber} to ${distribution.requestingDept.name}`,\n        created_by: userId\n      });\n    }\n\n    // 3. Update distribution status\n    const updated = await this.repository.update(\n      distributionId,\n      {\n        status: 'DISPENSED',\n        dispensed_by: dispensedBy,\n        updated_at: new Date()\n      },\n      { trx }\n    );\n\n    return updated;\n  });\n}\n```\n\n---\n\n## Error Handling\n\n### Error Codes and Scenarios\n\n```typescript\nenum DistributionErrorCode {\n  DISTRIBUTION_NOT_FOUND = 'DISTRIBUTION_NOT_FOUND',\n  INSUFFICIENT_STOCK = 'INSUFFICIENT_STOCK',\n  INVALID_STATUS = 'INVALID_STATUS',\n  NO_FIFO_LOTS = 'NO_FIFO_LOTS',\n  INVALID_LOCATION = 'INVALID_LOCATION',\n  INVALID_DEPARTMENT = 'INVALID_DEPARTMENT',\n  INVALID_DRUG = 'INVALID_DRUG',\n  CANNOT_DELETE_LAST_ITEM = 'CANNOT_DELETE_LAST_ITEM',\n  DUPLICATE_DISTRIBUTION_NUMBER = 'DUPLICATE_DISTRIBUTION_NUMBER'\n}\n```\n\n### Error Response Format\n\n```typescript\ninterface ErrorResponse {\n  error: {\n    code: DistributionErrorCode;\n    message: string;\n    details?: Record<string, any>;\n    timestamp: string;\n    path: string;\n  }\n}\n```\n\n### Example Error Scenarios\n\n1. **Insufficient Stock**\n```typescript\nthrow new AppError('INSUFFICIENT_STOCK', 'Insufficient stock for Paracetamol', {\n  drugId: '...',\n  drugName: 'Paracetamol 500mg',\n  locationId: '...',\n  locationName: 'Central Pharmacy',\n  requested: 1000,\n  available: 500\n}, 400);\n```\n\n2. **Invalid Status Transition**\n```typescript\nthrow new AppError('INVALID_STATUS', 'Distribution must be APPROVED before dispensing', {\n  currentStatus: 'PENDING',\n  requiredStatus: 'APPROVED',\n  action: 'dispense'\n}, 400);\n```\n\n3. **No FIFO Lots Available**\n```typescript\nthrow new AppError('NO_FIFO_LOTS', 'No available lots for drug', {\n  drugId: '...',\n  drugName: 'Morphine 10mg',\n  locationId: '...',\n  quantityNeeded: 50\n}, 400);\n```\n\n---\n\n## Testing Strategy\n\n### Unit Testing\n\n**Files to Test**:\n- `drug-distributions.service.spec.ts`\n- `drug-distributions.repository.spec.ts`\n- `drug-distribution-items.service.spec.ts`\n- `distribution-state-machine.spec.ts`\n- `fifo-dispensing.workflow.spec.ts`\n\n**Key Test Cases**:\n1. **Repository Tests**:\n   - CRUD operations\n   - Query filtering (status, department, date range)\n   - Pagination and sorting\n   - Error handling (not found, duplicate)\n\n2. **Service Tests**:\n   - Create distribution with stock validation\n   - Approve distribution with re-check\n   - Dispense with FIFO lot selection (mocked)\n   - Cancel distribution\n   - Complete distribution\n   - State transition validation\n\n3. **Workflow Tests**:\n   - State machine transitions (valid and invalid)\n   - FIFO lot selection algorithm\n   - Stock validation logic\n   - Distribution number generation\n\n**Example Test**:\n```typescript\ndescribe('DrugDistributionService', () => {\n  describe('createDistribution', () => {\n    it('should create distribution with PENDING status', async () => {\n      const input = {\n        fromLocationId: 'loc-1',\n        requestingDeptId: 'dept-1',\n        requestedBy: 'John Doe',\n        items: [\n          { drugId: 'drug-1', quantityRequested: 100 }\n        ]\n      };\n\n      // Mock stock availability\n      inventoryService.checkStockAvailability.mockResolvedValue({\n        available: true,\n        currentStock: 500\n      });\n\n      // Mock FIFO lots preview\n      inventoryService.getFifoLotsForItem.mockResolvedValue([\n        { lot_id: 'lot-1', lot_number: 'LOT2025A', quantity: 100, unit_cost: 5.00 }\n      ]);\n\n      const result = await service.createDistribution(input);\n\n      expect(result.status).toBe('PENDING');\n      expect(result.distributionNumber).toMatch(/^DIST-\\d{4}-\\d{2}-\\d{3}$/);\n      expect(result.totalItems).toBe(1);\n      expect(result.totalAmount).toBe(500);\n    });\n\n    it('should throw INSUFFICIENT_STOCK error when stock unavailable', async () => {\n      const input = { /* ... */ };\n\n      inventoryService.checkStockAvailability.mockResolvedValue({\n        available: false,\n        currentStock: 50\n      });\n\n      await expect(service.createDistribution(input))\n        .rejects\n        .toThrow('INSUFFICIENT_STOCK');\n    });\n  });\n});\n```\n\n### Integration Testing\n\n**Test Scenarios**:\n1. **Complete Distribution Workflow**:\n   - Create distribution → Approve → Dispense → Complete\n   - Verify status transitions\n   - Verify inventory updates\n   - Verify transaction logs\n\n2. **Error Scenarios**:\n   - Create with insufficient stock → Expect 400 error\n   - Approve already approved → Expect 400 error\n   - Dispense pending distribution → Expect 400 error\n   - Cancel dispensed distribution → Expect 400 error\n\n3. **Concurrent Operations**:\n   - Multiple distributions dispensing same drug simultaneously\n   - Verify no overselling\n   - Verify transaction isolation\n\n**Example Integration Test**:\n```typescript\ndescribe('Distribution Workflow Integration', () => {\n  it('should complete full workflow and update inventory', async () => {\n    // 1. Create distribution\n    const createResponse = await request(app.server)\n      .post('/api/inventory/operations/drug-distributions')\n      .send({\n        fromLocationId: testLocation.id,\n        requestingDeptId: testDept.id,\n        requestedBy: 'Test User',\n        items: [\n          { drugId: testDrug.id, quantityRequested: 100 }\n        ]\n      })\n      .expect(201);\n\n    const distributionId = createResponse.body.data.id;\n\n    // 2. Approve\n    await request(app.server)\n      .post(`/api/inventory/operations/drug-distributions/${distributionId}/approve`)\n      .send({ approvedBy: 'Supervisor' })\n      .expect(200);\n\n    // 3. Get initial stock\n    const initialStock = await getInventoryStock(testDrug.id, testLocation.id);\n\n    // 4. Dispense\n    await request(app.server)\n      .post(`/api/inventory/operations/drug-distributions/${distributionId}/dispense`)\n      .send({ dispensedBy: 'Pharmacist', userId: testUser.id })\n      .expect(200);\n\n    // 5. Verify inventory reduced\n    const finalStock = await getInventoryStock(testDrug.id, testLocation.id);\n    expect(finalStock).toBe(initialStock - 100);\n\n    // 6. Verify transaction created\n    const transactions = await getInventoryTransactions(distributionId);\n    expect(transactions).toHaveLength(1);\n    expect(transactions[0].transaction_type).toBe('ISSUE');\n    expect(transactions[0].quantity).toBe(-100);\n\n    // 7. Complete\n    await request(app.server)\n      .post(`/api/inventory/operations/drug-distributions/${distributionId}/complete`)\n      .send({ notes: 'Received by Ward' })\n      .expect(200);\n\n    // 8. Verify final status\n    const final = await request(app.server)\n      .get(`/api/inventory/operations/drug-distributions/${distributionId}`)\n      .expect(200);\n\n    expect(final.body.data.status).toBe('COMPLETED');\n  });\n});\n```\n\n### End-to-End Testing\n\n**User Scenarios**:\n1. **Department Staff Creates Request**:\n   - Login as department user\n   - Navigate to distribution request page\n   - Select drugs and quantities\n   - Submit request\n   - Verify PENDING status\n\n2. **Supervisor Approves Request**:\n   - Login as supervisor\n   - View pending distributions\n   - Review and approve\n   - Verify APPROVED status\n\n3. **Pharmacist Dispenses Drugs**:\n   - Login as pharmacist\n   - View approved distributions\n   - Dispense using FIFO/FEFO\n   - Verify DISPENSED status\n   - Verify inventory reduced\n\n4. **Department Receives Drugs**:\n   - Login as department user\n   - Confirm receipt\n   - Verify COMPLETED status\n\n---\n\n## Security Considerations\n\n### Authentication\n- All endpoints require valid JWT token\n- Token validated via `fastify.authenticate` hook\n\n### Authorization (RBAC)\n```typescript\nconst DISTRIBUTION_PERMISSIONS = {\n  'distribution:read': ['ADMIN', 'PHARMACIST', 'INVENTORY_STAFF', 'DEPARTMENT_USER'],\n  'distribution:create': ['ADMIN', 'PHARMACIST', 'DEPARTMENT_USER'],\n  'distribution:approve': ['ADMIN', 'SUPERVISOR'],\n  'distribution:dispense': ['ADMIN', 'PHARMACIST'],\n  'distribution:complete': ['ADMIN', 'DEPARTMENT_USER'],\n  'distribution:cancel': ['ADMIN', 'SUPERVISOR'],\n  'distribution:export': ['ADMIN', 'FINANCE_OFFICER'],\n  'ministry:export': ['ADMIN', 'COMPLIANCE_OFFICER']\n};\n```\n\n### Input Validation\n- All request schemas validated via TypeBox\n- UUID fields validated for format\n- Numeric fields validated for positive values\n- Date fields validated for ISO format\n- Enum fields validated against allowed values\n\n### SQL Injection Prevention\n- Use parameterized queries via Knex\n- Never concatenate user input into SQL strings\n- Validate and sanitize all inputs\n\n### Audit Trail\n- Log all state transitions with user ID and timestamp\n- Immutable inventory_transactions table\n- Track created_by, updated_by for all records\n\n---\n\n## Performance Considerations\n\n### Database Optimization\n- Indexes on frequently queried fields (status, dept_id, location_id, date)\n- Composite indexes for common filter combinations\n- Limit result sets with pagination (default 20, max 100)\n\n### Caching Strategy\n- Cache distribution types (rarely change)\n- Cache department and location lookups (60 minutes TTL)\n- Invalidate cache on updates\n\n### Query Optimization\n- Use database functions for FIFO/FEFO (faster than application logic)\n- Limit joins in list queries (use eager loading selectively)\n- Use database-level aggregations for reports\n\n### Transaction Management\n- Keep transactions short and focused\n- Release locks quickly\n- Use row-level locking for concurrent dispensing\n\n---\n\n## Monitoring and Logging\n\n### Metrics to Track\n- Distribution creation rate (per hour/day)\n- Average time from PENDING to COMPLETED\n- Dispensing errors (insufficient stock, no lots)\n- Top drugs by distribution frequency\n- Top departments by distribution count\n\n### Logging Standards\n```typescript\nlogger.info('Distribution created', {\n  correlationId: req.id,\n  distributionId: result.id,\n  distributionNumber: result.distributionNumber,\n  requestingDeptId: input.requestingDeptId,\n  itemCount: input.items.length,\n  userId: req.user.id\n});\n\nlogger.warn('Insufficient stock for distribution', {\n  correlationId: req.id,\n  drugId: item.drugId,\n  requested: item.quantityRequested,\n  available: stock.currentStock\n});\n\nlogger.error('Failed to dispense distribution', {\n  correlationId: req.id,\n  distributionId: id,\n  error: err.message,\n  stack: err.stack\n});\n```\n\n---\n\n## Deployment Considerations\n\n### Database Migrations\n- Run migrations in sequence (distribution_types → drug_distributions → drug_distribution_items)\n- Seed distribution_types with default values\n- Create database functions (get_fifo_lots if not exists)\n- Create export_distribution view\n\n### Configuration\n- Environment variables for schema name (`INVENTORY_SCHEMA`)\n- Feature flags for WebSocket events\n- Rate limiting configuration\n\n### Rollback Plan\n- Keep migration rollback scripts\n- Document state machine rules for troubleshooting\n- Maintain backup before deployment\n\n---\n\n**Document Version**: 1.0\n**Last Updated**: 2025-12-14\n**Author**: Distribution Backend API Team\n",
  "fileStats": {
    "size": 40783,
    "lines": 1559,
    "lastModified": "2025-12-14T13:56:55.921Z"
  },
  "comments": []
}