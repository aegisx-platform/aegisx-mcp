<!-- Department Hierarchy View Template -->
<div class="hierarchy-container">
  <!-- Header with controls -->
  <div class="hierarchy-header">
    <h3 class="hierarchy-title">Department Hierarchy</h3>

    <!-- Expand/Collapse controls -->
    @if (hasData() && !loading()) {
      <div class="hierarchy-controls">
        <button
          mat-stroked-button
          (click)="expandAll()"
          class="control-btn"
          title="Expand all nodes"
        >
          <mat-icon>unfold_more</mat-icon>
          <span>Expand All</span>
        </button>
        <button
          mat-stroked-button
          (click)="collapseAll()"
          class="control-btn"
          title="Collapse all nodes"
        >
          <mat-icon>unfold_less</mat-icon>
          <span>Collapse All</span>
        </button>
      </div>
    }
  </div>

  <!-- Loading state -->
  @if (loading()) {
    <div class="loading-state">
      <mat-spinner diameter="40"></mat-spinner>
      <p>Loading department hierarchy...</p>
    </div>
  }

  <!-- Error state -->
  @if (error() && !loading()) {
    <div class="error-state">
      <mat-icon class="error-icon">error_outline</mat-icon>
      <p class="error-message">{{ error() }}</p>
      <button mat-raised-button color="primary" (click)="loadHierarchy()">
        Retry
      </button>
    </div>
  }

  <!-- Empty state -->
  @if (!loading() && !error() && !hasData()) {
    <div class="empty-state">
      <mat-icon class="empty-icon">account_tree</mat-icon>
      <p class="empty-message">No departments found</p>
      <p class="empty-hint">Create your first department to get started</p>
    </div>
  }

  <!-- Tree view -->
  @if (!loading() && !error() && hasData()) {
    <div class="tree-container">
      <mat-tree
        [dataSource]="dataSource"
        [treeControl]="treeControl"
        class="department-tree"
      >
        <!-- Tree node template -->
        <mat-nested-tree-node *matTreeNodeDef="let node" matTreeNodeToggle>
          <li class="tree-node">
            <div
              class="node-content"
              [class.node-selected]="isSelected(node)"
              [class.node-inactive]="!node.is_active"
              (click)="selectNode(node)"
            >
              <!-- Expand/collapse button placeholder for alignment -->
              <button
                mat-icon-button
                disabled
                class="node-toggle-placeholder"
              >
                <mat-icon class="node-icon-spacer"></mat-icon>
              </button>

              <!-- Department info -->
              <div class="node-info">
                <span class="node-text">{{ getNodeDisplayText(node) }}</span>

                <!-- Inactive badge -->
                @if (!node.is_active) {
                  <mat-icon class="inactive-icon" title="Inactive department">
                    visibility_off
                  </mat-icon>
                }
              </div>
            </div>
          </li>
        </mat-nested-tree-node>

        <!-- Tree node with children template -->
        <mat-nested-tree-node
          *matTreeNodeDef="let node; when: hasChild"
          matTreeNodeToggle
        >
          <li class="tree-node">
            <div
              class="node-content"
              [class.node-selected]="isSelected(node)"
              [class.node-inactive]="!node.is_active"
              (click)="selectNode(node)"
            >
              <!-- Expand/collapse button -->
              <button
                mat-icon-button
                matTreeNodeToggle
                (click)="$event.stopPropagation()"
                class="node-toggle"
                [attr.aria-label]="'Toggle ' + node.dept_name"
              >
                <mat-icon class="node-icon">
                  {{
                    treeControl.isExpanded(node)
                      ? 'expand_more'
                      : 'chevron_right'
                  }}
                </mat-icon>
              </button>

              <!-- Department info -->
              <div class="node-info">
                <span class="node-text">{{ getNodeDisplayText(node) }}</span>

                <!-- Department count badge -->
                @if (node.children.length > 0) {
                  <span class="node-count-badge" title="Total departments in this branch">
                    {{ countDescendants(node) }}
                  </span>
                }

                <!-- Inactive badge -->
                @if (!node.is_active) {
                  <mat-icon class="inactive-icon" title="Inactive department">
                    visibility_off
                  </mat-icon>
                }
              </div>
            </div>

            <!-- Children nodes -->
            @if (treeControl.isExpanded(node)) {
              <ul class="tree-children">
                <ng-container matTreeNodeOutlet></ng-container>
              </ul>
            }
          </li>
        </mat-nested-tree-node>
      </mat-tree>
    </div>
  }
</div>
