# Fast development build - Single stage
FROM node:20.19.0-alpine3.20

# Install dependencies
RUN apk add --no-cache python3 make g++ && \
    addgroup -g 1001 -S nodejs && \
    adduser -S aegisx -u 1001 -G nodejs

WORKDIR /app
COPY --chown=aegisx:nodejs . .

# Install and build in one go
USER aegisx
ENV YARN_IGNORE_ENGINES=true YARN_SILENT=1 CI=true
RUN yarn install --frozen-lockfile --silent && \
    npx nx build admin --configuration=production

# Simple nginx setup
FROM nginx:alpine
COPY --from=0 /app/dist/apps/admin /usr/share/nginx/html
EXPOSE 80