#!/usr/bin/env sh

echo "ğŸš€ Running pre-push checks..."

# Allow bypass with SKIP_HOOKS=1
if [ "$SKIP_HOOKS" = "1" ]; then
    echo "â­ï¸  Skipping pre-push hooks (SKIP_HOOKS=1)"
    exit 0
fi

# Use correct base branch
BASE_BRANCH="origin/main"

# Check if there are any affected projects
AFFECTED=$(npx nx print-affected --base=$BASE_BRANCH --select=projects 2>/dev/null || echo "")

if [ -z "$AFFECTED" ]; then
    echo "âœ¨ No affected projects. Skipping checks."
    exit 0
fi

echo "ğŸ¯ Affected projects found. Running checks..."

# Run checks in parallel with modern syntax
echo "ğŸ“ Type checking..."
if ! npx nx affected --base=$BASE_BRANCH --target=typecheck --parallel=3; then
    echo "âŒ Type check failed! Fix errors or use: SKIP_HOOKS=1 git push"
    exit 1
fi

echo "ğŸ” Linting..."
if ! npx nx affected --base=$BASE_BRANCH --target=lint --parallel=3; then
    echo "âŒ Linting failed! Fix errors or use: SKIP_HOOKS=1 git push"
    exit 1
fi

echo "ğŸ§ª Running unit tests..."
if ! npx nx affected --base=$BASE_BRANCH --target=test --exclude=e2e --parallel=3; then
    echo "âŒ Tests failed! Fix errors or use: SKIP_HOOKS=1 git push"
    exit 1
fi

echo "âœ… All checks passed!"
